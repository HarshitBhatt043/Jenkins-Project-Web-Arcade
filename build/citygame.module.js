/**
 * @license
 * Copyright 2010-2022 3d.City.js Authors
 * SPDX-License-Identifier: MIT
 */
const Micro={haveMapAnimation:!0,localStorage:null,GameMapProps:["cityCentreX","cityCentreY","pollutionMaxX","pollutionMaxY","width","height"],savePropsVar:["cityTime"],CensusProps:["resPop","comPop","indPop","crimeRamp","pollutionRamp","landValueAverage","pollutionAverage","crimeAverage","totalPop","resHist10","resHist120","comHist10","comHist120","indHist10","indHist120","crimeHist10","crimeHist120","moneyHist10","moneyHist120","pollutionHist10","pollutionHist120"],BudgetProps:["autoBudget","totalFunds","policePercent","roadPercent","firePercent","roadSpend","policeSpend","fireSpend","roadMaintenanceBudget","policeMaintenanceBudget","fireMaintenanceBudget","cityTax","roadEffect","policeEffect","fireEffect"],PROBLEMS:["CVP_CRIME","CVP_POLLUTION","CVP_HOUSING","CVP_TAXES","CVP_TRAFFIC","CVP_UNEMPLOYMENT","CVP_FIRE"],NUMPROBLEMS:7,NUM_COMPLAINTS:4,problemData:[],EvalProps:["cityClass","cityScore"],speedPowerScan:[2,4,5,6],speedPollutionTerrainLandValueScan:[2,7,17,30],speedCrimeScan:[1,8,18,32],speedPopulationDensityScan:[1,9,19,38],speedFireAnalysis:[1,10,20,40],CENSUS_FREQUENCY_10:4,CENSUS_FREQUENCY_120:40,TAX_FREQUENCY:48,MAP_WIDTH:128,MAP_HEIGHT:128,MAP_DEFAULT_WIDTH:384,MAP_DEFAULT_HEIGHT:384,MAP_BIG_DEFAULT_WIDTH:2048,MAP_BIG_DEFAULT_HEIGHT:2048,MAP_BIG_DEFAULT_ID:"bigMap",MAP_PARENT_ID:"splashContainer",MAP_DEFAULT_ID:"SplashCanvas",DEFAULT_WIDTH:400,DEFAULT_HEIGHT:400,DEFAULT_ID:"MicropolisCanvas",RCI_DEFAULT_ID:"RCICanvas",LEVEL_EASY:0,LEVEL_MED:1,LEVEL_HARD:2,SPEED_PAUSED:0,SPEED_SLOW:1,SPEED_MED:2,SPEED_FAST:3,SPEED_ULTRA:4,ROUTE_FOUND:1,NO_ROUTE_FOUND:0,NO_ROAD_FOUND:-1,MAX_TRAFFIC_DISTANCE:30,perimX:[-1,0,1,2,2,2,1,0,-1,-2,-2,-2],perimY:[-2,-2,-2,-1,0,1,2,2,2,1,0,-1],SPRITE_TRAIN:1,SPRITE_HELICOPTER:2,SPRITE_AIRPLANE:3,SPRITE_SHIP:4,SPRITE_MONSTER:5,SPRITE_TORNADO:6,SPRITE_EXPLOSION:7,CC_VILLAGE:"VILLAGE",CC_TOWN:"TOWN",CC_CITY:"CITY",CC_CAPITAL:"CAPITAL",CC_METROPOLIS:"METROPOLIS",CC_MEGALOPOLIS:"MEGALOPOLIS",CRIME:0,POLLUTION:1,HOUSING:2,TAXES:3,TRAFFIC:4,UNEMPLOYMENT:5,FIRE:6,RES_VALVE_RANGE:2e3,COM_VALVE_RANGE:1500,IND_VALVE_RANGE:1500,taxTable:[200,150,120,100,80,50,30,0,-10,-40,-100,-150,-200,-250,-300,-350,-400,-450,-500,-550,-600],extMarketParamTable:[1.2,1.1,.98],RLevels:[.7,.9,1.2],FLevels:[1.4,1.2,.8],MAX_ROAD_EFFECT:32,MAX_POLICESTATION_EFFECT:1e3,MAX_FIRESTATION_EFFECT:1e3,policeMaintenanceCost:100,fireMaintenanceCost:100,roadMaintenanceCost:1,railMaintenanceCost:2,COAL_POWER_STRENGTH:700,NUCLEAR_POWER_STRENGTH:2e3,DISASTER_NONE:"None",DISASTER_MONSTER:"Monster",DISASTER_FIRE:"Fire",DISASTER_FLOOD:"Flood",DISASTER_CRASH:"Crash",DISASTER_MELTDOWN:"Meltdown",DISASTER_TORNADO:"Tornado",CURRENT_VERSION:3,KEY:"micropolisJSGame",DisChance:[479,239,59],TERRAIN_CREATE_ISLAND:0,TERRAIN_TREE_LEVEL:-1,TERRAIN_LAKE_LEVEL:-1,TERRAIN_CURVE_LEVEL:-1,ISLAND_RADIUS:18,M_ARRAY_TYPE:"undefined"!=typeof Float32Array?Float32Array:Array,arrs:["res","com","ind","crime","money","pollution"],directionTable:[0,3,2,1,3,4,5,7,6,5,7,8,1],SMOOTH_NEIGHBOURS_THEN_BLOCK:0,SMOOTH_ALL_THEN_CLAMP:1,simData:null,messageManager:null};class EventEmitter{static emitEvent(e,t){Micro.messageManager.sendMessage(e,t)}}class MiscUtils{static mcd(e){return{configurable:!1,enumerable:!1,writeable:!1,value:e}}static rotate10Arrays(){for(var e=0;e<Micro.arrs.length;e++){var t=Micro.arrs[e]+"Hist10";this[t].pop(),this[t].unshift(0)}}static rotate120Arrays(){for(var e=0;e<Micro.arrs.length;e++){var t=Micro.arrs[e]+"Hist120";this[t].pop(),this[t].unshift(0)}}static isCallable(e){return"function"==typeof e}static copyFrom(e,t,i){for(var s=function(e){return i(e)},a=t.data.length;a--;)e[a]=t.data[a].map(s)}static makeArrayOf(e,t){for(var i=new Array(e),s=e;s--;)i[s]=t;return i}}class math{static lerp(e,t,i){return(1-i)*e+i*t}static rand(e,t){return e+Math.random()*(t-e)}static randInt(e,t){return e+Math.floor(Math.random()*(t-e+1))}static clamp(e,t,i){return e<t?t:e>i?i:e}static getChance(e){return 0==(math.getRandom16()&e)}static getERandom(e){var t=math.getRandom(e),i=math.getRandom(e);return Math.min(t,i)}static getRandom(e){return Math.floor(Math.random()*(e+1))}static getRandom16(){return math.getRandom(65535)}static getRandom16Signed(){var e=math.getRandom16();return e<32768?e:-65536+e}}class ZoneUtils{static pixToWorld(e){return e>>4}static worldToPix(e){return e<<4}static unwrapTile(e){return e.isTile?e=e.getValue():e}static canBulldoze(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.FIRSTRIVEDGE&&e<=Tile.LASTRUBBLE||e>=Tile.POWERBASE+2&&e<=Tile.POWERBASE+12||e>=Tile.TINYEXP&&e<=Tile.LASTTINYEXP+2}static isCommercial(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.COMBASE&&e<Tile.INDBASE}static isIndustrial(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.INDBASE&&e<Tile.PORTBASE}static isResidential(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.RESBASE&&e<Tile.HOSPITALBASE}static isDriveable(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.ROADBASE&&e<=Tile.LASTRAIL||e===Tile.RAILHPOWERV||e===Tile.RAILVPOWERH}static isFire(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.FIREBASE&&e<Tile.ROADBASE}static isFlood(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.FLOOD&&e<Tile.LASTFLOOD}static isManualExplosion(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.TINYEXP&&e<=Tile.LASTTINYEXP}static isRail(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.RAILBASE&&e<Tile.RESBASE}static isRoad(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.ROADBASE&&e<Tile.POWERBASE}static normalizeRoad(e){return(e=ZoneUtils.unwrapTile(e))>=Tile.ROADBASE&&e<=Tile.LASTROAD+1?64+(15&e):e}static isCommercialZone(e){return e.isZone()&&ZoneUtils.isCommercial(e)}static isIndustrialZone(e){return e.isZone()&&ZoneUtils.isIndustrial(e)}static isResidentialZone(e){return e.isZone()&&ZoneUtils.isResidential(e)}static randomFire(e){return new Tiles(Tile.FIRE+(3&math.getRandom16()),Tile.ANIMBIT)}static randomRubble(e){return new Tiles(Tile.RUBBLE+(3&math.getRandom16()),Tile.BULLBIT)}static HOSPITAL(e){}static checkBigZone=function(e){let t;switch(e){case Tile.POWERPLANT:case Tile.PORT:case Tile.NUCLEAR:case Tile.STADIUM:t={zoneSize:4,deltaX:0,deltaY:0};break;case Tile.POWERPLANT+1:case Tile.COALSMOKE3:case Tile.COALSMOKE3+1:case Tile.COALSMOKE3+2:case Tile.PORT+1:case Tile.NUCLEAR+1:case Tile.STADIUM+1:t={zoneSize:4,deltaX:-1,deltaY:0};break;case Tile.POWERPLANT+4:case Tile.PORT+4:case Tile.NUCLEAR+4:case Tile.STADIUM+4:t={zoneSize:4,deltaX:0,deltaY:-1};break;case Tile.POWERPLANT+5:case Tile.PORT+5:case Tile.NUCLEAR+5:case Tile.STADIUM+5:t={zoneSize:4,deltaX:-1,deltaY:-1};break;case Tile.AIRPORT:t={zoneSize:6,deltaX:0,deltaY:0};break;case Tile.AIRPORT+1:t={zoneSize:6,deltaX:-1,deltaY:0};break;case Tile.AIRPORT+2:t={zoneSize:6,deltaX:-2,deltaY:0};break;case Tile.AIRPORT+3:t={zoneSize:6,deltaX:-3,deltaY:0};break;case Tile.AIRPORT+6:t={zoneSize:6,deltaX:0,deltaY:-1};break;case Tile.AIRPORT+7:t={zoneSize:6,deltaX:-1,deltaY:-1};break;case Tile.AIRPORT+8:t={zoneSize:6,deltaX:-2,deltaY:-1};break;case Tile.AIRPORT+9:t={zoneSize:6,deltaX:-3,deltaY:-1};break;case Tile.AIRPORT+12:t={zoneSize:6,deltaX:0,deltaY:-2};break;case Tile.AIRPORT+13:t={zoneSize:6,deltaX:-1,deltaY:-2};break;case Tile.AIRPORT+14:t={zoneSize:6,deltaX:-2,deltaY:-2};break;case Tile.AIRPORT+15:t={zoneSize:6,deltaX:-3,deltaY:-2};break;case Tile.AIRPORT+18:t={zoneSize:6,deltaX:0,deltaY:-3};break;case Tile.AIRPORT+19:t={zoneSize:6,deltaX:-1,deltaY:-3};break;case Tile.AIRPORT+20:t={zoneSize:6,deltaX:-2,deltaY:-3};break;case Tile.AIRPORT+21:t={zoneSize:6,deltaX:-3,deltaY:-3};break;default:t={zoneSize:0,deltaX:0,deltaY:0};break}return t};static checkZoneSize(e){return e>=Tile.RESBASE-1&&e<=Tile.PORTBASE-1||e>=Tile.LASTPOWERPLANT+1&&e<=Tile.POLICESTATION+4||e>=Tile.CHURCH1BASE&&e<=Tile.CHURCH7LAST?3:e>=Tile.PORTBASE&&e<=Tile.LASTPORT||e>=Tile.COALBASE&&e<=Tile.LASTPOWERPLANT||e>=Tile.STADIUMBASE&&e<=Tile.LASTZONE?4:0}static fireZone(e,t,i,s){let a,o,l,r,n=e.getTileValue(t,i),h=2,T=s.rateOfGrowthMap.worldGet(t,i);for(T=math.clamp(T-20,-200,200),s.rateOfGrowthMap.worldSet(t,i,T),n===Tile.AIRPORT?h=5:n>=Tile.PORTBASE?h=3:n<Tile.PORTBASE&&(h=2),a=-1;a<h;a++)for(o=-1;o<h;o++)l=t+a,r=i+o,e.testBounds(l,r)&&e.getTileValue(l,r>=Tile.ROADBASE)&&e.addTileFlags(l,r,Tile.BULLBIT)}static getLandPollutionValue(e,t,i){let s=e.landValueMap.worldGet(t,i);return s-=e.pollutionDensityMap.worldGet(t,i),s<30?0:s<80?1:s<150?2:3}static incRateOfGrowth(e,t,i,s){let a=e.rateOfGrowthMap.worldGet(t,i),o=math.clamp(a+4*s,-200,200);e.rateOfGrowthMap.worldSet(t,i,o)}static putZone(e,t,i,s,a){let o,l,r;for(o=-1;o<2;o++)for(l=-1;l<2;l++)if(r=e.getTileValue(t+l,i+o),r>=Tile.FLOOD&&r<Tile.ROADBASE)return;e.putZone(t,i,s,3),e.addTileFlags(t,i,Tile.BULLBIT),a&&e.addTileFlags(t,i,Tile.POWERBIT)}}class Tiles{constructor(e=Tile.DIRT,t){this.isTile=!0,this._value=e,arguments.length>1&&(this._value|=t)}getValue(){return this._value&Tile.BIT_MASK}setValue(e){if(0===arguments.length||"number"!=typeof e||e<0)throw new Error("Invalid parameter");let t=0;e<Tile.BIT_START&&(t=this._value&Tile.ALLBITS),this._value=e|t}isBulldozable(){return(this._value&Tile.BULLBIT)>0}isAnimated(){return(this._value&Tile.ANIMBIT)>0}isConductive(){return(this._value&Tile.CONDBIT)>0}isCombustible(){return(this._value&Tile.BURNBIT)>0}isPowered(){return(this._value&Tile.POWERBIT)>0}isZone(){return(this._value&Tile.ZONEBIT)>0}addFlags(e){if(!arguments.length||"number"!=typeof e||e<Tile.BIT_START||e>=Tile.BIT_END<<1)throw new Error("Invalid parameter");this._value|=e}removeFlags(e){if(!arguments.length||"number"!=typeof e||e<Tile.BIT_START||e>=Tile.BIT_END<<1)throw new Error("Invalid parameter");this._value&=~e}setFlags(e){let t=this._value&~Tile.ALLBITS;this._value=t|e}getFlags(){return this._value&Tile.ALLBITS}getRawValue(){return this._value}set(e,t){if(arguments.length<2||"number"!=typeof e||"number"!=typeof t||e>=Tile.TILE_COUNT)throw new Error("Invalid parameter");this.setValue(e),this.setFlags(t)}toString(){let e="Tile# "+this.getValue();return e+=this.isCombustible()?" burning":"",e+=this.isPowered()?" powered":"",e+=this.isAnimated()?" animated":"",e+=this.isConductive()?" conductive":"",e+=this.isZone()?" zone":"",e+=this.isBulldozable()?" bulldozeable":"",e}}const Tile={POWERBIT:32768,CONDBIT:16384,BURNBIT:8192,BULLBIT:4096,ANIMBIT:2048,ZONEBIT:1024,BLBNBIT:12288,BLBNCNBIT:28672,BNCNBIT:24576,ASCBIT:26624,ALLBITS:64512,BIT_START:1024,BIT_END:32768,BIT_MASK:1023,DIRT:0,RIVER:2,REDGE:3,CHANNEL:4,FIRSTRIVEDGE:5,LASTRIVEDGE:20,WATER_LOW:2,WATER_HIGH:20,TREEBASE:21,WOODS_LOW:21,LASTTREE:36,WOODS:37,UNUSED_TRASH1:38,UNUSED_TRASH2:39,WOODS_HIGH:39,WOODS2:40,WOODS3:41,WOODS4:42,WOODS5:43,RUBBLE:44,LASTRUBBLE:47,FLOOD:48,LASTFLOOD:51,RADTILE:52,UNUSED_TRASH3:53,UNUSED_TRASH4:54,UNUSED_TRASH5:55,FIRE:48,FIREBASE:48,LASTFIRE:55,HBRIDGE:64,ROADBASE:64,VBRIDGE:65,ROADS:66,ROADS2:67,ROADS3:68,ROADS4:69,ROADS5:70,ROADS6:71,ROADS7:72,ROADS8:73,ROADS9:74,ROADS10:75,INTERSECTION:76,HROADPOWER:77,VROADPOWER:78,BRWH:79,LTRFBASE:80,BRWV:95,BRWXXX1:111,BRWXXX2:127,BRWXXX3:143,HTRFBASE:144,BRWXXX4:159,BRWXXX5:175,BRWXXX6:191,LASTROAD:206,BRWXXX7:207,HPOWER:208,VPOWER:209,LHPOWER:210,LVPOWER:211,LVPOWER2:212,LVPOWER3:213,LVPOWER4:214,LVPOWER5:215,LVPOWER6:216,LVPOWER7:217,LVPOWER8:218,LVPOWER9:219,LVPOWER10:220,RAILHPOWERV:221,RAILVPOWERH:222,POWERBASE:208,LASTPOWER:222,UNUSED_TRASH6:223,HRAIL:224,VRAIL:225,LHRAIL:226,LVRAIL:227,LVRAIL2:228,LVRAIL3:229,LVRAIL4:230,LVRAIL5:231,LVRAIL6:232,LVRAIL7:233,LVRAIL8:234,LVRAIL9:235,LVRAIL10:236,HRAILROAD:237,VRAILROAD:238,RAILBASE:224,LASTRAIL:238,ROADVPOWERH:239,RESBASE:240,FREEZ:244,HOUSE:249,LHTHR:249,HHTHR:260,RZB:265,HOSPITALBASE:405,HOSPITAL:409,CHURCHBASE:414,CHURCH0BASE:414,CHURCH:418,CHURCH0:418,COMBASE:423,COMCLR:427,CZB:436,COMLAST:609,INDBASE:612,INDCLR:616,LASTIND:620,IND1:621,IZB:625,IND2:641,IND3:644,IND4:649,IND5:650,IND6:676,IND7:677,IND8:686,IND9:689,PORTBASE:693,PORT:698,LASTPORT:708,AIRPORTBASE:709,RADAR:711,AIRPORT:716,COALBASE:745,POWERPLANT:750,LASTPOWERPLANT:760,FIRESTBASE:761,FIRESTATION:765,POLICESTBASE:770,POLICESTATION:774,STADIUMBASE:779,STADIUM:784,FULLSTADIUM:800,NUCLEARBASE:811,NUCLEAR:816,LASTZONE:826,LIGHTNINGBOLT:827,HBRDG0:828,HBRDG1:829,HBRDG2:830,HBRDG3:831,RADAR0:832,RADAR1:833,RADAR2:834,RADAR3:835,RADAR4:836,RADAR5:837,RADAR6:838,RADAR7:839,FOUNTAIN:840,INDBASE2:844,TELEBASE:844,TELELAST:851,SMOKEBASE:852,TINYEXP:860,SOMETINYEXP:864,LASTTINYEXP:867,TINYEXPLAST:883,COALSMOKE1:916,COALSMOKE2:920,COALSMOKE3:924,COALSMOKE4:928,FOOTBALLGAME1:932,FOOTBALLGAME2:940,VBRDG0:948,VBRDG1:949,VBRDG2:950,VBRDG3:951,NUKESWIRL1:952,NUKESWIRL2:953,NUKESWIRL3:954,NUKESWIRL4:955,CHURCH1BASE:956,CHURCH1:960,CHURCH2BASE:965,CHURCH2:969,CHURCH3BASE:974,CHURCH3:978,CHURCH4BASE:983,CHURCH4:987,CHURCH5BASE:992,CHURCH5:996,CHURCH6BASE:1001,CHURCH6:1005,CHURCH7BASE:1010,CHURCH7:1014,CHURCH7LAST:1018,TILE_COUNT:1024,TILE_INVALID:-1,MIN_SIZE:16},RoadTable=[Tile.ROADS,Tile.ROADS2,Tile.ROADS,Tile.ROADS3,Tile.ROADS2,Tile.ROADS2,Tile.ROADS4,Tile.ROADS8,Tile.ROADS,Tile.ROADS6,Tile.ROADS,Tile.ROADS7,Tile.ROADS5,Tile.ROADS10,Tile.ROADS9,Tile.INTERSECTION],RailTable=[Tile.LHRAIL,Tile.LVRAIL,Tile.LHRAIL,Tile.LVRAIL2,Tile.LVRAIL,Tile.LVRAIL,Tile.LVRAIL3,Tile.LVRAIL7,Tile.LHRAIL,Tile.LVRAIL5,Tile.LHRAIL,Tile.LVRAIL6,Tile.LVRAIL4,Tile.LVRAIL9,Tile.LVRAIL8,Tile.LVRAIL10],WireTable=[Tile.LHPOWER,Tile.LVPOWER,Tile.LHPOWER,Tile.LVPOWER2,Tile.LVPOWER,Tile.LVPOWER,Tile.LVPOWER3,Tile.LVPOWER7,Tile.LHPOWER,Tile.LVPOWER5,Tile.LHPOWER,Tile.LVPOWER6,Tile.LVPOWER4,Tile.LVPOWER9,Tile.LVPOWER8,Tile.LVPOWER10];class MessageManager{constructor(){this.data=[]}sendMessage(e,t){this.data.push({message:e,data:t})}clear(){this.data=[]}getMessages(){return this.data.slice()}}var messageData={AUTOBUDGET_CHANGED:MiscUtils.mcd("Autobudget changed"),BUDGET_NEEDED:MiscUtils.mcd("User needs to budget"),BUDGET_REQUESTED:MiscUtils.mcd("Budget window requested"),BUDGET_WINDOW_CLOSED:MiscUtils.mcd("Budget window closed"),BLACKOUTS_REPORTED:MiscUtils.mcd("Blackouts reported"),CLASSIFICATION_UPDATED:MiscUtils.mcd("Classification updated"),CONGRATS_SHOWING:MiscUtils.mcd("Congratulations showing"),CONGRATS_WINDOW_CLOSED:MiscUtils.mcd("Congratulations window closed"),DATE_UPDATED:MiscUtils.mcd("Date changed"),DEBUG_WINDOW_REQUESTED:MiscUtils.mcd("Debug Window Requested"),DEBUG_WINDOW_CLOSED:MiscUtils.mcd("Debug Window Closed"),DISASTER_REQUESTED:MiscUtils.mcd("Disaster Requested"),DISASTER_WINDOW_CLOSED:MiscUtils.mcd("Disaster window closed"),EARTHQUAKE:MiscUtils.mcd("Earthquake"),EVAL_REQUESTED:MiscUtils.mcd("Evaluation Requested"),EVAL_UPDATED:MiscUtils.mcd("Evaluation Updated"),EVAL_WINDOW_CLOSED:MiscUtils.mcd("Eval window closed"),EXPLOSION_REPORTED:MiscUtils.mcd("Explosion Reported"),FIRE_REPORTED:MiscUtils.mcd("Fire!"),FIRE_STATION_NEEDS_FUNDING:MiscUtils.mcd("Fire station needs funding"),FLOODING_REPORTED:MiscUtils.mcd("Flooding reported"),FRONT_END_MESSAGE:MiscUtils.mcd("Front-end Message"),FUNDS_CHANGED:MiscUtils.mcd("Total funds has changed"),HEAVY_TRAFFIC:MiscUtils.mcd("Heavy traffic in city"),HELICOPTER_CRASHED:MiscUtils.mcd("Helicopter crashed"),HIGH_CRIME:MiscUtils.mcd("High crime"),HIGH_POLLUTION:MiscUtils.mcd("High pollution"),MONSTER_SIGHTED:MiscUtils.mcd("Monster sighted"),NAG_WINDOW_CLOSED:MiscUtils.mcd("Nag window closed"),NEED_AIRPORT:MiscUtils.mcd("Airport needed"),NEED_ELECTRICITY:MiscUtils.mcd("More power needed"),NEED_FIRE_STATION:MiscUtils.mcd("Fire station needed"),NEED_MORE_COMMERCIAL:MiscUtils.mcd("More commercial zones needed"),NEED_MORE_INDUSTRIAL:MiscUtils.mcd("More industrial zones needed"),NEED_MORE_RAILS:MiscUtils.mcd("More railways needed"),NEED_MORE_RESIDENTIAL:MiscUtils.mcd("More residential needed"),NEED_MORE_ROADS:MiscUtils.mcd("More roads needed"),NEED_POLICE_STATION:MiscUtils.mcd("Police station needed"),NEED_SEAPORT:MiscUtils.mcd("Seaport needed"),NEED_STADIUM:MiscUtils.mcd("Stadium needed"),NO_MONEY:MiscUtils.mcd("No money"),NOT_ENOUGH_POWER:MiscUtils.mcd("Not enough power"),NUCLEAR_MELTDOWN:MiscUtils.mcd("Nuclear Meltdown"),PLANE_CRASHED:MiscUtils.mcd("Plane crashed"),POLICE_NEEDS_FUNDING:MiscUtils.mcd("Police need funding"),POPULATION_UPDATED:MiscUtils.mcd("Population updated"),QUERY_WINDOW_CLOSED:MiscUtils.mcd("Query window closed"),QUERY_WINDOW_NEEDED:MiscUtils.mcd("Query window needed"),REACHED_CAPITAL:MiscUtils.mcd("Now a capital"),REACHED_CITY:MiscUtils.mcd("Now a city"),REACHED_METROPOLIS:MiscUtils.mcd("Now a metropolis"),REACHED_MEGALOPOLIS:MiscUtils.mcd("Now a megalopolis"),REACHED_TOWN:MiscUtils.mcd("Now a town"),REACHED_VILLAGE:MiscUtils.mcd("Now a village"),ROAD_NEEDS_FUNDING:MiscUtils.mcd("Roads need funding"),SAVE_REQUESTED:MiscUtils.mcd("Save requested"),SAVE_WINDOW_CLOSED:MiscUtils.mcd("Save window closed"),SCORE_UPDATED:MiscUtils.mcd("Score updated"),SCREENSHOT_LINK_CLOSED:MiscUtils.mcd("Screenshot link closed"),SCREENSHOT_WINDOW_CLOSED:MiscUtils.mcd("Screenshot window closed"),SCREENSHOT_WINDOW_REQUESTED:MiscUtils.mcd("Screenshot window requested"),SETTINGS_WINDOW_CLOSED:MiscUtils.mcd("Settings window closed"),SETTINGS_WINDOW_REQUESTED:MiscUtils.mcd("Settings window requested"),SHIP_CRASHED:MiscUtils.mcd("Shipwrecked"),SOUND_EXPLOSIONHIGH:MiscUtils.mcd("Explosion! Bang!"),SOUND_EXPLOSIONLOW:MiscUtils.mcd("Explosion! Bang!"),SOUND_HEAVY_TRAFFIC:MiscUtils.mcd("Heavy Traffic sound"),SOUND_HONKHONK:MiscUtils.mcd("HonkHonk sound"),SOUND_MONSTER:MiscUtils.mcd("Monster sound"),SPEED_CHANGE:MiscUtils.mcd("Speed change"),SPRITE_DYING:MiscUtils.mcd("Sprite dying"),SPRITE_MOVED:MiscUtils.mcd("Sprite move"),TAX_TOO_HIGH:MiscUtils.mcd("Tax too high"),TOOL_CLICKED:MiscUtils.mcd("Tool clicked"),TORNADO_SIGHTED:MiscUtils.mcd("Tornado sighted"),TOUCH_WINDOW_CLOSED:MiscUtils.mcd("Touch Window closed"),TRAFFIC_JAMS:MiscUtils.mcd("Traffic jams reported"),TRAIN_CRASHED:MiscUtils.mcd("Train crashed"),VALVES_UPDATED:MiscUtils.mcd("Valves updated"),WELCOME:MiscUtils.mcd("Welcome to micropolisJS"),WELCOMEBACK:MiscUtils.mcd("Welcome back to your 3D city")};const Messages=Object.defineProperties({},messageData);var disasterMessages=[Messages.EARTHQUAKE,Messages.EXPLOSION_REPORTED,Messages.FIRE_REPORTED,Messages.FLOODING_REPORTED,Messages.MONSTER_SIGHTED,Messages.NUCLEAR_MELTDOWN,Messages.TORNADO_SIGHTED];Object.defineProperty(Messages,"disasterMessages",MiscUtils.mcd(disasterMessages));var crashes=[Messages.HELICOPTER_CRASHED,Messages.PLANE_CRASHED,Messages.SHIP_CRASHED,Messages.TRAIN_CRASHED];Object.defineProperty(Messages,"crashes",MiscUtils.mcd(crashes));const Text=function(){var e={};e[""+Micro.LEVEL_EASY]="Easy",e[""+Micro.LEVEL_MED]="Medium",e[""+Micro.LEVEL_HARD]="Hard";var t={};t[Micro.CC_VILLAGE]="VILLAGE",t[Micro.CC_TOWN]="TOWN",t[Micro.CC_CITY]="CITY",t[Micro.CC_CAPITAL]="CAPITAL",t[Micro.CC_METROPOLIS]="METROPOLIS",t[Micro.CC_MEGALOPOLIS]="MEGALOPOLIS";var i={};i[Micro.CRIME]="Crime",i[Micro.POLLUTION]="Pollution",i[Micro.HOUSING]="Housing",i[Micro.TAXES]="Taxes",i[Micro.TRAFFIC]="Traffic",i[Micro.UNEMPLOYMENT]="Unemployment",i[Micro.FIRE]="Fire";var s={};s[Messages.FIRE_STATION_NEEDS_FUNDING]="Fire departments need funding",s[Messages.NEED_AIRPORT]="Commerce requires an Airport",s[Messages.NEED_FIRE_STATION]="Citizens demand a Fire Department",s[Messages.NEED_ELECTRICITY]="Build a Power Plant",s[Messages.NEED_MORE_INDUSTRIAL]="More industrial zones needed",s[Messages.NEED_MORE_COMMERCIAL]="More commercial zones needed",s[Messages.NEED_MORE_RESIDENTIAL]="More residential zones needed",s[Messages.NEED_MORE_RAILS]="Inadequate rail system",s[Messages.NEED_MORE_ROADS]="More roads required",s[Messages.NEED_POLICE_STATION]="Citizens demand a Police Department",s[Messages.NEED_SEAPORT]="Industry requires a Sea Port",s[Messages.NEED_STADIUM]="Residents demand a Stadium",s[Messages.ROAD_NEEDS_FUNDING]="Roads deteriorating, due to lack of funds",s[Messages.POLICE_NEEDS_FUNDING]="Police departments need funding",s[Messages.WELCOME]="Welcome to 3D City",s[Messages.WELCOMEBACK]="Welcome to 3D City";var a={};a[Messages.BLACKOUTS_REPORTED]="Brownouts, build another Power Plant",a[Messages.COPTER_CRASHED]="A helicopter crashed ",a[Messages.EARTHQUAKE]="Major earthquake reported !!",a[Messages.EXPLOSION_REPORTED]="Explosion detected ",a[Messages.FLOODING_REPORTED]="Flooding reported !",a[Messages.FIRE_REPORTED]="Fire reported ",a[Messages.HEAVY_TRAFFIC]="Heavy Traffic reported",a[Messages.HIGH_CRIME]="Crime very high",a[Messages.HIGH_POLLUTION]="Pollution very high",a[Messages.MONSTER_SIGHTED]="A Monster has been sighted !",a[Messages.NO_MONEY]="YOUR CITY HAS GONE BROKE",a[Messages.NOT_ENOUGH_POWER]="Blackouts reported. insufficient power capacity",a[Messages.NUCLEAR_MELTDOWN]="A Nuclear Meltdown has occurred !!",a[Messages.PLANE_CRASHED]="A plane has crashed ",a[Messages.SHIP_CRASHED]="Shipwreck reported ",a[Messages.TAX_TOO_HIGH]="Citizens upset. The tax rate is too high",a[Messages.TORNADO_SIGHTED]="Tornado reported !",a[Messages.TRAFFIC_JAMS]="Frequent traffic jams reported",a[Messages.TRAIN_CRASHED]="A train crashed ";var o={};return o[Messages.REACHED_CAPITAL]="Population has reached 50,000",o[Messages.REACHED_CITY]="Population has reached 10,000",o[Messages.REACHED_MEGALOPOLIS]="Population has reached 500,000",o[Messages.REACHED_METROPOLIS]="Population has reached 100,000",o[Messages.REACHED_TOWN]="Population has reached 2,000",{badMessages:a,cityClass:t,crimeStrings:["Safe","Light","Moderate","Dangerous"],densityStrings:["Low","Medium","High","Very High"],gameLevel:e,goodMessages:o,landValueStrings:["Slum","Lower Class","Middle Class","High"],months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],neutralMessages:s,problems:i,pollutionStrings:["None","Moderate","Heavy","Very Heavy"],rateStrings:["Declining","Stable","Slow Growth","Fast Growth"],toolMessages:{noMoney:"Insufficient funds to build that",needsDoze:"Area must be bulldozed first"},zoneTypes:["Clear","Water","Trees","Rubble","Flood","Radioactive Waste","Fire","Road","Power","Rail","Residential","Commercial","Industrial","Seaport","Airport","Coal Power","Fire Department","Police Department","Stadium","Nuclear Power","Draw Bridge","Radar Dish","Fountain","Industrial","Steelers 38  Bears 3","Draw Bridge","Ur 238"]}},TXT=new Text;class SpriteUtils{static pixToWorld(e){return ZoneUtils.pixToWorld(e)}static worldToPix(e){return ZoneUtils.worldToPix(e)}static turnTo(e,t){return e===t||(e<t?t-e<4?e++:e--:e-t<4?e--:e++,e>8&&(e=1),e<1&&(e=8)),e}static absoluteValue(e){return Math.abs(e)}static getTileValue(e,t,i){let s=ZoneUtils.pixToWorld(t),a=ZoneUtils.pixToWorld(i);return s<0||s>=e.width||a<0||a>=e.height?-1:e.getTileValue(s,a)}static getDir(e,t,i,s){let a,o=i-e,l=s-t;return a=o<0?l<0?11:8:l<0?2:5,o=Math.abs(o),l=Math.abs(l),2*o<l?a++:2*l<o&&a--,(a<0||a>12)&&(a=0),Micro.directionTable[a]}static absoluteDistance(e,t,i,s){let a=i-e,o=s-t;return Math.abs(a)+Math.abs(o)}static checkWet(e){return e===Tile.HPOWER||e===Tile.VPOWER||e===Tile.HRAIL||e===Tile.VRAIL||e===Tile.BRWH||e===Tile.BRWV}static destroyMapTile(e,t,i,s,a){let o=ZoneUtils.pixToWorld(s),l=ZoneUtils.pixToWorld(a);if(!t.testBounds(o,l))return;let r=t.getTile(o,l),n=r.getValue();n<Tile.TREEBASE||(r.isCombustible()?(r.isZone()&&(ZoneUtils.fireZone(t,o,l,i),n>Tile.RZB&&e.makeExplosionAt(s,a)),SpriteUtils.checkWet(n)?t.setTile(o,l,Tile.RIVER,0):t.setTile(o,l,Tile.TINYEXP,Tile.BULLBIT|Tile.ANIMBIT)):n>=Tile.ROADBASE&&n<=Tile.LASTROAD&&t.setTile(o,l,Tile.RIVER,0))}static getDistance(e,t,i,s){return Math.abs(e-i)+Math.abs(t-s)}static checkSpriteCollision(e,t){return 0!==e.frame&&0!==t.frame&&SpriteUtils.getDistance(e.x,e.y,t.x,t.y)<30}}class BaseSprite{constructor(){}init(e,t,i,s,a){this.type=e,this.map=t,this.spriteManager=i,this.x=s,this.y=a,this.origX=0,this.origY=0,this.destX=0,this.destY=0,this.count=0,this.soundCount=0,this.dir=0,this.newDir=0,this.step=0,this.flag=0,this.turn=0,this.accel=0,this.speed=100}getFileName(){return["obj",this.type,"-",this.frame-1].join("")}spriteNotInBounds(){let e=SpriteUtils.pixToWorld(this.x),t=SpriteUtils.pixToWorld(this.y);return e<0||t<0||e>=this.map.width||t>=this.map.height}}class TrainSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_TRAIN,e,t,i,s),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=1,this.dir=4,this.tileDeltaX=[0,16,0,-16],this.tileDeltaY=[-16,0,16,0],this.xDelta=[0,4,0,-4,0],this.yDelta=[-4,0,4,0,0],this.TrainPic2=[1,2,1,2,5],this.NORTHSOUTH=1,this.EASTWEST=2,this.NWSE=3,this.NESW=4,this.UNDERWATER=5,this.NORTH=0,this.EAST=1,this.SOUTH=2,this.WEST=3,this.CANTMOVE=4}move(e,t,i,s){if(this.frame!==this.NWSE&&this.frame!==this.NESW||(this.frame=this.TrainPic2[this.dir]),this.x+=this.xDelta[this.dir],this.y+=this.yDelta[this.dir],0==(3&e)){let e=3&math.getRandom16();for(let t=e;t<e+4;t++){let e=3&t;if(this.dir!==this.CANTMOVE&&e===(this.dir+2&3))continue;let i=SpriteUtils.getTileValue(this.map,this.x+this.tileDeltaX[e],this.y+this.tileDeltaY[e]);if(i>=Tile.RAILBASE&&i<=Tile.LASTRAIL||i===Tile.RAILVPOWERH||i===Tile.RAILHPOWERV)return this.dir!==e&&this.dir!==this.CANTMOVE?this.dir+e===this.WEST?this.frame=this.NWSE:this.frame=this.NESW:this.frame=this.TrainPic2[e],i!==Tile.HRAIL&&i!==Tile.VRAIL||(this.frame=this.UNDERWATER),void(this.dir=e)}if(this.dir===this.CANTMOVE)return void(this.frame=0);this.dir=this.CANTMOVE}}explodeSprite(e){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),e.sendMessage(Messages.TRAIN_CRASHED)}}class BoatSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_SHIP,e,t,i,s),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,i<SpriteUtils.worldToPix(4)?this.frame=3:i>=SpriteUtils.worldToPix(e.width-4)?this.frame=7:s<SpriteUtils.worldToPix(4)?this.frame=5:s>=SpriteUtils.worldToPix(e.height-4)?this.frame=1:this.frame=3,this.newDir=this.frame,this.dir=10,this.count=1,this.tileDeltaX=[0,0,1,1,1,0,-1,-1,-1],this.tileDeltaY=[0,-1,-1,0,1,1,1,0,-1],this.xDelta=[0,0,2,2,2,0,-2,-2,-2],this.yDelta=[0,-2,-2,0,2,2,2,0,-2],this.tileWhiteList=[Tile.RIVER,Tile.CHANNEL,Tile.POWERBASE,Tile.POWERBASE+1,Tile.RAILBASE,Tile.RAILBASE+1,Tile.BRWH,Tile.BRWV],this.CANTMOVE=10}move(e,t,i,s){let a,o,l,r,n,h,T=Tile.RIVER;if(this.soundCount>0&&this.soundCount--,0===this.soundCount&&(1==(3&math.getRandom16())&&t.sendMessage(Messages.SOUND_HONKHONK),this.soundCount=200),this.count>0&&this.count--,0===this.count){if(this.count=9,this.frame!==this.newDir)return void(this.frame=SpriteUtils.turnTo(this.frame,this.newDir));for(a=7&math.getRandom16(),o=this.frame,l=a;l<a+8;l++)if(o=1+(7&l),o!==this.dir&&(r=SpriteUtils.pixToWorld(this.x)+this.tileDeltaX[o],n=SpriteUtils.pixToWorld(this.y)+this.tileDeltaY[o],this.map.testBounds(r,n)&&(h=this.map.getTileValue(r,n),h===Tile.CHANNEL||h===Tile.BRWH||h===Tile.BRWV||this.oppositeAndUnderwater(h,this.dir,o)))){this.newDir=o,this.frame=SpriteUtils.turnTo(this.frame,this.newDir),this.dir=o+4,this.dir>8&&(this.dir-=8);break}l===a+8&&(this.dir=this.CANTMOVE,this.newDir=1+(7&math.getRandom16()))}else o=this.frame,o===this.newDir&&(this.x+=this.xDelta[o],this.y+=this.yDelta[o]);if(this.spriteNotInBounds())this.frame=0;else for(let e=0;e<8&&T!==this.tileWhiteList[e];e++)7===e&&(this.explodeSprite(t),SpriteUtils.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y))}explodeSprite(e){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),e.sendMessage(Messages.SHIP_CRASHED)}oppositeAndUnderwater(e,t,i){let s=t+4;return s>8&&(s-=8),i==s&&(e==Tile.POWERBASE||e==Tile.POWERBASE+1||e==Tile.RAILBASE||e==Tile.RAILBASE+1)}}class MonsterSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_MONSTER,e,t,i,s),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,i>SpriteUtils.worldToPix(e.width)/2?s>SpriteUtils.worldToPix(e.height)/2?this.frame=10:this.frame=7:s>SpriteUtils.worldToPix(e.height)/2?this.frame=1:this.frame=4,this.flag=0,this.count=1e3,this.destX=SpriteUtils.worldToPix(e.pollutionMaxX),this.destY=SpriteUtils.worldToPix(e.pollutionMaxY),this.origX=this.x,this.origY=this.y,this._seenLand=!1,this.xDelta=[2,2,-2,-2,0],this.yDelta=[-2,2,2,-2,0],this.cardinals1=[0,1,2,3],this.cardinals2=[1,2,3,0],this.diagonals1=[2,5,8,11],this.diagonals2=[11,2,5,8]}move(e,t,i,s){this.soundCount>0&&this.soundCount--;let a,o,l=Math.floor((this.frame-1)/3);if(l<4){if(a=(this.frame-1)%3,2===a&&(this.step=0),0===a&&(this.step=1),this.step?a++:a--,SpriteUtils.absoluteDistance(this.x,this.y,this.destX,this.destY)<60){if(0!==this.flag)return void(this.frame=0);this.flag=1,this.destX=this.origX,this.destY=this.origY}o=SpriteUtils.getDir(this.x,this.y,this.destX,this.destY),o=Math.floor((o-1)/2),o!==l&&math.getChance(10)&&(a=1&math.getRandom16()?this.cardinals1[l]:this.cardinals2[l],l=4,this.soundCount||(t.sendMessage(Messages.SOUND_MONSTER),this.soundCount=50+math.getRandom(100)))}else l=4,o=this.frame,a=o-13&3,3&math.getRandom16()||(a=1&math.getRandom16()?this.diagonals1[a]:this.diagonals2[a],l=Math.floor((a-1)/3),a=(a-1)%3);a=3*l+a+1,a>16&&(a=16),this.frame=a,this.x+=this.xDelta[l],this.y+=this.yDelta[l],this.count>0&&this.count--;let r=SpriteUtils.getTileValue(this.map,this.x,this.y);(-1===r||r===Tile.RIVER&&this.count<500)&&(this.frame=0),(r===Tile.DIRT||r>Tile.WATER_HIGH)&&(this._seenLand=!0);let n=this.spriteManager.getSpriteList();for(let e=0;e<n.length;e++){let i=n[e];0===i.frame||i.type!==Micro.SPRITE_AIRPLANE&&i.type!==Micro.SPRITE_HELICOPTER&&i.type!==Micro.SPRITE_SHIP&&i.type!==Micro.SPRITE_TRAIN||!SpriteUtils.checkSpriteCollision(this,i)||i.explodeSprite(t)}SpriteUtils.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y)}}class CopterSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_HELICOPTER,e,t,i,s),this.width=32,this.height=32,this.xOffset=-16,this.yOffset=-16,this.frame=5,this.count=1500,this.destX=math.getRandom(SpriteUtils.worldToPix(e.width))+8,this.destY=math.getRandom(SpriteUtils.worldToPix(e.height))+8,this.origX=i,this.origY=s,this.xDelta=[0,0,3,5,3,0,-3,-5,-3],this.yDelta=[0,-5,-3,0,3,5,3,0,-3]}move(e,t,i,s){if(this.soundCount>0&&this.soundCount--,this.count>0&&this.count--,0===this.count){let e=this.spriteManager.getSprite(Micro.SPRITE_MONSTER);if(null!==e?(this.destX=e.x,this.destY=e.y):(e=this.spriteManager.getSprite(Micro.SPRITE_TORNADO),null!==e?(this.destX=e.x,this.destY=e.y):(this.destX=this.origX,this.destY=this.origY)),SpriteUtils.absoluteDistance(this.x,this.y,this.origX,this.origY)<30)return void(this.frame=0)}if(0===this.soundCount){let e=SpriteUtils.pixToWorld(this.x),i=SpriteUtils.pixToWorld(this.y);e>=0&&e<this.map.width&&i>=0&&i<this.map.height&&s.trafficDensityMap.worldGet(e,i)>170&&0==(7&math.getRandom16())&&(t.sendMessage(Messages.HEAVY_TRAFFIC,{x:e,y:i}),t.sendMessage(Messages.SOUND_HEAVY_TRAFFIC),this.soundCount=200)}let a=this.frame;if(0==(3&e)){let e=SpriteUtils.getDir(this.x,this.y,this.destX,this.destY);a=SpriteUtils.turnTo(a,e),this.frame=a}this.x+=this.xDelta[a],this.y+=this.yDelta[a]}explodeSprite(e){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),e.sendMessage(Messages.HELICOPTER_CRASHED)}}class AirplaneSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_AIRPLANE,e,t,i,s),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,i>SpriteUtils.worldToPix(e.width-20)?(this.destX=this.x-200,this.frame=7):(this.destX=this.x+200,this.frame=11),this.destY=this.y,this.xDelta=[0,0,6,8,6,0,-6,-8,-6,8,8,8],this.yDelta=[0,-8,-6,0,6,8,6,0,-6,0,0,0]}move(e,t,i,s){let a=this.frame;if(e%5==0)if(a>8)a--,a<9&&(a=3),this.frame=a;else{let e=SpriteUtils.getDir(this.x,this.y,this.destX,this.destY);a=SpriteUtils.turnTo(a,e),this.frame=a}if(SpriteUtils.absoluteDistance(this.x,this.y,this.destX,this.destY)<50&&(this.destX=math.getRandom(SpriteUtils.worldToPix(this.map.width))+8,this.destY=math.getRandom(SpriteUtils.worldToPix(this.map.height))+8),i.enableDisasters){let e=!1,i=this.spriteManager.getSpriteList();for(let s=0;s<i.length;s++){let a=i[s];0!==a.frame&&(a.type!==Micro.SPRITE_HELICOPTER&&a.type!==Micro.SPRITE_AIRPLANE||!SpriteUtils.checkSpriteCollision(this,a)||(a.explodeSprite(t),e=!0))}e&&this.explodeSprite(t)}this.x+=this.xDelta[a],this.y+=this.yDelta[a],this.spriteNotInBounds()&&(this.frame=0)}explodeSprite(e){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),e.sendMessage(Messages.PLANE_CRASHED)}}class TornadoSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_TORNADO,e,t,i,s),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-40,this.frame=1,this.count=200,this.xDelta=[2,3,2,0,-2,-3],this.yDelta=[-2,0,2,3,2,0]}move(e,t,i,s){let a;a=this.frame,2===a?a=this.flag?3:1:(this.flag=1===a?1:0,a=2),this.count>0&&this.count--,this.frame=a;let o=this.spriteManager.getSpriteList();for(let e=0;e<o.length;e++){let i=o[e];0===i.frame||i.type!==Micro.SPRITE_AIRPLANE&&i.type!==Micro.SPRITE_HELICOPTER&&i.type!==Micro.SPRITE_SHIP&&i.type!==Micro.SPRITE_TRAIN||!SpriteUtils.checkSpriteCollision(this,i)||i.explodeSprite(t)}a=Random.getRandom(5),this.x+=this.xDelta[a],this.y+=this.yDelta[a],this.spriteNotInBounds()&&(this.frame=0),0!==this.count&&0===Random.getRandom(500)&&(this.frame=0),SpriteUtils.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y)}}class ExplosionSprite extends BaseSprite{constructor(e,t,i,s){super(),this.init(Micro.SPRITE_EXPLOSION,e,t,i,s),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,this.frame=1}startFire(e,t){if(e=ZoneUtils.pixToWorld(e),t=ZoneUtils.pixToWorld(t),!this.map.testBounds(e,t))return;let i=this.map.getTile(e,t),s=i.getValue();(i.isCombustible()||s===Tile.DIRT)&&(i.isZone()||this.map.setTo(e,t,ZoneUtils.randomFire()))}move(e,t,i,s){if(0==(1&e)){if(1===this.frame){let e=ZoneUtils.pixToWorld(this.x),i=ZoneUtils.pixToWorld(this.y);t.sendMessage(Messages.SOUND_EXPLOSIONHIGH),t.sendMessage(Messages.EXPLOSION_REPORTED,{x:e,y:i})}this.frame++}this.frame>6&&(this.frame=0,this.startFire(this.x,this.y),this.startFire(this.x-16,this.y-16),this.startFire(this.x+16,this.y+16),this.startFire(this.x-16,this.y+16),this.startFire(this.x+16,this.y+16))}}const constructors={};constructors[Micro.SPRITE_TRAIN]=TrainSprite,constructors[Micro.SPRITE_SHIP]=BoatSprite,constructors[Micro.SPRITE_MONSTER]=MonsterSprite,constructors[Micro.SPRITE_HELICOPTER]=CopterSprite,constructors[Micro.SPRITE_AIRPLANE]=AirplaneSprite,constructors[Micro.SPRITE_TORNADO]=TornadoSprite,constructors[Micro.SPRITE_EXPLOSION]=ExplosionSprite;class SpriteManager{constructor(e){this.spriteList=[],this.map=e,this.spriteCycle=0}getSprite(e){let t=this.spriteList.filter((function(t){return 0!==t.frame&&t.type===e}));return 0===t.length?null:t[0]}getSpriteList(){return this.spriteList.slice()}getSpritesInView(e,t,i,s){return e=SpriteUtils.worldToPix(e),t=SpriteUtils.worldToPix(t),i=SpriteUtils.worldToPix(i),s=SpriteUtils.worldToPix(s),this.spriteList.filter((function(a){return a.x+a.xOffset>=e&&a.y+a.yOffset>=t&&!(a.x+a.xOffset>=i&&a.y+a.yOffset>=s)}))}moveObjects(e){e||(e=Micro.simData);let t=e.messageManager,i=e.disasterManager,s=e.blockMaps;this.spriteCycle+=1;let a=this.spriteList.slice(),o=a.length;for(;o--;){let e=a[o];0!==e.frame&&e.move(this.spriteCycle,t,i,s)}this.pruneDeadSprites()}makeSprite(e,t,i){this.spriteList.push(new constructors[e](this.map,this,t,i))}makeTornado(e){let t=this.getSprite(Micro.SPRITE_TORNADO);if(null!==t)return void(t.count=200);let i=math.getRandom(SpriteUtils.worldToPix(this.map.width)-800)+400,s=math.getRandom(SpriteUtils.worldToPix(this.map.height)-200)+100;this.makeSprite(Micro.SPRITE_TORNADO,i,s),e.sendMessage(Messages.TORNADO_SIGHTED,{x:SpriteUtils.pixToWorld(i),y:SpriteUtils.pixToWorld(s)})}makeExplosion(e,t){this.map.testBounds(e,t)&&this.makeExplosionAt(SpriteUtils.worldToPix(e),SpriteUtils.worldToPix(t))}makeExplosionAt(e,t){this.makeSprite(Micro.SPRITE_EXPLOSION,e,t)}generatePlane(e,t){null===this.getSprite(Micro.SPRITE_AIRPLANE)&&this.makeSprite(Micro.SPRITE_AIRPLANE,SpriteUtils.worldToPix(e),SpriteUtils.worldToPix(t))}generateTrain(e,t,i){e.totalPop>20&&null===this.getSprite(Micro.SPRITE_TRAIN)&&0===math.getRandom(25)&&this.makeSprite(Micro.SPRITE_TRAIN,SpriteUtils.worldToPix(t)+8,SpriteUtils.worldToPix(i)+8)}generateShip(){let e,t;if(math.getChance(3))for(e=4;e<this.map.width-2;e++)if(this.map.getTileValue(e,0)===Tile.CHANNEL)return void this.makeShipHere(e,0);if(math.getChance(3))for(t=1;t<this.map.height-2;t++)if(this.map.getTileValue(0,t)===Tile.CHANNEL)return void this.makeShipHere(0,t);if(math.getChance(3))for(e=4;e<this.map.width-2;e++)if(this.map.getTileValue(e,this.map.height-1)===Tile.CHANNEL)return void this.makeShipHere(e,this.map.height-1);if(math.getChance(3))for(t=1;t<this.map.height-2;t++)if(this.map.getTileValue(this.map.width-1,t)===Tile.CHANNEL)return void this.makeShipHere(this.map.width-1,t)}getBoatDistance(e,t){let i,s=99999,a=SpriteUtils.worldToPix(e)+8,o=SpriteUtils.worldToPix(t)+8;for(let e=0,t=this.spriteList.length;e<t;e++)if(i=this.spriteList[e],i.type===Micro.SPRITE_SHIP&&0!==i.frame){let e=Math.abs(i.x-a)+Math.abs(i.y-o);s=Math.min(s,e)}return s}makeShipHere(e,t){this.makeSprite(Micro.SPRITE_SHIP,SpriteUtils.worldToPix(e),SpriteUtils.worldToPix(t))}generateCopter(e,t){null===this.getSprite(Micro.SPRITE_HELICOPTER)&&this.makeSprite(Micro.SPRITE_HELICOPTER,SpriteUtils.worldToPix(e),SpriteUtils.worldToPix(t))}makeMonsterAt(e,t,i){this.makeSprite(Micro.SPRITE_MONSTER,SpriteUtils.worldToPix(t),SpriteUtils.worldToPix(i)),e.sendMessage(Messages.MONSTER_SIGHTED,{x:t,y:i})}makeMonster(e){let t=this.getSprite(Micro.SPRITE_MONSTER);null!==t&&(t.soundCount=1,t.count=1e3,t.destX=SpriteUtils.worldToPix(this.map.pollutionMaxX),t.destY=SpriteUtils.worldToPix(this.map.pollutionMaxY));let i=0;for(let t=0;t<300;t++){let t=math.getRandom(this.map.width-20)+10,s=math.getRandom(this.map.height-10)+5;if(this.map.getTile(t,s).getValue()===Tile.RIVER){this.makeMonsterAt(e,t,s),i=1;break}}0===i&&this.makeMonsterAt(e,60,50)}pruneDeadSprites(e){this.spriteList=this.spriteList.filter((function(e){return 0!==e.frame}))}}class EvaluationUtils{static getTrafficAverage(e,t){for(var i=e.trafficDensityMap,s=e.landValueMap,a=0,o=1,l=0;l<s.gameMapWidth;l+=s.blockSize)for(var r=0;r<s.gameMapHeight;r+=s.blockSize)s.worldGet(l,r)>0&&(a+=i.worldGet(l,r),o++);return 2.4*Math.floor(a/o)}static getUnemployment(e){var t=8*(e.comPop+e.indPop);if(0===t)return 0;var i=e.resPop/t;return t=Math.round(255*(i-1)),Math.min(t,255)}static getFireSeverity(e){return Math.min(5*e.firePop,255)}}class Evaluation{constructor(e){this.problemVotes=[],this.problemOrder=[],this.evalInit(),this.gameLevel=""+e,this.changed=!1}save(e){for(var t=0,i=Micro.EvalProps.length;t<i;t++)e[Micro.EvalProps[t]]=this[Micro.EvalProps[t]]}load(e){for(var t=0,i=Micro.EvalProps.length;t<i;t++)this[Micro.EvalProps[t]]=e[Micro.EvalProps[t]]}cityEvaluation(e){e||(e=Micro.simData);var t=e.census;if(t.totalPop>0){Micro.problemData=[];for(var i=0;i<Micro.NUMPROBLEMS;i++)Micro.problemData.push(0);this.getAssessedValue(t),this.getPopulation(t),this.doProblems(e.census,e.budget,e.blockMaps),this.getScore(e),this.doVotes(),this.changeEval()}else this.evalInit(),this.cityYes=50,this.changeEval()}evalInit(){let e;for(this.cityYes=0,this.cityPop=0,this.cityPopDelta=0,this.cityAssessedValue=0,this.cityClass=Micro.CC_VILLAGE,this.cityClassLast=Micro.CC_VILLAGE,this.cityScore=500,this.cityScoreDelta=0,e=0;e<Micro.NUMPROBLEMS;e++)this.problemVotes[e]={index:e,voteCount:0};for(e=0;e<Micro.NUM_COMPLAINTS;e++)this.problemOrder[e]=Micro.NUMPROBLEMS}getAssessedValue(e){var t;t=5*e.roadTotal,t+=10*e.railTotal,t+=1e3*e.policeStationPop,t+=1e3*e.fireStationPop,t+=400*e.hospitalPop,t+=3e3*e.stadiumPop,t+=5e3*e.seaportPop,t+=1e4*e.airportPop,t+=3e3*e.coalPowerPop,t+=6e3*e.nuclearPowerPop,this.cityAssessedValue=1e3*t}getPopulation(e){let t=this.cityPop;return this.cityPop=20*(e.resPop+8*(e.comPop+e.indPop)),this.cityPopDelta=this.cityPop-t,0!==this.cityPopDelta&&EventEmitter.emitEvent(Messages.POPULATION_UPDATED,this.cityPop),this.cityPop}getCityClass(e){return this.cityClass=Micro.CC_VILLAGE,e>2e3&&(this.cityClass=Micro.CC_TOWN),e>1e4&&(this.cityClass=Micro.CC_CITY),e>5e4&&(this.cityClass=Micro.CC_CAPITAL),e>1e5&&(this.cityClass=Micro.CC_METROPOLIS),e>5e5&&(this.cityClass=Micro.CC_MEGALOPOLIS),this.cityClass!==this.cityClassLast&&(this.cityClassLast=this.cityClass,EventEmitter.emitEvent(Messages.CLASSIFICATION_UPDATED,this.cityClass)),this.cityClass}voteProblems(){for(var e=0;e<Micro.NUMPROBLEMS;e++)this.problemVotes[e].index=e,this.problemVotes[e].voteCount=0;for(var t=0,i=0,s=0;i<100&&s<600;){var a=math.getRandom(300);Micro.problemData[t]>a&&(this.problemVotes[t].voteCount+=1,i++),t=(t+1)%Micro.NUMPROBLEMS,s++}}doProblems(e,t,i){Micro.problemData[Micro.CRIME]=e.crimeAverage,Micro.problemData[Micro.POLLUTION]=e.pollutionAverage,Micro.problemData[Micro.HOUSING]=7*e.landValueAverage/10,Micro.problemData[Micro.TAXES]=10*t.cityTax,Micro.problemData[Micro.TRAFFIC]=EvaluationUtils.getTrafficAverage(i,e),Micro.problemData[Micro.UNEMPLOYMENT]=EvaluationUtils.getUnemployment(e),Micro.problemData[Micro.FIRE]=EvaluationUtils.getFireSeverity(e),this.voteProblems(),this.problemVotes.sort((function(e,t){return t.voteCount-e.voteCount})),this.problemOrder=this.problemVotes.map((function(e,t){return t>=Micro.NUM_COMPLAINTS||0===e.voteCount?null:e.index}))}getScore(e){var t,i=e.census,s=e.budget,a=e.valves;t=this.cityScore;for(var o=0,l=0;l<Micro.NUMPROBLEMS;l++)o+=Micro.problemData[l];o=Math.floor(o/3),o=4*(250-Math.min(o,250));let r=.85;a.resCap&&(o=Math.round(o*r)),a.comCap&&(o=Math.round(o*r)),a.indCap&&(o=Math.round(o*r)),s.roadEffect<s.MAX_ROAD_EFFECT&&(o-=s.MAX_ROAD_EFFECT-s.roadEffect),s.policeEffect<s.MAX_POLICE_STATION_EFFECT&&(o=Math.round(o*(.9+s.policeEffect/(10*s.MAX_POLICE_STATION_EFFECT)))),s.fireEffect<s.MAX_FIRE_STATION_EFFECT&&(o=Math.round(o*(.9+s.fireEffect/(10*s.MAX_FIRE_STATION_EFFECT)))),a.resValve<-1e3&&(o=Math.round(.85*o)),a.comValve<-1e3&&(o=Math.round(.85*o)),a.indValve<-1e3&&(o=Math.round(.85*o));var n=1;0===this.cityPop||0===this.cityPopDelta||this.cityPopDelta===this.cityPop?n=1:this.cityPopDelta>0?n=this.cityPopDelta/this.cityPop+1:this.cityPopDelta<0&&(n=.95+Math.floor(this.cityPopDelta/(this.cityPop-this.cityPopDelta))),o=(o=Math.round(o*n))-EvaluationUtils.getFireSeverity(i)-s.cityTax,(n=i.unpoweredZoneCount+i.poweredZoneCount)>0&&(o=Math.round(o*(i.poweredZoneCount/n))),o=math.clamp(o,0,1e3),this.cityScore=Math.round((this.cityScore+o)/2),this.cityScoreDelta=this.cityScore-t,0!==this.cityScoreDelta&&EventEmitter.emitEvent(Messages.SCORE_UPDATED,this.cityScore)}doVotes(){this.cityYes=0;for(let e=0;e<100;e++){let e=math.getRandom(1e3);this.cityScore>e&&this.cityYes++}}changeEval(){this.changed=!0}countProblems(){var e;for(e=0;e<Micro.NUM_COMPLAINTS&&this.problemOrder[e]!==Micro.NUMPROBLEMS;e++);return e}getProblemNumber(e){return e<0||e>=Micro.NUM_COMPLAINTS||this.problemOrder[e]===Micro.NUMPROBLEMS?-1:this.problemOrder[e]}getProblemVotes(e){return e<0||e>=Micro.NUM_COMPLAINTS||this.problemOrder[e]==Micro.NUMPROBLEMS?-1:this.problemVotes[this.problemOrder[e]].voteCount}}class Valves{constructor(){this.resValve=0,this.comValve=0,this.indValve=0,this.resCap=!1,this.comCap=!1,this.indCap=!1}save(e){e.resValve=this.resValve,e.comValve=this.comValve,e.indValve=this.indValve}load(e){this.resValve=e.resValve,this.comValve=e.comValve,this.indValve=e.indValve,EventEmitter.emitEvent(Messages.VALVES_UPDATED,{residential:this.resValve,commercial:this.comValve,industrial:this.indValve})}setValves(e,t,i){var s,a=t.resPop/8;t.totalPop=Math.round(a+t.comPop+t.indPop);var o=a+a*((t.resPop>0?(t.comHist10[1]+t.indHist10[1])/a:1)-1)+.02*a;s=(s=t.comHist10[1]+t.indHist10[1])>0?t.resHist10[1]/s:1,s=math.clamp(s,0,1.3);var l,r,n,h=(a+t.comPop+t.indPop)/3.7*s,T=t.indPop*s*Micro.extMarketParamTable[e];T=Math.max(T,5),l=a>0?o/a:1.3,r=t.comPop>0?h/t.comPop:h,n=t.indPop>0?T/t.indPop:T,l=Math.min(l,2),r=Math.min(r,2),n=Math.min(n,2);var c=Math.min(i.cityTax+e,20);l=600*(l-1)+Micro.taxTable[c],r=600*(r-1)+Micro.taxTable[c],n=600*(n-1)+Micro.taxTable[c],this.resValve=math.clamp(this.resValve+Math.round(l),-Micro.RES_VALVE_RANGE,Micro.RES_VALVE_RANGE),this.comValve=math.clamp(this.comValve+Math.round(r),-Micro.COM_VALVE_RANGE,Micro.COM_VALVE_RANGE),this.indValve=math.clamp(this.indValve+Math.round(n),-Micro.IND_VALVE_RANGE,Micro.IND_VALVE_RANGE),this.resCap&&this.resValve>0&&(this.resValve=0),this.comCap&&this.comValve>0&&(this.comValve=0),this.indCap&&this.indValve>0&&(this.indValve=0),EventEmitter.emitEvent(Messages.VALVES_UPDATED,{residential:this.resValve,commercial:this.comValve,industrial:this.indValve})}}class Budget{constructor(){this.roadEffect=Micro.MAX_ROAD_EFFECT,this.policeEffect=Micro.MAX_POLICESTATION_EFFECT,this.fireEffect=Micro.MAX_FIRESTATION_EFFECT,this.totalFunds=0,this.cityTax=7,this.cashFlow=0,this.taxFund=0,this.roadMaintenanceBudget=0,this.fireMaintenanceBudget=0,this.policeMaintenanceBudget=0,this.roadPercent=1,this.firePercent=1,this.policePercent=1,this.roadSpend=0,this.fireSpend=0,this.policeSpend=0,this.awaitingValues=!1,this.autoBudget=!0}save(e){for(var t=0,i=Micro.BudgetProps.length;t<i;t++)e[Micro.BudgetProps[t]]=this[Micro.BudgetProps[t]]}load(e){for(var t=0,i=Micro.BudgetProps.length;t<i;t++)this[Micro.BudgetProps[t]]=e[Micro.BudgetProps[t]];EventEmitter.emitEvent(Messages.AUTOBUDGET_CHANGED,this.autoBudget),EventEmitter.emitEvent(Messages.FUNDS_CHANGED,this.totalFunds)}setAutoBudget(e){this.autoBudget=e,EventEmitter.emitEvent(Messages.AUTOBUDGET_CHANGED,this.autoBudget)}_calculateBestPercentages(){if(this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),0===this.roadSpend+this.fireSpend+this.policeSpend)return this.roadPercent=1,this.firePercent=1,this.policePercent=1,{road:1,fire:1,police:1};var e=0,t=0,i=0,s=this.totalFunds+this.taxFund;return s-=e=s>=this.roadSpend?this.roadSpend:s,s-=t=s>=this.fireSpend?this.fireSpend:s,s-=i=s>=this.policeSpend?this.policeSpend:s,this.roadMaintenanceBudget>0?this.roadPercent=(e/this.roadMaintenanceBudget).toPrecision(2)-0:this.roadPercent=1,this.fireMaintenanceBudget>0?this.firePercent=(t/this.fireMaintenanceBudget).toPrecision(2)-0:this.firePercent=1,this.policeMaintenanceBudget>0?this.policePercent=(i/this.policeMaintenanceBudget).toPrecision(2)-0:this.policePercent=1,{road:e,police:i,fire:t}}doBudgetWindow(){return this.doBudgetNow(!0)}doBudgetNow(e){var t=this._calculateBestPercentages();if(!this.autoBudget&&!e)return this.autoBudget=!1,this.awaitingValues=!0,void EventEmitter.emitEvent(Messages.BUDGET_NEEDED);var i=t.road,s=t.police,a=t.fire,o=i+s+a;if(this.totalFunds+this.taxFund-o>0&&this.autoBudget||e)return this.awaitingValues=!1,void this.doBudgetSpend(i,a,s);this.setAutoBudget(!1),this.awaitingValues=!0,EventEmitter.emitEvent(Messages.BUDGET_NEEDED),EventEmitter.emitEvent(Messages.NO_MONEY)}doBudgetSpend(e,t,i){this.roadSpend=e,this.fireSpend=t,this.policeSpend=i;var s=this.roadSpend+this.fireSpend+this.policeSpend;this.spend(-(this.taxFund-s)),this.updateFundEffects()}updateFundEffects(){this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadEffect=Micro.MAX_ROAD_EFFECT,this.policeEffect=Micro.MAX_POLICESTATION_EFFECT,this.fireEffect=Micro.MAX_FIRESTATION_EFFECT,this.roadMaintenanceBudget>0&&(this.roadEffect=Math.floor(this.roadEffect*this.roadSpend/this.roadMaintenanceBudget)),this.fireMaintenanceBudget>0&&(this.fireEffect=Math.floor(this.fireEffect*this.fireSpend/this.fireMaintenanceBudget)),this.policeMaintenanceBudget>0&&(this.policeEffect=Math.floor(this.policeEffect*this.policeSpend/this.policeMaintenanceBudget))}collectTax(e,t){this.cashFlow=0,this.policeMaintenanceBudget=t.policeStationPop*Micro.policeMaintenanceCost,this.fireMaintenanceBudget=t.fireStationPop*Micro.fireMaintenanceCost;var i=t.roadTotal*Micro.roadMaintenanceCost,s=t.railTotal*Micro.railMaintenanceCost;this.roadMaintenanceBudget=Math.floor((i+s)*Micro.RLevels[e]),this.taxFund=Math.floor(Math.floor(t.totalPop*t.landValueAverage/120)*this.cityTax*Micro.FLevels[e]),t.totalPop>0?(this.cashFlow=this.taxFund-(this.policeMaintenanceBudget+this.fireMaintenanceBudget+this.roadMaintenanceBudget),this.doBudgetNow(!1)):(this.roadEffect=Micro.MAX_ROAD_EFFECT,this.policeEffect=Micro.MAX_POLICESTATION_EFFECT,this.fireEffect=Micro.MAX_FIRESTATION_EFFECT)}setTax(e){e!==this.cityTax&&(this.cityTax=e)}setFunds(e){e!==this.totalFunds&&(this.totalFunds=Math.max(0,e),EventEmitter.emitEvent(Messages.FUNDS_CHANGED,this.totalFunds),0===this.totalFunds&&EventEmitter.emitEvent(Messages.NO_MONEY))}spend(e){this.setFunds(this.totalFunds-e)}shouldDegradeRoad(){return this.roadEffect<Math.floor(15*this.MAX_ROAD_EFFECT/16)}}class Census{constructor(){this.clearCensus(),this.changed=!1,this.crimeRamp=0,this.pollutionRamp=0,this.landValueAverage=0,this.pollutionAverage=0,this.crimeAverage=0,this.totalPop=0;var e=function(e){this[e]=[];for(var t=120;t--;)this[e][t]=0};let t=Micro.arrs.length;for(;t--;){var i=Micro.arrs[t]+"Hist10",s=Micro.arrs[t]+"Hist120";e.call(this,i),e.call(this,s)}}save(e){for(var t=0,i=Micro.CensusProps.length;t<i;t++)e[Micro.CensusProps[t]]=this[Micro.CensusProps[t]]}load(e){for(var t=0,i=Micro.CensusProps.length;t<i;t++)this[Micro.CensusProps[t]]=e[Micro.CensusProps[t]]}clearCensus(){this.poweredZoneCount=0,this.unpoweredZoneCount=0,this.firePop=0,this.roadTotal=0,this.railTotal=0,this.resPop=0,this.comPop=0,this.indPop=0,this.resZonePop=0,this.comZonePop=0,this.indZonePop=0,this.hospitalPop=0,this.churchPop=0,this.policeStationPop=0,this.fireStationPop=0,this.stadiumPop=0,this.coalPowerPop=0,this.nuclearPowerPop=0,this.seaportPop=0,this.airportPop=0}take10Census(e){MiscUtils.rotate10Arrays.call(this),this.resHist10[0]=Math.floor(this.resPop/8),this.comHist10[0]=this.comPop,this.indHist10[0]=this.indPop,this.crimeRamp+=Math.floor((this.crimeAverage-this.crimeRamp)/4),this.crimeHist10[0]=Math.min(this.crimeRamp,255),this.pollutionRamp+=Math.floor((this.pollutionAverage-this.pollutionRamp)/4),this.pollutionHist10[0]=Math.min(this.pollutionRamp,255);var t=Math.floor(e.cashFlow/20)+128;this.moneyHist10[0]=math.clamp(t,0,255),this.resPop,this.hospitalPop<this.resPopScaled?this.needHospital=1:this.hospitalPop>this.resPopScaled?this.needHospital=-1:this.hospitalPop===this.resPopScaled&&(this.needHospital=0),this.changed=!0}take120Census(){MiscUtils.rotate120Arrays.call(this);this.resHist120[0]=Math.floor(this.resPop/8),this.comHist120[0]=this.comPop,this.indHist120[0]=this.indPop,this.crimeHist120[0]=this.crimeHist10[0],this.pollutionHist120[0]=this.pollutionHist10[0],this.moneyHist120[0]=this.moneyHist10[0],this.changed=!0}}class BlockMap{constructor(e,t,i){if(void 0===e||void 0===t||void 0===i)throw new Error("Invalid dimensions for block map");this.isBlockMap=!0,this.blockSize=i,this.gameMapWidth=e,this.gameMapHeight=t,this.width=Math.floor((e+i-1)/i),this.height=Math.floor((t+i-1)/i),this.data=[],this.clear()}clear(){let e,t=this.height;for(;t--;)for(e=this.width;e--;)this.data[this.width*t+e]=0}copyFrom(e,t){e.width!==this.width||e.height!==this.height||(e.blockSize,this.blockSize);let i,s,a=e.height,o=e.width;for(s=0;s<a;s++)for(i=0;i<o;i++)this.data[o*s+i]=t(e.data[o*s+i])}get(e,t){return this.data[this.width*t+e]}set(e,t,i){this.data[this.width*t+e]=i}toBlock(e){return Math.floor(e/this.blockSize)}worldGet(e,t){return this.get(this.toBlock(e),this.toBlock(t))}worldSet(e,t,i){this.set(this.toBlock(e),this.toBlock(t),i)}}const Direction={INVALID:-1,NORTH:0,NORTHEAST:1,EAST:2,SOUTHEAST:3,SOUTH:4,SOUTHWEST:5,WEST:6,NORTHWEST:7,BEGIN:0,END:8,increment45:function(e,t){if(arguments.length<1)throw new TypeError;return e==Direction.INVALID?e:(t||0===t||(t=1),e+t)},increment90:function(e){if(arguments.length<1)throw new TypeError;return Direction.increment45(e,2)},rotate45:function(e,t){if(arguments.length<1)throw new TypeError;return e==Direction.INVALID?e:(t||0===t||(t=1),(e-Direction.NORTH+t&7)+Direction.NORTH)},rotate90:function(e){if(arguments.length<1)throw new TypeError;return Direction.rotate45(e,2)},rotate180:function(e){if(arguments.length<1)throw new TypeError;return Direction.rotate45(e,4)}};class Position{constructor(e,t,i){if(this.isPosition=!0,this.width=Micro.MAP_WIDTH,this.height=Micro.MAP_HEIGHT,this.x=0,this.y=0,this.validDirs=[Direction.NORTH,Direction.NORTHEAST,Direction.EAST,Direction.SOUTHEAST,Direction.SOUTH,Direction.SOUTHWEST,Direction.WEST,Direction.NORTHWEST,Direction.INVALID],0===arguments.length)return this;if(1===arguments.length&&!e.isPosition)throw new Error("Position constructor called with invalid pos "+e);if(3===arguments.length&&!e.isPosition)throw new Error("Position constructor called with invalid pos "+e);if(!(3!==arguments.length||this.isNumber(t)&&this.isNumber(i)))throw new Error("Position constructor called with invalid deltas "+t+" "+i);if(2===arguments.length&&this.isNumber(e)&&!this.isNumber(t))throw new Error("Position constructor called with invalid y coordinate "+e+" "+t);if(2===arguments.length&&e.isPosition&&(!this.isNumber(t)||!this.isDirection(t)))throw new Error("Position constructor called with invalid direction "+e+" "+t);if(2===arguments.length&&!this.isNumber(e)&&!e.isPosition)throw new Error("Position constructor called with bad existing position "+e+" "+t);let s=!0;if(this.isNumber(e)?(this.x=e,this.y=t):(this.set(e),2===arguments.length?s=this.move(t):3===arguments.length&&(this.x+=t,this.y+=i)),this.x<0||this.x>=this.width||this.y<0||this.y>=this.height||!s)throw new Error("Invalid parameter")}isNumber(e){return!isNaN(e)}isDirection(e){return this.isNumber(e)&&-1!==this.validDirs.indexOf(e)}set(e){this.x=e.x,this.y=e.y}toString(){return"("+this.x+", "+this.y+")"}toInt(){return this.y*this.width+this.x}move(e){let t=!1;switch(e){case Direction.INVALID:return!0;case Direction.NORTH:this.y>0&&(this.y--,t=!0);break;case Direction.NORTHEAST:this.y>0&&this.x<this.width-1&&(this.y--,this.x++,t=!0);break;case Direction.EAST:this.x<this.width-1&&(this.x++,t=!0);break;case Direction.SOUTHEAST:this.y<this.height-1&&this.x<this.width-1&&(this.x++,this.y++,t=!0);break;case Direction.SOUTH:this.y<this.height-1&&(this.y++,t=!0);break;case Direction.SOUTHWEST:this.y<this.height-1&&this.x>0&&(this.y++,this.x--,t=!0);break;case Direction.WEST:this.x>0&&(this.x--,t=!0);break;case Direction.NORTHWEST:this.y>0&&this.x>0&&(this.y--,this.x--,t=!0);break}return t}}class PowerManager{constructor(e){this._map=e,this._powerStack=[],this.powerGridMap=new BlockMap(this._map.width,this._map.height,1,0)}setTilePower(e,t){var i=this._map.getTile(e,t),s=i.getValue();s===Tile.NUCLEAR||s===Tile.POWERPLANT||this.powerGridMap.worldGet(e,t)>0?i.addFlags(Tile.POWERBIT):i.removeFlags(Tile.POWERBIT)}clearPowerStack(){this._powerStackPointer=0,this._powerStack=[]}testForConductive(e,t){var i=new Position(e);return!(!i.move(t)||!this._map.getTile(i.x,i.y).isConductive()||0!==this.powerGridMap.worldGet(i.x,i.y))}doPowerScan(e){this.powerGridMap.clear();let t=e.coalPowerPop*Micro.COAL_POWER_STRENGTH+e.nuclearPowerPop*Micro.NUCLEAR_POWER_STRENGTH,i=0;for(;this._powerStack.length>0;){var s,a=this._powerStack.pop(),o=Direction.INVALID;do{if(i++,i>t)return void EventEmitter.emitEvent(Messages.NOT_ENOUGH_POWER);o!==Direction.INVALID&&a.move(o),this.powerGridMap.worldSet(a.x,a.y,1),s=0;for(var l=Direction.BEGIN;l<Direction.END&&s<2;)this.testForConductive(a,l)&&(s++,o=l),l=Direction.increment90(l);s>1&&this._powerStack.push(new Position(a))}while(s)}}coalPowerFound(e,t,i,s){s||(s=Micro.simData),s.census.coalPowerPop+=1,this._powerStack.push(new Position(t,i));var a=[-1,2,1,2],o=[-1,-1,0,0];if(!s.is3D)for(var l=0;l<4;l++)e.addTileFlags(t+a[l],i+o[l],Tile.ANIMBIT)}nuclearPowerFound(e,t,i,s){s||(s=Micro.simData);if(!(s.disasterManager.disastersEnabled&&0===math.getRandom([3e4,2e4,1e4][s.gameLevel])||(s.census.nuclearPowerPop+=1,this._powerStack.push(new Position(t,i)),s.is3D)))for(var a=0;a<4;a++)e.addTileFlags(t,i,Tile.ANIMBIT|Tile.CONDBIT|Tile.POWERBIT|Tile.BURNBIT)}registerHandlers(e,t){e.addAction(Tile.POWERPLANT,this.coalPowerFound.bind(this)),e.addAction(Tile.NUCLEAR,this.nuclearPowerFound.bind(this)),t.addAction(Tile.POWERPLANT,7,4),t.addAction(Tile.NUCLEAR,7,4)}}class MapScanner{constructor(e){this._map=e,this._actions=[]}addAction(e,t){this._actions.push({criterion:e,action:t})}mapScan(e,t,i){i||(i=Micro.simData);let s,a,o,l,r,n,h,T=this._map.height;for(;T--;)for(s=e;s<t;s++)if(o=this._map.getId(s,T),l=this._map.data[o]||new Tiles,r=l.getValue(),!(r<Tile.FLOOD))for(l.isConductive()&&i.powerManager.setTilePower(s,T),l.isZone()&&(i.repairManager.checkTile(s,T,i.cityTime),l.isPowered()?(i.census.poweredZoneCount+=1,this._map.powered({v:1,id:o})):(i.census.unpoweredZoneCount+=1,this._map.powered({v:2,id:o}))),a=this._actions.length;a--;){if(n=this._actions[a],h=MiscUtils.isCallable(n.criterion),h&&n.criterion.call(null,l)){n.action.call(null,this._map,s,T,i);break}if(!h&&n.criterion===r){n.action.call(null,this._map,s,T,i);break}}}}class RepairManager{constructor(e){this._map=e,this._actions=[]}addAction(e,t,i){this._actions.push({criterion:e,period:t,zoneSize:i})}repairZone(e,t,i){let s,a,o,l,r=this._map.getTileValue(e,t)-i-2;for(a=-1;a<i-1;a++)for(s=-1;s<i-1;s++)r++,o=this._map.getTile(e+s,t+a),o.isZone()||o.isAnimated()||(l=o.getValue(),(l<Tile.RUBBLE||l>=Tile.ROADBASE)&&this._map.setTile(e+s,t+a,r,Tile.CONDBIT|Tile.BURNBIT))}checkTile(e,t,i){let s,a,o,l,r,n=this._actions.length;for(;n--;)s=this._actions[n],a=s.period,0==(i&a)&&(o=this._map.getTile(e,t),l=o.getValue(),r=MiscUtils.isCallable(s.criterion),r&&s.criterion.call(null,o)?this.repairZone(e,t,s.zoneSize):r||s.criterion!==l||this.repairZone(e,t,s.zoneSize))}}class Traffic{constructor(e,t){this._map=e,this._stack=[],this._spriteManager=t}makeTraffic(e,t,i,s){this._stack=[];let a=new Position(e,t);return this.findPerimeterRoad(a)?this.tryDrive(a,s)?(this.addToTrafficDensityMap(i),Micro.ROUTE_FOUND):Micro.NO_ROUTE_FOUND:Micro.NO_ROAD_FOUND}addToTrafficDensityMap(e){let t=e.trafficDensityMap;for(;this._stack.length>0;){let e=this._stack.pop();if(!this._map.testBounds(e.x,e.y))continue;let i=this._map.getTileValue(e.x,e.y);if(i>=Tile.ROADBASE&&i<Tile.POWERBASE){let i=t.worldGet(e.x,e.y);if(i+=50,i=Math.min(i,240),t.worldSet(e.x,e.y,i),i>=240&&0===math.getRandom(5)){let t=this._spriteManager.getSprite(Micro.SPRITE_HELICOPTER);null!==t&&(t.destX=ZoneUtils.worldToPix(e.x),t.destY=ZoneUtils.worldToPix(e.y))}}}}findPerimeterRoad(e){for(let t=0;t<12;t++){let i=e.x+Micro.perimX[t],s=e.y+Micro.perimY[t];if(this._map.testBounds(i,s)&&ZoneUtils.isDriveable(this._map.getTileValue(i,s)))return e.x=i,e.y=s,!0}return!1}tryDrive(e,t){let i=Direction.INVALID,s=new Position(e);for(let e=0;e<Micro.MAX_TRAFFIC_DISTANCE;e++){let a=this.tryGo(s,i);if(a!=Direction.INVALID){if(s.move(a),i=Direction.rotate180(a),1&e&&this._stack.push(new Position(s)),this.driveDone(s,t))return!0}else{if(!(this._stack.length>0))return!1;this._stack.pop(),e+=3}}return!1}tryGo(e,t){let i,s=[],a=Direction.NORTH,o=0;for(i=0;i<4;i++)a!=t&&ZoneUtils.isDriveable(this._map.getTileFromMapOrDefault(e,a,Tile.DIRT))?(s[i]=a,o++):s[i]=Direction.INVALID,a=Direction.rotate90(a);if(0===o)return Direction.INVALID;if(1===o)for(i=0;i<4;i++)if(s[i]!=Direction.INVALID)return s[i];for(i=3&math.getRandom16();s[i]===Direction.INVALID;)i=i+1&3;return s[i]}driveDone(e,t){return!!(e.y>0&&t(this._map.getTileValue(e.x,e.y-1)))||(!!(e.x<this._map.width-1&&t(this._map.getTileValue(e.x+1,e.y)))||(!!(e.y<this._map.height-1&&t(this._map.getTileValue(e.x,e.y+1)))||!!(e.x>0&&t(this._map.getTileValue(e.x-1,e.y)))))}}const vulnerable=function(e){let t=e.getValue();return!(t<Tile.RESBASE||t>Tile.LASTZONE||e.isZone())};class DisasterManager{constructor(e,t,i){this._map=e,this._spriteManager=t,this._gameLevel=i,this._floodCount=0,this.disastersEnabled=!1,this.Dx=[0,1,0,-1],this.Dy=[-1,0,1,0]}doDisasters(e){if(this._floodCount&&this._floodCount--,this.disastersEnabled&&math.getRandom(Micro.DisChance[this._gameLevel]))switch(math.getRandom(8)){case 0:case 1:this.setFire();break;case 2:case 3:this.makeFlood();break;case 4:break;case 5:this._spriteManager.makeTornado();break;case 6:break;case 7:case 8:e.pollutionAverage>60&&this._spriteManager.makeMonster();break}}setDifficulty(e){this._gameLevel=e}scenarioDisaster(){}makeMeltdown(){for(let e=0;e<this._map.width-1;e++)for(let t=0;t<this._map.height-1;t++)if(this._map.getTileValue(e,t)===Tile.NUCLEAR)return void this.doMeltdown(e,t)}makeEarthquake(){let e,t,i,s=math.getRandom(700)+300;for(this.doEarthquake(s),EventEmitter.emitEvent(Messages.EARTHQUAKE,{x:this._map.cityCenterX,y:this._map.cityCenterY}),e=0;e<s;e++)t=math.getRandom(this._map.width-1),i=math.getRandom(this._map.height-1),vulnerable(this._map.getTile(t,i))&&(0!=(3&e)?this._map.setTo(t,i,ZoneUtils.randomRubble()):this._map.setTo(t,i,ZoneUtils.randomFire()))}setFire(e=1,t=!1){let i,s,a,o,l;for(i=0;i<e;i++)if(s=math.getRandom(this._map.width-1),a=math.getRandom(this._map.height-1),this._map.testBounds(s,a)&&(o=this._map.getTile(s,a),!o.isZone()&&(o=o.getValue(),l=t?Tile.LHTHR:Tile.TREEBASE,o>l&&o<Tile.LASTZONE)))return this._map.setTo(s,a,ZoneUtils.randomFire()),void EventEmitter.emitEvent(Messages.FIRE_REPORTED,{showable:!0,x:s,y:a})}makeCrash(){let e=this._spriteManager.getSprite(Micro.SPRITE_AIRPLANE);if(null!==e)return void e.explodeSprite();let t=math.getRandom(this._map.width-1),i=math.getRandom(this._map.height-1);this._spriteManager.generatePlane(t,i),e=this._spriteManager.getSprite(Micro.SPRITE_AIRPLANE),e.explodeSprite()}makeFire(){this.setFire(40,!1)}makeFlood(){let e,t,i,s,a,o,l,r;for(e=0;e<300;e++)if(t=math.getRandom(this._map.width-1),i=math.getRandom(this._map.height-1),this._map.testBounds(t,i)&&(s=this._map.getTileValue(t,i),s>Tile.CHANNEL&&s<=Tile.WATER_HIGH))for(a=0;a<4;a++)if(o=t+this.Dx[a],l=i+this.Dy[a],this._map.testBounds(o,l)&&(r=this._map.getTile(o,l),s=r.getValue(),r===Tile.DIRT||r.isBulldozable()&&r.isCombustible))return this._map.setTo(o,l,new Tiles(Tile.FLOOD)),this._floodCount=30,void EventEmitter.emitEvent(Messages.FLOODING_REPORTED,{showable:!0,x:o,y:l})}doFlood(e,t,i){let s,a,o,l,r;if(this._floodCount>0)for(s=0;s<4;s++)math.getChance(7)&&(a=e+this.Dx[s],o=t+this.Dy[s],this._map.testBounds(a,o)&&(l=this._map.getTile(a,o),r=l.getValue(),(l.isCombustible()||r===Tile.DIRT||r>=Tile.WOODS5&&r<Tile.FLOOD)&&(l.isZone()&&ZoneUtils.fireZone(this.map,a,o,i),this._map.setTile(a,o,Tile.FLOOD+math.getRandom(2),0))));else math.getChance(15)&&this._map.setTile(e,t,Tile.DIRT,0)}doMeltdown(e,t){let i,s,a,o;for(this._spriteManager.makeExplosion(e-1,t-1),this._spriteManager.makeExplosion(e-1,t+2),this._spriteManager.makeExplosion(e+2,t-1),this._spriteManager.makeExplosion(e+2,t+2),a=e-1;a<e+3;a++)for(s=t-1;s<t+3;s++)this._map.setTo(a,s,ZoneUtils.randomFire());for(i=0;i<200;i++)a=e-20+math.getRandom(40),s=t-15+math.getRandom(30),this._map.testBounds(a,s)&&(o=this._map.getTile(a,s),o.isZone()||(o.isCombustible()||o.getValue()===Tile.DIRT)&&this._map.setTile(a,s,Tile.RADTILE,0));EventEmitter.emitEvent(Messages.NUCLEAR_MELTDOWN,{showable:!0,x:e,y:t})}}const freeZone=[0,3,6,1,4,7,2,5,8],Residential={registerHandlers:function(e,t){e.addAction(ZoneUtils.isResidentialZone,Residential.residentialFound),e.addAction(ZoneUtils.HOSPITAL,Residential.hospitalFound),t.addAction(Tile.HOSPITAL,15,3)},placeResidential:function(e,t,i,s,a,o){let l=9*(4*a+s)+Tile.RZB;ZoneUtils.putZone(e,t,i,l,o)},getFreeZonePopulation:function(e,t,i,s){let a,o,l=0;for(a=t-1;a<=t+1;a++)for(o=i-1;o<=i+1;o++)a===t&&o===i||(s=e.getTileValue(a,o))>=Tile.LHTHR&&s<=Tile.HHTHR&&(l+=1);return l},getZonePopulation:function(e,t,i,s){if(s===Tile.FREEZ)return Residential.getFreeZonePopulation(e,t,i,s);return 8*(Math.floor((s-Tile.RZB)/9)%4+1)+16},evalLot:function(e,t,i){let s=[0,1,0,-1],a=[-1,0,1,0];if(!e.testBounds(t,i))return-1;let o=e.getTileValue(t,i);if(o<Tile.RESBASE||o>Tile.RESBASE+8)return-1;let l,r,n,h=1;for(l=0;l<4;l++)r=t+s[l],n=i+a[l],r<0||r>=e.width||n<0||n>=e.height||(o=e.getTileValue(r,n),o!==Tile.DIRT&&o<=Tile.LASTROAD&&(h+=1));return h},buildHouse:function(e,t,i,s){let a,o,l,r,n=0,h=0,T=[0,-1,0,1,-1,1,-1,0,1],c=[0,-1,-1,-1,0,0,1,1,1];for(a=0;a<9;a++)o=t+T[a],l=i+c[a],r=Residential.evalLot(e,o,l),r>h?(h=r,n=a):r===h&&math.getChance(7)&&(n=a);n>0&&e.testBounds(t+T[n],i+c[n])&&e.setTile(t+T[n],i+c[n],Tile.HOUSE+math.getRandom(2)+3*s,Tile.BLBNCNBIT)},growZone:function(e,t,i,s,a,o,l){s.pollutionDensityMap.worldGet(t,i)>128||(e.getTileValue(t,i)!==Tile.FREEZ?a<40&&(Residential.placeResidential(e,t,i,Math.floor(a/8)-1,o,l),ZoneUtils.incRateOfGrowth(s,t,i,8)):a<8?(Residential.buildHouse(e,t,i,o),ZoneUtils.incRateOfGrowth(s,t,i,1)):s.populationDensityMap.worldGet(t,i)>64&&(Residential.placeResidential(e,t,i,0,o,l),ZoneUtils.incRateOfGrowth(s,t,i,8)))},degradeZone:function(e,t,i,s,a,o,l){let r,n;if(0===a)return;if(a>16)return Residential.placeResidential(e,t,i,Math.floor((a-24)/8),o,l),void ZoneUtils.incRateOfGrowth(s,t,i,-8);if(16===a){for(e.setTo(t,i,new Tiles(Tile.FREEZ,Tile.BLBNCNBIT|Tile.ZONEBIT)),n=i-1;n<=i+1;n++)for(r=t-1;r<=t+1;r++)r===t&&n===i||e.setTile(t,i,Tile.LHTHR+o+math.getRandom(2),Tile.BLBNCNBIT);return void ZoneUtils.incRateOfGrowth(s,t,i,-8)}let h=0;for(ZoneUtils.incRateOfGrowth(s,t,i,-1),r=t-1;r<=t+1;r++)for(n=i-1;n<=i+1;n++){let t=e.getTileValue(r,n);if(t>=Tile.LHTHR&&t<=Tile.HHTHR)return void e.setTile(r,n,freeZone[h]+Tile.RESBASE,Tile.BLBNCNBIT);h+=1}},evalResidential:function(e,t,i,s){if(s===Micro.NO_ROAD_FOUND)return-3e3;let a=e.landValueMap.worldGet(t,i);return a-=e.pollutionDensityMap.worldGet(t,i),a=a<0?0:Math.min(32*a,6e3),a-3e3},residentialFound:function(e,t,i,s){let a;s||(s=Micro.simData),s.census.resZonePop+=1;let o=e.getTileValue(t,i),l=Residential.getZonePopulation(e,t,i,o);s.census.resPop+=l;let r=e.getTile(t,i).isPowered(),n=Micro.ROUTE_FOUND;if(l>math.getRandom(35)&&(n=s.traffic.makeTraffic(t,i,s.blockMaps,ZoneUtils.isCommercial),n===Micro.NO_ROAD_FOUND))return a=ZoneUtils.getLandPollutionValue(s.blockMaps,t,i),void Residential.degradeZone(e,t,i,s.blockMaps,l,a,r);if(o===Tile.FREEZ||math.getChance(7)){let o=Residential.evalResidential(s.blockMaps,t,i,n),h=s.valves.resValve+o;if(r||(h=-500),h>-350&&h-26380>math.getRandom16Signed())return 0===l&&math.getChance(3)?void Residential.makeHospital(e,t,i,s,r):(a=ZoneUtils.getLandPollutionValue(s.blockMaps,t,i),void Residential.growZone(e,t,i,s.blockMaps,l,a,r));h<350&&h+26380<math.getRandom16Signed()&&(a=ZoneUtils.getLandPollutionValue(s.blockMaps,t,i),Residential.degradeZone(e,t,i,s.blockMaps,l,a,r))}},makeHospital:function(e,t,i,s,a){if(s||(s=Micro.simData),s.census.needHospital>0)return ZoneUtils.putZone(e,t,i,Tile.HOSPITAL,a),void(s.census.needHospital=0)},hospitalFound:function(e,t,i,s){s||(s=Micro.simData),s.census.hospitalPop+=1,-1===s.census.needHospital&&0===math.getRandom(20)&&ZoneUtils.putZone(e,t,i,Tile.FREEZ,e.getTile(t,i).isPowered())}},Commercial={registerHandlers:function(e,t){e.addAction(ZoneUtils.isCommercialZone,Commercial.commercialFound)},getZonePopulation:function(e,t,i,s){return s===Tile.COMCLR?0:Math.floor((s-Tile.CZB)/9)%5+1},placeCommercial:function(e,t,i,s,a,o){var l=9*(5*a+s)+Tile.CZB;ZoneUtils.putZone(e,t,i,l,o)},growZone:function(e,t,i,s,a,o,l){var r=s.landValueMap.worldGet(t,i);a>(r>>=5)||a<5&&(Commercial.placeCommercial(e,t,i,a,o,l),ZoneUtils.incRateOfGrowth(s,t,i,8))},degradeZone:function(e,t,i,s,a,o,l){a>1?Commercial.placeCommercial(e,t,i,a-2,o,l):ZoneUtils.putZone(e,t,i,Tile.COMCLR,l),ZoneUtils.incRateOfGrowth(s,t,i,-8)},commercialFound:function(e,t,i,s){var a;s||(s=Micro.simData),s.census.comZonePop+=1;var o=e.getTileValue(t,i),l=Commercial.getZonePopulation(e,t,i,o);s.census.comPop+=l;var r=e.getTile(t,i).isPowered(),n=Micro.ROUTE_FOUND;if(l>math.getRandom(5)&&(n=s.traffic.makeTraffic(t,i,s.blockMaps,ZoneUtils.isIndustrial))===Micro.NO_ROAD_FOUND)return a=ZoneUtils.getLandPollutionValue(s.blockMaps,t,i),void Commercial.degradeZone(e,t,i,s.blockMaps,l,a,r);if(math.getChance(7)){var h=n===Micro.NO_ROAD_FOUND?-3e3:s.blockMaps.cityCentreDistScoreMap.worldGet(t,i),T=s.valves.comValve+h;if(r||(T=-500),r&&T>-350&&T-26380>math.getRandom16Signed())return a=ZoneUtils.getLandPollutionValue(s.blockMaps,t,i),void Commercial.growZone(e,t,i,s.blockMaps,l,a,r);T<350&&T+26380<math.getRandom16Signed()&&(a=ZoneUtils.getLandPollutionValue(s.blockMaps,t,i),Commercial.degradeZone(e,t,i,s.blockMaps,l,a,r))}}},animated=[!0,!1,!0,!0,!1,!1,!0,!0],xDelta=[-1,0,1,0,0,0,0,1],yDelta=[-1,0,-1,-1,0,0,-1,-1],Industrial={registerHandlers:function(e,t){e.addAction(ZoneUtils.isIndustrialZone,Industrial.industrialFound)},getZonePopulation:function(e,t,i,s){return s===Tile.INDCLR?0:Math.floor((s-Tile.IZB)/9)%4+1},placeIndustrial:function(e,t,i,s,a,o){var l=9*(4*a+s)+Tile.IZB;ZoneUtils.putZone(e,t,i,l,o)},growZone:function(e,t,i,s,a,o,l){a<4&&(Industrial.placeIndustrial(e,t,i,a,o,l),ZoneUtils.incRateOfGrowth(s,t,i,8))},degradeZone:function(e,t,i,s,a,o,l){a>1?Industrial.placeIndustrial(e,t,i,a-2,o,l):ZoneUtils.putZone(e,t,i,Tile.INDCLR,l),ZoneUtils.incRateOfGrowth(s,t,i,-8)},setAnimation:function(e,t,i,s,a){if(!(s<Tile.IZB)){var o=s-Tile.IZB>>3;animated[o]&&a?e.addTileFlags(t+xDelta[o],i+yDelta[o],Tile.ASCBIT):(e.addTileFlags(t+xDelta[o],i+yDelta[o],Tile.BNCNBIT),e.removeTileFlags(t+xDelta[o],i+yDelta[o],Tile.ANIMBIT))}},industrialFound:function(e,t,i,s){s||(s=Micro.simData),s.census.indZonePop+=1;var a=e.getTileValue(t,i),o=Industrial.getZonePopulation(e,t,i,a);s.census.indPop+=o;var l=e.getTile(t,i).isPowered();s.is3D||Industrial.setAnimation(e,t,i,a,l);var r=Micro.ROUTE_FOUND;if(o>math.getRandom(5)&&(r=s.traffic.makeTraffic(t,i,s.blockMaps,ZoneUtils.isResidential))===Micro.NO_ROAD_FOUND){var n=1&math.getRandom16();Industrial.degradeZone(e,t,i,s.blockMaps,o,n,l)}else if(math.getChance(7)){var h=s.valves.indValve+(r===Micro.NO_ROAD_FOUND?-1e3:0);if(l||(h=-500),h>-350&&h-26380>math.getRandom16Signed())return void Industrial.growZone(e,t,i,s.blockMaps,o,1&math.getRandom16(),l);h<350&&h+26380<math.getRandom16Signed()&&Industrial.degradeZone(e,t,i,s.blockMaps,o,1&math.getRandom16(),l)}}},verticalDeltaX=[0,1,0,0,0,0,1],verticalDeltaY=[-2,-2,-1,0,1,2,2],horizontalDeltaX=[-2,2,-2,-1,0,1,2],horizontalDeltaY=[-1,-1,0,0,0,0,0],openVertical=[Tile.VBRDG0,Tile.VBRDG1,Tile.RIVER,Tile.BRWV,Tile.RIVER,Tile.VBRDG2,Tile.VBRDG3],closeVertical=[Tile.VBRIDGE,Tile.RIVER,Tile.VBRIDGE,Tile.VBRIDGE,Tile.VBRIDGE,Tile.VBRIDGE,Tile.RIVER],openHorizontal=[Tile.HBRDG1,Tile.HBRDG3,Tile.HBRDG0,Tile.RIVER,Tile.BRWH,Tile.RIVER,Tile.HBRDG2],closeHorizontal=[Tile.RIVER,Tile.RIVER,Tile.HBRIDGE,Tile.HBRIDGE,Tile.HBRIDGE,Tile.HBRIDGE,Tile.HBRIDGE],densityTable=[Tile.ROADBASE,Tile.LTRFBASE,Tile.HTRFBASE],Road={registerHandlers:function(e,t){e.addAction(ZoneUtils.isRoad,Road.roadFound)},openBridge:function(e,t,i,s,a,o,l){let r,n,h;for(r=0;r<7;r++)n=t+s[r],h=i+a[r],e.testBounds(n,h)&&e.getTileValue(n,h)===(o[r]&Tile.BIT_MASK)&&e.setTileValue(n,h,l[r])},closeBridge:function(e,t,i,s,a,o,l){let r,n,h,T;for(r=0;r<7;r++)n=t+s[r],h=i+a[r],e.testBounds(n,h)&&(T=e.getTileValue(n,h),T!==Tile.CHANNEL&&(15&T)!=(15&o[r])||e.setTileValue(n,h,l[r]))},doBridge:function(e,t,i,s,a){if(a||(a=Micro.simData),s===Tile.BRWV)return math.getChance(3)&&a.spriteManager.getBoatDistance(t,i)>340&&Road.closeBridge(e,t,i,verticalDeltaX,verticalDeltaY,openVertical,closeVertical),!0;if(s==Tile.BRWH)return math.getChance(3)&&a.spriteManager.getBoatDistance(t,i)>340&&Road.closeBridge(e,t,i,horizontalDeltaX,horizontalDeltaY,openHorizontal,closeHorizontal),!0;if(a.spriteManager.getBoatDistance(t,i)<300||math.getChance(7)){if(1&s)return t<e.width-1&&e.getTileValue(t+1,i)===Tile.CHANNEL&&(Road.openBridge(e,t,i,verticalDeltaX,verticalDeltaY,closeVertical,openVertical),!0);if(i>0&&e.getTileValue(t,i-1)===Tile.CHANNEL)return Road.openBridge(e,t,i,horizontalDeltaX,horizontalDeltaY,closeHorizontal,openHorizontal),!0}return!1},roadFound:function(e,t,i,s){s||(s=Micro.simData),s.census.roadTotal+=1;let a=e.getTile(t,i),o=a.getValue();if(s.budget.shouldDegradeRoad()&&math.getChance(511)&&!a.isConductive()&&s.budget.roadEffect<(31&math.getRandom16()))return void((15&o)<2||15==(15&o)?e.setTile(t,i,Tile.RIVER):e.setTo(t,i,ZoneUtils.randomRubble()));a.isCombustible()||(s.census.roadTotal+=4);let l=0;o<Tile.LTRFBASE?l=0:o<Tile.HTRFBASE?l=1:(s.census.roadTotal+=1,l=2);let r=s.blockMaps.trafficDensityMap.worldGet(t,i)>>6;if(r>1&&(r-=1),r===l)return;let n=(o-Tile.ROADBASE&15)+densityTable[r],h=a.getFlags()&~Tile.ANIMBIT;r>0&&(h|=Tile.ANIMBIT),e.setTo(t,i,new Tiles(n,h))}},Transport={registerHandlers:function(e,t){e.addAction(ZoneUtils.isRail,Transport.railFound),e.addAction(Tile.PORT,Transport.portFound),e.addAction(Tile.AIRPORT,Transport.airportFound),t.addAction(Tile.PORT,15,4),t.addAction(Tile.AIRPORT,7,6)},railFound:function(e,t,i,s){if(s||(s=Micro.simData),s.census.railTotal+=1,s.spriteManager.generateTrain(s.census,t,i),s.budget.shouldDegradeRoad()&&math.getChance(511)){let a=e.getTile(t,i);if(a.isConductive())return;if(s.budget.roadEffect<(31&math.getRandom16())){a.getValue()<Tile.RAILBASE+2?e.setTile(t,i,Tile.RIVER,0):e.setTo(t,i,ZoneUtils.randomRubble())}}},airportFound:function(e,t,i,s){if(s||(s=Micro.simData),s.census.airportPop+=1,e.getTile(t,i).isPowered()){if(e.getTileValue(t+1,i-1)===Tile.RADAR&&e.setTile(t+1,i-1,Tile.RADAR0,Tile.CONDBIT|Tile.ANIMBIT|Tile.BURNBIT),0===math.getRandom(5))return void s.spriteManager.generatePlane(t,i);0===math.getRandom(12)&&s.spriteManager.generateCopter(t,i)}else e.setTile(t+1,i-1,Tile.RADAR,Tile.CONDBIT|Tile.BURNBIT)},portFound:function(e,t,i,s){s||(s=Micro.simData),s.census.seaportPop+=1,e.getTile(t,i).isPowered()&&null===s.spriteManager.getSprite(Micro.SPRITE_SHIP)&&s.spriteManager.generateShip()}},handleService=function(e,t,i){return function(s,a,o,l){l||(l=Micro.simData),l.census[e]+=1;var r=l.budget[t];s.getTile(a,o).isPowered()||(r=Math.floor(r/2));var n=new Position(a,o);l.traffic.findPerimeterRoad(n)||(r=Math.floor(r/2));var h=l.blockMaps[i].worldGet(a,o);h+=r,l.blockMaps[i].worldSet(a,o,h)}},EmergencyServices={registerHandlers:function(e,t){e.addAction(Tile.POLICESTATION,EmergencyServices.policeStationFound),e.addAction(Tile.FIRESTATION,EmergencyServices.fireStationFound)},policeStationFound:handleService("policeStationPop","policeEffect","policeStationMap"),fireStationFound:handleService("fireStationPop","fireEffect","fireStationMap")},xDelta$1=[-1,0,1,0],yDelta$1=[0,-1,0,1],MiscTiles={registerHandlers:function(e,t){e.addAction(ZoneUtils.isFire,MiscTiles.fireFound,!0),e.addAction(Tile.RADTILE,MiscTiles.radiationFound,!0),e.addAction(ZoneUtils.isFlood,MiscTiles.floodFound,!0)},fireFound:function(e,t,i,s){if(s||(s=Micro.simData),s.census.firePop+=1,0!=(3&math.getRandom16()))return;let a,o,l,r;for(a=0;a<4;a++)if(math.getChance(7)&&(o=t+xDelta$1[a],l=i+yDelta$1[a],e.testBounds(o,l))){if(r=e.getTile(t,i),!r.isCombustible())continue;r.isZone()&&(ZoneUtils.fireZone(e,t,i,s.blockMaps),r.getValue()>Tile.IZB&&s.spriteManager.makeExplosionAt(t,i)),e.setTo(ZoneUtils.randomFire())}let n=10;a=s.blockMaps.fireStationEffectMap.worldGet(t,i),a>100?n=1:a>20?n=2:a>0&&(n=3),0===math.getRandom(n)&&e.setTo(t,i,ZoneUtils.randomRubble())},radiationFound:function(e,t,i,s){math.getChance(4095)&&e.setTile(t,i,Tile.DIRT,0)},floodFound:function(e,t,i,s){s||(s=Micro.simData),s.disasterManager.doFlood(t,i,s.blockMaps)}},Stadia={registerHandlers:function(e,t){e.addAction(Tile.STADIUM,Stadia.emptyStadiumFound),e.addAction(Tile.FULLSTADIUM,Stadia.fullStadiumFound),t.addAction(Tile.STADIUM,15,4)},emptyStadiumFound:function(e,t,i,s){s||(s=Micro.simData),s.census.stadiumPop+=1,e.getTile(t,i).isPowered()&&0==(s.cityTime+t+i&31)&&(e.putZone(t,i,Tile.FULLSTADIUM,4),e.addTileFlags(t,i,Tile.POWERBIT),e.setTo(t+1,i,new Tiles(Tile.FOOTBALLGAME1,Tile.ANIMBIT)),e.setTo(t+1,i+1,new Tiles(Tile.FOOTBALLGAME2,Tile.ANIMBIT)))},fullStadiumFound:function(e,t,i,s){s||(s=Micro.simData),s.census.stadiumPop+=1;let a=e.getTile(t,i).isPowered();0==(s.cityTime+t+i&7)&&(e.putZone(t,i,Tile.STADIUM,4),a&&e.addTileFlags(t,i,Tile.POWERBIT))}};class MapUtils{static smoothMap(e,t,i){let s,a,o=e.width;for(;o--;)for(s=e.height;s--;)a=0,o>0&&(a+=e.get(o-1,s)),o<e.width-1&&(a+=e.get(o+1,s)),s>0&&(a+=e.get(o,s-1)),s<e.height-1&&(a+=e.get(o,s+1)),i===Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK?(a=e.get(o,s)+Math.floor(a/4),t.set(o,s,Math.floor(a/2))):(a=a+e.get(o,s)>>2,a>255&&(a=255),t.set(o,s,a))}static neutraliseRateOfGrowthMap(e){let t,i,s=e.rateOfGrowthMap,a=s.width;for(;a--;)for(t=s.height;t--;)i=s.get(a,t),0!==i&&(i>0?i--:i++,i=math.clamp(i,-200,200),s.set(a,t,i))}static neutraliseTrafficMap(e){let t,i,s=e.trafficDensityMap,a=s.width;for(;a--;)for(t=s.height;t--;)i=s.get(a,t),0!==i&&(i<=24?i=0:i-=i>200?34:24,s.set(a,t,i))}static getPollutionValue(e){if(e<Tile.POWERBASE){if(e>=Tile.HTRFBASE)return 75;if(e>=Tile.LTRFBASE)return 50;if(e<Tile.ROADBASE){if(e>Tile.FIREBASE)return 90;if(e>=Tile.RADTILE)return 255}return 0}return e<=Tile.LASTIND?0:e<Tile.PORTBASE?50:e<=Tile.LASTPOWERPLANT?100:0}static getCityCentreDistance(e,t,i){let s,a;return s=t>e.cityCentreX?t-e.cityCentreX:e.cityCentreX-t,a=i>e.cityCentreY?i-e.cityCentreY:e.cityCentreY-i,Math.min(s+a,64)}static pollutionTerrainLandValueScan(e,t,i){let s=i.tempMap1,a=i.tempMap2,o=i.tempMap3;o.clear();let l,r,n,h,T,c,d,E,R,u,p=i.landValueMap,m=i.terrainDensityMap,g=i.pollutionDensityMap,M=i.crimeRateMap,A=0,S=0,f=p.width;for(;f--;)for(l=p.height;l--;){for(r=0,n=!1,h=2*f,T=2*l,c=h;c<=h+1;c++)for(d=T;d<=T+1;d++)E=e.getTileValue(c,d),E!==Tile.DIRT&&(E<Tile.RUBBLE?(R=o.worldGet(c,d),o.worldSet(c,d,R+15)):(r+=MapUtils.getPollutionValue(E),E>=Tile.ROADBASE&&(n=!0)));r=Math.min(r,255),s.set(f,l,r),n?(u=34-Math.floor(MapUtils.getCityCentreDistance(e,h,T)/2),u<<=2,u+=m.get(f>>1,l>>1),u-=g.get(f,l),M.get(f,l)>190&&(u-=20),u=math.clamp(u,1,250),p.set(f,l,u),A+=u,S++):p.set(f,l,0)}t.landValueAverage=S>0?Math.floor(A/S):0,MapUtils.smoothMap(s,a,Micro.SMOOTH_ALL_THEN_CLAMP),MapUtils.smoothMap(a,s,Micro.SMOOTH_ALL_THEN_CLAMP);let O,I=0,D=0,L=0;for(f=0;f<e.width;f+=g.blockSize)for(l=0;l<e.height;l+=g.blockSize)O=s.worldGet(f,l),g.worldSet(f,l,O),0!==O&&(D++,L+=O,(O>I||O===I&&math.getChance(3))&&(I=O,e.pollutionMaxX=f,e.pollutionMaxY=l));t.pollutionAverage=D?Math.floor(L/D):0,MapUtils.smoothMap(o,m,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK)}static crimeScan(e,t){let i=t.policeStationMap,s=t.policeStationEffectMap,a=t.crimeRateMap,o=t.landValueMap,l=t.populationDensityMap;MapUtils.smoothMap(i,s,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK),MapUtils.smoothMap(s,i,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK),MapUtils.smoothMap(i,s,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK);let r,n,h,T=0,c=0,d=a.mapWidth,E=a.mapHeight;for(r=0;r<d;r+=blockSize)for(n=0;n<E;n+=blockSize)h=o.worldGet(r,n),h>0?(c+=1,h=128-h,h+=l.worldGet(r,n),h=Math.min(h,300),h-=i.worldGet(r,n),h=math.clamp(h,0,250),a.worldSet(r,n,h),T+=h):a.worldSet(r,n,0);e.crimeAverage=c>0?Math.floor(T/c):0}static fillCityCentreDistScoreMap(e,t){let i,s,a=t.cityCentreDistScoreMap,o=a.width;for(;o--;)for(i=a.height;i--;)s=Math.floor(MapUtils.getCityCentreDistance(e,8*o,8*i)/2),s*=4,s=64-s,a.set(o,i,s)}static getPopulationDensity(e,t,i,s){return s<Tile.COMBASE?Residential.getZonePopulation(e,t,i,s):s<Tile.INDBASE?8*Commercial.getZonePopulation(e,t,i,s):s<Tile.PORTBASE?8*Industrial.getZonePopulation(e,t,i,s):0}static populationDensityScan(e,t){let i=t.tempMap1,s=t.tempMap2;t.populationDensityMap;let a=0,o=0,l=0;i.clear();let r,n,h,T,c=e.width;for(;c--;)for(r=e.height;r--;)n=e.getTile(c,r),n.isZone()&&(h=n.getValue(),T=8*MapUtils.getPopulationDensity(e,c,r,h),T=Math.min(T,254),i.worldSet(c,r,T),a+=c,o+=r,l++);MapUtils.smoothMap(i,s,Micro.SMOOTH_ALL_THEN_CLAMP),MapUtils.smoothMap(s,i,Micro.SMOOTH_ALL_THEN_CLAMP),MapUtils.smoothMap(i,s,Micro.SMOOTH_ALL_THEN_CLAMP),t.populationDensityMap.copyFrom(s,(function(e){return 2*e})),MapUtils.fillCityCentreDistScoreMap(e,t),l>0?(e.cityCentreX=Math.floor(a/l),e.cityCentreY=Math.floor(o/l)):(e.cityCentreX=Math.floor(.5*e.width),e.cityCentreY=Math.floor(.5*e.height))}static fireAnalysis(e){let t=e.fireStationMap,i=e.fireStationEffectMap;MapUtils.smoothMap(t,i,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK),MapUtils.smoothMap(i,t,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK),MapUtils.smoothMap(t,i,Micro.SMOOTH_NEIGHBOURS_THEN_BLOCK)}}class Simulation{constructor(e,t,i,s,a){if(t!==Micro.LEVEL_EASY&&t!==Micro.LEVEL_MED&&t!==Micro.LEVEL_HARD)throw new Error("Invalid level!");this.map=e,this.gameLevel=t,this.div=this.map.width/8,this.is3D=s||!1,this.time="undefined"==typeof performance?Date:performance,this.speed=i,this.speedCycle=0,this.phaseCycle=0,this.simCycle=0,this.doInitialEval=!0,this.cityTime=50,this.cityPopLast=0,this.messageLast=Messages.VILLAGE_REACHED,this.startingYear=1900,this.resValveLast=0,this.comValveLast=0,this.indValveLast=0,this._cityYearLast=-1,this._cityMonthLast=-1,this._lastPowerMessage=null,this.infos=[],this.evaluation=new Evaluation(this.gameLevel),this.valves=new Valves,this.budget=new Budget,this.census=new Census,this.powerManager=new PowerManager(this.map),this.spriteManager=new SpriteManager(this.map),this.mapScanner=new MapScanner(this.map),this.repairManager=new RepairManager(this.map),this.traffic=new Traffic(this.map,this.spriteManager),this.disasterManager=new DisasterManager(this.map,this.spriteManager,this.gameLevel),this.messageManager=new MessageManager,Micro.messageManager=this.messageManager;let o=this.map.width,l=this.map.height;this.blockMaps={cityCentreDistScoreMap:new BlockMap(o,l,8),crimeRateMap:new BlockMap(o,l,2),fireStationMap:new BlockMap(o,l,8),fireStationEffectMap:new BlockMap(o,l,8),landValueMap:new BlockMap(o,l,2),policeStationMap:new BlockMap(o,l,8),policeStationEffectMap:new BlockMap(o,l,8),pollutionDensityMap:new BlockMap(o,l,2),populationDensityMap:new BlockMap(o,l,2),rateOfGrowthMap:new BlockMap(o,l,8),terrainDensityMap:new BlockMap(o,l,4),trafficDensityMap:new BlockMap(o,l,2),tempMap1:new BlockMap(o,l,2),tempMap2:new BlockMap(o,l,2),tempMap3:new BlockMap(o,l,4)},this.clearCensus(),a?this.load(a):(this.budget.setFunds(2e4),this.census.totalPop=1),Micro.simData=this,this.init()}save(e){for(let t=0,i=Micro.savePropsVar.length;t<i;t++)e[Micro.savePropsVar[t]]=this[Micro.savePropsVar[t]];this.map.save(e),this.evaluation.save(e),this.valves.save(e),this.budget.save(e),this.census.save(e)}load(e){this.messageManager.clear();for(let t=0,i=Micro.savePropsVar.length;t<i;t++)this[Micro.savePropsVar[t]]=e[Micro.savePropsVar[t]];this.evaluation.load(e),this.valves.load(e),this.budget.load(e),this.census.load(e)}setSpeed(e){this.speed=e}setDifficulty(e){if(e!==Micro.LEVEL_EASY&&e!==Micro.LEVEL_MED&&e!==Micro.LEVEL_HARD)throw new Error("Invalid level!");this.gameLevel=e,this.disasterManager.setDifficulty(this.gameLevel)}isPaused(){return this.speed===Micro.SPEED_PAUSED}simTick(){let e=this.simFrame();return e&&(this.updateTime(),this.updateInfo()),e}updateInfo(){return this.infos[0]=[TXT.months[this._cityMonthLast],this._cityYearLast].join(" "),this.infos[1]=TXT.cityClass[this.evaluation.cityScore],this.infos[2]=this.evaluation.cityScore,this.infos[3]=this.evaluation.cityPop,this.infos[4]=this.budget.totalFunds,this.infos[5]=this.valves.resValve,this.infos[6]=this.valves.comValve,this.infos[7]=this.valves.indValve,this.infos[9]=this.map.powerChange,this.map.powerChange=!1,this.infos}simFrame(){if(this.budget.awaitingValues)return!1;if(this.speed===Micro.SPEED_PAUSED)return!1;let e=100;this.speed===Micro.SPEED_MED&&(e=50),this.speed===Micro.SPEED_FAST&&(e=10),this.speed===Micro.SPEED_ULTRA&&(e=5);let t=this.time.now();return!(t-this.prevTime<e)&&(this.messageManager.clear(),this.simulate(),this.prevTime=t,!0)}clearCensus(){this.census.clearCensus(),this.powerManager.clearPowerStack(),this.blockMaps.fireStationMap.clear(),this.blockMaps.policeStationMap.clear()}init(){this.prevTime=-1,this.powerManager.registerHandlers(this.mapScanner,this.repairManager),Commercial.registerHandlers(this.mapScanner,this.repairManager),EmergencyServices.registerHandlers(this.mapScanner,this.repairManager),Industrial.registerHandlers(this.mapScanner,this.repairManager),MiscTiles.registerHandlers(this.mapScanner,this.repairManager),Road.registerHandlers(this.mapScanner,this.repairManager),Residential.registerHandlers(this.mapScanner,this.repairManager),Stadia.registerHandlers(this.mapScanner,this.repairManager),Transport.registerHandlers(this.mapScanner,this.repairManager),this.evaluation.evalInit(),this.valves.setValves(this.gameLevel,this.census,this.budget),this.clearCensus(),this.mapScanner.mapScan(0,this.map.width,null),this.powerManager.doPowerScan(this.census),MapUtils.pollutionTerrainLandValueScan(this.map,this.census,this.blockMaps),MapUtils.crimeScan(this.census,this.blockMaps),MapUtils.populationDensityScan(this.map,this.blockMaps),MapUtils.fireAnalysis(this.blockMaps)}simulate(){this.phaseCycle&=15;let e=this.speed-1;switch(this.phaseCycle){case 0:++this.simCycle>1023&&(this.simCycle=0),this.doInitialEval&&(this.doInitialEval=!1,this.evaluation.cityEvaluation()),this.cityTime++,0==(1&this.simCycle)&&this.valves.setValves(this.gameLevel,this.census,this.budget),this.clearCensus();break;case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:this.mapScanner.mapScan((this.phaseCycle-1)*this.div,this.phaseCycle*this.div,null);break;case 9:this.cityTime%Micro.CENSUS_FREQUENCY_10==0&&this.census.take10Census(this.budget),this.cityTime%Micro.CENSUS_FREQUENCY_120==0&&this.census.take120Census(this.budget),this.cityTime%Micro.TAX_FREQUENCY==0&&(this.budget.collectTax(this.gameLevel,this.census),this.evaluation.cityEvaluation());break;case 10:this.simCycle%5==0&&MapUtils.neutraliseRateOfGrowthMap(this.blockMaps),MapUtils.neutraliseTrafficMap(this.blockMaps),this.sendMessages();break;case 11:this.simCycle%Micro.speedPowerScan[e]==0&&this.powerManager.doPowerScan(this.census);break;case 12:this.simCycle%Micro.speedPollutionTerrainLandValueScan[e]==0&&MapUtils.pollutionTerrainLandValueScan(this.map,this.census,this.blockMaps);break;case 13:this.simCycle%Micro.speedCrimeScan[e]==0&&MapUtils.crimeScan(this.census,this.blockMaps);break;case 14:this.simCycle%Micro.speedPopulationDensityScan[e]==0&&MapUtils.populationDensityScan(this.map,this.blockMaps);break;case 15:this.simCycle%Micro.speedFireAnalysis[e]==0&&MapUtils.fireAnalysis(this.blockMaps),this.disasterManager.doDisasters(this.census);break}this.phaseCycle=this.phaseCycle+1&15}sendMessages(){this.checkGrowth();let e=this.census.resZonePop+this.census.comZonePop+this.census.indZonePop,t=this.census.nuclearPowerPop+this.census.coalPowerPop;switch(63&this.cityTime){case 1:Math.floor(e/4)>=this.census.resZonePop&&this.messageManager.sendMessage(Messages.NEED_MORE_RESIDENTIAL);break;case 5:Math.floor(e/8)>=this.census.comZonePop&&this.messageManager.sendMessage(Messages.NEED_MORE_COMMERCIAL);break;case 10:Math.floor(e/8)>=this.census.indZonePop&&this.messageManager.sendMessage(Messages.NEED_MORE_INDUSTRIAL);break;case 14:e>10&&2*e>this.census.roadTotal&&this.messageManager.sendMessage(Messages.NEED_MORE_ROADS);break;case 18:e>50&&e>this.census.railTotal&&this.messageManager.sendMessage(Messages.NEED_MORE_RAILS);break;case 22:e>10&&0==t&&this.messageManager.sendMessage(Messages.NEED_ELECTRICITY);break;case 26:this.census.resPop>500&&0===this.census.stadiumPop?(this.messageManager.sendMessage(Messages.NEED_STADIUM),this.valves.resCap=!0):this.valves.resCap=!1;break;case 28:this.census.indPop>70&&0===this.census.seaportPop?(this.messageManager.sendMessage(Messages.NEED_SEAPORT),this.valves.indCap=!0):this.valves.indCap=!1;break;case 30:this.census.comPop>100&&0===this.census.airportPop?(this.messageManager.sendMessage(Messages._NEED_AIRPORT),this.valves.comCap=!0):this.valves.comCap=!1;break;case 32:let i=this.census.unpoweredZoneCount+this.census.poweredZoneCount;i>0&&this.census.poweredZoneCount/i<.7&&this.messageManager.sendMessage(Messages.BLACKOUTS_REPORTED);break;case 35:this.census.pollutionAverage>60&&this.messageManager.sendMessage(Messages.HIGH_POLLUTION);break;case 42:this.census.crimeAverage>100&&this.messageManager.sendMessage(Messages.HIGH_CRIME);break;case 45:this.census.totalPop>60&&0===this.census.fireStationPop&&this.messageManager.sendMessage(Messages.NEED_FIRE_STATION);break;case 48:this.census.totalPop>60&&0===this.census.policeStationPop&&this.messageManager.sendMessage(Messages.NEED_POLICE_STATION);break;case 51:this.budget.cityTax>12&&this.messageManager.sendMessage(Messages.TAX_TOO_HIGH);break;case 54:this.budget.roadEffect<Math.floor(5*this.budget.MAX_ROAD_EFFECT/8)&&this.census.roadTotal>30&&this.messageManager.sendMessage(Messages.ROAD_NEEDS_FUNDING);break;case 57:this.budget.fireEffect<Math.floor(7*this.budget.MAX_FIRE_STATION_EFFECT/10)&&this.census.totalPop>20&&this.messageManager.sendMessage(Messages.FIRE_STATION_NEEDS_FUNDING);break;case 60:this.budget.policeEffect<Math.floor(7*this.budget.MAX_POLICE_STATION_EFFECT/10)&&this.census.totalPop>20&&this.messageManager.sendMessage(Messages.POLICE_NEEDS_FUNDING);break;case 63:this.census.trafficAverage>60&&this.messageManager.sendMessage(Messages.TRAFFIC_JAMS,-1,-1,!0);break}}checkGrowth(){if(0!=(3&this.cityTime))return;let e="",t=this.evaluation.getPopulation(this.census);if(t!==this.cityPopLast){let i=this.evaluation.getCityClass(this.cityPopLast),s=this.evaluation.getCityClass(t);if(i!==s)switch(s){case Micro.CC_VILLAGE:break;case Micro.CC_TOWN:e=Messages.REACHED_TOWN;break;case Micro.CC_CITY:e=Messages.REACHED_CITY;break;case Micro.CC_CAPITAL:e=Messages.REACHED_CAPITAL;break;case Micro.CC_METROPOLIS:e=Messages.REACHED_METROPOLIS;break;case Micro.CC_MEGALOPOLIS:e=Messages.REACHED_MEGALOPOLIS;break}}""!==e&&e!==this.messageLast&&(this.messageManager.sendMessage(e),this.messageLast=e),this.cityPopLast=t}setYear(e){e<this.startingYear&&(e=this.startingYear),e=e-this.startingYear-this.cityTime/48,this.cityTime+=48*e,this.updateTime()}updateTime(){let e=Math.floor(this.cityTime/48)+this.startingYear,t=Math.floor(this.cityTime%48)>>2;e>=1e6?this.setYear(this.startingYear):this._cityYearLast===e&&this._cityMonthLast===t||(this._cityYearLast=e,this._cityMonthLast=t,this.messageManager.sendMessage(Messages.DATE_UPDATED,{month:t,year:e}))}}class TileHistory{constructor(){this.clear()}clear(){this.data={}}toKey(e,t){return[e,t].join(",")}getTile(e,t){let i=this.toKey(e,t);return this.data[i]}setTile(e,t,i){let s=this.toKey(e,t);this.data[s]=i}}class AnimationManager{constructor(e,t,i){t=t||5,i=i||30,this._map=e,this.animationPeriod=t,this.blinkPeriod=i,this.shouldBlink=!1,this.count=1,this._lastPainted=null,this._data=[],this.initArray(),this.registerAnimations()}initArray(){for(let e=0;e<Tile.TILE_COUNT;e++)this._data[e]=e}inSequence(e,t){let i=[e],s=this._data[e];for(;-1===i.indexOf(s);){if(s===t)return!0;i.push(s),s=this._data[s]}return!1}getTiles(e,t,i,s,a=!1){let o=!1;a||(this.count+=1),this.count%this.blinkPeriod==0&&(this.shouldBlink=!this.shouldBlink),this.count%this.animationPeriod!=0||a||(o=!0);let l=new TileHistory,r=[];for(let a=e;a<i;a++)for(let e=t;e<s;e++){if(a<0||a>=this._map.width||e<0||e>=this._map.height)continue;let t=this._map.getTile(a,e);if(!t.isAnimated())continue;let i,s=t.getValue(),n=Tile.TILE_INVALID;this._lastPainted&&(i=this._lastPainted.getTile(a,e)),o?i&&this.inSequence(s,i)?(n=this._data[i],i===Tile.LASTTINYEXP?(this._map.setTo(a,e,ZoneUtils.randomRubble()),n=this._map.getTileValue(a,e)):n=this._data[i]):n=this._data[s]:i&&this.inSequence(s,i)&&(n=i),n!==Tile.TILE_INVALID&&(r.push({x:a,y:e,tileValue:n}),l.setTile(a,e,n),this._map.setPaintValue(a,e,n))}return this._lastPainted=l,r}registerSingleAnimation(e){for(let t=1;t<e.length;t++)this._data[e[t-1]]=e[t]}registerAnimations(){this.registerSingleAnimation([56,57,58,59,60,61,62,63,56]),this.registerSingleAnimation([860,861,862,863,864,865,866,867]),this.registerSingleAnimation([80,128,112,96,80]),this.registerSingleAnimation([81,129,113,97,81]),this.registerSingleAnimation([82,130,114,98,82]),this.registerSingleAnimation([83,131,115,99,83]),this.registerSingleAnimation([84,132,116,100,84]),this.registerSingleAnimation([85,133,117,101,85]),this.registerSingleAnimation([86,134,118,102,86]),this.registerSingleAnimation([87,135,119,103,87]),this.registerSingleAnimation([88,136,120,104,88]),this.registerSingleAnimation([89,137,121,105,89]),this.registerSingleAnimation([90,138,122,106,90]),this.registerSingleAnimation([91,139,123,107,91]),this.registerSingleAnimation([92,140,124,108,92]),this.registerSingleAnimation([93,141,125,109,93]),this.registerSingleAnimation([94,142,126,110,94]),this.registerSingleAnimation([95,143,127,111,95]),this.registerSingleAnimation([144,192,176,160,144]),this.registerSingleAnimation([145,193,177,161,145]),this.registerSingleAnimation([146,194,178,162,146]),this.registerSingleAnimation([147,195,179,163,147]),this.registerSingleAnimation([148,196,180,164,148]),this.registerSingleAnimation([149,197,181,165,149]),this.registerSingleAnimation([150,198,182,166,150]),this.registerSingleAnimation([151,199,183,167,151]),this.registerSingleAnimation([152,200,184,168,152]),this.registerSingleAnimation([153,201,185,169,153]),this.registerSingleAnimation([154,202,186,170,154]),this.registerSingleAnimation([155,203,187,171,155]),this.registerSingleAnimation([156,204,188,172,156]),this.registerSingleAnimation([157,205,189,173,157]),this.registerSingleAnimation([158,206,190,174,158]),this.registerSingleAnimation([159,207,191,175,159])}}class GameMap{constructor(e=128,t=128,i){this.isIsland=!1,this.pp=[],this.width=e,this.height=t,this.fsize=this.width*this.height,this.defaultValue=(new Tiles).getValue(),this.data=[],this.tilesData=new Micro.M_ARRAY_TYPE(this.fsize),this.powerData=new Micro.M_ARRAY_TYPE(this.fsize);let s=this.fsize;for(;s--;)this.data[s]=new Tiles(this.defaultValue),this.tilesData[s]=this.defaultValue;this.cityCentreX=Math.floor(.5*this.width),this.cityCentreY=Math.floor(.5*this.height),this.pollutionMaxX=this.cityCentreX,this.pollutionMaxY=this.cityCentreY,this.powerChange=!1,this.layer=[],this.resetLayer(),this.makePP()}upLayer(e,t,i,s){t>=Tile.TINYEXP&&t<=Tile.TINYEXPLAST&&(t-=825),this.tilesData[e]=t,this.layer[this.findLayer(i,s)]=1}resetLayer(){let e=64;for(;e--;)this.layer[e]=0}findLayer(e,t){return Math.floor(e/16)+8*Math.floor(t/16)}goodValue(e){return 0===e||e>1&&e<240}makePP(){let e,t=this.width,i=0,s=[];for(;t--;)for(e=this.height;e--;)s[i]=[t,e],i++;this.pp=s}powered(e){let t=e.id||this.getId(e.x,e.y);this.powerData[t]=e.v,this.powerChange=!0}save(e){let t,i=0;for(t=Micro.GameMapProps.length;i<t;)e[Micro.GameMapProps[i]]=this[Micro.GameMapProps[i]],i++;for(e.map=[],i=0,t=this.fsize;i<t;)e.map[i]=this.data[i].getRawValue(),i++;for(e.tileValue=[],i=0,t=this.fsize;i<t;)e.tileValue[i]=this.tilesData[i],i++}load(e){let t,i,s,a=0,o=e.map,l=e.tileValue;for(s=Micro.GameMapProps.length;a<s;)this[Micro.GameMapProps[a]]=e[Micro.GameMapProps[a]],a++;let r=void 0!==o[0].value;for(a=0,s=this.fsize;a<s;)t=a%this.width,i=Math.floor(a/this.width),r?this.setTileValue(t,i,o[a].value):this.setTileValue(t,i,o[a]),a++;for(a=0,s=this.fsize;a<s;)this.tilesData[a]=l[a],a++}testBounds(e,t){return e>=0&&t>=0&&e<this.width&&t<this.height}getId(e,t){return e+t*this.width}getTile(e,t,i){"object"==typeof e&&(t=e.y,e=e.x);let s=this.width,a=this.height;if(e<0||t<0||e>=s||t>=a)return new Tiles(Tile.TILE_INVALID);let o=this.getId(e,t),l=this.data[o];return i?(i.set(l),l):l}getTileValue(e,t){let i=new Error("Invalid parameter");if(arguments.length<1)throw i;if("object"==typeof e&&(t=e.y,e=e.x),!this.testBounds(e,t))throw i;let s=this.getId(e,t);return s in this.data||(this.data[s]=new Tiles(this.defaultValue)),this.data[s].getValue()}getTileFlags(e,t){let i=new Error("Invalid parameter");if(arguments.length<1)throw i;if("object"==typeof e&&(t=e.y,e=e.x),!this.testBounds(e,t))throw i;let s=this.getId(e,t);return s in this.data||(this.data[s]=new Tiles(this.defaultValue)),this.data[s].getFlags()}getTiles(e,t,i,s){let a=new Error("Invalid parameter");if(arguments.length<3)throw a;if(3===arguments.length&&(s=i,i=t,t=e.y,e=e.x),!this.testBounds(e,t))throw a;let o=[];for(let a=t,l=t+s;a<l;a++){o[a-t]=[];for(let s=e,l=e+i;s<l;s++){let e=this.getId(s,a);o[a-t].push(this.data[e])}}return o}getTileValues(e,t,i,s,a){a=a||[];let o=new Error("Invalid parameter");if(arguments.length<3)throw o;3===arguments.length&&(s=i,i=t,t=e.y,e=e.x);let l=this.width,r=this.height;for(let o=t,n=t+s;o<n;o++)for(let s=e,n=e+i;s<n;s++){if(o<0||s<0||o>=r||s>=l){a[(o-t)*i+(s-e)]=Tile.TILE_INVALID;continue}let n=s+o*l;a[(o-t)*i+(s-e)]=this.data[n].getRawValue()}return a}getTileFromMapOrDefault(e,t,i){switch(t){case Direction.NORTH:return e.y>0?this.getTileValue(e.x,e.y-1):i;case Direction.EAST:return e.x<this.width-1?this.getTileValue(e.x+1,e.y):i;case Direction.SOUTH:return e.y<this.height-1?this.getTileValue(e.x,e.y+1):i;case Direction.WEST:return e.x>0?this.getTileValue(e.x-1,e.y):i;default:return i}}testOld(e,t){return this.data[e].getValue()!==t}setTile(e,t,i,s){3===arguments.length&&(s=i,i=t,t=e.y,e=e.x);let a=this.getId(e,t),o=this.testOld(a,i);this.data[a].set(i,s),o&&this.upLayer(a,i,e,t)}setTo(e,t,i){void 0===i&&(i=t,t=e.y,e=e.x);let s=this.getId(e,t),a=i.getValue(),o=this.testOld(s,a);this.data[s]=i,o&&this.upLayer(s,a,e,t)}setTileValue(e,t,i){2===arguments.length&&(i=t,t=e.y,e=e.x);let s=this.getId(e,t),a=this.testOld(s,i);this.data[s].setValue(i),a&&this.upLayer(s,i,e,t)}setPaintValue(e,t,i){2===arguments.length&&(i=t,t=e.y,e=e.x);let s=this.getId(e,t);this.upLayer(s,i,e,t)}setTileFlags(e,t,i){let s=new Error("Invalid flag parameter");if(arguments.length<2)throw s;if(2===arguments.length&&(i=t,t=e.y,e=e.x),!this.testBounds(e,t))throw s;let a=this.getId(e,t);this.data[a].setFlags(i)}addTileFlags(e,t,i){let s=new Error("Invalid flag parameter");if(arguments.length<2)throw s;if(2===arguments.length&&(i=t,t=e.y,e=e.x),!this.testBounds(e,t))throw s;let a=this.getId(e,t);this.data[a].addFlags(i)}removeTileFlags(e,t,i){if(arguments.length<2)throw new Error("GameMap removeTileFlags called with too few arguments");if(2===arguments.length&&(i=t,t=e.y,e=e.x),!this.testBounds(e,t))throw new Error("GameMap removeTileFlags called with invalid bounds"+e+", "+t);let s=this.getId(e,t);this.data[s].removeFlags(i)}putZone(e,t,i,s){if(!this.testBounds(e,t)||!this.testBounds(e-1+s,t-1+s))throw new Error("GameMap putZone called with invalid bounds");let a,o,l=i-1-s,r=e-1,n=t-1;for(o=n;o<n+s;o++)for(a=r;a<r+s;a++)a===e&&o===t?this.setTo(a,o,new Tiles(l,Tile.BNCNBIT|Tile.ZONEBIT)):this.setTo(a,o,new Tiles(l,Tile.BNCNBIT)),l+=1}}class MapGenerator{constructor(){this.SRMatrix=[[0,0,3,3,0,0],[0,3,2,2,3,0],[3,2,2,2,2,3],[3,2,2,2,2,3],[0,3,2,2,3,0],[0,0,3,3,0,0]],this.BRMatrix=[[0,0,0,3,3,3,0,0,0],[0,0,3,2,2,2,3,0,0],[0,3,2,2,2,2,2,3,0],[3,2,2,2,2,2,2,2,3],[3,2,2,2,4,2,2,2,3],[3,2,2,2,2,2,2,2,3],[0,3,2,2,2,2,2,3,0],[0,0,3,2,2,2,3,0,0],[0,0,0,3,3,3,0,0,0]],this.riverEdge=[13,13,17,15,5,2,19,17,9,11,2,13,7,9,5,2],this.treeTable=[0,0,0,34,0,0,36,35,0,32,0,33,30,31,29,37]}construct(e,t,i=!1){if(Micro.TERRAIN_TREE_LEVEL=-1,Micro.TERRAIN_LAKE_LEVEL=-1,Micro.TERRAIN_CURVE_LEVEL=-1,Micro.ISLAND_RADIUS=18,this.map=new GameMap(e||Micro.MAP_WIDTH,t||Micro.MAP_HEIGHT),Micro.TERRAIN_CREATE_ISLAND=math.getRandom(2)-1,Micro.TERRAIN_CREATE_ISLAND<0&&math.getRandom(100)<10)return this.makeIsland(),this.map;if(1===Micro.TERRAIN_CREATE_ISLAND?this.makeNakedIsland():this.clearMap(),0!==Micro.TERRAIN_CURVE_LEVEL){let e=40+math.getRandom(this.map.width-79),t=33+math.getRandom(this.map.height-66),i=new Position(e,t);this.doRivers(i)}return 0!==Micro.TERRAIN_LAKE_LEVEL&&this.makeLakes(),this.smoothRiver(),this.cleanBorder(),0!==Micro.TERRAIN_TREE_LEVEL&&this.doTrees(),this.map}cleanBorder(){let e,t,i,s,a,o=this.map;if(!o.isIsland){for(e=0;e<o.width;e++)i=e+1,i>o.width-1&&(i=o.width-1),s=e-1,s<0&&(s=0),a=1,o.getTileValue(e,a)+o.getTileValue(i,a)+o.getTileValue(s,a)===6&&o.setTile(e,0,Tile.RIVER,0),a=o.height-2,o.getTileValue(e,a)+o.getTileValue(i,a)+o.getTileValue(s,a)===6&&o.setTile(e,o.height-1,Tile.RIVER,0);for(t=0;t<o.height;t++)i=t+1,i>o.height-1&&(i=o.height-1),s=t-1,s<0&&(s=0),a=1,o.getTileValue(a,t)+o.getTileValue(a,i)+o.getTileValue(a,s)===6&&o.setTile(0,t,Tile.RIVER,0),a=o.width-2,o.getTileValue(a,t)+o.getTileValue(a,i)+o.getTileValue(a,s)===6&&o.setTile(o.width-1,t,Tile.RIVER,0)}}clearMap(){let e=this.map;e.pp.forEach((t=>{e.setTile(t[0],t[1],Tile.DIRT,0)}))}clearUnnatural(){let e,t=this.map;t.pp.forEach((i=>{e=t.getTileValue(i[0],i[1]),e>Tile.WOODS&&t.setTile(i[0],i[1],Tile.DIRT,0)}))}makeNakedIsland(){let e,t,i,s,a=this.map,o=Micro.ISLAND_RADIUS;for(a.isIsland=!0,a.pp.forEach((i=>{e=i[0],t=i[1],e<5||e>=a.width-5||t<5||t>=a.height-5?a.setTile(e,t,Tile.RIVER,0):a.setTile(e,t,Tile.DIRT,0)})),e=0;e<a.width-5;e+=2)s=math.getERandom(o),this.plopBRiver({x:e,y:s}),s=a.height-10-math.getERandom(o),this.plopBRiver({x:e,y:s}),this.plopSRiver({x:e,y:0}),this.plopSRiver({x:e,y:a.height-6});for(t=0;t<a.height-5;t+=2)i=math.getERandom(o),this.plopBRiver({x:i,y:t}),i=a.width-10-math.getERandom(o),this.plopBRiver({x:i,y:t}),this.plopSRiver({x:0,y:t}),this.plopSRiver({x:a.width-6,y:t})}makeIsland(){this.makeNakedIsland(),this.smoothRiver(),this.doTrees()}makeLakes(){let e,t,i=Micro.TERRAIN_LAKE_LEVEL<0?math.getRandom(10):.5*Micro.TERRAIN_LAKE_LEVEL;for(;i>0;)e=math.getRandom(this.map.width-21)+10,t=math.getRandom(this.map.height-20)+10,this.makeSingleLake(new Position(e,t)),i--}makeSingleLake(e){let t,i=math.getRandom(12)+2;for(;i>0;)t=new Position(e,math.getRandom(12)-6,math.getRandom(12)-6),math.getRandom(4)?this.plopSRiver(t):this.plopBRiver(t),i--}treeSplash(e,t){let i,s=Micro.TERRAIN_TREE_LEVEL<0?math.getRandom(150)+50:math.getRandom(100+2*Micro.TERRAIN_TREE_LEVEL)+50,a=new Position(e,t);for(;s>0;){if(i=Direction.NORTH+math.getRandom(7),a.move(i),!this.map.testBounds(a.x,a.y))return;this.map.getTileValue(a)===Tile.DIRT&&this.map.setTile(a,Tile.WOODS,Tile.BLBNBIT),s--}}doTrees(){let e=Micro.TERRAIN_TREE_LEVEL<0?math.getRandom(100)+50:Micro.TERRAIN_TREE_LEVEL+3;for(;e--;)this.treeSplash(math.getRandom(this.map.width-1),math.getRandom(this.map.height-1));this.smoothTrees(),this.smoothTrees()}smoothRiver(){let e,t,i,s,a,o,l,r,n=this.map,h=this.riverEdge,T=[-1,0,1,0],c=[0,1,0,-1];n.pp.forEach((d=>{if(e=d[0],t=d[1],n.getTileValue(e,t)===Tile.REDGE){for(l=0,i=0;i<4;i++)l<<=1,s=e+T[i],a=t+c[i],n.testBounds(s,a)&&(o=n.getTileValue(s,a),o!==Tile.DIRT&&(o<Tile.WOODS_LOW||o>Tile.WOODS_HIGH)&&l++);r=h[15&l],r!==Tile.RIVER&&math.getRandom(1)&&r++,n.setTile(e,t,r,Tile.BULLBIT)}}))}isTree(e){return e>=Tile.WOODS_LOW&&e<=Tile.WOODS_HIGH}smoothTrees(){let e,t,i=this.map;i.pp.forEach((s=>{e=s[0],t=s[1],this.isTree(i.getTileValue(e,t))&&this.smoothTreesAt(e,t,!1)}))}smoothTreesAt(e,t,i){let s=this.map,a=[-1,0,1,0],o=[0,1,0,-1];if(!this.isTree(this.map.getTileValue(e,t)))return;let l,r,n,h,T=0;for(l=0;l<4;l++)T<<=1,r=e+a[l],n=t+o[l],s.testBounds(r,n)&&this.isTree(s.getTileValue(r,n))&&T++;h=this.treeTable[15&T],h?(h!==Tile.WOODS&&e+t&1&&(h-=8),h>28&&h<38&&(h-=8),s.setTile(e,t,h,Tile.BLBNBIT)):i||(h>28&&h<38&&(h-=8),s.setTileValue(e,t,h,0))}doRivers(e){let t=Direction.NORTH+2*math.getRandom(3);this.doBRiver(e,t,t),t=Direction.rotate180(t);let i=this.doBRiver(e,t,t);t=Direction.NORTH+2*math.getRandom(3),this.doSRiver(e,t,i)}doBRiver(e,t,i){let s,a;Micro.TERRAIN_CURVE_LEVEL<0?(s=100,a=200):(s=Micro.TERRAIN_CURVE_LEVEL+10,a=Micro.TERRAIN_CURVE_LEVEL+100);let o=new Position(e);for(;this.map.testBounds(o.x+4,o.y+4);)this.plopBRiver(o),math.getRandom(s+1)<10?i=t:(math.getRandom(a+1)>90&&(i=Direction.rotate45(i)),math.getRandom(a+1)>90&&(i=Direction.rotate45(i,7))),o.move(i);return i}doSRiver(e,t,i){let s,a;Micro.TERRAIN_CURVE_LEVEL<0?(s=100,a=200):(s=Micro.TERRAIN_CURVE_LEVEL+10,a=Micro.TERRAIN_CURVE_LEVEL+100);let o=new Position(e);for(;this.map.testBounds(o.x+3,o.y+3);)this.plopSRiver(o),math.getRandom(s+1)<10?i=t:(math.getRandom(a+1)>90&&(i=Direction.rotate45(i)),math.getRandom(a+1)>90&&(i=Direction.rotate45(i,7))),o.move(i);return i}putOnMap(e,t,i){if(0===e)return;if(!this.map.testBounds(t,i))return;let s=this.map.getTileValue(t,i);if(s!==Tile.DIRT){if(s===Tile.RIVER&&e!==Tile.CHANNEL)return;if(s===Tile.CHANNEL)return}this.map.setTile(t,i,e,0)}plopBRiver(e){let t,i=9;for(;i--;)for(t=9;t--;)this.putOnMap(this.BRMatrix[t][i],e.x+i,e.y+t)}plopSRiver(e){let t,i=6;for(;i--;)for(t=6;t--;)this.putOnMap(this.SRMatrix[t][i],e.x+i,e.y+t)}smoothWater(){let e,t,i,s,a,o,l=this.map;l.pp.forEach((o=>{if(s=o[0],a=o[1],e=l.getTileValue(s,a),e>=Tile.WATER_LOW&&e<=Tile.WATER_HIGH)for(t=new Position(s,a),i=Direction.BEGIN;i<Direction.END;i=Direction.increment90(i))if(e=l.getTileFromMap(t,i,Tile.WATER_LOW),e<Tile.WATER_LOW||e>Tile.WATER_HIGH){l.setTileValue(s,a,Tile.REDGE,0);break}})),l.pp.forEach((r=>{if(s=r[0],a=r[1],e=l.getTileValue(s,a),e!==Tile.CHANNEL&&e>=Tile.WATER_LOW&&e<=Tile.WATER_HIGH){for(o=!0,t=new Position(s,a),i=Direction.BEGIN;i<Direction.END;i=Direction.increment90(i))if(e=l.getTileFromMap(t,i,Tile.WATER_LOW),e<Tile.WATER_LOW||e>Tile.WATER_HIGH){o=!1;break}o&&l.setTileValue(s,a,Tile.RIVER,0)}})),l.pp.forEach((o=>{if(s=o[0],a=o[1],e=l.getTileValue(s,a),e>=Tile.WOODS_LOW&&e<=Tile.WOODS_HIGH)for(t=new Position(s,a),i=Direction.BEGIN;i<Direction.END;i=Direction.increment90(i))if(e=l.getTileFromMap(t,i,TILE_INVALID),e===Tile.RIVER||e===Tile.CHANNEL){l.setTileValue(s,a,Tile.REDGE,0);break}}))}}class WorldEffects{constructor(e){this._map=e,this._data={}}toKey(e,t){return[e,t].join(",")}fromKey(e){return{x:(e=e.split(","))[0]-0,y:e[1]-0}}clear(){this._data=[]}getTile(e,t){let i=this.toKey(e,t),s=this._data[i];return void 0===s&&(s=this._map.getTile(e,t)),s}getTileValue(e,t){return this.getTile(e,t).getValue()}setTile(e,t,i,s){if(void 0!==s&&i.isTile)throw new Error("Flags supplied with already defined tile");void 0!==s||i.isTile?void 0!==s&&(i=new Tiles(i,s)):i=new Tiles(i);let a=this.toKey(e,t);this._data[a]=i}apply(){let e=Object.keys(this._data);for(let t=0,i=e.length;t<i;t++){let i=this.fromKey(e[t]);this._map.setTo(i,this._data[e[t]])}}}class BaseTool{constructor(){this.TOOLRESULT_OK=0,this.TOOLRESULT_FAILED=1,this.TOOLRESULT_NO_MONEY=2,this.TOOLRESULT_NEEDS_BULLDOZE=3,this.autoBulldoze=!0,this.bulldozerCost=1}init(e,t,i,s=!1){this.toolCost=e,this.result=null,this.isDraggable=s,this._shouldAutoBulldoze=i,this._map=t,this._worldEffects=new WorldEffects(t),this._applicationCost=0}clear(){this._applicationCost=0,this._worldEffects.clear()}addCost(e){this._applicationCost+=e}doAutoBulldoze(e,t){let i=this._worldEffects.getTile(e,t);i.isBulldozable()&&(i=ZoneUtils.normalizeRoad(i),(i>=Tile.TINYEXP&&i<=Tile.LASTTINYEXP||i<Tile.HBRIDGE&&i!==Tile.DIRT)&&(this.addCost(1),this._worldEffects.setTile(e,t,Tile.DIRT)))}apply(e){this._worldEffects.apply(),e.spend(this._applicationCost),this.clear()}modifyIfEnoughFunding(e){return this.result!==this.TOOLRESULT_OK?(this.clear(),!1):e.totalFunds<this._applicationCost?(this.result=this.TOOLRESULT_NO_MONEY,this.clear(),!1):(this.apply.call(this,e),this.clear(),!0)}setAutoBulldoze(e){this.autoBulldoze=e}getAutoBulldoze(){return this.autoBulldoze}}class BaseToolConnector extends BaseTool{constructor(){super()}fixSingle(e,t){let i=0,s=this._worldEffects.getTile(e,t);return s=ZoneUtils.normalizeRoad(s),s>=Tile.ROADS&&s<=Tile.INTERSECTION?(t>0&&(s=this._worldEffects.getTile(e,t-1),s=ZoneUtils.normalizeRoad(s),(s===Tile.HRAILROAD||s>=Tile.ROADBASE&&s<=Tile.VROADPOWER)&&s!==Tile.HROADPOWER&&s!==Tile.VRAILROAD&&s!==Tile.ROADBASE&&(i|=1)),e<this._map.width-1&&(s=this._worldEffects.getTile(e+1,t),s=ZoneUtils.normalizeRoad(s),(s===Tile.VRAILROAD||s>=Tile.ROADBASE&&s<=Tile.VROADPOWER)&&s!==Tile.VROADPOWER&&s!==Tile.HRAILROAD&&s!==Tile.VBRIDGE&&(i|=2)),t<this._map.height-1&&(s=this._worldEffects.getTile(e,t+1),s=ZoneUtils.normalizeRoad(s),(s===Tile.HRAILROAD||s>=Tile.ROADBASE&&s<=Tile.VROADPOWER)&&s!==Tile.HROADPOWER&&s!==Tile.VRAILROAD&&s!==Tile.ROADBASE&&(i|=4)),e>0&&(s=this._worldEffects.getTile(e-1,t),s=ZoneUtils.normalizeRoad(s),(s===Tile.VRAILROAD||s>=Tile.ROADBASE&&s<=Tile.VROADPOWER)&&s!==Tile.VROADPOWER&&s!==Tile.HRAILROAD&&s!==Tile.VBRIDGE&&(i|=8)),void this._worldEffects.setTile(e,t,RoadTable[i]|Tile.BULLBIT|Tile.BURNBIT)):s>=Tile.LHRAIL&&s<=Tile.LVRAIL10?(t>0&&(s=this._worldEffects.getTile(e,t-1),s=ZoneUtils.normalizeRoad(s),s>=Tile.RAILHPOWERV&&s<=Tile.VRAILROAD&&s!==Tile.RAILHPOWERV&&s!==Tile.HRAILROAD&&s!==Tile.HRAIL&&(i|=1)),e<this._map.width-1&&(s=this._worldEffects.getTile(e+1,t),s=ZoneUtils.normalizeRoad(s),s>=Tile.RAILHPOWERV&&s<=Tile.VRAILROAD&&s!==Tile.RAILVPOWERH&&s!==Tile.VRAILROAD&&s!==Tile.VRAIL&&(i|=2)),t<this._map.height-1&&(s=this._worldEffects.getTile(e,t+1),s=ZoneUtils.normalizeRoad(s),s>=Tile.RAILHPOWERV&&s<=Tile.VRAILROAD&&s!==Tile.RAILHPOWERV&&s!==Tile.HRAILROAD&&s!==Tile.HRAIL&&(i|=4)),e>0&&(s=this._worldEffects.getTile(e-1,t),s=ZoneUtils.normalizeRoad(s),s>=Tile.RAILHPOWERV&&s<=Tile.VRAILROAD&&s!==Tile.RAILVPOWERH&&s!==Tile.VRAILROAD&&s!==Tile.VRAIL&&(i|=8)),void this._worldEffects.setTile(e,t,RailTable[i]|Tile.BULLBIT|Tile.BURNBIT)):s>=Tile.LHPOWER&&s<=Tile.LVPOWER10?(t>0&&(s=this._worldEffects.getTile(e,t-1),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!==Tile.VPOWER&&s!==Tile.VROADPOWER&&s!==Tile.RAILVPOWERH&&(i|=1))),e<this._map.width-1&&(s=this._worldEffects.getTile(e+1,t),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!==Tile.HPOWER&&s!==Tile.HROADPOWER&&s!==Tile.RAILHPOWERV&&(i|=2))),t<this._map.height-1&&(s=this._worldEffects.getTile(e,t+1),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!==Tile.VPOWER&&s!==Tile.VROADPOWER&&s!==Tile.RAILVPOWERH&&(i|=4))),e>0&&(s=this._worldEffects.getTile(e-1,t),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!==Tile.HPOWER&&s!==Tile.HROADPOWER&&s!==Tile.RAILHPOWERV&&(i|=8))),void this._worldEffects.setTile(e,t,WireTable[i]|Tile.BLBNCNBIT)):void 0}checkZoneConnections(e,t){this.fixSingle(e,t),t>0&&this.fixSingle(e,t-1),e<this._map.width-1&&this.fixSingle(e+1,t),t<this._map.height-1&&this.fixSingle(e,t+1),e>0&&this.fixSingle(e-1,t)}checkBorder(e,t,i){let s;for(e-=1,t-=1,s=0;s<i;s++)this.fixZone(e+s,t-1);for(s=0;s<i;s++)this.fixZone(e-1,t+s);for(s=0;s<i;s++)this.fixZone(e+s,t+i);for(s=0;s<i;s++)this.fixZone(e+i,t+s)}}class BuildingTool extends BaseToolConnector{constructor(e,t,i,s,a){super(),this.init(e,i,!1),this.centreTile=t,this.size=s,this.animated=a}putBuilding(e,t){let i,s,a,o,l=this.centreTile-this.size-1;for(let r=0;r<this.size;r++){s=t+r;for(let t=0;t<this.size;t++)i=e+t,a=l,o=Tile.BNCNBIT,1===t&&(1===r?o|=Tile.ZONEBIT:2===r&&this.animated&&(o|=Tile.ANIMBIT)),this._worldEffects.setTile(i,s,a,o),l++}}prepareBuildingSite(e,t){if(e<0||e+this.size>this._map.width)return this.TOOLRESULT_FAILED;if(t<0||t+this.size>this._map.height)return this.TOOLRESULT_FAILED;let i,s,a;for(let o=0;o<this.size;o++){s=t+o;for(let t=0;t<this.size;t++)if(i=e+t,a=this._worldEffects.getTileValue(i,s),a!==Tile.DIRT){if(!this.autoBulldoze)return this.TOOLRESULT_NEEDS_BULLDOZE;if(!ZoneUtils.canBulldoze(a))return this.TOOLRESULT_NEEDS_BULLDOZE;this._worldEffects.setTile(i,s,Tile.DIRT),this.addCost(this.bulldozerCost)}}return this.TOOLRESULT_OK}buildBuilding(e,t){e--,t--;let i=this.prepareBuildingSite(e,t);return i!==this.TOOLRESULT_OK?i:(this.addCost(this.toolCost),this.putBuilding(e,t),this.checkBorder(e,t),this.TOOLRESULT_OK)}doTool(e,t,i){this.result=this.buildBuilding(e,t)}}class BulldozerTool extends BaseToolConnector{constructor(e){super(),this.init(10,e,!0)}putRubble(e,t,i){for(let s=e;s<e+i;s++)for(let e=t;e<t+i;e++)if(this._map.testBounds(s,e)){let t=this._worldEffects.getTile(s,e);t!==Tile.RADTILE&&t!==Tile.DIRT&&this._worldEffects.setTile(s,e,Tile.TINYEXP+math.getRandom(2),Tile.ANIMBIT|Tile.BULLBIT)}}layDoze(e,t){let i=this._worldEffects.getTile(e,t);if(!i.isBulldozable())return this.TOOLRESULT_FAILED;switch(i=i.getValue(),i=ZoneUtils.normalizeRoad(i),i){case Tile.HBRIDGE:case Tile.VBRIDGE:case Tile.BRWV:case Tile.BRWH:case Tile.HBRDG0:case Tile.HBRDG1:case Tile.HBRDG2:case Tile.HBRDG3:case Tile.VBRDG0:case Tile.VBRDG1:case Tile.VBRDG2:case Tile.VBRDG3:case Tile.HPOWER:case Tile.VPOWER:case Tile.HRAIL:case Tile.VRAIL:this._worldEffects.setTile(e,t,Tile.RIVER);break;default:this._worldEffects.setTile(e,t,Tile.DIRT);break}return this.addCost(1),this.TOOLRESULT_OK}doTool(e,t,i,s){this._map.testBounds(e,t)||(this.result=this.TOOLRESULT_FAILED);let a,o,l,r=this._worldEffects.getTile(e,t),n=r.getValue(),h=0;if(r.isZone())h=ZoneUtils.checkZoneSize(n),a=0,o=0;else{let e=ZoneUtils.checkBigZone(n);h=e.zoneSize,a=e.deltaX,o=e.deltaY}if(h>0){this.addCost(this.bulldozerCost),this._map.powered({v:1,x:e,y:t});let i=e+a,s=t+o;switch(h){case 3:this.putRubble(i-1,s-1,3);break;case 4:this.putRubble(i-1,s-1,4);break;case 6:this.putRubble(i-1,s-1,6);break}this.result=this.TOOLRESULT_OK}n===Tile.RIVER||n===Tile.REDGE||n===Tile.CHANNEL?(l=this.layDoze(e,t),n!==this._worldEffects.getTileValue(e,t)&&this.addCost(5)):(l=this.layDoze(e,t),this.checkZoneConnections(e,t)),this.result=l}}class ParkTool extends BaseTool{constructor(e){super(),this.init(10,e,!0)}doTool(e,t,i){if(this._worldEffects.getTileValue(e,t)!==Tile.DIRT)return void(this.result=this.TOOLRESULT_NEEDS_BULLDOZE);let s,a=math.getRandom(4),o=Tile.BURNBIT|Tile.BULLBIT;4===a?(s=Tile.FOUNTAIN,o|=Tile.ANIMBIT):s=a+Tile.WOODS2,this._worldEffects.setTile(e,t,s,o),this.addCost(10),this.result=this.TOOLRESULT_OK}}class RailTool extends BaseToolConnector{constructor(e){super(),this.init(20,e,!0,!0)}layRail(e,t){this.doAutoBulldoze(e,t);let i=this.toolCost,s=this._worldEffects.getTileValue(e,t);switch(s=ZoneUtils.normalizeRoad(s),s){case Tile.DIRT:this._worldEffects.setTile(e,t,Tile.LHRAIL|Tile.BULLBIT|Tile.BURNBIT);break;case Tile.RIVER:case Tile.REDGE:case Tile.CHANNEL:if(i=100,e<this._map.width-1&&(s=this._worldEffects.getTileValue(e+1,t),s=ZoneUtils.normalizeRoad(s),s==Tile.RAILHPOWERV||s==Tile.HRAIL||s>=Tile.LHRAIL&&s<=Tile.HRAILROAD)){this._worldEffects.setTile(e,t,Tile.HRAIL,Tile.BULLBIT);break}if(e>0&&(s=this._worldEffects.getTileValue(e-1,t),s=ZoneUtils.normalizeRoad(s),s==Tile.RAILHPOWERV||s==Tile.HRAIL||s>Tile.VRAIL&&s<Tile.VRAILROAD)){this._worldEffects.setTile(e,t,Tile.HRAIL,Tile.BULLBIT);break}if(t<this._map.height-1&&(s=this._worldEffects.getTileValue(e,t+1),s=ZoneUtils.normalizeRoad(s),s==Tile.RAILVPOWERH||s==Tile.VRAILROAD||s>Tile.HRAIL&&s<Tile.HRAILROAD)){this._worldEffects.setTile(e,t,Tile.VRAIL,Tile.BULLBIT);break}if(t>0&&(s=this._worldEffects.getTileValue(e,t-1),s=ZoneUtils.normalizeRoad(s),s==Tile.RAILVPOWERH||s==Tile.VRAILROAD||s>Tile.HRAIL&&s<Tile.HRAILROAD)){this._worldEffects.setTile(e,t,Tile.VRAIL,Tile.BULLBIT);break}return this.TOOLRESULT_FAILED;case Tile.LHPOWER:this._worldEffects.setTile(e,t,Tile.RAILVPOWERH,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.LVPOWER:this._worldEffects.setTile(e,t,Tile.RAILHPOWERV,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.ROADS:this._worldEffects.setTile(e,t,Tile.VRAILROAD,Tile.BURNBIT|Tile.BULLBIT);break;case Tile.ROADS2:this._worldEffects.setTile(e,t,Tile.HRAILROAD,Tile.BURNBIT|Tile.BULLBIT);break;default:return this.TOOLRESULT_FAILED}return this.addCost(i),this.checkZoneConnections(e,t),this.TOOLRESULT_OK}doTool(e,t,i){this.result=this.layRail(e,t)}}class RoadTool extends BaseToolConnector{constructor(e){super(),this.init(10,e,!0,!0)}layRoad(e,t){this.doAutoBulldoze(e,t);let i=this._worldEffects.getTileValue(e,t),s=this.toolCost;switch(i){case Tile.DIRT:this._worldEffects.setTile(e,t,Tile.ROADS,Tile.BULLBIT|Tile.BURNBIT);break;case Tile.RIVER:case Tile.REDGE:case Tile.CHANNEL:if(s=50,e<this._map.width-1&&(i=this._worldEffects.getTileValue(e+1,t),i=ZoneUtils.normalizeRoad(i),i===Tile.VRAILROAD||i===Tile.HBRIDGE||i>=Tile.ROADS&&i<=Tile.HROADPOWER)){this._worldEffects.setTile(e,t,Tile.HBRIDGE,Tile.BULLBIT);break}if(e>0&&(i=this._worldEffects.getTileValue(e-1,t),i=ZoneUtils.normalizeRoad(i),i===Tile.VRAILROAD||i===Tile.HBRIDGE||i>=Tile.ROADS&&i<=Tile.INTERSECTION)){this._worldEffects.setTile(e,t,Tile.HBRIDGE,Tile.BULLBIT);break}if(t<this._map.height-1&&(i=this._worldEffects.getTileValue(e,t+1),i=ZoneUtils.normalizeRoad(i),i===Tile.HRAILROAD||i===Tile.VROADPOWER||i>=Tile.VBRIDGE&&i<=Tile.INTERSECTION)){this._worldEffects.setTile(e,t,Tile.VBRIDGE,Tile.BULLBIT);break}if(t>0&&(i=this._worldEffects.getTileValue(e,t-1),i=ZoneUtils.normalizeRoad(i),i===Tile.HRAILROAD||i===Tile.VROADPOWER||i>=Tile.VBRIDGE&&i<=Tile.INTERSECTION)){this._worldEffects.setTile(e,t,Tile.VBRIDGE,Tile.BULLBIT);break}return this.TOOLRESULT_FAILED;case Tile.LHPOWER:this._worldEffects.setTile(e,t,Tile.VROADPOWER|Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.LVPOWER:this._worldEffects.setTile(e,t,Tile.HROADPOWER|Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.LHRAIL:this._worldEffects.setTile(e,t,Tile.HRAILROAD|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.LVRAIL:this._worldEffects.setTile(e,t,Tile.VRAILROAD|Tile.BURNBIT|Tile.BULLBIT);break;default:return this.TOOLRESULT_FAILED}return this.addCost(s),this.checkZoneConnections(e,t),this.TOOLRESULT_OK}doTool=function(e,t,i){this.result=this.layRoad(e,t)}}class QueryTool extends BaseTool{constructor(e){super(),this.init(0,e,!1,!1),this.txt=""}classifyPopulationDensity(e,t,i){var s=i.populationDensityMap.worldGet(e,t);s>>=6,s&=3,this.txt+="Density: "+TXT.densityStrings[s]+"<br>"}classifyLandValue(e,t,i){var s=i.landValueMap.worldGet(e,t),a=0;s>=150?a=3:s>=80?a=2:s>=30&&(a=1),this.txt+="Value: "+TXT.landValueStrings[a]+"<br>"}classifyCrime(e,t,i){var s=i.crimeRateMap.worldGet(e,t);s>>=6,s&=3,this.txt+="Crime: "+TXT.crimeStrings[s]+"<br>"}classifyPollution(e,t,i){var s=i.pollutionDensityMap.worldGet(e,t);s>>=6,s&=3,this.txt+="Pollution: "+TXT.pollutionStrings[s]+"<br>"}classifyRateOfGrowth(e,t,i){var s=i.rateOfGrowthMap.worldGet(e,t);s>>=6,s&=3,this.txt+="Growth: "+TXT.rateStrings[s]}classifyDebug(e,t,i){}classifyZone(e,t){var i=[Tile.DIRT,Tile.RIVER,Tile.TREEBASE,Tile.RUBBLE,Tile.FLOOD,Tile.RADTILE,Tile.FIRE,Tile.ROADBASE,Tile.POWERBASE,Tile.RAILBASE,Tile.RESBASE,Tile.COMBASE,Tile.INDBASE,Tile.PORTBASE,Tile.AIRPORTBASE,Tile.COALBASE,Tile.FIRESTBASE,Tile.POLICESTBASE,Tile.STADIUMBASE,Tile.NUCLEARBASE,Tile.HBRDG0,Tile.RADAR0,Tile.FOUNTAIN,Tile.INDBASE2,Tile.FOOTBALLGAME1,Tile.VBRDG0,952],s=this._map.getTileValue(e,t);s>=Tile.COALSMOKE1&&s<Tile.FOOTBALLGAME1&&(s=Tile.COALBASE);var a,o=0;for(o=0,a=i.length-1;o<a&&!(s<i[o+1]);o++);this.txt="Zone: "+TXT.zoneTypes[o]+"<br>"}getInfo(){return this.txt}doTool(e,t,i,s){this._map.getTileValue(e,t),this._map.getTile(e,t),this.classifyZone(e,t),this.classifyPopulationDensity(e,t,i),this.classifyLandValue(e,t,i),this.classifyCrime(e,t,i),this.classifyPollution(e,t,i),this.classifyRateOfGrowth(e,t,i),this.classifyDebug(e,t,i),s.sendMessage(Messages.QUERY_WINDOW_NEEDED),this.result=this.TOOLRESULT_OK}}class WireTool extends BaseToolConnector{constructor(e){super(),this.init(5,e,!0,!0)}layWire(e,t){this.doAutoBulldoze(e,t);let i=5,s=this._worldEffects.getTileValue(e,t);switch(s=ZoneUtils.normalizeRoad(s),s){case Tile.DIRT:this._worldEffects.setTile(e,t,Tile.LHPOWER,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.RIVER:case Tile.REDGE:case Tile.CHANNEL:if(i=25,e<this._map.width-1&&(s=this._worldEffects.getTile(e+1,t),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!=Tile.HROADPOWER&&s!=Tile.RAILHPOWERV&&s!=Tile.HPOWER))){this._worldEffects.setTile(e,t,Tile.VPOWER,Tile.CONDBIT|Tile.BULLBIT);break}if(e>0&&(s=this._worldEffects.getTile(e-1,t),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!=Tile.HROADPOWER&&s!=Tile.RAILHPOWERV&&s!=Tile.HPOWER))){this._worldEffects.setTile(e,t,Tile.VPOWER,Tile.CONDBIT|Tile.BULLBIT);break}if(t<this._map.height-1&&(s=this._worldEffects.getTile(e,t+1),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!=Tile.VROADPOWER&&s!=Tile.RAILVPOWERH&&s!=Tile.VPOWER))){this._worldEffects.setTile(e,t,Tile.HPOWER,Tile.CONDBIT|Tile.BULLBIT);break}if(t>0&&(s=this._worldEffects.getTile(e,t-1),s.isConductive()&&(s=s.getValue(),s=ZoneUtils.normalizeRoad(s),s!=Tile.VROADPOWER&&s!=Tile.RAILVPOWERH&&s!=Tile.VPOWER))){this._worldEffects.setTile(e,t,Tile.HPOWER,Tile.CONDBIT|Tile.BULLBIT);break}return this.TOOLRESULT_FAILED;case Tile.ROADS:this._worldEffects.setTile(e,t,Tile.HROADPOWER,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.ROADS2:this._worldEffects.setTile(e,t,Tile.VROADPOWER,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.LHRAIL:this._worldEffects.setTile(e,t,Tile.RAILHPOWERV,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;case Tile.LVRAIL:this._worldEffects.setTile(e,t,Tile.RAILVPOWERH,Tile.CONDBIT|Tile.BURNBIT|Tile.BULLBIT);break;default:return this.TOOLRESULT_FAILED}return this.addCost(i),this.checkZoneConnections(e,t),this.TOOLRESULT_OK}doTool(e,t,i){this.result=this.layWire(e,t)}}const postMessage=self.webkitPostMessage||self.postMessage;var Game,returnMessage,isWorker=!0,trans=!1;self.onmessage=function(e){CityGame.message(e)};class CityGame{static message(e){var t=e.data.tell;"INIT"==t&&(e.data.returnMessage&&(returnMessage=e.data.returnMessage,isWorker=!1),Game=new MainGame(e.data.timestep)),"NEWMAP"==t&&Game.newMap(),"PLAYMAP"==t&&Game.playMap(),"TOOL"==t&&Game.tool(e.data.name),"MAPCLICK"==t&&Game.mapClick(e.data.x,e.data.y,e.data.single||!1),"DIFFICULTY"==t&&Game.changeDifficulty(e.data.n),"SPEED"==t&&Game.changeSpeed(e.data.n),"BUDGET"==t&&Game.handleBudgetRequest(),"NEWBUDGET"==t&&Game.setBudget(e.data.budgetData),"DISASTER"==t&&Game.setDisaster(e.data.disaster),"EVAL"==t&&Game.getEvaluation(),"SAVEGAME"==t&&Game.saveGame(e.data.saveCity),"LOADGAME"==t&&Game.loadGame(e.data.isStart),"MAKELOADGAME"==t&&Game.makeLoadGame(e.data.savegame,e.data.isStart)}static post(e,t){isWorker?postMessage(e,t):returnMessage({data:e})}}var update=function(){Game.tick()};class MainGame{constructor(e){this.timestep=e,this.mapSize=[128,128],this.difficulty=1,this.speed=2,this.oldSpeed=0,this.mapGen=new MapGenerator,this.simulation=null,this.gameTools=null,this.animationManager=null,this.map=null,this.isPaused=!1,this.simNeededBudget=!1,this.currentTool=null,this.timer=null,this.infos=[],this.sprites=[],this.spritesData=null,this.animsData=null,this.spritesData=[],this.power=null,CityGame.post({tell:"READY"})}next(e=0){this.timer=setTimeout(update,e)}stop(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)}tick(){this.simulation.simTick()&&(this.infos=this.simulation.infos,this.processMessages(Game.simulation.messageManager.getMessages()),this.animatedTiles(),this.simulation.spriteManager.moveObjects(),this.calculateSprites(),CityGame.post({tell:"RUN",infos:this.infos,tilesData:this.map.tilesData,powerData:this.map.powerData,sprites:this.spritesData,layer:this.map.layer}),this.map.resetLayer()),this.next()}newMap(){this.map=this.mapGen.construct(this.mapSize[0],this.mapSize[1]),CityGame.post({tell:"NEWMAP",tilesData:this.map.tilesData,mapSize:this.mapSize,island:this.map.isIsland,trans:trans})}playMap(e){var t=new MessageManager,i=2e4;1==this.difficulty&&(i=1e4),2==this.difficulty&&(i=5e3),this.gameTools={airport:new BuildingTool(1e4,Tile.AIRPORT,this.map,6,!1),bulldozer:new BulldozerTool(this.map),coal:new BuildingTool(3e3,Tile.POWERPLANT,this.map,4,!1),commercial:new BuildingTool(100,Tile.COMCLR,this.map,3,!1),fire:new BuildingTool(500,Tile.FIRESTATION,this.map,3,!1),industrial:new BuildingTool(100,Tile.INDCLR,this.map,3,!1),nuclear:new BuildingTool(5e3,Tile.NUCLEAR,this.map,4,!0),park:new ParkTool(this.map),police:new BuildingTool(500,Tile.POLICESTATION,this.map,3,!1),port:new BuildingTool(3e3,Tile.PORT,this.map,4,!1),rail:new RailTool(this.map),residential:new BuildingTool(100,Tile.FREEZ,this.map,3,!1),road:new RoadTool(this.map),query:new QueryTool(this.map),stadium:new BuildingTool(5e3,Tile.STADIUM,this.map,4,!1),wire:new WireTool(this.map)},this.animationManager=new AnimationManager(this.map),e?(i=this.savedGame.totalFunds,this.speed=this.savedGame.speed,this.difficulty=this.savedGame.difficulty,this.simulation=new Simulation(this.map,this.difficulty,this.speed,!0,this.savedGame),t.sendMessage(Messages.WELCOMEBACK)):(this.simulation=new Simulation(this.map,this.difficulty,this.speed,!0),t.sendMessage(Messages.WELCOME)),this.simulation.budget.setFunds(i),this.processMessages(t.getMessages()),this.isPaused=!1,this.tick()}changeSpeed(e){this.speed=e,this.simulation.setSpeed(this.speed),0===this.speed?(this.isPaused=!0,this.stop()):this.isPaused&&(this.isPaused=!1,this.stop(),this.tick())}changeDifficulty(e){this.difficulty=e,this.simulation&&this.simulation.setDifficulty(this.difficulty)}animatedTiles(){var e=this.animationManager.getTiles(0,0,this.mapSize[0]+1,this.mapSize[1]+1,this.isPaused),t=e.length;for(this.animsData=new Micro.M_ARRAY_TYPE(t);t--;){var i=e[t];this.animsData[t]=[i.tileValue,i.x,i.y]}}calculateSprites(){this.sprites=this.simulation.spriteManager.getSpritesInView(0,0,this.mapSize[0]+1,this.mapSize[1]+1);for(var e=this.sprites.length;e--;){var t=this.sprites[e];this.spritesData[e]=[t.type,t.frame,t.x||0,t.y||0]}}processMessages(e){for(var t=!1,i=0,s=e.length;i<s;i++){var a=e[i];switch(a.message){case Messages.BUDGET_NEEDED:this.simNeededBudget=!0,this.handleBudgetRequest();break;case Messages.QUERY_WINDOW_NEEDED:CityGame.post({tell:"QUERY",queryTxt:this.currentTool.getInfo()});break;default:if(!t&&void 0!==TXT.goodMessages[a.message]){this.infos[8]=TXT.goodMessages[a.message];break}if(!t&&void 0!==TXT.badMessages[a.message]){t=!0,this.infos[8]=TXT.badMessages[a.message];break}if(!t&&void 0!==TXT.neutralMessages[a.message]){t=!0,this.infos[8]=TXT.neutralMessages[a.message];break}}}}tool(e){null!==this.currentTool&&this.currentTool.clear(),this.currentTool="none"!==e?this.gameTools[e]:null}destroy(e,t){}findId(e,t){return e+t*this.mapSize[1]}mapClick(e,t,i){if(null!==this.currentTool){var s=this.simulation.budget;this.simulation.evaluation;var a=new MessageManager;switch(this.currentTool.doTool(e,t,this.simulation.blockMaps,a),this.currentTool.modifyIfEnoughFunding(s,a),this.currentTool.result){case this.currentTool.TOOLRESULT_NEEDS_BULLDOZE:TXT.toolMessages.needsDoze;break;case this.currentTool.TOOLRESULT_NO_MONEY:TXT.toolMessages.noMoney;break;default:i||CityGame.post({tell:"BUILD",x:e,y:t});break}this.processMessages(a.getMessages())}}setDisaster(e){if(e!==Micro.DISASTER_NONE){var t=new MessageManager;switch(e){case Micro.DISASTER_MONSTER:this.simulation.spriteManager.makeMonster(t);break;case Micro.DISASTER_FIRE:this.simulation.disasterManager.makeFire(t);break;case Micro.DISASTER_FLOOD:this.simulation.disasterManager.makeFlood(t);break;case Micro.DISASTER_CRASH:this.simulation.disasterManager.makeCrash(t);break;case Micro.DISASTER_MELTDOWN:this.simulation.disasterManager.makeMeltdown(t);break;case Micro.DISASTER_TORNADO:this.simulation.spriteManager.makeTornado(t);break}this.processMessages(t.getMessages())}}setBudget(e){this.simulation.budget.cityTax=e[0],this.simulation.budget.roadPercent=e[1]/100,this.simulation.budget.firePercent=e[2]/100,this.simulation.budget.policePercent=e[3]/100}handleBudgetRequest(){this.budgetShowing=!0;let e={roadFund:this.simulation.budget.roadFund,roadRate:Math.floor(100*this.simulation.budget.roadPercent),fireFund:this.simulation.budget.fireFund,fireRate:Math.floor(100*this.simulation.budget.firePercent),policeFund:this.simulation.budget.policeFund,policeRate:Math.floor(100*this.simulation.budget.policePercent),taxRate:this.simulation.budget.cityTax,totalFunds:this.simulation.budget.totalFunds,taxesCollected:this.simulation.budget.taxFund};CityGame.post({tell:"BUDGET",budgetData:e}),this.simNeededBudget?(this.simulation.budget.doBudgetWindow(),this.simNeededBudget=!1):this.simulation.budget.updateFundEffects()}getEvaluation(){let e=this.simulation.evaluation,t="";for(var i=0;i<4;i++){let s=e.getProblemNumber(i),a="";-1!==s&&(a=TXT.problems[s]),t+=a+"<br>"}let s=[e.cityYes,t];CityGame.post({tell:"EVAL",evalData:s})}saveGame(e){let t={name:"Yoooooo",everClicked:!0};t.speed=this.speed,t.difficulty=this.difficulty,t.version=Micro.CURRENT_VERSION,t.city=e,this.simulation.save(t),t=JSON.stringify(t),CityGame.post({tell:"SAVEGAME",gameData:t,key:Micro.KEY})}loadGame(e){var t=e||!1;CityGame.post({tell:"LOADGAME",key:Micro.KEY,isStart:t})}makeLoadGame(e,t){let i=t||!1;clearInterval(this.timer),this.savedGame=JSON.parse(e),this.map=new GameMap(Micro.MAP_WIDTH,Micro.MAP_HEIGHT),this.map.load(this.savedGame),CityGame.post({tell:"FULLREBUILD",tilesData:this.map.tilesData,mapSize:this.mapSize,island:this.map.isIsland,cityData:this.savedGame.city,isStart:i})}transitionOldSave(e){switch(e.version){case 1:e.everClicked=!1;case 2:e.pollutionMaxX=Math.floor(e.width/2),e.pollutionMaxY=Math.floor(e.height/2),e.cityCentreX=Math.floor(e.width/2),e.cityCentreY=Math.floor(e.height/2);break}}}export{CityGame,MainGame};