var scene,camera,fieldOfView,aspectRatio,nearPlane,farPlane,gobalLight,shadowLight,backLight,renderer,container,controls,clock,levelInterval,fieldGameOver,fieldDistance,HEIGHT,WIDTH,windowHalfX,windowHalfY,hero,delta=0,floorRadius=200,speed=6,distance=0,level=1,levelUpdateFreq=3e3,initSpeed=5,maxSpeed=48,monsterPos=.65,monsterPosTarget=.65,floorRotation=0,collisionObstacle=10,collisionBonus=20,gameStatus="play",cameraPosGame=160,cameraPosGameOver=260,monsterAcceleration=.004,malusClearColor=11815737,malusClearAlpha=0,audio=new Audio("./Antonio-Vivaldi-Summer_01.mp3"),mousePos={x:0,y:0},blackMat=new THREE.MeshPhongMaterial({color:1050375,shading:THREE.FlatShading}),brownMat=new THREE.MeshPhongMaterial({color:11815737,shininess:0,shading:THREE.FlatShading}),greenMat=new THREE.MeshPhongMaterial({color:8044430,shininess:0,shading:THREE.FlatShading}),pinkMat=new THREE.MeshPhongMaterial({color:14442309,shininess:0,shading:THREE.FlatShading}),lightBrownMat=new THREE.MeshPhongMaterial({color:14711383,shading:THREE.FlatShading}),whiteMat=new THREE.MeshPhongMaterial({color:10786697,shading:THREE.FlatShading}),skinMat=new THREE.MeshPhongMaterial({color:16752293,shading:THREE.FlatShading}),PI=Math.PI;function initScreenAnd3D(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,windowHalfX=WIDTH/2,windowHalfY=HEIGHT/2,(scene=new THREE.Scene).fog=new THREE.Fog(14084838,160,350),aspectRatio=WIDTH/HEIGHT,fieldOfView=50,nearPlane=1,farPlane=2e3,(camera=new THREE.PerspectiveCamera(fieldOfView,aspectRatio,nearPlane,farPlane)).position.x=0,camera.position.z=cameraPosGame,camera.position.y=30,camera.lookAt(new THREE.Vector3(0,30,0)),(renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0})).setPixelRatio(window.devicePixelRatio),renderer.setClearColor(malusClearColor,malusClearAlpha),renderer.setSize(WIDTH,HEIGHT),renderer.shadowMap.enabled=!0,(container=document.getElementById("world")).appendChild(renderer.domElement),window.addEventListener("resize",handleWindowResize,!1),document.addEventListener("mousedown",handleMouseDown,!1),document.addEventListener("touchend",handleMouseDown,!1),clock=new THREE.Clock}function handleWindowResize(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,windowHalfX=WIDTH/2,windowHalfY=HEIGHT/2,renderer.setSize(WIDTH,HEIGHT),camera.aspect=WIDTH/HEIGHT,camera.updateProjectionMatrix()}function handleMouseDown(t){"play"==gameStatus?hero.jump():"readyToReplay"==gameStatus&&replay()}function createLights(){globalLight=new THREE.AmbientLight(16777215,.9),(shadowLight=new THREE.DirectionalLight(16777215,1)).position.set(-30,40,20),shadowLight.castShadow=!0,shadowLight.shadow.camera.left=-400,shadowLight.shadow.camera.right=400,shadowLight.shadow.camera.top=400,shadowLight.shadow.camera.bottom=-400,shadowLight.shadow.camera.near=1,shadowLight.shadow.camera.far=2e3,shadowLight.shadow.mapSize.width=shadowLight.shadow.mapSize.height=2048,scene.add(globalLight),scene.add(shadowLight)}function createFloor(){floorShadow=new THREE.Mesh(new THREE.SphereGeometry(floorRadius,50,50),new THREE.MeshPhongMaterial({color:8044430,specular:0,shininess:1,transparent:!0,opacity:.5})),floorShadow.receiveShadow=!0,floorGrass=new THREE.Mesh(new THREE.SphereGeometry(floorRadius-.5,50,50),new THREE.MeshBasicMaterial({color:8044430})),floorGrass.receiveShadow=!1,floor=new THREE.Group,floor.position.y=-floorRadius,floor.add(floorShadow),floor.add(floorGrass),scene.add(floor)}function removeParticle(t){t.visible=!1}function createHero(){(hero=new Hero).mesh.rotation.y=Math.PI/2,scene.add(hero.mesh),hero.nod()}function createMonster(){monster=new Monster,monster.mesh.position.z=20,scene.add(monster.mesh),updateMonsterPosition()}function updateMonsterPosition(){monster.run(),(monsterPos+=((monsterPosTarget-=delta*monsterAcceleration)-monsterPos)*delta)<.56&&gameOver();var t=Math.PI*monsterPos;monster.mesh.position.y=-floorRadius+Math.sin(t)*(floorRadius+12),monster.mesh.position.x=Math.cos(t)*(floorRadius+15),monster.mesh.rotation.z=-Math.PI/2+t}function gameOver(){fieldGameOver.className="show",gameStatus="gameOver",monster.sit(),hero.hang(),monster.heroHolder.add(hero.mesh),TweenMax.to(this,1,{speed:0}),TweenMax.to(camera.position,3,{z:cameraPosGameOver,y:60,x:-30}),carrot.mesh.visible=!1,obstacle.mesh.visible=!1,clearInterval(levelInterval)}function replay(){gameStatus="preparingToReplay",fieldGameOver.className="",TweenMax.killTweensOf(monster.pawFL.position),TweenMax.killTweensOf(monster.pawFR.position),TweenMax.killTweensOf(monster.pawBL.position),TweenMax.killTweensOf(monster.pawBR.position),TweenMax.killTweensOf(monster.pawFL.rotation),TweenMax.killTweensOf(monster.pawFR.rotation),TweenMax.killTweensOf(monster.pawBL.rotation),TweenMax.killTweensOf(monster.pawBR.rotation),TweenMax.killTweensOf(monster.tail.rotation),TweenMax.killTweensOf(monster.head.rotation),TweenMax.killTweensOf(monster.eyeL.scale),TweenMax.killTweensOf(monster.eyeR.scale),monster.tail.rotation.y=0,TweenMax.to(camera.position,3,{z:cameraPosGame,x:0,y:30,ease:Power4.easeInOut}),TweenMax.to(monster.torso.rotation,2,{x:0,ease:Power4.easeInOut}),TweenMax.to(monster.torso.position,2,{y:0,ease:Power4.easeInOut}),TweenMax.to(monster.pawFL.rotation,2,{x:0,ease:Power4.easeInOut}),TweenMax.to(monster.pawFR.rotation,2,{x:0,ease:Power4.easeInOut}),TweenMax.to(monster.mouth.rotation,2,{x:.5,ease:Power4.easeInOut}),TweenMax.to(monster.head.rotation,2,{y:0,x:-.3,ease:Power4.easeInOut}),TweenMax.to(hero.mesh.position,2,{x:20,ease:Power4.easeInOut}),TweenMax.to(hero.head.rotation,2,{x:0,y:0,ease:Power4.easeInOut}),TweenMax.to(monster.mouth.rotation,2,{x:.2,ease:Power4.easeInOut}),TweenMax.to(monster.mouth.rotation,1,{x:.4,ease:Power4.easeIn,delay:1,onComplete:function(){resetGame()}})}Hero=function(){this.status="running",this.runningCycle=0,this.mesh=new THREE.Group,this.body=new THREE.Group,this.mesh.add(this.body);var t=new THREE.CubeGeometry(7,7,10,1);this.torso=new THREE.Mesh(t,brownMat),this.torso.position.z=0,this.torso.position.y=7,this.torso.castShadow=!0,this.body.add(this.torso);var e=new THREE.CubeGeometry(9,9,5,1);this.pants=new THREE.Mesh(e,whiteMat),this.pants.position.z=-3,this.pants.position.y=0,this.pants.castShadow=!0,this.torso.add(this.pants);var a=new THREE.CubeGeometry(3,3,3,1);a.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,-2)),this.tail=new THREE.Mesh(a,lightBrownMat),this.tail.position.z=-4,this.tail.position.y=5,this.tail.castShadow=!0,this.torso.add(this.tail),this.torso.rotation.x=-Math.PI/8;var o=new THREE.CubeGeometry(10,10,13,1);o.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,7.5)),this.head=new THREE.Mesh(o,brownMat),this.head.position.z=2,this.head.position.y=11,this.head.castShadow=!0,this.body.add(this.head);var i=new THREE.CubeGeometry(1,4,4,1);this.cheekR=new THREE.Mesh(i,pinkMat),this.cheekR.position.x=-5,this.cheekR.position.z=7,this.cheekR.position.y=-2.5,this.cheekR.castShadow=!0,this.head.add(this.cheekR),this.cheekL=this.cheekR.clone(),this.cheekL.position.x=-this.cheekR.position.x,this.head.add(this.cheekL);var s=new THREE.CubeGeometry(6,6,3,1);this.nose=new THREE.Mesh(s,lightBrownMat),this.nose.position.z=13.5,this.nose.position.y=2.6,this.nose.castShadow=!0,this.head.add(this.nose);var n=new THREE.CubeGeometry(4,2,4,1);n.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,3)),n.applyMatrix((new THREE.Matrix4).makeRotationX(Math.PI/12)),this.mouth=new THREE.Mesh(n,brownMat),this.mouth.position.z=8,this.mouth.position.y=-4,this.mouth.castShadow=!0,this.head.add(this.mouth);var h=new THREE.CubeGeometry(3,3,3,1);this.pawFR=new THREE.Mesh(h,lightBrownMat),this.pawFR.position.x=-2,this.pawFR.position.z=6,this.pawFR.position.y=1.5,this.pawFR.castShadow=!0,this.body.add(this.pawFR),this.pawFL=this.pawFR.clone(),this.pawFL.position.x=-this.pawFR.position.x,this.pawFL.castShadow=!0,this.body.add(this.pawFL);var r=new THREE.CubeGeometry(3,3,6,1);this.pawBL=new THREE.Mesh(r,lightBrownMat),this.pawBL.position.y=1.5,this.pawBL.position.z=0,this.pawBL.position.x=5,this.pawBL.castShadow=!0,this.body.add(this.pawBL),this.pawBR=this.pawBL.clone(),this.pawBR.position.x=-this.pawBL.position.x,this.pawBR.castShadow=!0,this.body.add(this.pawBR);var d=new THREE.CubeGeometry(7,18,2,1);d.vertices[6].x+=2,d.vertices[6].z+=.5,d.vertices[7].x+=2,d.vertices[7].z-=.5,d.vertices[2].x-=2,d.vertices[2].z-=.5,d.vertices[3].x-=2,d.vertices[3].z+=.5,d.applyMatrix((new THREE.Matrix4).makeTranslation(0,9,0)),this.earL=new THREE.Mesh(d,brownMat),this.earL.position.x=2,this.earL.position.z=2.5,this.earL.position.y=5,this.earL.rotation.z=-Math.PI/12,this.earL.castShadow=!0,this.head.add(this.earL),this.earR=this.earL.clone(),this.earR.position.x=-this.earL.position.x,this.earR.rotation.z=-this.earL.rotation.z,this.earR.castShadow=!0,this.head.add(this.earR);var l=new THREE.CubeGeometry(2,4,4);this.eyeL=new THREE.Mesh(l,whiteMat),this.eyeL.position.x=5,this.eyeL.position.z=5.5,this.eyeL.position.y=2.9,this.eyeL.castShadow=!0,this.head.add(this.eyeL);var w=new THREE.CubeGeometry(.6,2,2);this.iris=new THREE.Mesh(w,blackMat),this.iris.position.x=1.2,this.iris.position.y=1,this.iris.position.z=1,this.eyeL.add(this.iris),this.eyeR=this.eyeL.clone(),this.eyeR.children[0].position.x=-this.iris.position.x,this.eyeR.position.x=-this.eyeL.position.x,this.head.add(this.eyeR),this.body.traverse((function(t){t instanceof THREE.Mesh&&(t.castShadow=!0,t.receiveShadow=!0)}))},BonusParticles=function(){this.mesh=new THREE.Group;var t=new THREE.CubeGeometry(10,10,10,1),e=new THREE.CubeGeometry(5,5,5,1);this.parts=[];for(var a=0;a<10;a++){var o=new THREE.Mesh(t,pinkMat),i=new THREE.Mesh(e,greenMat);i.scale.set(.5,.5,.5),this.parts.push(o),this.parts.push(i),this.mesh.add(o),this.mesh.add(i)}},BonusParticles.prototype.explose=function(){for(var t=0;t<this.parts.length;t++){var e=100*Math.random()-50,a=100*Math.random()-50,o=100*Math.random()-50,i=this.parts[t];i.position.set(0,0,0),i.scale.set(1,1,1),i.visible=!0;var s=.5+.5*Math.random();TweenMax.to(i.position,s,{x:e,y:a,z:o,ease:Power4.easeOut}),TweenMax.to(i.scale,s,{x:.01,y:.01,z:.01,ease:Power4.easeOut,onComplete:removeParticle,onCompleteParams:[i]})}},Hero.prototype.run=function(){this.status="running";var t=Math.min(speed,maxSpeed);this.runningCycle+=delta*t*.7,this.runningCycle=this.runningCycle%(2*Math.PI);var e=this.runningCycle;this.body.position.y=6+4*Math.sin(e-Math.PI/2),this.body.rotation.x=.2+4*Math.sin(e-Math.PI/2)*.1,this.torso.rotation.x=4*Math.sin(e-Math.PI/2)*.1,this.torso.position.y=7+4*Math.sin(e-Math.PI/2)*.5,this.mouth.rotation.x=Math.PI/16+4*Math.cos(e)*.05,this.head.position.z=2+4*Math.sin(e-Math.PI/2)*.5,this.head.position.y=8+4*Math.cos(e-Math.PI/2)*.7,this.head.rotation.x=4*Math.sin(e+Math.PI)*.1-.2,this.earL.rotation.x=.8*Math.cos(-Math.PI/2+e),this.earR.rotation.x=1.2*Math.cos(-Math.PI/2+.2+e),this.eyeR.scale.y=this.eyeL.scale.y=.7+.6*Math.abs(Math.cos(-Math.PI/4+.5*e)),this.tail.rotation.x=4*Math.cos(Math.PI/2+e)*.3,this.pawFR.position.y=1.5+4*Math.sin(e),this.pawFR.rotation.x=Math.cos(e)*Math.PI/4,this.pawFR.position.z=6-4*Math.cos(e)*2,this.pawFL.position.y=1.5+4*Math.sin(.2+e),this.pawFL.rotation.x=Math.cos(e)*Math.PI/4,this.pawFL.position.z=6-4*Math.cos(.2+e)*2,this.pawBR.position.y=1.5+4*Math.sin(Math.PI+e),this.pawBR.rotation.x=Math.cos(e+1.5*Math.PI)*Math.PI/3,this.pawBR.position.z=4*-Math.cos(Math.PI+e),this.pawBL.position.y=1.5+4*Math.sin(Math.PI+e),this.pawBL.rotation.x=Math.cos(e+1.5*Math.PI)*Math.PI/3,this.pawBL.position.z=4*-Math.cos(Math.PI+e)},Hero.prototype.jump=function(){if("jumping"!=this.status){this.status="jumping";var t=this,e=10/speed;TweenMax.to(this.earL.rotation,e,{x:"+=.3",ease:Back.easeOut}),TweenMax.to(this.earR.rotation,e,{x:"-=.3",ease:Back.easeOut}),TweenMax.to(this.pawFL.rotation,e,{x:"+=.7",ease:Back.easeOut}),TweenMax.to(this.pawFR.rotation,e,{x:"-=.7",ease:Back.easeOut}),TweenMax.to(this.pawBL.rotation,e,{x:"+=.7",ease:Back.easeOut}),TweenMax.to(this.pawBR.rotation,e,{x:"-=.7",ease:Back.easeOut}),TweenMax.to(this.tail.rotation,e,{x:"+=1",ease:Back.easeOut}),TweenMax.to(this.mouth.rotation,e,{x:.5,ease:Back.easeOut}),TweenMax.to(this.mesh.position,e/2,{y:45,ease:Power2.easeOut}),TweenMax.to(this.mesh.position,e/2,{y:0,ease:Power4.easeIn,delay:e/2,onComplete:function(){t.status="running"}})}},Monster=function(){this.runningCycle=0,this.mesh=new THREE.Group,this.body=new THREE.Group;var t=new THREE.CubeGeometry(15,15,20,1);this.torso=new THREE.Mesh(t,blackMat);var e=new THREE.CubeGeometry(20,20,40,1);e.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,20)),this.head=new THREE.Mesh(e,blackMat),this.head.position.z=12,this.head.position.y=2;var a=new THREE.CubeGeometry(10,4,20,1);a.applyMatrix((new THREE.Matrix4).makeTranslation(0,-2,10)),this.mouth=new THREE.Mesh(a,blackMat),this.mouth.position.y=-8,this.mouth.rotation.x=.4,this.mouth.position.z=4,this.heroHolder=new THREE.Group,this.heroHolder.position.z=20,this.mouth.add(this.heroHolder);var o=new THREE.CubeGeometry(2,2,1,1);o.vertices[1].x-=1,o.vertices[4].x+=1,o.vertices[5].x+=1,o.vertices[0].x-=1;for(var i=0;i<3;i++){var s=new THREE.Mesh(o,whiteMat);s.position.x=2.5*i-2.8,s.position.y=1,s.position.z=19;var n=new THREE.Mesh(o,whiteMat);n.rotation.y=Math.PI/2,n.position.z=12+2.5*i,n.position.y=1,n.position.x=4;var h=n.clone();n.position.x=-4,this.mouth.add(s),this.mouth.add(n),this.mouth.add(h)}var r=new THREE.CubeGeometry(6,1,14);r.applyMatrix((new THREE.Matrix4).makeTranslation(0,0,7)),this.tongue=new THREE.Mesh(r,pinkMat),this.tongue.position.z=2,this.tongue.rotation.x=-.2,this.mouth.add(this.tongue);var d=new THREE.CubeGeometry(4,4,4,1);this.nose=new THREE.Mesh(d,pinkMat),this.nose.position.z=39.5,this.nose.position.y=9,this.head.add(this.nose),this.head.add(this.mouth);var l=new THREE.CubeGeometry(2,3,3);this.eyeL=new THREE.Mesh(l,whiteMat),this.eyeL.position.x=10,this.eyeL.position.z=5,this.eyeL.position.y=5,this.eyeL.castShadow=!0,this.head.add(this.eyeL);var w=new THREE.CubeGeometry(.6,1,1);this.iris=new THREE.Mesh(w,blackMat),this.iris.position.x=1.2,this.iris.position.y=-1,this.iris.position.z=1,this.eyeL.add(this.iris),this.eyeR=this.eyeL.clone(),this.eyeR.children[0].position.x=-this.iris.position.x,this.eyeR.position.x=-this.eyeL.position.x,this.head.add(this.eyeR);var p=new THREE.CubeGeometry(8,6,2,1);p.vertices[1].x-=4,p.vertices[4].x+=4,p.vertices[5].x+=4,p.vertices[5].z-=2,p.vertices[0].x-=4,p.vertices[0].z-=2,p.applyMatrix((new THREE.Matrix4).makeTranslation(0,3,0)),this.earL=new THREE.Mesh(p,blackMat),this.earL.position.x=6,this.earL.position.z=1,this.earL.position.y=10,this.earL.castShadow=!0,this.head.add(this.earL),this.earR=this.earL.clone(),this.earR.position.x=-this.earL.position.x,this.earR.rotation.z=-this.earL.rotation.z,this.head.add(this.earR);l=new THREE.CubeGeometry(2,4,4);var M=new THREE.CylinderGeometry(5,2,20,4,1);M.applyMatrix((new THREE.Matrix4).makeTranslation(0,10,0)),M.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),M.applyMatrix((new THREE.Matrix4).makeRotationZ(Math.PI/4)),this.tail=new THREE.Mesh(M,blackMat),this.tail.position.z=-10,this.tail.position.y=4,this.torso.add(this.tail);var c=new THREE.CylinderGeometry(1.5,0,10);c.applyMatrix((new THREE.Matrix4).makeTranslation(0,-5,0)),this.pawFL=new THREE.Mesh(c,blackMat),this.pawFL.position.y=-7.5,this.pawFL.position.z=8.5,this.pawFL.position.x=5.5,this.torso.add(this.pawFL),this.pawFR=this.pawFL.clone(),this.pawFR.position.x=-this.pawFL.position.x,this.torso.add(this.pawFR),this.pawBR=this.pawFR.clone(),this.pawBR.position.z=-this.pawFL.position.z,this.torso.add(this.pawBR),this.pawBL=this.pawBR.clone(),this.pawBL.position.x=this.pawFL.position.x,this.torso.add(this.pawBL),this.mesh.add(this.body),this.torso.add(this.head),this.body.add(this.torso),this.torso.castShadow=!0,this.head.castShadow=!0,this.pawFL.castShadow=!0,this.pawFR.castShadow=!0,this.pawBL.castShadow=!0,this.pawBR.castShadow=!0,this.body.rotation.y=Math.PI/2},Monster.prototype.run=function(){var t=Math.min(speed,maxSpeed);this.runningCycle+=delta*t*.7,this.runningCycle=this.runningCycle%(2*Math.PI);var e=this.runningCycle;this.pawFR.rotation.x=Math.sin(e)*Math.PI/4,this.pawFR.position.y=-5.5-Math.sin(e),this.pawFR.position.z=7.5+Math.cos(e),this.pawFL.rotation.x=Math.sin(e+.4)*Math.PI/4,this.pawFL.position.y=-5.5-Math.sin(e+.4),this.pawFL.position.z=7.5+Math.cos(e+.4),this.pawBL.rotation.x=Math.sin(e+2)*Math.PI/4,this.pawBL.position.y=-5.5-Math.sin(e+3.8),this.pawBL.position.z=-7.5+Math.cos(e+3.8),this.pawBR.rotation.x=Math.sin(e+2.4)*Math.PI/4,this.pawBR.position.y=-5.5-Math.sin(e+3.4),this.pawBR.position.z=-7.5+Math.cos(e+3.4),this.torso.rotation.x=Math.sin(e)*Math.PI/8,this.torso.position.y=3-3*Math.sin(e+Math.PI/2),this.head.rotation.x=.4*Math.sin(-e-1)-.1,this.mouth.rotation.x=.2+.4*Math.sin(e+Math.PI+.3),this.tail.rotation.x=.2+Math.sin(e-Math.PI/2),this.eyeR.scale.y=.5+.5*Math.sin(e+Math.PI)},Hero.prototype.nod=function(){var t=this,e=.5+Math.random(),a=-Math.PI/6+Math.random()*Math.PI/3;TweenMax.to(this.head.rotation,e,{y:a,ease:Power4.easeInOut,onComplete:function(){t.nod()}});var o=Math.PI/4+Math.random()*Math.PI/6,i=Math.PI/4+Math.random()*Math.PI/6;TweenMax.to(this.earL.rotation,e,{x:o,ease:Power4.easeInOut}),TweenMax.to(this.earR.rotation,e,{x:i,ease:Power4.easeInOut});var s=Math.random()*Math.PI/2,n=8*Math.random()-4;TweenMax.to(this.pawBL.rotation,e/2,{x:s,ease:Power1.easeInOut,yoyo:!0,repeat:2}),TweenMax.to(this.pawBL.position,e/2,{y:n,ease:Power1.easeInOut,yoyo:!0,repeat:2});var h=Math.random()*Math.PI/2,r=8*Math.random()-4;TweenMax.to(this.pawBR.rotation,e/2,{x:h,ease:Power1.easeInOut,yoyo:!0,repeat:2}),TweenMax.to(this.pawBR.position,e/2,{y:r,ease:Power1.easeInOut,yoyo:!0,repeat:2});var d=Math.random()*Math.PI/2,l=8*Math.random()-4;TweenMax.to(this.pawFL.rotation,e/2,{x:d,ease:Power1.easeInOut,yoyo:!0,repeat:2}),TweenMax.to(this.pawFL.position,e/2,{y:l,ease:Power1.easeInOut,yoyo:!0,repeat:2});var w=Math.random()*Math.PI/2,p=8*Math.random()-4;TweenMax.to(this.pawFR.rotation,e/2,{x:w,ease:Power1.easeInOut,yoyo:!0,repeat:2}),TweenMax.to(this.pawFR.position,e/2,{y:p,ease:Power1.easeInOut,yoyo:!0,repeat:2});var M=Math.random()*Math.PI/8;TweenMax.to(this.mouth.rotation,e,{x:M,ease:Power1.easeInOut});var c=2*Math.random()-1,m=2*Math.random()-1,y=this.iris,E=this.eyeR.children[0];TweenMax.to([y.position,E.position],e,{y:c,z:m,ease:Power1.easeInOut}),Math.random()>.2&&TweenMax.to([this.eyeR.scale,this.eyeL.scale],e/8,{y:0,ease:Power1.easeInOut,yoyo:!0,repeat:1})},Hero.prototype.hang=function(){var t=this,e=Power4.easeOut;TweenMax.killTweensOf(this.eyeL.scale),TweenMax.killTweensOf(this.eyeR.scale),this.body.rotation.x=0,this.torso.rotation.x=0,this.body.position.y=0,this.torso.position.y=7,TweenMax.to(this.mesh.rotation,1,{y:0,ease:e}),TweenMax.to(this.mesh.position,1,{y:-7,z:6,ease:e}),TweenMax.to(this.head.rotation,1,{x:Math.PI/6,ease:e,onComplete:function(){t.nod()}}),TweenMax.to(this.earL.rotation,1,{x:Math.PI/3,ease:e}),TweenMax.to(this.earR.rotation,1,{x:Math.PI/3,ease:e}),TweenMax.to(this.pawFL.position,1,{y:-1,z:3,ease:e}),TweenMax.to(this.pawFR.position,1,{y:-1,z:3,ease:e}),TweenMax.to(this.pawBL.position,1,{y:-2,z:-3,ease:e}),TweenMax.to(this.pawBR.position,1,{y:-2,z:-3,ease:e}),TweenMax.to(this.eyeL.scale,1,{y:1,ease:e}),TweenMax.to(this.eyeR.scale,1,{y:1,ease:e})},Monster.prototype.nod=function(){var t=this,e=1+2*Math.random(),a=-Math.PI/3+.5*Math.random(),o=Math.PI/3-.2+.4*Math.random();TweenMax.to(this.head.rotation,e,{x:o,y:a,ease:Power4.easeInOut,onComplete:function(){t.nod()}});var i=-Math.PI/4;TweenMax.to(this.tail.rotation,e/8,{y:i,ease:Power1.easeInOut,yoyo:!0,repeat:8}),TweenMax.to([this.eyeR.scale,this.eyeL.scale],e/20,{y:0,ease:Power1.easeInOut,yoyo:!0,repeat:1})},Monster.prototype.sit=function(){var t=1.2,e=Power4.easeOut,a=this;TweenMax.to(this.torso.rotation,t,{x:-1.3,ease:e}),TweenMax.to(this.torso.position,t,{y:-5,ease:e,onComplete:function(){a.nod(),gameStatus="readyToReplay"}}),TweenMax.to(this.head.rotation,t,{x:Math.PI/3,y:-Math.PI/3,ease:e}),TweenMax.to(this.tail.rotation,t,{x:2,y:Math.PI/4,ease:e}),TweenMax.to(this.pawBL.rotation,t,{x:-.1,ease:e}),TweenMax.to(this.pawBR.rotation,t,{x:-.1,ease:e}),TweenMax.to(this.pawFL.rotation,t,{x:1,ease:e}),TweenMax.to(this.pawFR.rotation,t,{x:1,ease:e}),TweenMax.to(this.mouth.rotation,t,{x:.3,ease:e}),TweenMax.to(this.eyeL.scale,t,{y:1,ease:e}),TweenMax.to(this.eyeR.scale,t,{y:1,ease:e})},Carrot=function(){this.angle=0,this.mesh=new THREE.Group;var t=new THREE.CylinderGeometry(5,3,10,4,1);t.vertices[8].y+=2,t.vertices[9].y-=3,this.body=new THREE.Mesh(t,pinkMat);var e=new THREE.CubeGeometry(5,10,1,1);e.applyMatrix((new THREE.Matrix4).makeTranslation(0,5,0)),e.vertices[2].x-=1,e.vertices[3].x-=1,e.vertices[6].x+=1,e.vertices[7].x+=1,this.leaf1=new THREE.Mesh(e,greenMat),this.leaf1.position.y=7,this.leaf1.rotation.z=.3,this.leaf1.rotation.x=.2,this.leaf2=this.leaf1.clone(),this.leaf2.scale.set(1,1.3,1),this.leaf2.position.y=7,this.leaf2.rotation.z=-.3,this.leaf2.rotation.x=-.2,this.mesh.add(this.body),this.mesh.add(this.leaf1),this.mesh.add(this.leaf2),this.body.traverse((function(t){t instanceof THREE.Mesh&&(t.castShadow=!0,t.receiveShadow=!0)}))},Hedgehog=function(){this.angle=0,this.status="ready",this.mesh=new THREE.Group;var t=new THREE.CubeGeometry(6,6,6,1);this.body=new THREE.Mesh(t,blackMat);var e=new THREE.CubeGeometry(5,5,7,1);this.head=new THREE.Mesh(e,lightBrownMat),this.head.position.z=6,this.head.position.y=-.5;var a=new THREE.CubeGeometry(1.5,1.5,1.5,1);this.nose=new THREE.Mesh(a,blackMat),this.nose.position.z=4,this.nose.position.y=2;var o=new THREE.CubeGeometry(1,3,3);this.eyeL=new THREE.Mesh(o,whiteMat),this.eyeL.position.x=2.2,this.eyeL.position.z=-.5,this.eyeL.position.y=.8,this.eyeL.castShadow=!0,this.head.add(this.eyeL);var i=new THREE.CubeGeometry(.5,1,1);this.iris=new THREE.Mesh(i,blackMat),this.iris.position.x=.5,this.iris.position.y=.8,this.iris.position.z=.8,this.eyeL.add(this.iris),this.eyeR=this.eyeL.clone(),this.eyeR.children[0].position.x=-this.iris.position.x,this.eyeR.position.x=-this.eyeL.position.x;var s=new THREE.CubeGeometry(.5,2,.5,1);s.applyMatrix((new THREE.Matrix4).makeTranslation(0,1,0));for(var n=0;n<9;n++){var h=n%3,r=Math.floor(n/3),d=new THREE.Mesh(s,blackMat);d.rotation.x=-Math.PI/2+Math.PI/12*h-.5+Math.random(),d.position.z=-3,d.position.y=2*h-2,d.position.x=2*r-2,this.body.add(d);var l=new THREE.Mesh(s,blackMat);l.position.y=3,l.position.x=2*h-2,l.position.z=2*r-2,l.rotation.z=Math.PI/6-Math.PI/6*h-.5+Math.random(),this.body.add(l);var w=new THREE.Mesh(s,blackMat);w.position.x=3,w.position.y=2*h-2,w.position.z=2*r-2,w.rotation.z=-Math.PI/2+Math.PI/12*h-.5+Math.random(),this.body.add(w);var p=new THREE.Mesh(s,blackMat);p.position.x=-3,p.position.y=2*h-2,p.position.z=2*r-2,p.rotation.z=Math.PI/2-Math.PI/12*h-.5+Math.random(),this.body.add(p)}this.head.add(this.eyeR);var M=new THREE.CubeGeometry(2,2,.5,1);this.earL=new THREE.Mesh(M,lightBrownMat),this.earL.position.x=2.5,this.earL.position.z=-2.5,this.earL.position.y=2.5,this.earL.rotation.z=-Math.PI/12,this.earL.castShadow=!0,this.head.add(this.earL),this.earR=this.earL.clone(),this.earR.position.x=-this.earL.position.x,this.earR.rotation.z=-this.earL.rotation.z,this.earR.castShadow=!0,this.head.add(this.earR);var c=new THREE.CubeGeometry(1,1,.5,1);this.mouth=new THREE.Mesh(c,blackMat),this.mouth.position.z=3.5,this.mouth.position.y=-1.5,this.head.add(this.mouth),this.mesh.add(this.body),this.body.add(this.head),this.head.add(this.nose),this.mesh.traverse((function(t){t instanceof THREE.Mesh&&(t.castShadow=!0,t.receiveShadow=!0)}))},Hedgehog.prototype.nod=function(){var t=this,e=.1+.5*Math.random(),a=-Math.PI/4+Math.random()*Math.PI/2;TweenMax.to(this.head.rotation,e,{y:a,onComplete:function(){t.nod()}})},Fir=function(){var t=new THREE.CylinderGeometry(2,2,200,6,1);t.applyMatrix((new THREE.Matrix4).makeTranslation(0,100,0)),this.mesh=new THREE.Mesh(t,greenMat),this.mesh.castShadow=!0};var firs=new THREE.Group;function createFirs(){for(var t=0;t<100;t++){var e=t*(2*Math.PI)/100,a=Math.PI/2;a+=Math.random()>.05?.25+.3*Math.random():-.35-.1*Math.random();var o=new Tree;o.mesh.position.x=Math.sin(a)*Math.cos(e)*floorRadius,o.mesh.position.y=Math.sin(a)*Math.sin(e)*(floorRadius-10),o.mesh.position.z=Math.cos(a)*floorRadius;var i=o.mesh.position.clone(),s=new THREE.Vector3(0,1,0);o.mesh.quaternion.setFromUnitVectors(s,i.clone().normalize()),floor.add(o.mesh)}}function createCarrot(){carrot=new Carrot,scene.add(carrot.mesh)}function updateCarrotPosition(){carrot.mesh.rotation.y+=6*delta,carrot.mesh.rotation.z=Math.PI/2-(floorRotation+carrot.angle),carrot.mesh.position.y=-floorRadius+Math.sin(floorRotation+carrot.angle)*(floorRadius+50),carrot.mesh.position.x=Math.cos(floorRotation+carrot.angle)*(floorRadius+50)}function updateObstaclePosition(){"flying"!=obstacle.status&&(floorRotation+obstacle.angle>2.5&&(obstacle.angle=-floorRotation+.3*Math.random(),obstacle.body.rotation.y=Math.random()*Math.PI*2),obstacle.mesh.rotation.z=floorRotation+obstacle.angle-Math.PI/2,obstacle.mesh.position.y=-floorRadius+Math.sin(floorRotation+obstacle.angle)*(floorRadius+3),obstacle.mesh.position.x=Math.cos(floorRotation+obstacle.angle)*(floorRadius+3))}function updateFloorRotation(){floorRotation+=.03*delta*speed,floorRotation%=2*Math.PI,floor.rotation.z=floorRotation}function createObstacle(){obstacle=new Hedgehog,obstacle.body.rotation.y=-Math.PI/2,obstacle.mesh.scale.set(1.1,1.1,1.1),obstacle.mesh.position.y=floorRadius+4,obstacle.nod(),scene.add(obstacle.mesh)}function createBonusParticles(){bonusParticles=new BonusParticles,bonusParticles.mesh.visible=!1,scene.add(bonusParticles.mesh)}function checkCollision(){var t=hero.mesh.position.clone().sub(carrot.mesh.position.clone()),e=hero.mesh.position.clone().sub(obstacle.mesh.position.clone());t.length()<collisionBonus&&getBonus(),e.length()<collisionObstacle&&"flying"!=obstacle.status&&getMalus()}function getBonus(){bonusParticles.mesh.position.copy(carrot.mesh.position),bonusParticles.mesh.visible=!0,bonusParticles.explose(),carrot.angle+=Math.PI/2,monsterPosTarget+=.025}function getMalus(){obstacle.status="flying";var t=Math.random()>.5?-20-10*Math.random():20+5*Math.random();TweenMax.to(obstacle.mesh.position,4,{x:t,y:50*Math.random(),z:350,ease:Power4.easeOut}),TweenMax.to(obstacle.mesh.rotation,4,{x:3*Math.PI,z:3*Math.PI,y:6*Math.PI,ease:Power4.easeOut,onComplete:function(){obstacle.status="ready",obstacle.body.rotation.y=Math.random()*Math.PI*2,obstacle.angle=-floorRotation-.4*Math.random(),obstacle.angle=obstacle.angle%(2*Math.PI),obstacle.mesh.rotation.x=0,obstacle.mesh.rotation.y=0,obstacle.mesh.rotation.z=0,obstacle.mesh.position.z=0}}),monsterPosTarget-=.04,TweenMax.from(this,.5,{malusClearAlpha:.5,onUpdate:function(){renderer.setClearColor(malusClearColor,malusClearAlpha)}})}function updateDistance(){var t=(distance+=delta*speed)/2;fieldDistance.innerHTML=Math.floor(t)}function updateLevel(){speed>=maxSpeed||(level++,speed+=2)}function loop(){delta=clock.getDelta(),updateFloorRotation(),"play"==gameStatus&&("running"==hero.status&&hero.run(),updateDistance(),updateMonsterPosition(),updateCarrotPosition(),updateObstaclePosition(),checkCollision()),render(),requestAnimationFrame(loop)}function render(){renderer.render(scene,camera)}function init(t){initScreenAnd3D(),createLights(),createFloor(),createHero(),createMonster(),createFirs(),createCarrot(),createBonusParticles(),createObstacle(),initUI(),resetGame(),loop()}function resetGame(){scene.add(hero.mesh),hero.mesh.rotation.y=Math.PI/2,hero.mesh.position.y=0,hero.mesh.position.z=0,hero.mesh.position.x=0,monsterPos=.56,monsterPosTarget=.65,speed=initSpeed,level=0,distance=0,carrot.mesh.visible=!0,obstacle.mesh.visible=!0,gameStatus="play",hero.status="running",hero.nod(),audio.play(),updateLevel(),levelInterval=setInterval(updateLevel,levelUpdateFreq)}function initUI(){fieldDistance=document.getElementById("distValue"),fieldGameOver=document.getElementById("gameoverInstructions")}window.addEventListener("load",init,!1),Tree=function(){this.mesh=new THREE.Object3D,this.trunc=new Trunc,this.mesh.add(this.trunc.mesh)},Trunc=function(){var t=50+150*Math.random(),e=1+5*Math.random(),a=5+5*Math.random(),o=[blackMat,brownMat,pinkMat,whiteMat,greenMat,lightBrownMat,pinkMat],i=blackMat,s=new THREE.CylinderGeometry(e,a,t,3,3);s.applyMatrix((new THREE.Matrix4).makeTranslation(0,t/2,0)),this.mesh=new THREE.Mesh(s,i);for(var n=0;n<s.vertices.length;n++){var h=Math.random(),r=s.vertices[n];if(r.x+=-h+Math.random()*h*2,r.y+=-h+Math.random()*h*2,r.z+=-h+Math.random()*h*2,s.computeVertexNormals(),Math.random()>.7){var d=3*Math.random(),l=new THREE.CubeGeometry(d,d,d,1),w=o[Math.floor(Math.random()*o.length)],p=new THREE.Mesh(l,w);p.position.x=r.x,p.position.y=r.y+3,p.position.z=r.z,p.rotation.x=Math.random()*Math.PI,p.rotation.y=Math.random()*Math.PI,this.mesh.add(p)}if(Math.random()>.5&&r.y>10&&r.y<t-10){var M=3+5*Math.random(),c=.2+Math.random(),m=new THREE.CylinderGeometry(c/2,c,M,3,1);m.applyMatrix((new THREE.Matrix4).makeTranslation(0,M/2,0));var y=new THREE.Mesh(m,i);y.position.x=r.x,y.position.y=r.y,y.position.z=r.z;var E=new THREE.Vector3(r.x,2,r.z),u=new THREE.Vector3(0,1,0);y.quaternion.setFromUnitVectors(u,E.clone().normalize()),this.mesh.add(y)}}this.mesh.castShadow=!0};