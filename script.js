let gameSpeed=1;const BLUE={r:103,g:215,b:240},GREEN={r:166,g:224,b:44},PINK={r:250,g:36,b:115},ORANGE={r:254,g:149,b:34},allColors=[BLUE,GREEN,PINK,ORANGE],getSpawnDelay=()=>{const e=1400-3.1*state.game.cubeCount;return Math.max(e,550)},doubleStrongEnableScore=2e3,slowmoThreshold=10,strongThreshold=25,spinnerThreshold=25;let pointerIsDown=!1,pointerScreen={x:0,y:0},pointerScene={x:0,y:0};const minPointerSpeed=60,hitDampening=.1,backboardZ=-400,shadowColor="#262e36",airDrag=.022,gravity=.3,sparkColor="rgba(170,221,255,.9)",sparkThickness=2.2,airDragSpark=.1,touchTrailColor="rgba(170,221,255,.62)",touchTrailThickness=7,touchPointLife=120,touchPoints=[],targetRadius=40,targetHitRadius=50,makeTargetGlueColor=e=>"rgb(170,221,255)",fragRadius=40/3,canvas=document.querySelector("#c"),cameraDistance=900,sceneScale=1,cameraFadeStartZ=405,cameraFadeEndZ=585,cameraFadeRange=180,allVertices=[],allPolys=[],allShadowVertices=[],allShadowPolys=[],GAME_MODE_RANKED=Symbol("GAME_MODE_RANKED"),GAME_MODE_CASUAL=Symbol("GAME_MODE_CASUAL"),MENU_MAIN=Symbol("MENU_MAIN"),MENU_PAUSE=Symbol("MENU_PAUSE"),MENU_SCORE=Symbol("MENU_SCORE"),state={game:{mode:GAME_MODE_RANKED,time:0,score:0,cubeCount:0},menus:{active:MENU_MAIN}},isInGame=()=>!state.menus.active,isMenuVisible=()=>!!state.menus.active,isCasualGame=()=>state.game.mode===GAME_MODE_CASUAL,isPaused=()=>state.menus.active===MENU_PAUSE,highScoreKey="__menja__highScore",getHighScore=()=>{const e=localStorage.getItem(highScoreKey);return e?parseInt(e,10):0};let _lastHighscore=getHighScore();const setHighScore=e=>{_lastHighscore=getHighScore(),localStorage.setItem(highScoreKey,String(e))},isNewHighScore=()=>state.game.score>_lastHighscore,invariant=(e,t)=>{if(!e)throw new Error(t)},$=e=>document.querySelector(e),handleClick=(e,t)=>e.addEventListener("click",t),handlePointerDown=(e,t)=>{e.addEventListener("touchstart",t),e.addEventListener("mousedown",t)},formatNumber=e=>e.toLocaleString(),PI=Math.PI,TAU=2*Math.PI,ETA=.5*Math.PI,clamp=(e,t,o)=>Math.min(Math.max(e,t),o),lerp=(e,t,o)=>(t-e)*o+e,random=(e,t)=>Math.random()*(t-e)+e,randomInt=(e,t)=>(Math.random()*(t-e+1)|0)+e,pickOne=e=>e[Math.random()*e.length|0],colorToHex=e=>"#"+(0|e.r).toString(16).padStart(2,"0")+(0|e.g).toString(16).padStart(2,"0")+(0|e.b).toString(16).padStart(2,"0"),shadeColor=(e,t)=>{let o,a;return t<.5?(o=0,a=1-2*t):(o=255,a=2*t-1),"#"+(0|lerp(e.r,o,a)).toString(16).padStart(2,"0")+(0|lerp(e.g,o,a)).toString(16).padStart(2,"0")+(0|lerp(e.b,o,a)).toString(16).padStart(2,"0")},_allCooldowns=[],makeCooldown=(e,t=1)=>{let o=0,a=0;const r={rechargeTime:e,units:t},n=()=>((()=>{const e=state.game.time;e<a?o=0:(o-=e-a,o<0&&(o=0)),a=e})(),o<=e*(t-1)),s={canUse:n,useIfAble(){const t=n();return t&&(o+=e),t},mutate(a){a.rechargeTime&&(o-=e-a.rechargeTime,o<0&&(o=0),e=a.rechargeTime),a.units&&(t=a.units)},reset(){o=0,a=0,this.mutate(r)}};return _allCooldowns.push(s),s},resetAllCooldowns=()=>_allCooldowns.forEach((e=>e.reset())),makeSpawner=({chance:e,cooldownPerSpawn:t,maxSpawns:o})=>{const a=makeCooldown(t,o);return{shouldSpawn:()=>Math.random()<=e&&a.useIfAble(),mutate(t){t.chance&&(e=t.chance),a.mutate({rechargeTime:t.cooldownPerSpawn,units:t.maxSpawns})}}},normalize=e=>{const t=Math.hypot(e.x,e.y,e.z);return{x:e.x/t,y:e.y/t,z:e.z/t}},add=e=>t=>e+t,scaleVector=e=>t=>{t.x*=e,t.y*=e,t.z*=e};function cloneVertices(e){return e.map((e=>({x:e.x,y:e.y,z:e.z})))}function copyVerticesTo(e,t){const o=e.length;for(let a=0;a<o;a++){const o=e[a],r=t[a];r.x=o.x,r.y=o.y,r.z=o.z}}function computeTriMiddle(e){const t=e.vertices;e.middle.x=(t[0].x+t[1].x+t[2].x)/3,e.middle.y=(t[0].y+t[1].y+t[2].y)/3,e.middle.z=(t[0].z+t[1].z+t[2].z)/3}function computeQuadMiddle(e){const t=e.vertices;e.middle.x=(t[0].x+t[1].x+t[2].x+t[3].x)/4,e.middle.y=(t[0].y+t[1].y+t[2].y+t[3].y)/4,e.middle.z=(t[0].z+t[1].z+t[2].z+t[3].z)/4}function computePolyMiddle(e){3===e.vertices.length?computeTriMiddle(e):computeQuadMiddle(e)}function computePolyDepth(e){computePolyMiddle(e);const t=e.middle.x,o=e.middle.y,a=e.middle.z-900;e.depth=Math.hypot(t,o,a)}function computePolyNormal(e,t){const o=e.vertices[0],a=e.vertices[1],r=e.vertices[2],n=o.x-a.x,s=o.y-a.y,i=o.z-a.z,l=o.x-r.x,c=o.y-r.y,d=o.z-r.z,h=s*d-i*c,m=i*l-n*d,u=n*c-s*l,p=Math.hypot(h,m,u),y=e[t];y.x=h/p,y.y=m/p,y.z=u/p}function transformVertices(e,t,o,a,r,n,s,i,l,c,d){const h=Math.sin(n),m=Math.cos(n),u=Math.sin(s),p=Math.cos(s),y=Math.sin(i),x=Math.cos(i);e.forEach(((e,n)=>{const s=t[n],i=e.x,g=e.z*h+e.y*m,f=e.z*m-e.y*h,S=i*p-f*u,w=S*x-g*y,M=S*y+g*x,v=i*u+f*p;s.x=w*l+o,s.y=M*c+a,s.z=v*d+r}))}const projectVertex=e=>{const t=900/(900-e.z);e.x=e.x*t,e.y=e.y*t},projectVertexTo=(e,t)=>{const o=900/(900-e.z);t.x=e.x*o,t.y=e.y*o},PERF_START=()=>{},PERF_END=()=>{},PERF_UPDATE=()=>{};function makeCubeModel({scale:e=1}){return{vertices:[{x:-e,y:-e,z:e},{x:e,y:-e,z:e},{x:e,y:e,z:e},{x:-e,y:e,z:e},{x:-e,y:-e,z:-e},{x:e,y:-e,z:-e},{x:e,y:e,z:-e},{x:-e,y:e,z:-e}],polys:[{vIndexes:[0,1,2,3]},{vIndexes:[7,6,5,4]},{vIndexes:[3,2,6,7]},{vIndexes:[4,5,1,0]},{vIndexes:[5,6,2,1]},{vIndexes:[0,3,7,4]}]}}function makeRecursiveCubeModel({recursionLevel:e,splitFn:t,color:o,scale:a=1}){const r=e=>1/3**e;let n=[{x:0,y:0,z:0}];for(let o=1;o<=e;o++){const e=2*r(o),a=[];n.forEach((o=>{a.push(...t(o,e))})),n=a}const s={vertices:[],polys:[]},i=makeCubeModel({scale:1});i.vertices.forEach(scaleVector(r(e)));r(e);return n.forEach(((e,t)=>{Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z));s.vertices.push(...i.vertices.map((t=>({x:(t.x+e.x)*a,y:(t.y+e.y)*a,z:(t.z+e.z)*a})))),s.polys.push(...i.polys.map((e=>{return{vIndexes:e.vIndexes.map((o=8*t,e=>o+e))};var o})))})),s}function mengerSpongeSplit(e,t){return[{x:e.x+t,y:e.y-t,z:e.z+t},{x:e.x+t,y:e.y-t,z:e.z+0},{x:e.x+t,y:e.y-t,z:e.z-t},{x:e.x+0,y:e.y-t,z:e.z+t},{x:e.x+0,y:e.y-t,z:e.z-t},{x:e.x-t,y:e.y-t,z:e.z+t},{x:e.x-t,y:e.y-t,z:e.z+0},{x:e.x-t,y:e.y-t,z:e.z-t},{x:e.x+t,y:e.y+t,z:e.z+t},{x:e.x+t,y:e.y+t,z:e.z+0},{x:e.x+t,y:e.y+t,z:e.z-t},{x:e.x+0,y:e.y+t,z:e.z+t},{x:e.x+0,y:e.y+t,z:e.z-t},{x:e.x-t,y:e.y+t,z:e.z+t},{x:e.x-t,y:e.y+t,z:e.z+0},{x:e.x-t,y:e.y+t,z:e.z-t},{x:e.x+t,y:e.y+0,z:e.z+t},{x:e.x+t,y:e.y+0,z:e.z-t},{x:e.x-t,y:e.y+0,z:e.z+t},{x:e.x-t,y:e.y+0,z:e.z-t}]}function optimizeModel(e,t=1e-4){const{vertices:o,polys:a}=e,r=(e,o)=>Math.abs(e.x-o.x)<t&&Math.abs(e.y-o.y)<t&&Math.abs(e.z-o.z)<t,n=(e,t)=>{const o=e.vIndexes,a=t.vIndexes;return!(o[0]!==a[0]&&o[0]!==a[1]&&o[0]!==a[2]&&o[0]!==a[3]||o[1]!==a[0]&&o[1]!==a[1]&&o[1]!==a[2]&&o[1]!==a[3]||o[2]!==a[0]&&o[2]!==a[1]&&o[2]!==a[2]&&o[2]!==a[3]||o[3]!==a[0]&&o[3]!==a[1]&&o[3]!==a[2]&&o[3]!==a[3])};o.forEach(((e,t)=>{e.originalIndexes=[t]}));for(let e=o.length-1;e>=0;e--)for(let t=e-1;t>=0;t--){const a=o[e],n=o[t];if(r(a,n)){o.splice(e,1),n.originalIndexes.push(...a.originalIndexes);break}}o.forEach(((e,t)=>{a.forEach((o=>{o.vIndexes.forEach(((o,a,r)=>{e.originalIndexes.includes(o)&&(r[a]=t)}))}))})),a.forEach((e=>{const t=e.vIndexes;e.sum=t[0]+t[1]+t[2]+t[3]})),a.sort(((e,t)=>t.sum-e.sum));for(let e=a.length-1;e>=0;e--)for(let t=e-1;t>=0;t--){const o=a[e],r=a[t];if(o.sum!==r.sum)break;if(n(o,r)){a.splice(e,1),a.splice(t,1),e--;break}}return e}class Entity{constructor({model:e,color:t,wireframe:o=!1}){const a=cloneVertices(e.vertices),r=cloneVertices(e.vertices),n=colorToHex(t),s=shadeColor(t,.4),i=e.polys.map((e=>({vertices:e.vIndexes.map((e=>a[e])),color:t,wireframe:o,strokeWidth:o?2:0,strokeColor:n,strokeColorDark:s,depth:0,middle:{x:0,y:0,z:0},normalWorld:{x:0,y:0,z:0},normalCamera:{x:0,y:0,z:0}}))),l=e.polys.map((e=>({vertices:e.vIndexes.map((e=>r[e])),wireframe:o,normalWorld:{x:0,y:0,z:0}})));this.projected={},this.model=e,this.vertices=a,this.polys=i,this.shadowVertices=r,this.shadowPolys=l,this.reset()}reset(){this.x=0,this.y=0,this.z=0,this.xD=0,this.yD=0,this.zD=0,this.rotateX=0,this.rotateY=0,this.rotateZ=0,this.rotateXD=0,this.rotateYD=0,this.rotateZD=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this.projected.x=0,this.projected.y=0}transform(){transformVertices(this.model.vertices,this.vertices,this.x,this.y,this.z,this.rotateX,this.rotateY,this.rotateZ,this.scaleX,this.scaleY,this.scaleZ),copyVerticesTo(this.vertices,this.shadowVertices)}project(){projectVertexTo(this,this.projected)}}const targets=[],targetPool=new Map(allColors.map((e=>[e,[]]))),targetWireframePool=new Map(allColors.map((e=>[e,[]]))),getTarget=(()=>{const e=makeSpawner({chance:.5,cooldownPerSpawn:1e4,maxSpawns:1});let t=!1;const o=makeSpawner({chance:.3,cooldownPerSpawn:12e3,maxSpawns:1}),a=makeSpawner({chance:.1,cooldownPerSpawn:1e4,maxSpawns:1}),r=[["x","y"],["y","z"],["z","x"]];return function(){t&&state.game.score<=2e3?t=!1:!t&&state.game.score>2e3&&(t=!0,o.mutate({maxSpawns:2}));let n=pickOne([BLUE,GREEN,ORANGE]),s=!1,i=1;const l=state.game.cubeCount>=25&&isInGame()&&a.shouldSpawn();state.game.cubeCount>=10&&e.shouldSpawn()?(n=BLUE,s=!0):state.game.cubeCount>=25&&o.shouldSpawn()&&(n=PINK,i=3);const c=function(e,t){let o=(t?targetWireframePool:targetPool).get(e).pop();return o||(o=new Entity({model:optimizeModel(makeRecursiveCubeModel({recursionLevel:1,splitFn:mengerSpongeSplit,scale:40})),color:e,wireframe:t}),o.color=e,o.wireframe=t,o.hit=!1,o.maxHealth=0,o.health=0),o}(n,s);c.hit=!1,c.maxHealth=3,c.health=i,updateTargetHealth(c,0);const d=[.1*Math.random()-.05,.1*Math.random()-.05];l&&(d[0]=-.25,d[1]=0,c.rotateZ=random(0,TAU));const h=pickOne(r);return d.forEach(((e,t)=>{switch(h[t]){case"x":c.rotateXD=e;break;case"y":c.rotateYD=e;break;case"z":c.rotateZD=e;break}})),c}})(),updateTargetHealth=(e,t)=>{if(e.health+=t,!e.wireframe){const t=e.health-1,o="rgb(170,221,255)";for(let a of e.polys)a.strokeWidth=t,a.strokeColor=o}},returnTarget=e=>{e.reset();(e.wireframe?targetWireframePool:targetPool).get(e.color).push(e)};function resetAllTargets(){for(;targets.length;)returnTarget(targets.pop())}const frags=[],fragPool=new Map(allColors.map((e=>[e,[]]))),fragWireframePool=new Map(allColors.map((e=>[e,[]]))),createBurst=(()=>{const e=mengerSpongeSplit({x:0,y:0,z:0},2*fragRadius),t=cloneVertices(e),o=cloneVertices(e),a=cloneVertices(e),r=e.map(normalize),n=cloneVertices(r),s=e.length;function i(e){let t=(e.wireframe?fragWireframePool:fragPool).get(e.color).pop();return t||(t=new Entity({model:makeCubeModel({scale:fragRadius}),color:e.color,wireframe:e.wireframe}),t.color=e.color,t.wireframe=e.wireframe),t}return(l,c=1)=>{transformVertices(e,t,l.x,l.y,l.z,l.rotateX,l.rotateY,l.rotateZ,1,1,1),transformVertices(e,o,l.x-l.xD,l.y-l.yD,l.z-l.zD,l.rotateX-l.rotateXD,l.rotateY-l.rotateYD,l.rotateZ-l.rotateZD,1,1,1);for(let e=0;e<s;e++){const r=t[e],n=o[e],s=a[e];s.x=r.x-n.x,s.y=r.y-n.y,s.z=r.z-n.z}transformVertices(r,n,0,0,0,l.rotateX,l.rotateY,l.rotateZ,1,1,1);for(let e=0;e<s;e++){const o=t[e],r=a[e],s=n[e],d=i(l);d.x=o.x,d.y=o.y,d.z=o.z,d.rotateX=l.rotateX,d.rotateY=l.rotateY,d.rotateZ=l.rotateZ;const h=2*c,m=2*c,u=.015;d.xD=r.x+s.x*h+Math.random()*m,d.yD=r.y+s.y*h+Math.random()*m,d.zD=r.z+s.z*h+Math.random()*m,d.rotateXD=d.xD*u,d.rotateYD=d.yD*u,d.rotateZD=d.zD*u,frags.push(d)}}})(),returnFrag=e=>{e.reset();(e.wireframe?fragWireframePool:fragPool).get(e.color).push(e)},sparks=[],sparkPool=[];function addSpark(e,t,o,a){const r=sparkPool.pop()||{};return r.x=e+.5*o,r.y=t+.5*a,r.xD=o,r.yD=a,r.life=random(200,300),r.maxLife=r.life,sparks.push(r),r}function sparkBurst(e,t,o,a){const r=TAU/o;for(let n=0;n<o;n++){const o=n*r+r*Math.random(),s=(1-Math.random()**3)*a;addSpark(e,t,Math.sin(o)*s,Math.cos(o)*s)}}let glueShedVertices;function glueShedSparks(e){glueShedVertices?copyVerticesTo(e.vertices,glueShedVertices):glueShedVertices=cloneVertices(e.vertices),glueShedVertices.forEach((e=>{Math.random()<.4&&(projectVertex(e),addSpark(e.x,e.y,random(-12,12),random(-12,12)))}))}function returnSpark(e){sparkPool.push(e)}const hudContainerNode=$(".hud");function setHudVisibility(e){hudContainerNode.style.display=e?"block":"none"}const scoreNode=$(".score-lbl"),cubeCountNode=$(".cube-count-lbl");function renderScoreHud(){isCasualGame()?(scoreNode.style.display="none",cubeCountNode.style.opacity=1):(scoreNode.innerText=`SCORE: ${state.game.score}`,scoreNode.style.display="block",cubeCountNode.style.opacity=.65),cubeCountNode.innerText=`CUBES SMASHED: ${state.game.cubeCount}`}renderScoreHud(),handlePointerDown($(".pause-btn"),(()=>pauseGame()));const slowmoNode=$(".slowmo"),slowmoBarNode=$(".slowmo__bar");function renderSlowmoStatus(e){slowmoNode.style.opacity=0===e?0:1,slowmoBarNode.style.transform=`scaleX(${e.toFixed(3)})`}const menuContainerNode=$(".menus"),menuMainNode=$(".menu--main"),menuPauseNode=$(".menu--pause"),menuScoreNode=$(".menu--score"),finalScoreLblNode=$(".final-score-lbl"),highScoreLblNode=$(".high-score-lbl");function showMenu(e){e.classList.add("active")}function hideMenu(e){e.classList.remove("active")}function renderMenus(){switch(hideMenu(menuMainNode),hideMenu(menuPauseNode),hideMenu(menuScoreNode),state.menus.active){case MENU_MAIN:showMenu(menuMainNode);break;case MENU_PAUSE:showMenu(menuPauseNode);break;case MENU_SCORE:finalScoreLblNode.textContent=formatNumber(state.game.score),isNewHighScore()?highScoreLblNode.textContent="New High Score!":highScoreLblNode.textContent=`High Score: ${formatNumber(getHighScore())}`,showMenu(menuScoreNode);break}setHudVisibility(!isMenuVisible()),menuContainerNode.classList.toggle("has-active",isMenuVisible()),menuContainerNode.classList.toggle("interactive-mode",isMenuVisible()&&pointerIsDown)}function setActiveMenu(e){state.menus.active=e,renderMenus()}function setScore(e){state.game.score=e,renderScoreHud()}function incrementScore(e){isInGame()&&(state.game.score+=e,state.game.score<0&&(state.game.score=0),renderScoreHud())}function setCubeCount(e){state.game.cubeCount=e,renderScoreHud()}function incrementCubeCount(e){isInGame()&&(state.game.cubeCount+=e,renderScoreHud())}function setGameMode(e){state.game.mode=e}function resetGame(){resetAllTargets(),state.game.time=0,_allCooldowns.forEach((e=>e.reset())),setScore(0),setCubeCount(0),spawnTime=getSpawnDelay()}function pauseGame(){isInGame()&&setActiveMenu(MENU_PAUSE)}function resumeGame(){isPaused()&&setActiveMenu(null)}function endGame(){var e;handleCanvasPointerUp(),isNewHighScore()&&(e=state.game.score,_lastHighscore=getHighScore(),localStorage.setItem(highScoreKey,String(e))),setActiveMenu(MENU_SCORE)}renderMenus(),handleClick($(".play-normal-btn"),(()=>{setGameMode(GAME_MODE_RANKED),setActiveMenu(null),resetGame()})),handleClick($(".play-casual-btn"),(()=>{setGameMode(GAME_MODE_CASUAL),setActiveMenu(null),resetGame()})),handleClick($(".resume-btn"),(()=>resumeGame())),handleClick($(".menu-btn--pause"),(()=>setActiveMenu(MENU_MAIN))),handleClick($(".play-again-btn"),(()=>{setActiveMenu(null),resetGame()})),handleClick($(".menu-btn--score"),(()=>setActiveMenu(MENU_MAIN))),handleClick($(".play-normal-btn"),(()=>{setGameMode(GAME_MODE_RANKED),setActiveMenu(null),resetGame()})),handleClick($(".play-casual-btn"),(()=>{setGameMode(GAME_MODE_CASUAL),setActiveMenu(null),resetGame()})),handleClick($(".resume-btn"),(()=>resumeGame())),handleClick($(".menu-btn--pause"),(()=>setActiveMenu(MENU_MAIN))),handleClick($(".play-again-btn"),(()=>{setActiveMenu(null),resetGame()})),handleClick($(".menu-btn--score"),(()=>setActiveMenu(MENU_MAIN))),window.addEventListener("keydown",(e=>{"p"===e.key&&(isPaused()?resumeGame():pauseGame())}));let spawnTime=0;const maxSpawnX=450,pointerDelta={x:0,y:0},pointerDeltaScaled={x:0,y:0},slowmoDuration=1500;let slowmoRemaining=0,spawnExtra=0;const spawnExtraDelay=300;let targetSpeed=1;function tick(e,t,o,a,r){if(state.game.time+=o,slowmoRemaining>0)slowmoRemaining-=o,slowmoRemaining<0&&(slowmoRemaining=0),targetSpeed=pointerIsDown?.075:.3;else{const e=isMenuVisible()&&pointerIsDown;targetSpeed=e?.025:1}var n,s,i;renderSlowmoStatus(slowmoRemaining/1500),gameSpeed+=(targetSpeed-gameSpeed)/22*r,n=gameSpeed,s=0,i=1,gameSpeed=Math.min(Math.max(n,s),i);const l=e/2,c=t/2,d=1-.022*a,h=1-.1*a,m=1/(.75*a+.25);pointerDelta.x=0,pointerDelta.y=0,pointerDeltaScaled.x=0,pointerDeltaScaled.y=0;const u=touchPoints[touchPoints.length-1];pointerIsDown&&u&&!u.touchBreak&&(pointerDelta.x=pointerScene.x-u.x,pointerDelta.y=pointerScene.y-u.y,pointerDeltaScaled.x=pointerDelta.x*m,pointerDeltaScaled.y=pointerDelta.y*m);const p=Math.hypot(pointerDelta.x,pointerDelta.y),y=p*m;for(touchPoints.forEach((e=>e.life-=o)),pointerIsDown&&touchPoints.push({x:pointerScene.x,y:pointerScene.y,life:120});touchPoints[0]&&touchPoints[0].life<=0;)touchPoints.shift();if(spawnTime-=o,spawnTime<=0){spawnExtra>0?(spawnExtra--,spawnTime=300):spawnTime=getSpawnDelay();const e=getTarget(),t=Math.min(.8*l,450);e.x=Math.random()*t*2-t,e.y=c+100,e.z=40*Math.random()*2-40,e.xD=Math.random()*(-2*e.x/120),e.yD=-20,targets.push(e)}const x=40-l,g=l-40,f=-c-120;e:for(let e=targets.length-1;e>=0;e--){const t=targets[e];if(t.x+=t.xD*a,t.y+=t.yD*a,t.y<f&&(t.y=f,t.yD=0),t.x<x?(t.x=x,t.xD*=-.4):t.x>g&&(t.x=g,t.xD*=-.4),t.z<-400&&(t.z=-400,t.zD*=-.4),t.yD+=.3*a,t.rotateX+=t.rotateXD*a,t.rotateY+=t.rotateYD*a,t.rotateZ+=t.rotateZD*a,t.transform(),t.project(),t.y>c+100){targets.splice(e,1),returnTarget(t),isInGame()&&(isCasualGame()?incrementScore(-25):endGame());continue}const o=Math.ceil(p/40*2);for(let a=1;a<=o;a++){const r=1-a/o,n=pointerScene.x-pointerDelta.x*r,s=pointerScene.y-pointerDelta.y*r;if(Math.hypot(n-t.projected.x,s-t.projected.y)<=50){if(!t.hit){t.hit=!0,t.xD+=.1*pointerDeltaScaled.x,t.yD+=.1*pointerDeltaScaled.y,t.rotateXD+=.001*pointerDeltaScaled.y,t.rotateYD+=.001*pointerDeltaScaled.x;const o=7+.125*y;y>60?(t.health--,incrementScore(10),t.health<=0?(incrementCubeCount(1),createBurst(t,m),sparkBurst(n,s,8,o),t.wireframe&&(slowmoRemaining=1500,spawnTime=0,spawnExtra=2),targets.splice(e,1),returnTarget(t)):(sparkBurst(n,s,8,o),glueShedSparks(t),updateTargetHealth(t,0))):(incrementScore(5),sparkBurst(n,s,3,o))}continue e}}t.hit=!1}const S=-400+fragRadius,w=-e,M=e;for(let e=frags.length-1;e>=0;e--){const t=frags[e];t.x+=t.xD*a,t.y+=t.yD*a,t.z+=t.zD*a,t.xD*=d,t.yD*=d,t.zD*=d,t.y<f&&(t.y=f,t.yD=0),t.z<S&&(t.z=S,t.zD*=-.4),t.yD+=.3*a,t.rotateX+=t.rotateXD*a,t.rotateY+=t.rotateYD*a,t.rotateZ+=t.rotateZD*a,t.transform(),t.project(),(t.projected.y>c+50||t.projected.x<w||t.projected.x>M||t.z>585)&&(frags.splice(e,1),returnFrag(t))}for(let e=sparks.length-1;e>=0;e--){const t=sparks[e];t.life-=o,t.life<=0?(sparks.splice(e,1),returnSpark(t)):(t.x+=t.xD*a,t.y+=t.yD*a,t.xD*=h,t.yD*=h,t.yD+=.3*a)}allVertices.length=0,allPolys.length=0,allShadowVertices.length=0,allShadowPolys.length=0,targets.forEach((e=>{allVertices.push(...e.vertices),allPolys.push(...e.polys),allShadowVertices.push(...e.shadowVertices),allShadowPolys.push(...e.shadowPolys)})),frags.forEach((e=>{allVertices.push(...e.vertices),allPolys.push(...e.polys),allShadowVertices.push(...e.shadowVertices),allShadowPolys.push(...e.shadowPolys)})),allPolys.forEach((e=>computePolyNormal(e,"normalWorld"))),allPolys.forEach(computePolyDepth),allPolys.sort(((e,t)=>t.depth-e.depth)),allVertices.forEach(projectVertex),allPolys.forEach((e=>computePolyNormal(e,"normalCamera"))),transformVertices(allShadowVertices,allShadowVertices,0,0,0,TAU/8,0,0,1,1,1),allShadowPolys.forEach((e=>computePolyNormal(e,"normalWorld")));const v=Math.hypot(1,1),z=allShadowVertices.length;for(let e=0;e<z;e++){const t=allVertices[e].z- -400;allShadowVertices[e].z-=v*t}transformVertices(allShadowVertices,allShadowVertices,0,0,0,-TAU/8,0,0,1,1,1),allShadowVertices.forEach(projectVertex)}function draw(e,t,o,a){e.lineJoin="bevel",e.fillStyle="#262e36",e.strokeStyle="#262e36",allShadowPolys.forEach((t=>{if(t.wireframe){e.lineWidth=2,e.beginPath();const{vertices:o}=t,a=o.length,r=o[0];e.moveTo(r.x,r.y);for(let t=1;t<a;t++){const a=o[t];e.lineTo(a.x,a.y)}e.closePath(),e.stroke()}else{e.beginPath();const{vertices:o}=t,a=o.length,r=o[0];e.moveTo(r.x,r.y);for(let t=1;t<a;t++){const a=o[t];e.lineTo(a.x,a.y)}e.closePath(),e.fill()}})),allPolys.forEach((t=>{if(!t.wireframe&&t.normalCamera.z<0)return;0!==t.strokeWidth&&(e.lineWidth=t.normalCamera.z<0?.5*t.strokeWidth:t.strokeWidth,e.strokeStyle=t.normalCamera.z<0?t.strokeColorDark:t.strokeColor);const{vertices:o}=t,a=o[o.length-1],r=t.middle.z>405;if(!t.wireframe){const o=.5*t.normalWorld.y+-.5*t.normalWorld.z,a=o>0?.1:(o**32-o)/2*.9+.1;e.fillStyle=shadeColor(t.color,a)}r&&(e.globalAlpha=Math.max(0,1-(t.middle.z-405)/180)),e.beginPath(),e.moveTo(a.x,a.y);for(let t of o)e.lineTo(t.x,t.y);t.wireframe||e.fill(),0!==t.strokeWidth&&e.stroke(),r&&(e.globalAlpha=1)})),e.strokeStyle=sparkColor,e.lineWidth=2.2,e.beginPath(),sparks.forEach((t=>{e.moveTo(t.x,t.y);const o=(t.life/t.maxLife)**.5*1.5;e.lineTo(t.x-t.xD*o,t.y-t.yD*o)})),e.stroke(),e.strokeStyle=touchTrailColor;const r=touchPoints.length;for(let t=1;t<r;t++){const o=touchPoints[t],a=touchPoints[t-1];if(o.touchBreak||a.touchBreak)continue;const r=o.life/120;e.lineWidth=7*r,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(o.x,o.y),e.stroke()}}function setupCanvases(){const e=canvas.getContext("2d"),t=window.devicePixelRatio||1;let o,a,r;function n(){const e=window.innerWidth,n=window.innerHeight;o=n/1e3,a=e/o,r=n/o,canvas.width=e*t,canvas.height=n*t,canvas.style.width=e+"px",canvas.style.height=n+"px"}n(),window.addEventListener("resize",n);let s=0;function i(n){let i=n-s;if(s=n,l(),isPaused())return;i<0?i=17:i>68&&(i=68);const c=a/2,d=r/2;pointerScene.x=pointerScreen.x/o-c,pointerScene.y=pointerScreen.y/o-d;const h=i/16.6667;tick(a,r,gameSpeed*i,gameSpeed*h,h),e.clearRect(0,0,canvas.width,canvas.height);const m=t*o;e.scale(m,m),e.translate(c,d),draw(e,a,r,o),e.setTransform(1,0,0,1,0,0)}const l=()=>requestAnimationFrame(i);l()}function handleCanvasPointerDown(e,t){pointerIsDown||(pointerIsDown=!0,pointerScreen.x=e,pointerScreen.y=t,isMenuVisible()&&renderMenus())}function handleCanvasPointerUp(){pointerIsDown&&(pointerIsDown=!1,touchPoints.push({touchBreak:!0,life:120}),isMenuVisible()&&renderMenus())}function handleCanvasPointerMove(e,t){pointerIsDown&&(pointerScreen.x=e,pointerScreen.y=t)}if("PointerEvent"in window)canvas.addEventListener("pointerdown",(e=>{e.isPrimary&&handleCanvasPointerDown(e.clientX,e.clientY)})),canvas.addEventListener("pointerup",(e=>{e.isPrimary&&handleCanvasPointerUp()})),canvas.addEventListener("pointermove",(e=>{e.isPrimary&&handleCanvasPointerMove(e.clientX,e.clientY)})),document.body.addEventListener("mouseleave",handleCanvasPointerUp);else{let e=null;canvas.addEventListener("touchstart",(t=>{if(!pointerIsDown){const o=t.changedTouches[0];e=o.identifier,handleCanvasPointerDown(o.clientX,o.clientY)}})),canvas.addEventListener("touchend",(t=>{for(let o of t.changedTouches)if(o.identifier===e){handleCanvasPointerUp();break}})),canvas.addEventListener("touchmove",(t=>{for(let o of t.changedTouches)if(o.identifier===e){handleCanvasPointerMove(o.clientX,o.clientY),t.preventDefault();break}}),{passive:!1})}setupCanvases();