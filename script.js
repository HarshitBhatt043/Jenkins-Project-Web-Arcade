"use strict";var sceneWidth,sceneHeight,camera,scene,renderer,dom,sun,ground,rollingGroundSphere,ball,ballRollingSpeed,sphericalHelper,pathAngleValues,currentLane,clock,jumping,treesInPath,treesPool,explodeParticleGeometry,explodeParticles,titleText,scoreText,pausedText,highText,score,highScore,paused,rollingSpeed=.008,worldRadius=26,heroRadius=.2,heroBaseY=1.86,bounceValue=.1,gravity=.005,leftLane=-1,rightLane=1,middleLane=0,treeReleaseInterval=.5,lastTreeReleaseTime=0,particleCount=20,explosionPower=1.06;function init(){createScene(),update()}function createScene(){score=0,highScore=0,paused=!1,treesInPath=[],treesPool=[],(clock=new THREE.Clock).start(),ballRollingSpeed=rollingSpeed*worldRadius/heroRadius/5,sphericalHelper=new THREE.Spherical,pathAngleValues=[1.52,1.57,1.62],sceneWidth=window.innerWidth-20,sceneHeight=window.innerHeight-20,(scene=new THREE.Scene).fog=new THREE.FogExp2(9427199,.09),(camera=new THREE.PerspectiveCamera(60,sceneWidth/sceneHeight,.1,1e3)).position.z=8.5,camera.position.y=3.3,(renderer=new THREE.WebGLRenderer({alpha:!0})).setClearColor(9427199,1),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.setSize(sceneWidth,sceneHeight),(dom=document.getElementById("game")).appendChild(renderer.domElement),createTreesPool(),addWorld(),addBall(),addLight(),createExplosionParticles(),window.addEventListener("resize",onWindowResize,!1),document.onkeydown=handleKeyDown,(titleText=document.createElement("div")).style.position="absolute",titleText.style.fontFamily="Dela Gothic One",titleText.style.textAlign="center",titleText.innerHTML="ROLLING FORESTS",titleText.style.top="10px",titleText.style.color="#005000",window.innerWidth<600?(titleText.style.fontSize="24px",titleText.style.left=window.innerWidth/2-142.5+"px"):(titleText.style.fontSize="32px",titleText.style.left=window.innerWidth/2-190+"px"),document.body.appendChild(titleText),(pausedText=document.createElement("div")).style.position="absolute",pausedText.style.fontFamily="Dela Gothic One",pausedText.style.fontWeight="bold",pausedText.style.color="#000",window.innerWidth<600?(pausedText.style.fontSize="12px",pausedText.style.top="45px",pausedText.style.left="15px"):(pausedText.style.fontSize="24px",pausedText.style.top="50px",pausedText.style.left="30px"),document.body.appendChild(pausedText),(scoreText=document.createElement("div")).style.position="absolute",scoreText.style.fontFamily="Dela Gothic One",scoreText.style.fontWeight="bold",scoreText.style.color="#000",scoreText.innerHTML="Score: 0",window.innerWidth<600?(scoreText.style.fontSize="12px",scoreText.style.top="65px",scoreText.style.left="15px"):(scoreText.style.fontSize="24px",scoreText.style.top="80px",scoreText.style.left="30px"),document.body.appendChild(scoreText),(highText=document.createElement("div")).style.position="absolute",highText.style.fontFamily="Dela Gothic One",highText.style.fontWeight="bold",highText.style.color="#000",highText.innerHTML="High Score: 0",window.innerWidth<600?(highText.style.fontSize="12px",highText.style.top="85px",highText.style.left="15px"):(highText.style.fontSize="24px",highText.style.top="110px",highText.style.left="30px"),document.body.appendChild(highText)}function createExplosionParticles(){explodeParticleGeometry=new THREE.Geometry;for(var e=0;e<particleCount;e++){var t=new THREE.Vector3;explodeParticleGeometry.vertices.push(t)}var n=new THREE.PointsMaterial({color:1601560,transparent:!0,opacity:1,size:.2});explodeParticles=new THREE.Points(explodeParticleGeometry,n),scene.add(explodeParticles),explodeParticles.visible=!1}function createTreesPool(){for(var e,t=0;t<10;t++)e=createTree(),treesPool.push(e)}function handleKeyDown(e){37!==e.keyCode&&65!==e.keyCode||paused?39!==e.keyCode&&68!==e.keyCode||paused?80===e.keyCode||81===e.keyCode?paused?(pausedText.innerHTML="",paused=!1):(pausedText.innerHTML="Game Paused",paused=!0):38!==e.keyCode&&87!==e.keyCode&&32!==e.keyCode||jumping||paused||(bounceValue=.11,jumping=!0):currentLane==middleLane?currentLane=rightLane:currentLane==leftLane&&(currentLane=middleLane):currentLane==middleLane?currentLane=leftLane:currentLane==rightLane&&(currentLane=middleLane)}function handleSwipe(e){"right"!=e||paused?"left"!=e||paused?"down"==e?paused?(pausedText.innerHTML="",paused=!1):(pausedText.innerHTML="Game Paused",paused=!0):"up"!=e||jumping||paused||(bounceValue=.11,jumping=!0):currentLane==middleLane?currentLane=rightLane:currentLane==leftLane&&(currentLane=middleLane):currentLane==middleLane?currentLane=leftLane:currentLane==rightLane&&(currentLane=middleLane)}function addBall(){var e=new THREE.DodecahedronGeometry(heroRadius,1),t=new THREE.MeshStandardMaterial({color:16532739,shading:THREE.FlatShading});(ball=new THREE.Mesh(e,t)).receiveShadow=!0,ball.castShadow=!0,scene.add(ball),ball.position.y=heroBaseY,ball.position.z=4.8,currentLane=middleLane,ball.position.x=currentLane,jumping=!1}function addWorld(){for(var e,t,n=new THREE.SphereGeometry(worldRadius,40,40),o=new THREE.MeshStandardMaterial({color:15436659,shading:THREE.FlatShading}),r=new THREE.Vector3,i=new THREE.Vector3,a=new THREE.Vector3,l=new THREE.Vector3,s=1,d=.5,c=1;c<38;c++){s=c;for(var p=0;p<40;p++)e=40*s+1,r=n.vertices[p+e].clone(),c%2!=0&&(0==p&&(a=r.clone()),i=n.vertices[p+e+1].clone(),39==p&&(i=a),d=.5*Math.random()+.25,r.lerp(i,d)),t=.07*Math.random()-.035,l=r.clone().normalize().multiplyScalar(t),n.vertices[p+e]=r.add(l)}(rollingGroundSphere=new THREE.Mesh(n,o)).receiveShadow=!0,rollingGroundSphere.castShadow=!1,rollingGroundSphere.rotation.z=-Math.PI/2,scene.add(rollingGroundSphere),rollingGroundSphere.position.y=-24,rollingGroundSphere.position.z=2,addWorldTrees()}function addLight(){var e=new THREE.HemisphereLight(16775930,0,.9);scene.add(e),(sun=new THREE.DirectionalLight(13484485,.9)).position.set(12,6,-7),sun.castShadow=!0,scene.add(sun),sun.shadow.mapSize.width=256,sun.shadow.mapSize.height=256,sun.shadow.camera.near=.5,sun.shadow.camera.far=50}function addPathTree(){var e=[0,1,2],t=Math.floor(3*Math.random());addTree(!0,t),e.splice(t,1),Math.random()>.5&&addTree(!0,e[t=Math.floor(2*Math.random())])}function addWorldTrees(){for(var e=6.28/36,t=0;t<36;t++)addTree(!1,t*e,!0),addTree(!1,t*e,!1)}function addTree(e,t,n){var o;if(e){if(0==treesPool.length)return;(o=treesPool.pop()).visible=!0,treesInPath.push(o),sphericalHelper.set(worldRadius-.3,pathAngleValues[t],4-rollingGroundSphere.rotation.x)}else{o=createTree();var r=0;r=n?1.68+.1*Math.random():1.46-.1*Math.random(),sphericalHelper.set(worldRadius-.3,r,t)}o.position.setFromSpherical(sphericalHelper);var i=rollingGroundSphere.position.clone().normalize(),a=o.position.clone().normalize();o.quaternion.setFromUnitVectors(a,i),o.rotation.x+=Math.random()*(2*Math.PI/10)+-Math.PI/10,rollingGroundSphere.add(o)}function createTree(){var e=.15*Math.random()+.05,t=(new THREE.Vector3,new THREE.ConeGeometry(.5,1,8,6)),n=new THREE.MeshStandardMaterial({color:3407667,shading:THREE.FlatShading});t.vertices[0].clone(),blowUpTree(t.vertices,8,0,e),tightenTree(t.vertices,8,1),blowUpTree(t.vertices,8,2,1.1*e,!0),tightenTree(t.vertices,8,3),blowUpTree(t.vertices,8,4,1.2*e),tightenTree(t.vertices,8,5);var o=new THREE.Mesh(t,n);o.castShadow=!0,o.receiveShadow=!1,o.position.y=.9,o.rotation.y=Math.random()*Math.PI;var r=new THREE.CylinderGeometry(.1,.1,.5),i=new THREE.MeshStandardMaterial({color:12748848,shading:THREE.FlatShading}),a=new THREE.Mesh(r,i);a.position.y=.25;var l=new THREE.Object3D;return l.add(a),l.add(o),l}function blowUpTree(e,t,n,o,r){for(var i,a,l=new THREE.Vector3,s=e[0].clone(),d=0;d<t;d++)l=e[d+(i=n*t+1)].clone(),s.y=l.y,a=l.sub(s),r?d%2==0?(a.normalize().multiplyScalar(o/6),e[d+i].add(a)):(a.normalize().multiplyScalar(o),e[d+i].add(a),e[d+i].y=e[d+i+t].y+.05):d%2!=0?(a.normalize().multiplyScalar(o/6),e[d+i].add(a)):(a.normalize().multiplyScalar(o),e[d+i].add(a),e[d+i].y=e[d+i+t].y+.05)}function tightenTree(e,t,n){for(var o,r,i=new THREE.Vector3,a=e[0].clone(),l=0;l<t;l++)i=e[l+(o=n*t+1)].clone(),a.y=i.y,(r=i.sub(a)).normalize().multiplyScalar(.06),e[l+o].sub(r)}function update(){paused||(rollingGroundSphere.rotation.x+=rollingSpeed,ball.rotation.x-=ballRollingSpeed,ball.position.y<=heroBaseY&&(jumping=!1,bounceValue=.04*Math.random()+.005),ball.position.y+=bounceValue,ball.position.x=THREE.Math.lerp(ball.position.x,currentLane,2*clock.getDelta()),bounceValue-=gravity,clock.getElapsedTime()>treeReleaseInterval&&(clock.start(),addPathTree(),score+=1,scoreText.innerHTML=`Score: ${score.toString()}`),doTreeLogic(),doExplosionLogic(),render(),doDifficultyLogic()),requestAnimationFrame(update)}function doTreeLogic(){var e,t,n=new THREE.Vector3,o=[];treesInPath.forEach((function(t,r){e=treesInPath[r],n.setFromMatrixPosition(e.matrixWorld),n.z>6&&e.visible?o.push(e):n.distanceTo(ball.position)<=.6&&(score>highScore&&(highText.innerHTML=`High Score: ${score.toString()}`,highScore=score),score=0,explode())})),o.forEach((function(n,r){e=o[r],t=treesInPath.indexOf(e),treesInPath.splice(t,1),treesPool.push(e),e.visible=!1}))}function doExplosionLogic(){if(explodeParticles.visible){for(var e=0;e<particleCount;e++)explodeParticleGeometry.vertices[e].multiplyScalar(explosionPower);explosionPower>1.005?(explosionPower-=.001,explodeParticles.material.opacity-=.025):explodeParticles.visible=!1,explodeParticleGeometry.verticesNeedUpdate=!0}else explodeParticles.material.opacity=1}function explode(){explodeParticles.position.y=2,explodeParticles.position.z=4.8,explodeParticles.position.x=ball.position.x;for(var e=0;e<particleCount;e++){var t=new THREE.Vector3;t.x=.4*Math.random()-.2,t.y=.4*Math.random()-.2,t.z=.4*Math.random()-.2,explodeParticleGeometry.vertices[e]=t}explosionPower=1.07,explodeParticles.visible=!0}function doDifficultyLogic(){0===score?rollingSpeed=.008:rollingSpeed<.0095&&(rollingSpeed+=1e-5),0===score?treeReleaseInterval=.5:treeReleaseInterval>.2&&(treeReleaseInterval-=Math.log(score)/1e3)}function render(){renderer.render(scene,camera)}function onWindowResize(){sceneHeight=window.innerHeight-20,sceneWidth=window.innerWidth-20,titleText.style.left=window.innerWidth/2-190+"px",window.innerWidth<600?(titleText.style.fontSize="24px",titleText.style.left=window.innerWidth/2-142.5+"px"):(titleText.style.fontSize="32px",titleText.style.left=window.innerWidth/2-190+"px"),window.innerWidth<600?(pausedText.style.fontSize="12px",pausedText.style.top="45px",pausedText.style.left="15px"):(pausedText.style.fontSize="24px",pausedText.style.top="50px",pausedText.style.left="30px"),window.innerWidth<600?(scoreText.style.fontSize="12px",scoreText.style.top="65px",scoreText.style.left="15px"):(scoreText.style.fontSize="24px",scoreText.style.top="80px",scoreText.style.left="30px"),window.innerWidth<600?(highText.style.fontSize="12px",highText.style.top="85px",highText.style.left="15px"):(highText.style.fontSize="24px",highText.style.top="110px",highText.style.left="30px"),renderer.setSize(sceneWidth,sceneHeight),camera.aspect=sceneWidth/sceneHeight,camera.updateProjectionMatrix()}function detectSwipe(e,t,n=90){const o={sX:0,sY:0,eX:0,eY:0},r=Object.freeze({UP:"up",DOWN:"down",RIGHT:"right",LEFT:"left"});let i=null;const a=document.getElementById(e);a.addEventListener("touchstart",(function(e){const t=e.touches[0];o.sX=t.screenX,o.sY=t.screenY}),!1),a.addEventListener("touchmove",(function(e){const t=e.touches[0];o.eX=t.screenX,o.eY=t.screenY}),!1),a.addEventListener("touchend",(function(e){const l=o.eX-o.sX,s=o.eY-o.sY;l**2+s**2<n**2||(i=0===s||Math.abs(l/s)>1?l>0?r.LEFT:r.RIGHT:s>0?r.DOWN:r.UP,i&&"function"==typeof t&&t(a,i),i=null)}),!1)}init(),detectSwipe("body",((e,t)=>handleSwipe(t)));