import{Hub}from"./city3d/Hub.js";import{View}from"./city3d/View.js";import{saveAs}from"./saveAs.js";var d=document.getElementById("debug");const simulation_timestep=30;var stats=null;window.tilesData=null,window.spriteData=null,window.gameData=null,window.powerData=null,window.layerData=[],window.isMobile=!1,window.trans=!1,window.newup=!1,window.powerup=!1,window.directMessage=null,window.isWorker=!0,window.withHeight=!1;export class Main{static init(t){void 0!==t&&(directMessage=t,isWorker=!1),isMobile=testMobile(),this.initWorker(),window.hub=new Hub,window.view3d=new View(isMobile)}static initWorker(){isWorker?(window.cityWorker=new Worker("./build/citygame.min.js"),cityWorker.postMessage=cityWorker.webkitPostMessage||cityWorker.postMessage,cityWorker.onmessage=message,post({tell:"INIT",timestep:30})):post({tell:"INIT",timestep:30,returnMessage:message})}static start(){hub.start()}static sendTool(t){post({tell:"TOOL",name:t})}static destroy(t,e){post({tell:"MAPCLICK",x:t,y:e,single:!0})}static mapClick(t){var e=view3d.raypos;e.x<0&&e.z<0||post({tell:"MAPCLICK",x:e.x,y:e.z})}static selectTool(t){view3d.selectTool(t)}static setTimeColors(t){view3d.setTimeColors(t)}static newMap(t){view3d.inMapGenation||(hub.generate(!0),withHeight="NEW"!==t,view3d.inMapGenation=!0,setTimeout(post,1e3,{tell:"NEWMAP"}))}static playMap(){hub.initGameHub(),view3d.startZoom(),post({tell:"PLAYMAP"})}static selectTool(t){view3d.selectTool(t)}static setDifficulty(t){let e=0;"MEDIUM"===t&&(e=1),"HARD"===t&&(e=2),post({tell:"DIFFICULTY",n:e})}static setSpeed(t){post({tell:"SPEED",n:t})}static getBudjet(){post({tell:"BUDGET"})}static setBudjet(t){post({tell:"NEWBUDGET",budgetData:t})}static getEval(){post({tell:"EVAL"})}static setDisaster(t){post({tell:"DISASTER",disaster:t})}static setOverlays(t){}static saveGame(){var t=[];view3d.saveCityBuild(t),post({tell:"SAVEGAME",saveCity:t=JSON.stringify(t)})}static loadGame(t){var e=t||!1;e&&(hub.generate(!0),view3d.inMapGenation=!0),post({tell:"LOADGAME",isStart:e})}static newGameMap(){}static showStats(){view3d.isWithStats=!0}static hideStats(){view3d.isWithStats=!1}}function debug(t){d.innerHTML+="<br>"+t}function testMobile(){return!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))}function makeGameSave(t,e){if(window.localStorage.setItem(e,t),!view3d.isMobile){var a=new Blob([t],{type:"text/plain;charset=utf-8"});saveAs(a,"city3d.json")}}function makeLoadGame(t,e){var a=e||!1;let i;i=view3d.tmpGameData?view3d.tmpGameData:window.localStorage.getItem(t),i&&(post({tell:"MAKELOADGAME",savegame:i,isStart:a}),view3d.tmpGameData=null)}function post(t,e){isWorker?cityWorker.postMessage(t,e):directMessage({data:t})}function message(t){var e=t.data.tell;"NEWMAP"==e&&(hub.generate(!1),tilesData=t.data.tilesData,view3d.paintMap(t.data.mapSize,t.data.island,withHeight)),"FULLREBUILD"==e&&(t.data.isStart&&hub.generate(!1),view3d.fullRedraw=!0,tilesData=t.data.tilesData,view3d.paintMap(t.data.mapSize,t.data.island,withHeight),view3d.loadCityBuild(t.data.cityData),t.data.isStart&&view3d.startPlay()),"BUILD"==e&&view3d.build(t.data.x,t.data.y),"RUN"==e&&(tilesData=t.data.tilesData,powerData=t.data.powerData,spriteData=t.data.sprites,layerData=t.data.layer,hub.updateCITYinfo(t.data.infos),newup=!0,powerup=t.data.infos[9],view3d.updateLayer(),view3d.moveSprite(),view3d.showPower()),"BUDGET"==e&&hub.openBudget(t.data.budgetData),"QUERY"==e&&hub.openQuery(t.data.queryTxt),"EVAL"==e&&hub.openEval(t.data.evalData),"SAVEGAME"==e&&makeGameSave(t.data.gameData,t.data.key),"LOADGAME"==e&&makeLoadGame(t.data.key,t.data.isStart)}