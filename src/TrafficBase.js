import*as THREE from"../build/three.module.js";import{GLTFLoader}from"./jsm/loaders/GLTFLoader.js";import{DRACOLoader}from"./jsm/loaders/DRACOLoader.js";import{OrbitControls}from"./jsm/controls/OrbitControls.js";import{mergeBufferGeometries}from"./jsm/utils/BufferGeometryUtils.js";import{TrafficWorld,Traffic}from"./traffic/Traffic.js";export class TrafficBase extends THREE.Group{constructor(t={}){super();let s=void 0===t.isStandard||t.isStandard;this.position.y=.01,this.callback=t.callback||null,this.cars=[],this.roads=[],this.inter=[],this.mats={},this.mapPath="./assets/textures/",this.modelPath="./assets/models/";const i=new THREE.TextureLoader;this.grid=Traffic.settings.gridSize,this.sets={timeFactor:5,lightsFlip:0};const e=s?THREE.MeshStandardMaterial:THREE.MeshBasicMaterial;let a=s?{metalness:.8,roughness:.2}:{};this.car_geo={},this.car_mat=[],this.car_mat[0]=new e(a),this.car_mat[1]=new e(a),this.car_mat[2]=new e(a);let r=new Image;r.onload=function(){this.generateRandomColor(r,this.car_mat[0]),this.generateRandomColor(r,this.car_mat[1]),this.generateRandomColor(r,this.car_mat[2])}.bind(this),r.src=this.mapPath+"cars.png",this.inter_geo=new THREE.PlaneGeometry(this.grid,this.grid),this.inter_geo.applyMatrix4((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),this.road_geo=new THREE.PlaneGeometry(this.grid,this.grid),this.road_geo.applyMatrix4((new THREE.Matrix4).makeRotationX(.5*-Math.PI)),this.mats.inter_mat=new e({map:i.load(this.mapPath+"roadx.png"),...a}),this.mats.road_mat=new e({map:i.load(this.mapPath+"road.png"),...a});if(0){let t=19,s=.5*t-.5*this.grid,i=new THREE.GridHelper(t,t,0,2105376);i.position.set(s,-.01,s),this.add(i)}this.loadCarsModel()}clearAll(){clearInterval(this.interval);let t=this.children.length;for(;t--;)this.remove(this.children[t]);for(let t in this.car_geo)this.car_geo[t].dispose();this.road_geo.dispose(),this.inter_geo.dispose(),this.car_mat[0].dispose(),this.car_mat[1].dispose(),this.car_mat[2],this.mats.inter_mat.dispose(),this.mats.road_mat.dispose(),this.cars=[],this.roads=[],this.inter=[],this.mats={},this.parent.remove(this)}init(){Traffic.settings.gridSize=1,Traffic.settings.carScale=.05,Traffic.settings.carSpeed=.05,Traffic.settings.defaultTimeFactor=5,this.world=new TrafficWorld,this.world.generateMap(2,2,4,1,100),this.previousTime=0,this.sets.timeFactor=Traffic.settings.defaultTimeFactor,this.sets.lightsFlip=Traffic.settings.lightsFlipInterval,this.interval=setInterval(this.update.bind(this),1e3/60),this.callback&&this.callback()}update(){Traffic.settings.lightsFlipInterval=this.sets.lightsFlip;let t=Date.now();this.lastUpdate;this.lastUpdate=t;let s,i,e,a,r=Date.now(),o=r-this.previousTime||0;for(a in o>100&&(o=100),this.previousTime=r,this.world.onTick(this.sets.timeFactor*o/1e3),s=this.world.intersections.all(),s)this.addInter(s[a]);for(a in i=this.world.roads.all(),i)this.addRoad(i[a]),this.addSignals(i[a]);let n=this.world.toRemove.length;for(;n--;)this.removeCar(this.world.toRemove[n]);for(a in this.world.clearTmpRemove(),e=this.world.cars.all(),e)this.addCar(e[a],a)}generateRandomColor(t,s){const i=document.createElement("canvas");i.width=i.height=1024;const e=i.getContext("2d");let a,r=0,o=0;for(a=0;a<16;a++)e.beginPath(),11!==a&&15!==a&&(e.fillStyle=this.randCarColor()),e.rect(256*r,256*o,256,256),e.fill(),r++,4==r&&(r=0,o++);e.drawImage(t,0,0,1024,1024);let n=new THREE.Texture(i);n.needsUpdate=!0,n.flipY=!1,s.map=n,s.needsUpdate=!0}loadCarsModel(){let t=this.car_geo,s=new GLTFLoader,i=(new DRACOLoader).setDecoderPath("./build/draco/");s.setDRACOLoader(i),s.load(this.modelPath+"cars.glb",function(s){s.scene.traverse((function(s){s.isMesh&&(t[s.name]=s.geometry)})),this.init()}.bind(this))}addRoad(t){if(null==t.source||null==t.target)throw Error("invalid road");let s=t.id.substring(4);if(null==this.roads[s]){let i,e=t.source.rect.pos(),a=t.target.rect.pos(),r=(a.x-e.x)/this.grid,o=(a.y-e.y)/this.grid,n=0,h=1;if(0!=o&&(n=1),0==n?(i=Math.abs(r)-1,r<0&&(h=-1)):(i=Math.abs(o)-1,o<0&&(h=-1)),i<=0)return;let l,d=new THREE.Matrix4,m=[];for(;i--;)0==n?(d.makeTranslation(e.x+this.grid*h+i*this.grid*h,0,e.y),d.multiply((new THREE.Matrix4).makeRotationY(.5*Math.PI))):d.makeTranslation(e.x,0,e.y+this.grid*h+i*this.grid*h),l=this.road_geo.clone(),l.applyMatrix4(d),m.push(l);let c=mergeBufferGeometries(m),g=new THREE.Mesh(c,this.mats.road_mat);this.add(g),this.roads[s]=g}}addSignals(t,s){}addCar(t){let s=t.id.substring(3);if(null==this.cars[s]){let i=this.randInt(0,2),e=new THREE.Mesh(this.car_geo[Traffic.TYPE_OF_CARS[t.type].m],this.car_mat[i]);this.add(e),e.position.set(1e4,0,0),e.scale.set(5,5,5),this.cars[s]=e}else{let i=t.pos,e=t.direction;this.cars[s].position.set(i.x,0,i.y),this.cars[s].rotation.y=-e+.5*Math.PI}}removeCar(t){t=t.substring(3),null!=this.cars[t]&&(this.remove(this.cars[t]),this.cars[t]=null)}addInter(t){let s=t.id.substring(12);if(null==this.inter[s]){this.inter[s]=new THREE.Mesh(this.inter_geo,this.mats.inter_mat),this.add(this.inter[s]);t.roads.length;let i=t.rect.pos();this.inter[s].position.set(i.x,0,i.y)}else{t.controlSignals.state[0]}}randColor(){return"#"+Math.floor(16777215*Math.random()).toString(16)}randCarColor(){let t,s=this.randInt(0,100),i=this.randInt(0,3);t=s<23?0:s<44?1:s<62?2:s<76?3:s<84?4:s<90?5:s<96?6:s<97?7:s<98?8:9;let e=[[16777215,13685203,15724527,15658734],[2433314,3156523,2569771,3092779],[9278613,12697788,13554900,12502212],[9672089,4342338,5921370,7632501],[12863776,16729121,6292233,14226462],[4903419,2579043,1150428,2725030],[10910006,8866081,14132587,5570567],[6287660,1605703,9285161,1750553],[16773386,16777149,16579295,16760074],[12134760,6036047,4693,16758759]][t][i].toString(16);return e=e.length<6?"#0"+e:"#"+e,e}randInt(t,s){return t+Math.floor(Math.random()*(s-t+1))}}