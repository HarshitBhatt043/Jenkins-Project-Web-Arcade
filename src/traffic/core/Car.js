import{Traffic}from"../Traffic.js";import{Trajectory}from"./Trajectory.js";export class Car{constructor(e,t){this.type=Traffic.rand(Traffic.TYPE_OF_CARS.length-1),this.id=Traffic.uniqueId("car"),this.color=(300+240*Traffic.random()|0)%360,this._speed=0,this.width=Traffic.TYPE_OF_CARS[this.type].w*Traffic.settings.carScale,this.length=Traffic.TYPE_OF_CARS[this.type].l*Traffic.settings.carScale,this.maxSpeed=30*Traffic.settings.carSpeed,Traffic.TYPE_OF_CARS[this.type].maxSpeed&&(this.maxSpeed=Traffic.TYPE_OF_CARS[this.type].maxSpeed*Traffic.settings.carSpeed),this.s0=2*Traffic.settings.carScale,this.s1=1*Traffic.settings.carScale,this.timeHeadway=1.5*Traffic.settings.carSpeed,this.maxAcceleration=1*Traffic.settings.carSpeed,this.maxDeceleration=3*Traffic.settings.carSpeed,this.mid=.5*Traffic.settings.gridSize,this.trajectory=new Trajectory(this,e,t),this.alive=!0,this.preferedLane=null,this.toLongStop=0}get pos(){let e=this.coords;return{x:e.x-this.mid,y:e.y-this.mid}}get coords(){return this.trajectory.coords}get speed(){return this._speed}set speed(e){this._speed=Traffic.clamp(e,0,this.maxSpeed)}get direction(){return this.trajectory.direction}release(){return this.trajectory.release()}getAcceleration(){let e,t,r,i,a,s,n,c,h,o,f,l,d,p,T;return f=this.trajectory.nextCarDistance,c=Traffic.max(f.distance,0),e=this.maxAcceleration,t=this.maxDeceleration,s=this.speed-(null!=(T=f.car)?T.speed:void 0)||0,h=Traffic.pow(this.speed/this.maxSpeed,4),n=this.s0,p=this.speed*this.timeHeadway,r=this.speed*s/(2*Traffic.sqrt(e*t)),l=n+p+r,i=Traffic.pow(l/c,2),d=this.s1+p+Traffic.pow(this.speed,2)/(2*t),o=Traffic.pow(d/this.trajectory.distanceToStopLine,2),a=1-h-i-o,this.maxAcceleration*a}move(e){let t,r,i,a,s;if(t=this.getAcceleration(),this.speed+=t*e,!this.trajectory.isChangingLanes&&this.nextLane){switch(r=this.trajectory.current.lane,s=r.getTurnDirection(this.nextLane),s){case 0:i=r.leftmostAdjacent;break;case 2:i=r.rightmostAdjacent;break;default:i=r}i!==r&&this.trajectory.changeLane(i)}if(a=this.speed*e+.5*t*Traffic.pow(e,2),this.trajectory.nextCarDistance.distance,this.trajectory.timeToMakeTurn(a)&&null==this.nextLane)return this.alive=!1;this.trajectory.isChangingLanes&&(a<=0?this.toLongStop++:this.toLongStop=0,this.toLongStop>1e3&&(this.alive=!1)),this.trajectory.moveForward(a)}pickNextRoad(){let e,t,r;return t=this.trajectory.nextIntersection,e=this.trajectory.current.lane,r=t.roads.filter((function(t){return t.target!==e.road.source})),0===r.length?null:Traffic.sample(r)}pickNextLane(){let e,t,r;if(this.nextLane)throw Error("next lane is already chosen");if(this.nextLane=null,t=this.pickNextRoad(),!t)return null;if(r=this.trajectory.current.lane.road.getTurnDirection(t),e=function(){switch(r){case 0:return t.lanesNumber-1;break;case 1:return Traffic.rand(0,t.lanesNumber-1);break;case 2:return 0;break}}(),this.nextLane=t.lanes[e],!this.nextLane)throw Error("can not pick next lane");return this.nextLane}popNextLane(){let e=this.nextLane;return this.nextLane=null,this.preferedLane=null,e}}