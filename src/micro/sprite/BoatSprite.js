import{BaseSprite}from"./BaseSprite.js";import{Micro}from"../Micro.js";import{Tile}from"../Tile.js";import{Messages}from"../Messages.js";import{SpriteUtils}from"./SpriteUtils.js";import{math}from"../math/math.js";export class BoatSprite extends BaseSprite{constructor(i,t,e,s){super(),this.init(Micro.SPRITE_SHIP,i,t,e,s),this.width=48,this.height=48,this.xOffset=-24,this.yOffset=-24,e<SpriteUtils.worldToPix(4)?this.frame=3:e>=SpriteUtils.worldToPix(i.width-4)?this.frame=7:s<SpriteUtils.worldToPix(4)?this.frame=5:s>=SpriteUtils.worldToPix(i.height-4)?this.frame=1:this.frame=3,this.newDir=this.frame,this.dir=10,this.count=1,this.tileDeltaX=[0,0,1,1,1,0,-1,-1,-1],this.tileDeltaY=[0,-1,-1,0,1,1,1,0,-1],this.xDelta=[0,0,2,2,2,0,-2,-2,-2],this.yDelta=[0,-2,-2,0,2,2,2,0,-2],this.tileWhiteList=[Tile.RIVER,Tile.CHANNEL,Tile.POWERBASE,Tile.POWERBASE+1,Tile.RAILBASE,Tile.RAILBASE+1,Tile.BRWH,Tile.BRWV],this.CANTMOVE=10}move(i,t,e,s){let r,h,o,l,a,n,m=Tile.RIVER;if(this.soundCount>0&&this.soundCount--,0===this.soundCount&&(1==(3&math.getRandom16())&&t.sendMessage(Messages.SOUND_HONKHONK),this.soundCount=200),this.count>0&&this.count--,0===this.count){if(this.count=9,this.frame!==this.newDir)return void(this.frame=SpriteUtils.turnTo(this.frame,this.newDir));for(r=7&math.getRandom16(),h=this.frame,o=r;o<r+8;o++)if(h=1+(7&o),h!==this.dir&&(l=SpriteUtils.pixToWorld(this.x)+this.tileDeltaX[h],a=SpriteUtils.pixToWorld(this.y)+this.tileDeltaY[h],this.map.testBounds(l,a)&&(n=this.map.getTileValue(l,a),n===Tile.CHANNEL||n===Tile.BRWH||n===Tile.BRWV||this.oppositeAndUnderwater(n,this.dir,h)))){this.newDir=h,this.frame=SpriteUtils.turnTo(this.frame,this.newDir),this.dir=h+4,this.dir>8&&(this.dir-=8);break}o===r+8&&(this.dir=this.CANTMOVE,this.newDir=1+(7&math.getRandom16()))}else h=this.frame,h===this.newDir&&(this.x+=this.xDelta[h],this.y+=this.yDelta[h]);if(this.spriteNotInBounds())this.frame=0;else for(let i=0;i<8&&m!==this.tileWhiteList[i];i++)7===i&&(this.explodeSprite(t),SpriteUtils.destroyMapTile(this.spriteManager,this.map,s,this.x,this.y))}explodeSprite(i){this.frame=0,this.spriteManager.makeExplosionAt(this.x,this.y),i.sendMessage(Messages.SHIP_CRASHED)}oppositeAndUnderwater(i,t,e){let s=t+4;return s>8&&(s-=8),e==s&&(i==Tile.POWERBASE||i==Tile.POWERBASE+1||i==Tile.RAILBASE||i==Tile.RAILBASE+1)}}