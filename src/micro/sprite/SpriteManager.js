import{BaseSprite}from"./BaseSprite.js";import{Micro}from"../Micro.js";import{Tile}from"../Tile.js";import{Messages}from"../Messages.js";import{SpriteUtils}from"./SpriteUtils.js";import{TrainSprite}from"./TrainSprite.js";import{BoatSprite}from"./BoatSprite.js";import{MonsterSprite}from"./MonsterSprite.js";import{CopterSprite}from"./CopterSprite.js";import{AirplaneSprite}from"./AirplaneSprite.js";import{TornadoSprite}from"./TornadoSprite.js";import{ExplosionSprite}from"./ExplosionSprite.js";import{math}from"../math/math.js";const constructors={};constructors[Micro.SPRITE_TRAIN]=TrainSprite,constructors[Micro.SPRITE_SHIP]=BoatSprite,constructors[Micro.SPRITE_MONSTER]=MonsterSprite,constructors[Micro.SPRITE_HELICOPTER]=CopterSprite,constructors[Micro.SPRITE_AIRPLANE]=AirplaneSprite,constructors[Micro.SPRITE_TORNADO]=TornadoSprite,constructors[Micro.SPRITE_EXPLOSION]=ExplosionSprite;export class SpriteManager{constructor(t){this.spriteList=[],this.map=t,this.spriteCycle=0}getSprite(t){let i=this.spriteList.filter((function(i){return 0!==i.frame&&i.type===t}));return 0===i.length?null:i[0]}getSpriteList(){return this.spriteList.slice()}getSpritesInView(t,i,e,r){return t=SpriteUtils.worldToPix(t),i=SpriteUtils.worldToPix(i),e=SpriteUtils.worldToPix(e),r=SpriteUtils.worldToPix(r),this.spriteList.filter((function(s){return s.x+s.xOffset>=t&&s.y+s.yOffset>=i&&!(s.x+s.xOffset>=e&&s.y+s.yOffset>=r)}))}moveObjects(t){t||(t=Micro.simData);let i=t.messageManager,e=t.disasterManager,r=t.blockMaps;this.spriteCycle+=1;let s=this.spriteList.slice(),o=s.length;for(;o--;){let t=s[o];0!==t.frame&&t.move(this.spriteCycle,i,e,r)}this.pruneDeadSprites()}makeSprite(t,i,e){this.spriteList.push(new constructors[t](this.map,this,i,e))}makeTornado(t){let i=this.getSprite(Micro.SPRITE_TORNADO);if(null!==i)return void(i.count=200);let e=math.getRandom(SpriteUtils.worldToPix(this.map.width)-800)+400,r=math.getRandom(SpriteUtils.worldToPix(this.map.height)-200)+100;this.makeSprite(Micro.SPRITE_TORNADO,e,r),t.sendMessage(Messages.TORNADO_SIGHTED,{x:SpriteUtils.pixToWorld(e),y:SpriteUtils.pixToWorld(r)})}makeExplosion(t,i){this.map.testBounds(t,i)&&this.makeExplosionAt(SpriteUtils.worldToPix(t),SpriteUtils.worldToPix(i))}makeExplosionAt(t,i){this.makeSprite(Micro.SPRITE_EXPLOSION,t,i)}generatePlane(t,i){null===this.getSprite(Micro.SPRITE_AIRPLANE)&&this.makeSprite(Micro.SPRITE_AIRPLANE,SpriteUtils.worldToPix(t),SpriteUtils.worldToPix(i))}generateTrain(t,i,e){t.totalPop>20&&null===this.getSprite(Micro.SPRITE_TRAIN)&&0===math.getRandom(25)&&this.makeSprite(Micro.SPRITE_TRAIN,SpriteUtils.worldToPix(i)+8,SpriteUtils.worldToPix(e)+8)}generateShip(){let t,i;if(math.getChance(3))for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,0)===Tile.CHANNEL)return void this.makeShipHere(t,0);if(math.getChance(3))for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(0,i)===Tile.CHANNEL)return void this.makeShipHere(0,i);if(math.getChance(3))for(t=4;t<this.map.width-2;t++)if(this.map.getTileValue(t,this.map.height-1)===Tile.CHANNEL)return void this.makeShipHere(t,this.map.height-1);if(math.getChance(3))for(i=1;i<this.map.height-2;i++)if(this.map.getTileValue(this.map.width-1,i)===Tile.CHANNEL)return void this.makeShipHere(this.map.width-1,i)}getBoatDistance(t,i){let e,r=99999,s=SpriteUtils.worldToPix(t)+8,o=SpriteUtils.worldToPix(i)+8;for(let t=0,i=this.spriteList.length;t<i;t++)if(e=this.spriteList[t],e.type===Micro.SPRITE_SHIP&&0!==e.frame){let t=Math.abs(e.x-s)+Math.abs(e.y-o);r=Math.min(r,t)}return r}makeShipHere(t,i){this.makeSprite(Micro.SPRITE_SHIP,SpriteUtils.worldToPix(t),SpriteUtils.worldToPix(i))}generateCopter(t,i){null===this.getSprite(Micro.SPRITE_HELICOPTER)&&this.makeSprite(Micro.SPRITE_HELICOPTER,SpriteUtils.worldToPix(t),SpriteUtils.worldToPix(i))}makeMonsterAt(t,i,e){this.makeSprite(Micro.SPRITE_MONSTER,SpriteUtils.worldToPix(i),SpriteUtils.worldToPix(e)),t.sendMessage(Messages.MONSTER_SIGHTED,{x:i,y:e})}makeMonster(t){let i=this.getSprite(Micro.SPRITE_MONSTER);null!==i&&(i.soundCount=1,i.count=1e3,i.destX=SpriteUtils.worldToPix(this.map.pollutionMaxX),i.destY=SpriteUtils.worldToPix(this.map.pollutionMaxY));let e=0;for(let i=0;i<300;i++){let i=math.getRandom(this.map.width-20)+10,r=math.getRandom(this.map.height-10)+5;if(this.map.getTile(i,r).getValue()===Tile.RIVER){this.makeMonsterAt(t,i,r),e=1;break}}0===e&&this.makeMonsterAt(t,60,50)}pruneDeadSprites(t){this.spriteList=this.spriteList.filter((function(t){return 0!==t.frame}))}}