import{Micro}from"./Micro.js";import{Messages}from"./Messages.js";import{MessageManager}from"./MessageManager.js";import{TXT}from"./Text.js";import{SpriteManager}from"./sprite/SpriteManager.js";import{Evaluation}from"./game/Evaluation.js";import{Valves}from"./game/Valves.js";import{Budget}from"./game/Budget.js";import{Census}from"./game/Census.js";import{BlockMap}from"./game/BlockMap.js";import{PowerManager}from"./game/PowerManager.js";import{MapScanner}from"./game/MapScanner.js";import{RepairManager}from"./game/RepairManager.js";import{Traffic}from"./game/Traffic.js";import{DisasterManager}from"./game/DisasterManager.js";import{Residential}from"./zone/Residential.js";import{Commercial}from"./zone/Commercial.js";import{Industrial}from"./zone/Industrial.js";import{Road}from"./zone/Road.js";import{Transport}from"./zone/Transport.js";import{EmergencyServices}from"./zone/EmergencyServices.js";import{MiscTiles}from"./zone/MiscTiles.js";import{Stadia}from"./zone/Stadia.js";import{MapUtils}from"./map/MapUtils.js";export class Simulation{constructor(s,e,a,i,t){if(e!==Micro.LEVEL_EASY&&e!==Micro.LEVEL_MED&&e!==Micro.LEVEL_HARD)throw new Error("Invalid level!");this.map=s,this.gameLevel=e,this.div=this.map.width/8,this.is3D=i||!1,this.time="undefined"==typeof performance?Date:performance,this.speed=a,this.speedCycle=0,this.phaseCycle=0,this.simCycle=0,this.doInitialEval=!0,this.cityTime=50,this.cityPopLast=0,this.messageLast=Messages.VILLAGE_REACHED,this.startingYear=1900,this.resValveLast=0,this.comValveLast=0,this.indValveLast=0,this._cityYearLast=-1,this._cityMonthLast=-1,this._lastPowerMessage=null,this.infos=[],this.evaluation=new Evaluation(this.gameLevel),this.valves=new Valves,this.budget=new Budget,this.census=new Census,this.powerManager=new PowerManager(this.map),this.spriteManager=new SpriteManager(this.map),this.mapScanner=new MapScanner(this.map),this.repairManager=new RepairManager(this.map),this.traffic=new Traffic(this.map,this.spriteManager),this.disasterManager=new DisasterManager(this.map,this.spriteManager,this.gameLevel),this.messageManager=new MessageManager,Micro.messageManager=this.messageManager;let r=this.map.width,n=this.map.height;this.blockMaps={cityCentreDistScoreMap:new BlockMap(r,n,8),crimeRateMap:new BlockMap(r,n,2),fireStationMap:new BlockMap(r,n,8),fireStationEffectMap:new BlockMap(r,n,8),landValueMap:new BlockMap(r,n,2),policeStationMap:new BlockMap(r,n,8),policeStationEffectMap:new BlockMap(r,n,8),pollutionDensityMap:new BlockMap(r,n,2),populationDensityMap:new BlockMap(r,n,2),rateOfGrowthMap:new BlockMap(r,n,8),terrainDensityMap:new BlockMap(r,n,4),trafficDensityMap:new BlockMap(r,n,2),tempMap1:new BlockMap(r,n,2),tempMap2:new BlockMap(r,n,2),tempMap3:new BlockMap(r,n,4)},this.clearCensus(),t?this.load(t):(this.budget.setFunds(2e4),this.census.totalPop=1),Micro.simData=this,this.init()}save(s){for(let e=0,a=Micro.savePropsVar.length;e<a;e++)s[Micro.savePropsVar[e]]=this[Micro.savePropsVar[e]];this.map.save(s),this.evaluation.save(s),this.valves.save(s),this.budget.save(s),this.census.save(s)}load(s){this.messageManager.clear();for(let e=0,a=Micro.savePropsVar.length;e<a;e++)this[Micro.savePropsVar[e]]=s[Micro.savePropsVar[e]];this.evaluation.load(s),this.valves.load(s),this.budget.load(s),this.census.load(s)}setSpeed(s){this.speed=s}setDifficulty(s){if(s!==Micro.LEVEL_EASY&&s!==Micro.LEVEL_MED&&s!==Micro.LEVEL_HARD)throw new Error("Invalid level!");this.gameLevel=s,this.disasterManager.setDifficulty(this.gameLevel)}isPaused(){return this.speed===Micro.SPEED_PAUSED}simTick(){let s=this.simFrame();return s&&(this.updateTime(),this.updateInfo()),s}updateInfo(){return this.infos[0]=[TXT.months[this._cityMonthLast],this._cityYearLast].join(" "),this.infos[1]=TXT.cityClass[this.evaluation.cityScore],this.infos[2]=this.evaluation.cityScore,this.infos[3]=this.evaluation.cityPop,this.infos[4]=this.budget.totalFunds,this.infos[5]=this.valves.resValve,this.infos[6]=this.valves.comValve,this.infos[7]=this.valves.indValve,this.infos[9]=this.map.powerChange,this.map.powerChange=!1,this.infos}simFrame(){if(this.budget.awaitingValues)return!1;if(this.speed===Micro.SPEED_PAUSED)return!1;let s=100;this.speed===Micro.SPEED_MED&&(s=50),this.speed===Micro.SPEED_FAST&&(s=10),this.speed===Micro.SPEED_ULTRA&&(s=5);let e=this.time.now();return!(e-this.prevTime<s)&&(this.messageManager.clear(),this.simulate(),this.prevTime=e,!0)}clearCensus(){this.census.clearCensus(),this.powerManager.clearPowerStack(),this.blockMaps.fireStationMap.clear(),this.blockMaps.policeStationMap.clear()}init(){this.prevTime=-1,this.powerManager.registerHandlers(this.mapScanner,this.repairManager),Commercial.registerHandlers(this.mapScanner,this.repairManager),EmergencyServices.registerHandlers(this.mapScanner,this.repairManager),Industrial.registerHandlers(this.mapScanner,this.repairManager),MiscTiles.registerHandlers(this.mapScanner,this.repairManager),Road.registerHandlers(this.mapScanner,this.repairManager),Residential.registerHandlers(this.mapScanner,this.repairManager),Stadia.registerHandlers(this.mapScanner,this.repairManager),Transport.registerHandlers(this.mapScanner,this.repairManager),this.evaluation.evalInit(),this.valves.setValves(this.gameLevel,this.census,this.budget),this.clearCensus(),this.mapScanner.mapScan(0,this.map.width,null),this.powerManager.doPowerScan(this.census),MapUtils.pollutionTerrainLandValueScan(this.map,this.census,this.blockMaps),MapUtils.crimeScan(this.census,this.blockMaps),MapUtils.populationDensityScan(this.map,this.blockMaps),MapUtils.fireAnalysis(this.blockMaps)}simulate(){this.phaseCycle&=15;let s=this.speed-1;switch(this.phaseCycle){case 0:++this.simCycle>1023&&(this.simCycle=0),this.doInitialEval&&(this.doInitialEval=!1,this.evaluation.cityEvaluation()),this.cityTime++,0==(1&this.simCycle)&&this.valves.setValves(this.gameLevel,this.census,this.budget),this.clearCensus();break;case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:this.mapScanner.mapScan((this.phaseCycle-1)*this.div,this.phaseCycle*this.div,null);break;case 9:this.cityTime%Micro.CENSUS_FREQUENCY_10==0&&this.census.take10Census(this.budget),this.cityTime%Micro.CENSUS_FREQUENCY_120==0&&this.census.take120Census(this.budget),this.cityTime%Micro.TAX_FREQUENCY==0&&(this.budget.collectTax(this.gameLevel,this.census),this.evaluation.cityEvaluation());break;case 10:this.simCycle%5==0&&MapUtils.neutraliseRateOfGrowthMap(this.blockMaps),MapUtils.neutraliseTrafficMap(this.blockMaps),this.sendMessages();break;case 11:this.simCycle%Micro.speedPowerScan[s]==0&&this.powerManager.doPowerScan(this.census);break;case 12:this.simCycle%Micro.speedPollutionTerrainLandValueScan[s]==0&&MapUtils.pollutionTerrainLandValueScan(this.map,this.census,this.blockMaps);break;case 13:this.simCycle%Micro.speedCrimeScan[s]==0&&MapUtils.crimeScan(this.census,this.blockMaps);break;case 14:this.simCycle%Micro.speedPopulationDensityScan[s]==0&&MapUtils.populationDensityScan(this.map,this.blockMaps);break;case 15:this.simCycle%Micro.speedFireAnalysis[s]==0&&MapUtils.fireAnalysis(this.blockMaps),this.disasterManager.doDisasters(this.census);break}this.phaseCycle=this.phaseCycle+1&15}sendMessages(){this.checkGrowth();let s=this.census.resZonePop+this.census.comZonePop+this.census.indZonePop,e=this.census.nuclearPowerPop+this.census.coalPowerPop;switch(63&this.cityTime){case 1:Math.floor(s/4)>=this.census.resZonePop&&this.messageManager.sendMessage(Messages.NEED_MORE_RESIDENTIAL);break;case 5:Math.floor(s/8)>=this.census.comZonePop&&this.messageManager.sendMessage(Messages.NEED_MORE_COMMERCIAL);break;case 10:Math.floor(s/8)>=this.census.indZonePop&&this.messageManager.sendMessage(Messages.NEED_MORE_INDUSTRIAL);break;case 14:s>10&&2*s>this.census.roadTotal&&this.messageManager.sendMessage(Messages.NEED_MORE_ROADS);break;case 18:s>50&&s>this.census.railTotal&&this.messageManager.sendMessage(Messages.NEED_MORE_RAILS);break;case 22:s>10&&0==e&&this.messageManager.sendMessage(Messages.NEED_ELECTRICITY);break;case 26:this.census.resPop>500&&0===this.census.stadiumPop?(this.messageManager.sendMessage(Messages.NEED_STADIUM),this.valves.resCap=!0):this.valves.resCap=!1;break;case 28:this.census.indPop>70&&0===this.census.seaportPop?(this.messageManager.sendMessage(Messages.NEED_SEAPORT),this.valves.indCap=!0):this.valves.indCap=!1;break;case 30:this.census.comPop>100&&0===this.census.airportPop?(this.messageManager.sendMessage(Messages._NEED_AIRPORT),this.valves.comCap=!0):this.valves.comCap=!1;break;case 32:let a=this.census.unpoweredZoneCount+this.census.poweredZoneCount;a>0&&this.census.poweredZoneCount/a<.7&&this.messageManager.sendMessage(Messages.BLACKOUTS_REPORTED);break;case 35:this.census.pollutionAverage>60&&this.messageManager.sendMessage(Messages.HIGH_POLLUTION);break;case 42:this.census.crimeAverage>100&&this.messageManager.sendMessage(Messages.HIGH_CRIME);break;case 45:this.census.totalPop>60&&0===this.census.fireStationPop&&this.messageManager.sendMessage(Messages.NEED_FIRE_STATION);break;case 48:this.census.totalPop>60&&0===this.census.policeStationPop&&this.messageManager.sendMessage(Messages.NEED_POLICE_STATION);break;case 51:this.budget.cityTax>12&&this.messageManager.sendMessage(Messages.TAX_TOO_HIGH);break;case 54:this.budget.roadEffect<Math.floor(5*this.budget.MAX_ROAD_EFFECT/8)&&this.census.roadTotal>30&&this.messageManager.sendMessage(Messages.ROAD_NEEDS_FUNDING);break;case 57:this.budget.fireEffect<Math.floor(7*this.budget.MAX_FIRE_STATION_EFFECT/10)&&this.census.totalPop>20&&this.messageManager.sendMessage(Messages.FIRE_STATION_NEEDS_FUNDING);break;case 60:this.budget.policeEffect<Math.floor(7*this.budget.MAX_POLICE_STATION_EFFECT/10)&&this.census.totalPop>20&&this.messageManager.sendMessage(Messages.POLICE_NEEDS_FUNDING);break;case 63:this.census.trafficAverage>60&&this.messageManager.sendMessage(Messages.TRAFFIC_JAMS,-1,-1,!0);break}}checkGrowth(){if(0!=(3&this.cityTime))return;let s="",e=this.evaluation.getPopulation(this.census);if(e!==this.cityPopLast){let a=this.evaluation.getCityClass(this.cityPopLast),i=this.evaluation.getCityClass(e);if(a!==i)switch(i){case Micro.CC_VILLAGE:break;case Micro.CC_TOWN:s=Messages.REACHED_TOWN;break;case Micro.CC_CITY:s=Messages.REACHED_CITY;break;case Micro.CC_CAPITAL:s=Messages.REACHED_CAPITAL;break;case Micro.CC_METROPOLIS:s=Messages.REACHED_METROPOLIS;break;case Micro.CC_MEGALOPOLIS:s=Messages.REACHED_MEGALOPOLIS;break;default:break}}""!==s&&s!==this.messageLast&&(this.messageManager.sendMessage(s),this.messageLast=s),this.cityPopLast=e}setYear(s){s<this.startingYear&&(s=this.startingYear),s=s-this.startingYear-this.cityTime/48,this.cityTime+=48*s,this.updateTime()}updateTime(){let s=Math.floor(this.cityTime/48)+this.startingYear,e=Math.floor(this.cityTime%48)>>2;s>=1e6?this.setYear(this.startingYear):this._cityYearLast===s&&this._cityMonthLast===e||(this._cityYearLast=s,this._cityMonthLast=e,this.messageManager.sendMessage(Messages.DATE_UPDATED,{month:e,year:s}))}}