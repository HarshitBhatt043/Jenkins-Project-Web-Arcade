import{Micro}from"../Micro.js";import{Tiles,Tile,ZoneUtils}from"../Tile.js";import{math}from"../math/math.js";const verticalDeltaX=[0,1,0,0,0,0,1],verticalDeltaY=[-2,-2,-1,0,1,2,2],horizontalDeltaX=[-2,2,-2,-1,0,1,2],horizontalDeltaY=[-1,-1,0,0,0,0,0],openVertical=[Tile.VBRDG0,Tile.VBRDG1,Tile.RIVER,Tile.BRWV,Tile.RIVER,Tile.VBRDG2,Tile.VBRDG3],closeVertical=[Tile.VBRIDGE,Tile.RIVER,Tile.VBRIDGE,Tile.VBRIDGE,Tile.VBRIDGE,Tile.VBRIDGE,Tile.RIVER],openHorizontal=[Tile.HBRDG1,Tile.HBRDG3,Tile.HBRDG0,Tile.RIVER,Tile.BRWH,Tile.RIVER,Tile.HBRDG2],closeHorizontal=[Tile.RIVER,Tile.RIVER,Tile.HBRIDGE,Tile.HBRIDGE,Tile.HBRIDGE,Tile.HBRIDGE,Tile.HBRIDGE],densityTable=[Tile.ROADBASE,Tile.LTRFBASE,Tile.HTRFBASE];export const Road={registerHandlers:function(e,i){e.addAction(ZoneUtils.isRoad,Road.roadFound)},openBridge:function(e,i,l,t,o,a,r){let n,T,R;for(n=0;n<7;n++)T=i+t[n],R=l+o[n],e.testBounds(T,R)&&e.getTileValue(T,R)===(a[n]&Tile.BIT_MASK)&&e.setTileValue(T,R,r[n])},closeBridge:function(e,i,l,t,o,a,r){let n,T,R,s;for(n=0;n<7;n++)T=i+t[n],R=l+o[n],e.testBounds(T,R)&&(s=e.getTileValue(T,R),s!==Tile.CHANNEL&&(15&s)!=(15&a[n])||e.setTileValue(T,R,r[n]))},doBridge:function(e,i,l,t,o){if(o||(o=Micro.simData),t===Tile.BRWV)return math.getChance(3)&&o.spriteManager.getBoatDistance(i,l)>340&&Road.closeBridge(e,i,l,verticalDeltaX,verticalDeltaY,openVertical,closeVertical),!0;if(t==Tile.BRWH)return math.getChance(3)&&o.spriteManager.getBoatDistance(i,l)>340&&Road.closeBridge(e,i,l,horizontalDeltaX,horizontalDeltaY,openHorizontal,closeHorizontal),!0;if(o.spriteManager.getBoatDistance(i,l)<300||math.getChance(7)){if(1&t)return i<e.width-1&&e.getTileValue(i+1,l)===Tile.CHANNEL&&(Road.openBridge(e,i,l,verticalDeltaX,verticalDeltaY,closeVertical,openVertical),!0);if(l>0&&e.getTileValue(i,l-1)===Tile.CHANNEL)return Road.openBridge(e,i,l,horizontalDeltaX,horizontalDeltaY,closeHorizontal,openHorizontal),!0}return!1},roadFound:function(e,i,l,t){t||(t=Micro.simData),t.census.roadTotal+=1;let o=e.getTile(i,l),a=o.getValue();if(t.budget.shouldDegradeRoad()&&math.getChance(511)&&!o.isConductive()&&t.budget.roadEffect<(31&math.getRandom16()))return void((15&a)<2||15==(15&a)?e.setTile(i,l,Tile.RIVER):e.setTo(i,l,ZoneUtils.randomRubble()));o.isCombustible()||(t.census.roadTotal+=4);let r=0;a<Tile.LTRFBASE?r=0:a<Tile.HTRFBASE?r=1:(t.census.roadTotal+=1,r=2);let n=t.blockMaps.trafficDensityMap.worldGet(i,l)>>6;if(n>1&&(n-=1),n===r)return;let T=(a-Tile.ROADBASE&15)+densityTable[n],R=o.getFlags()&~Tile.ANIMBIT;n>0&&(R|=Tile.ANIMBIT),e.setTo(i,l,new Tiles(T,R))}};