import{Micro}from"../Micro.js";import{Tiles,Tile,ZoneUtils}from"../Tile.js";import{math}from"../math/math.js";const freeZone=[0,3,6,1,4,7,2,5,8];export const Residential={registerHandlers:function(e,i){e.addAction(ZoneUtils.isResidentialZone,Residential.residentialFound),e.addAction(ZoneUtils.HOSPITAL,Residential.hospitalFound),i.addAction(Tile.HOSPITAL,15,3)},placeResidential:function(e,i,t,l,o,n){let a=9*(4*o+l)+Tile.RZB;ZoneUtils.putZone(e,i,t,a,n)},getFreeZonePopulation:function(e,i,t,l){let o,n,a=0;for(o=i-1;o<=i+1;o++)for(n=t-1;n<=t+1;n++)o===i&&n===t||(l=e.getTileValue(o,n))>=Tile.LHTHR&&l<=Tile.HHTHR&&(a+=1);return a},getZonePopulation:function(e,i,t,l){if(l===Tile.FREEZ)return Residential.getFreeZonePopulation(e,i,t,l);return 8*(Math.floor((l-Tile.RZB)/9)%4+1)+16},evalLot:function(e,i,t){let l=[0,1,0,-1],o=[-1,0,1,0];if(!e.testBounds(i,t))return-1;let n=e.getTileValue(i,t);if(n<Tile.RESBASE||n>Tile.RESBASE+8)return-1;let a,s,r,d=1;for(a=0;a<4;a++)s=i+l[a],r=t+o[a],s<0||s>=e.width||r<0||r>=e.height||(n=e.getTileValue(s,r),n!==Tile.DIRT&&n<=Tile.LASTROAD&&(d+=1));return d},buildHouse:function(e,i,t,l){let o,n,a,s,r=0,d=0,u=[0,-1,0,1,-1,1,-1,0,1],T=[0,-1,-1,-1,0,0,1,1,1];for(o=0;o<9;o++)n=i+u[o],a=t+T[o],s=Residential.evalLot(e,n,a),s>d?(d=s,r=o):s===d&&math.getChance(7)&&(r=o);r>0&&e.testBounds(i+u[r],t+T[r])&&e.setTile(i+u[r],t+T[r],Tile.HOUSE+math.getRandom(2)+3*l,Tile.BLBNCNBIT)},growZone:function(e,i,t,l,o,n,a){l.pollutionDensityMap.worldGet(i,t)>128||(e.getTileValue(i,t)!==Tile.FREEZ?o<40&&(Residential.placeResidential(e,i,t,Math.floor(o/8)-1,n,a),ZoneUtils.incRateOfGrowth(l,i,t,8)):o<8?(Residential.buildHouse(e,i,t,n),ZoneUtils.incRateOfGrowth(l,i,t,1)):l.populationDensityMap.worldGet(i,t)>64&&(Residential.placeResidential(e,i,t,0,n,a),ZoneUtils.incRateOfGrowth(l,i,t,8)))},degradeZone:function(e,i,t,l,o,n,a){let s,r;if(0===o)return;if(o>16)return Residential.placeResidential(e,i,t,Math.floor((o-24)/8),n,a),void ZoneUtils.incRateOfGrowth(l,i,t,-8);if(16===o){for(e.setTo(i,t,new Tiles(Tile.FREEZ,Tile.BLBNCNBIT|Tile.ZONEBIT)),r=t-1;r<=t+1;r++)for(s=i-1;s<=i+1;s++)s===i&&r===t||e.setTile(i,t,Tile.LHTHR+n+math.getRandom(2),Tile.BLBNCNBIT);return void ZoneUtils.incRateOfGrowth(l,i,t,-8)}let d=0;for(ZoneUtils.incRateOfGrowth(l,i,t,-1),s=i-1;s<=i+1;s++)for(r=t-1;r<=t+1;r++){let i=e.getTileValue(s,r);if(i>=Tile.LHTHR&&i<=Tile.HHTHR)return void e.setTile(s,r,freeZone[d]+Tile.RESBASE,Tile.BLBNCNBIT);d+=1}},evalResidential:function(e,i,t,l){if(l===Micro.NO_ROAD_FOUND)return-3e3;let o=e.landValueMap.worldGet(i,t);return o-=e.pollutionDensityMap.worldGet(i,t),o=o<0?0:Math.min(32*o,6e3),o-3e3},residentialFound:function(e,i,t,l){let o;l||(l=Micro.simData),l.census.resZonePop+=1;let n=e.getTileValue(i,t),a=Residential.getZonePopulation(e,i,t,n);l.census.resPop+=a;let s=e.getTile(i,t).isPowered(),r=Micro.ROUTE_FOUND;if(a>math.getRandom(35)&&(r=l.traffic.makeTraffic(i,t,l.blockMaps,ZoneUtils.isCommercial),r===Micro.NO_ROAD_FOUND))return o=ZoneUtils.getLandPollutionValue(l.blockMaps,i,t),void Residential.degradeZone(e,i,t,l.blockMaps,a,o,s);if(n===Tile.FREEZ||math.getChance(7)){let n=Residential.evalResidential(l.blockMaps,i,t,r),d=l.valves.resValve+n;if(s||(d=-500),d>-350&&d-26380>math.getRandom16Signed())return 0===a&&math.getChance(3)?void Residential.makeHospital(e,i,t,l,s):(o=ZoneUtils.getLandPollutionValue(l.blockMaps,i,t),void Residential.growZone(e,i,t,l.blockMaps,a,o,s));d<350&&d+26380<math.getRandom16Signed()&&(o=ZoneUtils.getLandPollutionValue(l.blockMaps,i,t),Residential.degradeZone(e,i,t,l.blockMaps,a,o,s))}},makeHospital:function(e,i,t,l,o){if(l||(l=Micro.simData),l.census.needHospital>0)return ZoneUtils.putZone(e,i,t,Tile.HOSPITAL,o),void(l.census.needHospital=0)},hospitalFound:function(e,i,t,l){l||(l=Micro.simData),l.census.hospitalPop+=1,-1===l.census.needHospital&&0===math.getRandom(20)&&ZoneUtils.putZone(e,i,t,Tile.FREEZ,e.getTile(i,t).isPowered())}};