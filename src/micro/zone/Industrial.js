import{Micro}from"../Micro.js";import{Tiles,Tile,ZoneUtils}from"../Tile.js";import{math}from"../math/math.js";const animated=[!0,!1,!0,!0,!1,!1,!0,!0],xDelta=[-1,0,1,0,0,0,0,1],yDelta=[-1,0,-1,-1,0,0,-1,-1];export const Industrial={registerHandlers:function(e,i){e.addAction(ZoneUtils.isIndustrialZone,Industrial.industrialFound)},getZonePopulation:function(e,i,t,a){return a===Tile.INDCLR?0:Math.floor((a-Tile.IZB)/9)%4+1},placeIndustrial:function(e,i,t,a,n,o){var l=9*(4*n+a)+Tile.IZB;ZoneUtils.putZone(e,i,t,l,o)},growZone:function(e,i,t,a,n,o,l){n<4&&(Industrial.placeIndustrial(e,i,t,n,o,l),ZoneUtils.incRateOfGrowth(a,i,t,8))},degradeZone:function(e,i,t,a,n,o,l){n>1?Industrial.placeIndustrial(e,i,t,n-2,o,l):ZoneUtils.putZone(e,i,t,Tile.INDCLR,l),ZoneUtils.incRateOfGrowth(a,i,t,-8)},setAnimation:function(e,i,t,a,n){if(!(a<Tile.IZB)){var o=a-Tile.IZB>>3;animated[o]&&n?e.addTileFlags(i+xDelta[o],t+yDelta[o],Tile.ASCBIT):(e.addTileFlags(i+xDelta[o],t+yDelta[o],Tile.BNCNBIT),e.removeTileFlags(i+xDelta[o],t+yDelta[o],Tile.ANIMBIT))}},industrialFound:function(e,i,t,a){a||(a=Micro.simData),a.census.indZonePop+=1;var n=e.getTileValue(i,t),o=Industrial.getZonePopulation(e,i,t,n);a.census.indPop+=o;var l=e.getTile(i,t).isPowered();a.is3D||Industrial.setAnimation(e,i,t,n,l);var r=Micro.ROUTE_FOUND;if(o>math.getRandom(5)&&(r=a.traffic.makeTraffic(i,t,a.blockMaps,ZoneUtils.isResidential))===Micro.NO_ROAD_FOUND){var s=1&math.getRandom16();Industrial.degradeZone(e,i,t,a.blockMaps,o,s,l)}else if(math.getChance(7)){var d=a.valves.indValve+(r===Micro.NO_ROAD_FOUND?-1e3:0);if(l||(d=-500),d>-350&&d-26380>math.getRandom16Signed())return void Industrial.growZone(e,i,t,a.blockMaps,o,1&math.getRandom16(),l);d<350&&d+26380<math.getRandom16Signed()&&Industrial.degradeZone(e,i,t,a.blockMaps,o,1&math.getRandom16(),l)}}};