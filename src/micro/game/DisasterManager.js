import{EventEmitter,Micro,MiscUtils}from"../Micro.js";import{Tiles,Tile,ZoneUtils}from"../Tile.js";import{Messages}from"../Messages.js";import{math}from"../math/math.js";export const vulnerable=function(e){let t=e.getValue();return!(t<Tile.RESBASE||t>Tile.LASTZONE||e.isZone())};export class DisasterManager{constructor(e,t,i){this._map=e,this._spriteManager=t,this._gameLevel=i,this._floodCount=0,this.disastersEnabled=!1,this.Dx=[0,1,0,-1],this.Dy=[-1,0,1,0]}doDisasters(e){if(this._floodCount&&this._floodCount--,this.disastersEnabled&&math.getRandom(Micro.DisChance[this._gameLevel]))switch(math.getRandom(8)){case 0:case 1:this.setFire();break;case 2:case 3:this.makeFlood();break;case 4:break;case 5:this._spriteManager.makeTornado();break;case 6:break;case 7:case 8:e.pollutionAverage>60&&this._spriteManager.makeMonster();break}}setDifficulty(e){this._gameLevel=e}scenarioDisaster(){}makeMeltdown(){for(let e=0;e<this._map.width-1;e++)for(let t=0;t<this._map.height-1;t++)if(this._map.getTileValue(e,t)===Tile.NUCLEAR)return void this.doMeltdown(e,t)}makeEarthquake(){let e,t,i,s=math.getRandom(700)+300;for(this.doEarthquake(s),EventEmitter.emitEvent(Messages.EARTHQUAKE,{x:this._map.cityCenterX,y:this._map.cityCenterY}),e=0;e<s;e++)t=math.getRandom(this._map.width-1),i=math.getRandom(this._map.height-1),vulnerable(this._map.getTile(t,i))&&(0!=(3&e)?this._map.setTo(t,i,ZoneUtils.randomRubble()):this._map.setTo(t,i,ZoneUtils.randomFire()))}setFire(e=1,t=!1){let i,s,a,o,h;for(i=0;i<e;i++)if(s=math.getRandom(this._map.width-1),a=math.getRandom(this._map.height-1),this._map.testBounds(s,a)&&(o=this._map.getTile(s,a),!o.isZone()&&(o=o.getValue(),h=t?Tile.LHTHR:Tile.TREEBASE,o>h&&o<Tile.LASTZONE)))return this._map.setTo(s,a,ZoneUtils.randomFire()),void EventEmitter.emitEvent(Messages.FIRE_REPORTED,{showable:!0,x:s,y:a})}makeCrash(){let e=this._spriteManager.getSprite(Micro.SPRITE_AIRPLANE);if(null!==e)return void e.explodeSprite();let t=math.getRandom(this._map.width-1),i=math.getRandom(this._map.height-1);this._spriteManager.generatePlane(t,i),e=this._spriteManager.getSprite(Micro.SPRITE_AIRPLANE),e.explodeSprite()}makeFire(){this.setFire(40,!1)}makeFlood(){let e,t,i,s,a,o,h,m;for(e=0;e<300;e++)if(t=math.getRandom(this._map.width-1),i=math.getRandom(this._map.height-1),this._map.testBounds(t,i)&&(s=this._map.getTileValue(t,i),s>Tile.CHANNEL&&s<=Tile.WATER_HIGH))for(a=0;a<4;a++)if(o=t+this.Dx[a],h=i+this.Dy[a],this._map.testBounds(o,h)&&(m=this._map.getTile(o,h),s=m.getValue(),m===Tile.DIRT||m.isBulldozable()&&m.isCombustible))return this._map.setTo(o,h,new Tiles(Tile.FLOOD)),this._floodCount=30,void EventEmitter.emitEvent(Messages.FLOODING_REPORTED,{showable:!0,x:o,y:h})}doFlood(e,t,i){let s,a,o,h,m;if(this._floodCount>0)for(s=0;s<4;s++)math.getChance(7)&&(a=e+this.Dx[s],o=t+this.Dy[s],this._map.testBounds(a,o)&&(h=this._map.getTile(a,o),m=h.getValue(),(h.isCombustible()||m===Tile.DIRT||m>=Tile.WOODS5&&m<Tile.FLOOD)&&(h.isZone()&&ZoneUtils.fireZone(this.map,a,o,i),this._map.setTile(a,o,Tile.FLOOD+math.getRandom(2),0))));else math.getChance(15)&&this._map.setTile(e,t,Tile.DIRT,0)}doMeltdown(e,t){let i,s,a,o;for(this._spriteManager.makeExplosion(e-1,t-1),this._spriteManager.makeExplosion(e-1,t+2),this._spriteManager.makeExplosion(e+2,t-1),this._spriteManager.makeExplosion(e+2,t+2),a=e-1;a<e+3;a++)for(s=t-1;s<t+3;s++)this._map.setTo(a,s,ZoneUtils.randomFire());for(i=0;i<200;i++)a=e-20+math.getRandom(40),s=t-15+math.getRandom(30),this._map.testBounds(a,s)&&(o=this._map.getTile(a,s),o.isZone()||(o.isCombustible()||o.getValue()===Tile.DIRT)&&this._map.setTile(a,s,Tile.RADTILE,0));EventEmitter.emitEvent(Messages.NUCLEAR_MELTDOWN,{showable:!0,x:e,y:t})}}