import{Micro,MiscUtils}from"../Micro.js";import{Tiles,Tile}from"../Tile.js";export class MapScanner{constructor(i){this._map=i,this._actions=[]}addAction(i,e){this._actions.push({criterion:i,action:e})}mapScan(i,e,t){t||(t=Micro.simData);let a,o,s,r,n,c,l,p=this._map.height;for(;p--;)for(a=i;a<e;a++)if(s=this._map.getId(a,p),r=this._map.data[s]||new Tiles,n=r.getValue(),!(n<Tile.FLOOD))for(r.isConductive()&&t.powerManager.setTilePower(a,p),r.isZone()&&(t.repairManager.checkTile(a,p,t.cityTime),r.isPowered()?(t.census.poweredZoneCount+=1,this._map.powered({v:1,id:s})):(t.census.unpoweredZoneCount+=1,this._map.powered({v:2,id:s}))),o=this._actions.length;o--;){if(c=this._actions[o],l=MiscUtils.isCallable(c.criterion),l&&c.criterion.call(null,r)){c.action.call(null,this._map,a,p,t);break}if(!l&&c.criterion===n){c.action.call(null,this._map,a,p,t);break}}}}