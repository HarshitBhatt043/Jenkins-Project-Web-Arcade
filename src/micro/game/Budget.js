import{EventEmitter,Micro}from"../Micro.js";import{Messages}from"../Messages.js";export class Budget{constructor(){this.roadEffect=Micro.MAX_ROAD_EFFECT,this.policeEffect=Micro.MAX_POLICESTATION_EFFECT,this.fireEffect=Micro.MAX_FIRESTATION_EFFECT,this.totalFunds=0,this.cityTax=7,this.cashFlow=0,this.taxFund=0,this.roadMaintenanceBudget=0,this.fireMaintenanceBudget=0,this.policeMaintenanceBudget=0,this.roadPercent=1,this.firePercent=1,this.policePercent=1,this.roadSpend=0,this.fireSpend=0,this.policeSpend=0,this.awaitingValues=!1,this.autoBudget=!0}save(t){for(var e=0,i=Micro.BudgetProps.length;e<i;e++)t[Micro.BudgetProps[e]]=this[Micro.BudgetProps[e]]}load(t){for(var e=0,i=Micro.BudgetProps.length;e<i;e++)this[Micro.BudgetProps[e]]=t[Micro.BudgetProps[e]];EventEmitter.emitEvent(Messages.AUTOBUDGET_CHANGED,this.autoBudget),EventEmitter.emitEvent(Messages.FUNDS_CHANGED,this.totalFunds)}setAutoBudget(t){this.autoBudget=t,EventEmitter.emitEvent(Messages.AUTOBUDGET_CHANGED,this.autoBudget)}_calculateBestPercentages(){if(this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),0===this.roadSpend+this.fireSpend+this.policeSpend)return this.roadPercent=1,this.firePercent=1,this.policePercent=1,{road:1,fire:1,police:1};var t=0,e=0,i=0,s=this.totalFunds+this.taxFund;return s-=t=s>=this.roadSpend?this.roadSpend:s,s-=e=s>=this.fireSpend?this.fireSpend:s,s-=i=s>=this.policeSpend?this.policeSpend:s,this.roadMaintenanceBudget>0?this.roadPercent=(t/this.roadMaintenanceBudget).toPrecision(2)-0:this.roadPercent=1,this.fireMaintenanceBudget>0?this.firePercent=(e/this.fireMaintenanceBudget).toPrecision(2)-0:this.firePercent=1,this.policeMaintenanceBudget>0?this.policePercent=(i/this.policeMaintenanceBudget).toPrecision(2)-0:this.policePercent=1,{road:t,police:i,fire:e}}doBudgetWindow(){return this.doBudgetNow(!0)}doBudgetNow(t){var e=this._calculateBestPercentages();if(!this.autoBudget&&!t)return this.autoBudget=!1,this.awaitingValues=!0,void EventEmitter.emitEvent(Messages.BUDGET_NEEDED);var i=e.road,s=e.police,n=e.fire,a=i+s+n;if(this.totalFunds+this.taxFund-a>0&&this.autoBudget||t)return this.awaitingValues=!1,void this.doBudgetSpend(i,n,s);this.setAutoBudget(!1),this.awaitingValues=!0,EventEmitter.emitEvent(Messages.BUDGET_NEEDED),EventEmitter.emitEvent(Messages.NO_MONEY)}doBudgetSpend(t,e,i){this.roadSpend=t,this.fireSpend=e,this.policeSpend=i;var s=this.roadSpend+this.fireSpend+this.policeSpend;this.spend(-(this.taxFund-s)),this.updateFundEffects()}updateFundEffects(){this.roadSpend=Math.round(this.roadMaintenanceBudget*this.roadPercent),this.fireSpend=Math.round(this.fireMaintenanceBudget*this.firePercent),this.policeSpend=Math.round(this.policeMaintenanceBudget*this.policePercent),this.roadEffect=Micro.MAX_ROAD_EFFECT,this.policeEffect=Micro.MAX_POLICESTATION_EFFECT,this.fireEffect=Micro.MAX_FIRESTATION_EFFECT,this.roadMaintenanceBudget>0&&(this.roadEffect=Math.floor(this.roadEffect*this.roadSpend/this.roadMaintenanceBudget)),this.fireMaintenanceBudget>0&&(this.fireEffect=Math.floor(this.fireEffect*this.fireSpend/this.fireMaintenanceBudget)),this.policeMaintenanceBudget>0&&(this.policeEffect=Math.floor(this.policeEffect*this.policeSpend/this.policeMaintenanceBudget))}collectTax(t,e){this.cashFlow=0,this.policeMaintenanceBudget=e.policeStationPop*Micro.policeMaintenanceCost,this.fireMaintenanceBudget=e.fireStationPop*Micro.fireMaintenanceCost;var i=e.roadTotal*Micro.roadMaintenanceCost,s=e.railTotal*Micro.railMaintenanceCost;this.roadMaintenanceBudget=Math.floor((i+s)*Micro.RLevels[t]),this.taxFund=Math.floor(Math.floor(e.totalPop*e.landValueAverage/120)*this.cityTax*Micro.FLevels[t]),e.totalPop>0?(this.cashFlow=this.taxFund-(this.policeMaintenanceBudget+this.fireMaintenanceBudget+this.roadMaintenanceBudget),this.doBudgetNow(!1)):(this.roadEffect=Micro.MAX_ROAD_EFFECT,this.policeEffect=Micro.MAX_POLICESTATION_EFFECT,this.fireEffect=Micro.MAX_FIRESTATION_EFFECT)}setTax(t){t!==this.cityTax&&(this.cityTax=t)}setFunds(t){t!==this.totalFunds&&(this.totalFunds=Math.max(0,t),EventEmitter.emitEvent(Messages.FUNDS_CHANGED,this.totalFunds),0===this.totalFunds&&EventEmitter.emitEvent(Messages.NO_MONEY))}spend(t){this.setFunds(this.totalFunds-t)}shouldDegradeRoad(){return this.roadEffect<Math.floor(15*this.MAX_ROAD_EFFECT/16)}}