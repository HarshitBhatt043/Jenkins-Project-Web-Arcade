import{EventEmitter,Micro}from"../Micro.js";import{Tile}from"../Tile.js";import{Messages}from"../Messages.js";import{BlockMap}from"./BlockMap.js";import{Direction}from"../math/Direction.js";import{Position}from"../math/Position.js";import{math}from"../math/math.js";export class PowerManager{constructor(e){this._map=e,this._powerStack=[],this.powerGridMap=new BlockMap(this._map.width,this._map.height,1,0)}setTilePower(e,i){var o=this._map.getTile(e,i),t=o.getValue();t===Tile.NUCLEAR||t===Tile.POWERPLANT||this.powerGridMap.worldGet(e,i)>0?o.addFlags(Tile.POWERBIT):o.removeFlags(Tile.POWERBIT)}clearPowerStack(){this._powerStackPointer=0,this._powerStack=[]}testForConductive(e,i){var o=new Position(e);return!(!o.move(i)||!this._map.getTile(o.x,o.y).isConductive()||0!==this.powerGridMap.worldGet(o.x,o.y))}doPowerScan(e){this.powerGridMap.clear();let i=e.coalPowerPop*Micro.COAL_POWER_STRENGTH+e.nuclearPowerPop*Micro.NUCLEAR_POWER_STRENGTH,o=0;for(;this._powerStack.length>0;){var t,r=this._powerStack.pop(),a=Direction.INVALID;do{if(o++,o>i)return void EventEmitter.emitEvent(Messages.NOT_ENOUGH_POWER);a!==Direction.INVALID&&r.move(a),this.powerGridMap.worldSet(r.x,r.y,1),t=0;for(var s=Direction.BEGIN;s<Direction.END&&t<2;)this.testForConductive(r,s)&&(t++,a=s),s=Direction.increment90(s);t>1&&this._powerStack.push(new Position(r))}while(t)}}coalPowerFound(e,i,o,t){t||(t=Micro.simData),t.census.coalPowerPop+=1,this._powerStack.push(new Position(i,o));var r=[-1,2,1,2],a=[-1,-1,0,0];if(!t.is3D)for(var s=0;s<4;s++)e.addTileFlags(i+r[s],o+a[s],Tile.ANIMBIT)}nuclearPowerFound(e,i,o,t){t||(t=Micro.simData);if(!(t.disasterManager.disastersEnabled&&0===math.getRandom([3e4,2e4,1e4][t.gameLevel])||(t.census.nuclearPowerPop+=1,this._powerStack.push(new Position(i,o)),t.is3D)))for(var r=0;r<4;r++)e.addTileFlags(i,o,Tile.ANIMBIT|Tile.CONDBIT|Tile.POWERBIT|Tile.BURNBIT)}registerHandlers(e,i){e.addAction(Tile.POWERPLANT,this.coalPowerFound.bind(this)),e.addAction(Tile.NUCLEAR,this.nuclearPowerFound.bind(this)),i.addAction(Tile.POWERPLANT,7,4),i.addAction(Tile.NUCLEAR,7,4)}}