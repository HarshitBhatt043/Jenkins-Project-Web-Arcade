import{EventEmitter,Micro}from"../Micro.js";import{Messages}from"../Messages.js";import{math}from"../math/math.js";export class EvaluationUtils{static getTrafficAverage(t,e){for(var o=t.trafficDensityMap,i=t.landValueMap,r=0,s=1,a=0;a<i.gameMapWidth;a+=i.blockSize)for(var c=0;c<i.gameMapHeight;c+=i.blockSize)i.worldGet(a,c)>0&&(r+=o.worldGet(a,c),s++);return 2.4*Math.floor(r/s)}static getUnemployment(t){var e=8*(t.comPop+t.indPop);if(0===e)return 0;var o=t.resPop/e;return e=Math.round(255*(o-1)),Math.min(e,255)}static getFireSeverity(t){return Math.min(5*t.firePop,255)}}export class Evaluation{constructor(t){this.problemVotes=[],this.problemOrder=[],this.evalInit(),this.gameLevel=""+t,this.changed=!1}save(t){for(var e=0,o=Micro.EvalProps.length;e<o;e++)t[Micro.EvalProps[e]]=this[Micro.EvalProps[e]]}load(t){for(var e=0,o=Micro.EvalProps.length;e<o;e++)this[Micro.EvalProps[e]]=t[Micro.EvalProps[e]]}cityEvaluation(t){t||(t=Micro.simData);var e=t.census;if(e.totalPop>0){Micro.problemData=[];for(var o=0;o<Micro.NUMPROBLEMS;o++)Micro.problemData.push(0);this.getAssessedValue(e),this.getPopulation(e),this.doProblems(t.census,t.budget,t.blockMaps),this.getScore(t),this.doVotes(),this.changeEval()}else this.evalInit(),this.cityYes=50,this.changeEval()}evalInit(){let t;for(this.cityYes=0,this.cityPop=0,this.cityPopDelta=0,this.cityAssessedValue=0,this.cityClass=Micro.CC_VILLAGE,this.cityClassLast=Micro.CC_VILLAGE,this.cityScore=500,this.cityScoreDelta=0,t=0;t<Micro.NUMPROBLEMS;t++)this.problemVotes[t]={index:t,voteCount:0};for(t=0;t<Micro.NUM_COMPLAINTS;t++)this.problemOrder[t]=Micro.NUMPROBLEMS}getAssessedValue(t){var e;e=5*t.roadTotal,e+=10*t.railTotal,e+=1e3*t.policeStationPop,e+=1e3*t.fireStationPop,e+=400*t.hospitalPop,e+=3e3*t.stadiumPop,e+=5e3*t.seaportPop,e+=1e4*t.airportPop,e+=3e3*t.coalPowerPop,e+=6e3*t.nuclearPowerPop,this.cityAssessedValue=1e3*e}getPopulation(t){let e=this.cityPop;return this.cityPop=20*(t.resPop+8*(t.comPop+t.indPop)),this.cityPopDelta=this.cityPop-e,0!==this.cityPopDelta&&EventEmitter.emitEvent(Messages.POPULATION_UPDATED,this.cityPop),this.cityPop}getCityClass(t){return this.cityClass=Micro.CC_VILLAGE,t>2e3&&(this.cityClass=Micro.CC_TOWN),t>1e4&&(this.cityClass=Micro.CC_CITY),t>5e4&&(this.cityClass=Micro.CC_CAPITAL),t>1e5&&(this.cityClass=Micro.CC_METROPOLIS),t>5e5&&(this.cityClass=Micro.CC_MEGALOPOLIS),this.cityClass!==this.cityClassLast&&(this.cityClassLast=this.cityClass,EventEmitter.emitEvent(Messages.CLASSIFICATION_UPDATED,this.cityClass)),this.cityClass}voteProblems(){for(var t=0;t<Micro.NUMPROBLEMS;t++)this.problemVotes[t].index=t,this.problemVotes[t].voteCount=0;for(var e=0,o=0,i=0;o<100&&i<600;){var r=math.getRandom(300);Micro.problemData[e]>r&&(this.problemVotes[e].voteCount+=1,o++),e=(e+1)%Micro.NUMPROBLEMS,i++}}doProblems(t,e,o){Micro.problemData[Micro.CRIME]=t.crimeAverage,Micro.problemData[Micro.POLLUTION]=t.pollutionAverage,Micro.problemData[Micro.HOUSING]=7*t.landValueAverage/10,Micro.problemData[Micro.TAXES]=10*e.cityTax,Micro.problemData[Micro.TRAFFIC]=EvaluationUtils.getTrafficAverage(o,t),Micro.problemData[Micro.UNEMPLOYMENT]=EvaluationUtils.getUnemployment(t),Micro.problemData[Micro.FIRE]=EvaluationUtils.getFireSeverity(t),this.voteProblems(),this.problemVotes.sort((function(t,e){return e.voteCount-t.voteCount})),this.problemOrder=this.problemVotes.map((function(t,e){return e>=Micro.NUM_COMPLAINTS||0===t.voteCount?null:t.index}))}getScore(t){var e,o=t.census,i=t.budget,r=t.valves;e=this.cityScore;for(var s=0,a=0;a<Micro.NUMPROBLEMS;a++)s+=Micro.problemData[a];s=Math.floor(s/3),s=4*(250-Math.min(s,250));let c=.85;r.resCap&&(s=Math.round(s*c)),r.comCap&&(s=Math.round(s*c)),r.indCap&&(s=Math.round(s*c)),i.roadEffect<i.MAX_ROAD_EFFECT&&(s-=i.MAX_ROAD_EFFECT-i.roadEffect),i.policeEffect<i.MAX_POLICE_STATION_EFFECT&&(s=Math.round(s*(.9+i.policeEffect/(10*i.MAX_POLICE_STATION_EFFECT)))),i.fireEffect<i.MAX_FIRE_STATION_EFFECT&&(s=Math.round(s*(.9+i.fireEffect/(10*i.MAX_FIRE_STATION_EFFECT)))),r.resValve<-1e3&&(s=Math.round(.85*s)),r.comValve<-1e3&&(s=Math.round(.85*s)),r.indValve<-1e3&&(s=Math.round(.85*s));var l=1;0===this.cityPop||0===this.cityPopDelta||this.cityPopDelta===this.cityPop?l=1:this.cityPopDelta>0?l=this.cityPopDelta/this.cityPop+1:this.cityPopDelta<0&&(l=.95+Math.floor(this.cityPopDelta/(this.cityPop-this.cityPopDelta))),s=(s=Math.round(s*l))-EvaluationUtils.getFireSeverity(o)-i.cityTax,(l=o.unpoweredZoneCount+o.poweredZoneCount)>0&&(s=Math.round(s*(o.poweredZoneCount/l))),s=math.clamp(s,0,1e3),this.cityScore=Math.round((this.cityScore+s)/2),this.cityScoreDelta=this.cityScore-e,0!==this.cityScoreDelta&&EventEmitter.emitEvent(Messages.SCORE_UPDATED,this.cityScore)}doVotes(){this.cityYes=0;for(let t=0;t<100;t++){let t=math.getRandom(1e3);this.cityScore>t&&this.cityYes++}}changeEval(){this.changed=!0}countProblems(){var t;for(t=0;t<Micro.NUM_COMPLAINTS&&this.problemOrder[t]!==Micro.NUMPROBLEMS;t++);return t}getProblemNumber(t){return t<0||t>=Micro.NUM_COMPLAINTS||this.problemOrder[t]===Micro.NUMPROBLEMS?-1:this.problemOrder[t]}getProblemVotes(t){return t<0||t>=Micro.NUM_COMPLAINTS||this.problemOrder[t]==Micro.NUMPROBLEMS?-1:this.problemVotes[this.problemOrder[t]].voteCount}}