import{Micro}from"./Micro.js";import{Tile}from"./Tile.js";import{MessageManager}from"./MessageManager.js";import{Messages}from"./Messages.js";import{TXT}from"./Text.js";import{Simulation}from"./Simulation.js";import{AnimationManager}from"./game/AnimationManager.js";import{GameMap}from"./map/GameMap.js";import{MapGenerator}from"./map/MapGenerator.js";import{BuildingTool}from"./tool/BuildingTool.js";import{BulldozerTool}from"./tool/BulldozerTool.js";import{ParkTool}from"./tool/ParkTool.js";import{RailTool}from"./tool/RailTool.js";import{RoadTool}from"./tool/RoadTool.js";import{QueryTool}from"./tool/QueryTool.js";import{WireTool}from"./tool/WireTool.js";const postMessage=self.webkitPostMessage||self.postMessage;var timer,Game,power,returnMessage,pcount=0,isWorker=!0,trans=!1;self.onmessage=function(e){CityGame.message(e)};export class CityGame{static message(e){var t=e.data.tell;"INIT"==t&&(e.data.returnMessage&&(returnMessage=e.data.returnMessage,isWorker=!1),Game=new MainGame(e.data.timestep)),"NEWMAP"==t&&Game.newMap(),"PLAYMAP"==t&&Game.playMap(),"TOOL"==t&&Game.tool(e.data.name),"MAPCLICK"==t&&Game.mapClick(e.data.x,e.data.y,e.data.single||!1),"DIFFICULTY"==t&&Game.changeDifficulty(e.data.n),"SPEED"==t&&Game.changeSpeed(e.data.n),"BUDGET"==t&&Game.handleBudgetRequest(),"NEWBUDGET"==t&&Game.setBudget(e.data.budgetData),"DISASTER"==t&&Game.setDisaster(e.data.disaster),"EVAL"==t&&Game.getEvaluation(),"SAVEGAME"==t&&Game.saveGame(e.data.saveCity),"LOADGAME"==t&&Game.loadGame(e.data.isStart),"MAKELOADGAME"==t&&Game.makeLoadGame(e.data.savegame,e.data.isStart)}static post(e,t){isWorker?postMessage(e,t):returnMessage({data:e})}}var update=function(){Game.tick()};export class MainGame{constructor(e){this.timestep=e,this.mapSize=[128,128],this.difficulty=1,this.speed=2,this.oldSpeed=0,this.mapGen=new MapGenerator,this.simulation=null,this.gameTools=null,this.animationManager=null,this.map=null,this.isPaused=!1,this.simNeededBudget=!1,this.currentTool=null,this.timer=null,this.infos=[],this.sprites=[],this.spritesData=null,this.animsData=null,this.spritesData=[],this.power=null,CityGame.post({tell:"READY"})}next(e=0){this.timer=setTimeout(update,e)}stop(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)}tick(){this.simulation.simTick()&&(this.infos=this.simulation.infos,this.processMessages(Game.simulation.messageManager.getMessages()),Micro.haveMapAnimation&&this.animatedTiles(),this.simulation.spriteManager.moveObjects(),this.calculateSprites(),CityGame.post({tell:"RUN",infos:this.infos,tilesData:this.map.tilesData,powerData:this.map.powerData,sprites:this.spritesData,layer:this.map.layer}),this.map.resetLayer()),this.next()}newMap(){this.map=this.mapGen.construct(this.mapSize[0],this.mapSize[1]),CityGame.post({tell:"NEWMAP",tilesData:this.map.tilesData,mapSize:this.mapSize,island:this.map.isIsland,trans:trans})}playMap(e){var t=new MessageManager,s=2e4;1==this.difficulty&&(s=1e4),2==this.difficulty&&(s=5e3),this.gameTools={airport:new BuildingTool(1e4,Tile.AIRPORT,this.map,6,!1),bulldozer:new BulldozerTool(this.map),coal:new BuildingTool(3e3,Tile.POWERPLANT,this.map,4,!1),commercial:new BuildingTool(100,Tile.COMCLR,this.map,3,!1),fire:new BuildingTool(500,Tile.FIRESTATION,this.map,3,!1),industrial:new BuildingTool(100,Tile.INDCLR,this.map,3,!1),nuclear:new BuildingTool(5e3,Tile.NUCLEAR,this.map,4,!0),park:new ParkTool(this.map),police:new BuildingTool(500,Tile.POLICESTATION,this.map,3,!1),port:new BuildingTool(3e3,Tile.PORT,this.map,4,!1),rail:new RailTool(this.map),residential:new BuildingTool(100,Tile.FREEZ,this.map,3,!1),road:new RoadTool(this.map),query:new QueryTool(this.map),stadium:new BuildingTool(5e3,Tile.STADIUM,this.map,4,!1),wire:new WireTool(this.map)},Micro.haveMapAnimation&&(this.animationManager=new AnimationManager(this.map)),e?(s=this.savedGame.totalFunds,this.speed=this.savedGame.speed,this.difficulty=this.savedGame.difficulty,this.simulation=new Simulation(this.map,this.difficulty,this.speed,!0,this.savedGame),t.sendMessage(Messages.WELCOMEBACK)):(this.simulation=new Simulation(this.map,this.difficulty,this.speed,!0),t.sendMessage(Messages.WELCOME)),this.simulation.budget.setFunds(s),this.processMessages(t.getMessages()),this.isPaused=!1,this.tick()}changeSpeed(e){this.speed=e,this.simulation.setSpeed(this.speed),0===this.speed?(this.isPaused=!0,this.stop()):this.isPaused&&(this.isPaused=!1,this.stop(),this.tick())}changeDifficulty(e){this.difficulty=e,this.simulation&&this.simulation.setDifficulty(this.difficulty)}animatedTiles(){var e=this.animationManager.getTiles(0,0,this.mapSize[0]+1,this.mapSize[1]+1,this.isPaused),t=e.length;for(this.animsData=new Micro.M_ARRAY_TYPE(t);t--;){var s=e[t];this.animsData[t]=[s.tileValue,s.x,s.y]}}calculateSprites(){this.sprites=this.simulation.spriteManager.getSpritesInView(0,0,this.mapSize[0]+1,this.mapSize[1]+1);for(var e=this.sprites.length;e--;){var t=this.sprites[e];this.spritesData[e]=[t.type,t.frame,t.x||0,t.y||0]}}processMessages(e){for(var t=!1,s=0,i=e.length;s<i;s++){var a=e[s];switch(a.message){case Messages.BUDGET_NEEDED:this.simNeededBudget=!0,this.handleBudgetRequest();break;case Messages.QUERY_WINDOW_NEEDED:CityGame.post({tell:"QUERY",queryTxt:this.currentTool.getInfo()});break;default:if(!t&&void 0!==TXT.goodMessages[a.message]){this.infos[8]=TXT.goodMessages[a.message];break}if(!t&&void 0!==TXT.badMessages[a.message]){t=!0,this.infos[8]=TXT.badMessages[a.message];break}if(!t&&void 0!==TXT.neutralMessages[a.message]){t=!0,this.infos[8]=TXT.neutralMessages[a.message];break}}}}tool(e){null!==this.currentTool&&this.currentTool.clear(),this.currentTool="none"!==e?this.gameTools[e]:null}destroy(e,t){}findId(e,t){return e+t*this.mapSize[1]}mapClick(e,t,s){if(null!==this.currentTool){var i=this.simulation.budget,a=(this.simulation.evaluation,new MessageManager);this.currentTool.doTool(e,t,this.simulation.blockMaps,a),this.currentTool.modifyIfEnoughFunding(i,a);switch(this.currentTool.result){case this.currentTool.TOOLRESULT_NEEDS_BULLDOZE:TXT.toolMessages.needsDoze;break;case this.currentTool.TOOLRESULT_NO_MONEY:TXT.toolMessages.noMoney;break;default:"&nbsp;",s||CityGame.post({tell:"BUILD",x:e,y:t});break}this.processMessages(a.getMessages())}}setDisaster(e){if(e!==Micro.DISASTER_NONE){var t=new MessageManager;switch(e){case Micro.DISASTER_MONSTER:this.simulation.spriteManager.makeMonster(t);break;case Micro.DISASTER_FIRE:this.simulation.disasterManager.makeFire(t);break;case Micro.DISASTER_FLOOD:this.simulation.disasterManager.makeFlood(t);break;case Micro.DISASTER_CRASH:this.simulation.disasterManager.makeCrash(t);break;case Micro.DISASTER_MELTDOWN:this.simulation.disasterManager.makeMeltdown(t);break;case Micro.DISASTER_TORNADO:this.simulation.spriteManager.makeTornado(t);break}this.processMessages(t.getMessages())}}setBudget(e){this.simulation.budget.cityTax=e[0],this.simulation.budget.roadPercent=e[1]/100,this.simulation.budget.firePercent=e[2]/100,this.simulation.budget.policePercent=e[3]/100}handleBudgetRequest(){this.budgetShowing=!0;let e={roadFund:this.simulation.budget.roadFund,roadRate:Math.floor(100*this.simulation.budget.roadPercent),fireFund:this.simulation.budget.fireFund,fireRate:Math.floor(100*this.simulation.budget.firePercent),policeFund:this.simulation.budget.policeFund,policeRate:Math.floor(100*this.simulation.budget.policePercent),taxRate:this.simulation.budget.cityTax,totalFunds:this.simulation.budget.totalFunds,taxesCollected:this.simulation.budget.taxFund};CityGame.post({tell:"BUDGET",budgetData:e}),this.simNeededBudget?(this.simulation.budget.doBudgetWindow(),this.simNeededBudget=!1):this.simulation.budget.updateFundEffects()}getEvaluation(){let e=this.simulation.evaluation,t="";for(var s=0;s<4;s++){let i=e.getProblemNumber(s),a="";-1!==i&&(a=TXT.problems[i]),t+=a+"<br>"}let i=[e.cityYes,t];CityGame.post({tell:"EVAL",evalData:i})}saveGame(e){let t={name:"Yoooooo",everClicked:!0};t.speed=this.speed,t.difficulty=this.difficulty,t.version=Micro.CURRENT_VERSION,t.city=e,this.simulation.save(t),t=JSON.stringify(t),CityGame.post({tell:"SAVEGAME",gameData:t,key:Micro.KEY})}loadGame(e){var t=e||!1;CityGame.post({tell:"LOADGAME",key:Micro.KEY,isStart:t})}makeLoadGame(e,t){let s=t||!1;clearInterval(this.timer),this.savedGame=JSON.parse(e),this.map=new GameMap(Micro.MAP_WIDTH,Micro.MAP_HEIGHT),this.map.load(this.savedGame),CityGame.post({tell:"FULLREBUILD",tilesData:this.map.tilesData,mapSize:this.mapSize,island:this.map.isIsland,cityData:this.savedGame.city,isStart:s})}transitionOldSave(e){switch(e.version){case 1:e.everClicked=!1;case 2:e.pollutionMaxX=Math.floor(e.width/2),e.pollutionMaxY=Math.floor(e.height/2),e.cityCentreX=Math.floor(e.width/2),e.cityCentreY=Math.floor(e.height/2);break}}}