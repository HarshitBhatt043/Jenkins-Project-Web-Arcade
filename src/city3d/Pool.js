import*as THREE from"../../build/three.module.js";import{GLTFLoader}from"../jsm/loaders/GLTFLoader.js";import{DRACOLoader}from"../jsm/loaders/DRACOLoader.js";import{RGBELoader}from"../jsm/loaders/RGBELoader.js";export class Pool{constructor(t,e=64,i=!0,s=!1,a=!1){this.sky="day",this.callback=t,this.tileSize=e,this.isWithNormal=i,this.isWithRoughness=s,this.isPixelStyle=a,this.loaderGLB=new GLTFLoader;let r=(new DRACOLoader).setDecoderPath("./build/draco/");this.loaderGLB.setDRACOLoader(r),this.mapPath="./assets/textures/",this.modelPath="./assets/models/",this.modelSrc=["cars","world"],this.imgSrc=["tiles.png","town.png","building.png","cars.png"],this.isWithNormal&&this.imgSrc.push("tiles_n.png","building_n.png","town_n.png"),this.isWithRoughness&&this.imgSrc.push("tiles_r.png","building_r.png","town_r.png"),this.imgSrc.push("border.jpg","border_a.jpg"),this.imgs=[],this.num=0,this.tiles={normal:[],roughness:[],texture:[]},this.color={ground:"#c68564",normal:"#8080ff",snow:"#e6f0ff",white:"#ffffff",lightGrey:"#CCCCCC",metal:"#AAAAAA",sky:"#8397ac"},this.textures={},this.geos={},this.loadEnvmap()}displayMessage(t){hub&&hub.message(t)}loadEnvmap(){this.displayMessage("Loading envmap ..."),(new RGBELoader).load(this.mapPath+this.sky+".hdr",function(t){this.env=t,this.loadImages()}.bind(this))}loadImages(){this.displayMessage("Loading images ...");let t=this.num,e=this.imgSrc[t],i=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));this.imgs[i]=new Image,this.imgs[i].onload=function(){this.num++,this.num===this.imgSrc.length?this.defineCanvas():this.loadImages()}.bind(this),this.imgs[i].src=this.mapPath+e}defineCanvas(){this.num=0,this.canvas={town:this.makeCanvas("town"),building:this.makeCanvas("building"),tiles:this.makeCanvas("tiles",!0)},this.isWithNormal&&(this.canvas.tiles_n=this.makeCanvas("tiles_n",!0)),this.isWithRoughness&&(this.canvas.tiles_r=this.makeCanvas("tiles_r",!0),this.canvas.town_r=this.makeCanvas("town_r"),this.canvas.building_r=this.makeCanvas("building_r")),this.drawCanvas(),this.makeCarColor()}makeCanvas(t,e){let i=e&&32===this.tileSize?.5:1,s=this.imgs[t],a=document.createElement("canvas");return a.width=s.width*i,a.height=s.height*i,a}drawCanvas(){let t,e;for(let i in this.canvas)t=this.canvas[i],e=t.getContext("2d"),e.clearRect(0,0,t.width,t.height),"tiles"!==i&&"town"!==i&&"building"!==i||(e.fillStyle=this.color.ground,e.fillRect(0,0,t.width,t.height)),"tiles_n"===i&&(e.fillStyle=this.color.normal,e.fillRect(0,0,t.width,t.height)),"tiles_r"!==i&&"town_r"!==i&&"building_r"!==i||(e.fillStyle=this.color.lightGrey,e.fillRect(0,0,t.width,t.height)),e.drawImage(this.imgs[i],0,0,t.width,t.height);this.defineTextures()}defineTextures(){this.makePixelData("tiles"),this.textures.town=new THREE.Texture(this.canvas.town),this.filterTexture(this.textures.town,{flip:!1}),this.textures.building=new THREE.Texture(this.canvas.building),this.filterTexture(this.textures.building,{flip:!1}),this.isWithNormal&&(this.makePixelData("tiles_n"),this.textures.town_n=new THREE.Texture(this.imgs.town_n),this.filterTexture(this.textures.town_n,{flip:!1,normal:!0}),this.textures.building_n=new THREE.Texture(this.imgs.building_n),this.filterTexture(this.textures.building_n,{flip:!1,normal:!0})),this.isWithRoughness&&(this.makePixelData("tiles_r"),this.textures.town_r=new THREE.Texture(this.canvas.town_r),this.filterTexture(this.textures.town_r,{flip:!1,normal:!0}),this.textures.building_r=new THREE.Texture(this.canvas.building_r),this.filterTexture(this.textures.building_r,{flip:!1,normal:!0})),this.textures.border=new THREE.Texture(this.imgs.border),this.filterTexture(this.textures.border,{flip:!1}),this.textures.border_a=new THREE.Texture(this.imgs.border_a),this.filterTexture(this.textures.border_a,{flip:!1}),this.loadModel()}filterTexture(t,e={}){e.normal||(t.encoding=THREE.sRGBEncoding),void 0!==e.flip&&(t.flipY=e.flip),void 0!==e.midmap&&(t.generateMipmaps=e.midmap),void 0!==e.alpha&&(t.premultiplyAlpha=e.alpha),this.isPixelStyle?(t.magFilter=THREE.NearestFilter,t.minFilter=THREE.LinearMipMapLinearFilter):(t.magFilter=THREE.LinearFilter,t.minFilter=THREE.LinearMipmapLinearFilter),t.needsUpdate=!0}makePixelData(t){let e,i,s=this.canvas[t].getContext("2d"),a=this.tileSize;for(let r=0;r<240;r++){e=r%32*a,i=Math.floor(r/32)*a;let l=s.getImageData(e,i,a,a).data;"tiles_n"===t?this.tiles.normal[r]=new THREE.DataTexture(l,a,a):"tiles_r"===t?this.tiles.roughness[r]=new THREE.DataTexture(l,a,a):this.tiles.texture[r]=new THREE.DataTexture(l,a,a)}}tint(t,e,i){let s,a,r,l=t.width*t.height,h=t.getContext("2d"),n=null,o=null;if(i&&0!==this.dayTime&&1!==this.dayTime){for(h.clearRect(0,0,t.width,t.height),h.drawImage(i,0,0),n=h.getImageData(0,0,t.width,t.height),s=n.data,a=l;a--;)r=a<<2,0!==s[r+3]&&(0==s[r+0]&&0==s[r+1]&&0==s[r+2]&&(s[r+3]=60),0==s[r+1]&&(3==this.dayTime&&(s[r+1]=255),2==this.dayTime&&(s[r+0]=0,s[r+3]=60)));h.putImageData(n,0,0),o=document.createElement("img"),o.src=t.toDataURL("image/png")}if(e?(h.clearRect(0,0,t.width,t.height),h.drawImage(e,0,0)):h.drawImage(this.skyCanvasBasic,0,0),0!==this.dayTime){let e=h.getImageData(0,0,t.width,t.height);s=e.data,a=l;let i=this.tcolor;for(;a--;)r=a<<2,s[r+0]=s[r+0]*(1-i.a)+i.r*i.a,s[r+1]=s[r+1]*(1-i.a)+i.g*i.a,s[r+2]=s[r+2]*(1-i.a)+i.b*i.a;h.putImageData(e,0,0),o&&h.drawImage(o,0,0)}}rand(t,e){return t+Math.random()*(e-t)}makeTitleTexture(t=0){let e=[this.color.metal,"#fff"];1===t&&(e=["#333333","#999999"]),2===t&&(e=["#000","#999999"]);let i=.25,s=document.createElement("canvas");s.width=s.height=256;let a=s.getContext("2d");a.beginPath(),a.fillStyle=e[0],a.rect(0,0,256,256),a.fill();let r,l,h=8;for(;h--;)r=this.rand(150,255),l=this.rand(r-60,r-20),a.beginPath(),a.fillStyle=1!==t?"rgb("+r+","+r+","+l+")":e[1],a.rect(146*h*i,0,36.5,50),a.fill();let n=new THREE.Texture(s);return this.filterTexture(n,{flip:!1}),n}makeCarColor(){let t=document.createElement("canvas");t.width=t.height=1024;let e,i=t.getContext("2d"),s=0,a=0,r=3;for(;r--;){for(i.clearRect(0,0,t.width,t.height),e=0;e<16;e++)i.beginPath(),11!==e&&15!==e&&(i.fillStyle=this.carColor()),i.rect(256*s,256*a,256,256),i.fill(),s++,4==s&&(s=0,a++);i.drawImage(this.imgs.cars,0,0);let l="cars_"+r;this.textures[l]=new THREE.Texture(t),this.filterTexture(this.textures[l],{flip:!1})}}carColor(){let t=this.randInt(0,9),e=this.randInt(0,3),i=[[16777215,13685203,15724527,15658734],[2433314,3156523,2569771,3092779],[9278613,12697788,13554900,12502212],[9672089,4342338,5921370,7632501],[12863776,16729121,6292233,14226462],[4903419,2579043,1150428,2725030],[10910006,8866081,14132587,5570567],[6287660,1605703,9285161,1750553],[16773386,16777149,16579295,16760074],[12134760,6036047,4693,16758759]][t][e].toString(16);return i=i.length<6?"#0"+i:"#"+i,i}randInt(t,e){return t+Math.floor(Math.random()*(e-t+1))}tile(t,e){return this.tiles[t][e]}texture(t){return this.textures[t]}loadModel(){this.displayMessage("Loading 3d model ...");let t=this.num,e=this.modelSrc[t];this.loaderGLB.load(this.modelPath+e+".glb",function(t){let i,s,a,r={};t.scene.traverse((function(t){"title"===t.name&&(a=t),"border"===t.name&&(i=t),"border_min"===t.name&&(s=t),t.isMesh&&!r[t.name]&&(r[t.name]=t.geometry)})),i&&(this.border=i),s&&(this.border_min=s),a&&(this.title=a),this.defineGeometry(r,e),this.num++,this.num===this.modelSrc.length?(this.displayMessage("..."),this.callback()):this.loadModel()}.bind(this))}defineGeometry(t,e){let i,s;switch(e){case"cars":i={cars:[]};for(let e in t)s=Number(e.substring(4)),i.cars[s]=t[e];break;case"world":i={town:[null,null,null,null,t.police,t.park_1,t.park_2,t.fire,t.coal,t.nuclear,t.port,t.stadium,t.airport],tree:[t.ttt3,t.ttt3,t.ttt4,t.ttt4,t.ttt0,t.ttt1,t.ttt2,t.ttt5],sprite:[t.train,t.elico.clone(),t.plane.clone()],residential:[],commercial:[],industrial:[],house:[]};let e=9;for(;e--;)i.industrial[e]=t["i_0"+e];for(e=19;e--;)i.residential[e]=e<10?t["r_0"+e]:t["r_"+e];for(e=21;e--;)i.commercial[e]=e<10?t["c_0"+e]:t["c_"+e];for(e=12;e--;)i.house[e]=e<10?t["rh_0"+e]:t["rh_"+e];break}this.geos={...this.geos,...i}}geo(t,e){return this.geos[t][e]||null}}