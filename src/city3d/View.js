import*as THREE from"../../build/three.module.js";import*as UIL from"../../build/uil.module.js";import{GLTFLoader}from"../jsm/loaders/GLTFLoader.js";import{DRACOLoader}from"../jsm/loaders/DRACOLoader.js";import{RGBELoader}from"../jsm/loaders/RGBELoader.js";import{ImprovedNoise}from"../jsm/math/ImprovedNoise.js";import{Main}from"../Main.js";import{Base}from"./Base.js";import{BuildTool}from"./BuildTool.js";import{Pool}from"./Pool.js";import{TrafficBase}from"../TrafficBase.js";export class View{constructor(t,e,i,s){this.container=document.getElementById("container"),this.mapPath="./assets/textures/",this.modelPath="./assets/models/",this.rootModel=this.modelPath+"world.glb",this.hub=null,this.isMenu=!1,this.inMapGenation=!1,this.isPixelStyle=!1,this.metalness=.6,this.roughness=.3,this.wireframe=!1,this.loadGame=null,this.M_list=["treeLists","townLists","houseLists","buildingLists"],this.M_temp=["tempTreeLayers","temptownLayers","tempHouseLayers","tempBuildingLayers"],this.M_mesh=["treeMeshs","townMeshs","houseMeshs","buildingMeshs"],this.M_mats=["townMaterial","townMaterial","buildingMaterial","buildingMaterial"],this.pix=window.devicePixelRatio,this.pix>2&&(this.pix=2),this.isLow=s||!1,this.isMobile=t||!1,this.ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,this.isWithTree=!0,this.isWithLight=!0,this.isStandardMaterial=!0,this.isWithEnv=!0,this.isWithNormal=!0,this.isWithRoughness=!0,this.isWithFog=!0,this.isIsland=!1,this.isWinter=!1,this.isComputeVertex=!0,this.isTransGeo=!0,this.key=[0,0,0,0,0,0,0],this.oldData=[],this.tileSize=64,(this.isMobile||this.isLow)&&(this.pix=1,this.isWithTree=!1,this.isWithEnv=!1,this.isWithNormal=!1,this.isWithLight=!1,this.tileSize=32),this.mu=64===this.tileSize?4:2,this.f=[0,0,0],this.stats=[0,0],this.isWithStats=!1,this.dayTime=0,this.tcolor={r:10,g:15,b:80,a:.9},this.snd_layzone=new Audio("./sound/layzone.mp3"),this.imgSrc=["tiles"+this.tileSize+".png","town.jpg","building.jpg","building_win.png","town_win.png"],this.isWithNormal&&this.imgSrc.push("building_n.png","town_n.png","tiles"+this.tileSize+"_n.png"),this.imgSrcPlus=["tiles"+this.tileSize+"_w.png","town_w.jpg","building_w.jpg"];let h=this.imgSrc.length;for(;h--;)this.imgSrc[h]=this.mapPath+this.imgSrc[h];for(h=this.imgSrcPlus.length;h--;)this.imgSrcPlus[h]=this.mapPath+this.imgSrcPlus[h];this.winterMapLoaded=!1,this.tmpGameData=null,this.imgs=[],this.num=0,this.fullRedraw=!1,this.isWithBackground=!1,this.isWithHeight=!1,this.ToRad=Math.PI/180,this.camera=null,this.scene=null,this.renderer=null,this.timer=null,this.miniTerrain=[],this.terrainTxt=[],this.terrainTxtN=[],this.terrainTxtR=[],this.forceUpdate={x:-1,y:-1},this.cam={horizontal:90,vertical:60,distance:120},this.vsize={x:window.innerWidth,y:window.innerHeight,z:window.innerWidth/window.innerHeight},this.mouse={ox:0,oy:0,h:0,v:0,mx:0,my:0,dx:0,dy:0,down:!1,over:!1,drag:!1,click:!1,move:!0,dragView:!1,button:0},this.raypos={x:-1,y:0,z:-1},this.select="",this.meshs={},this.mapSize=[128,128],this.nlayers=64,this.tool=null,this.currentTool=null,this.heightData=null,this.worldTexture=null,this.centralTexture=null,this.serviceTexture=null,this.buildingTexture=null,this.skyTexture=null,this.townMaterial=null,this.buildingMaterial=null,this.townCanvas=null,this.buildingCanvas=null,this.skyCanvas=null,this.skyCanvasBasic=null,this.buildingHeigth=null,this.townMap=null,this.buildingMap=null,this.buildingGeo=null,this.residentialGeo=null,this.commercialGeo=null,this.industrialGeo=null,this.spriteGeo=null,this.treeGeo=null,this.houseGeo=null,this.treeMeshs=[],this.treeLists=[],this.tempTreeLayers=[],this.treeValue=[],this.powerMeshs=[],this.powerMaterial=null,this.buildingMeshs=[],this.buildingLists=[],this.tempBuildingLayers=[],this.townMeshs=[],this.townLists=[],this.temptownLayers=[],this.houseMeshs=[],this.houseLists=[],this.tempHouseLayers=[],this.tempDestruct=[],this.currentLayer=0,this.needResize=!1,this.env=null,this.ease_p=-1,this.onEase=null,this.spriteLists=["train","elico","plane","boat","monster","tornado","sparks"],this.spriteMeshs=[],this.spriteObjs={},this.terrainMaterials=[],this.pool=new Pool(function(){this.done()}.bind(this),this.tileSize,this.isWithNormal,this.isWithRoughness,this.isPixelStyle)}preIntro(){this.center.x=9.5,this.center.z=9.5,this.cam.distance=30,this.moveCamera(),this.addBorder();const t=new THREE.PlaneGeometry(19,19,3,3);t.rotateX(.5*-Math.PI),this.basePlane=new THREE.Mesh(t,this.planeMat),this.basePlane.position.copy(this.center),this.scene.add(this.basePlane),this.title=this.pool.title,this.title.material=this.titleMat,this.title.position.copy(this.center),this.scene.add(this.title),this.traffic=new TrafficBase({isStandard:this.isStandardMaterial}),this.scene.add(this.traffic),this.buildings=new THREE.Group;let e,i=16,s=0,h=0;for(;i--;)4===s&&(h++,s=0),e=this.getRandomObject(),e.position.set(4*s+3,.01,4*h+3),this.buildings.add(e),s++;this.scene.add(this.buildings),this.plane=new THREE.Mesh(new THREE.PlaneGeometry(18,4.5,5,1),new THREE.MeshBasicMaterial({transparent:!0,alphaToCoverage:!0})),this.plane.geometry.rotateX(.4*-Math.PI),this.plane.position.copy(this.center),this.plane.position.y=.8,this.plane.position.z=22.2,this.plane.name="p1",this.scene.add(this.plane),UIL.Tools.setStyle({fontFamily:"sans-serif",fontWeight:"bold",fontShadow:"none",button:"#c1cbd7",overoff:"#223143",over:"#6c819a",select:"#45586f",text:"#223143",textOver:"#FFFFFF",border:"#6c819a",borderSize:3,fontSize:20}),this.ui=new UIL.Gui({w:512,maxHeight:128,parent:null,isCanvas:!0,close:!1,transparent:!0,plane:this.plane});this.ui.add("grid",{values:["NEW","LOAD"],selectable:!1,bsize:[200,40],spaces:[18,2],radius:40}).onChange(this.openMap.bind(this));this.ui.onDraw=function(){null===this.screen&&(this.screen=new THREE.Texture(this.canvas),this.screen.encoding=THREE.sRGBEncoding,this.plane.material.map=this.screen,this.plane.material.needsUpdate=!0),this.screen.needsUpdate=!0},this.isMenu=!0}fileSelect(t){hub.generate(!0),this.inMapGenation=!0;const e=t.target.files[0],i=new FileReader;let s=e.name;"json"===s.substring(s.lastIndexOf(".")+1,s.length)&&(i.readAsText(e),i.onload=function(t){this.tmpGameData=t.target.result,this.openMap("LOADDONE")}.bind(this))}openMap(t){if(this.isMobile&&"LOAD"===t){if(!window.localStorage.getItem("micropolisJSGame"))return;t="LOADDONE"}if("LOAD"===t){this.fileInput||(this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.style.display="none",this.fileInput.onchange=this.fileSelect.bind(this),document.body.appendChild(this.fileInput));let t=document.createEvent("MouseEvents");return t.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),void this.fileInput.dispatchEvent(t)}this.fileInput&&document.body.removeChild(this.fileInput),this.command=t,this.isMenu=!1,this.ease_p=0,this.onEase=this.easing,this.scene.remove(this.title),this.scene.remove(this.plane),this.traffic.clearAll(),this.scene.remove(this.buildings),this.ui.clear()}endOpen(){"LOADDONE"===this.command&&(this.isMenu=!1,setTimeout(function(){this.ui.dispose()}.bind(this),100),Main.loadGame(!0)),"NEW"===this.command&&(Main.newMap("NEW"),this.scene.add(this.plane),this.plane.position.copy(this.center),this.plane.position.y=4,this.plane.position.z=123,this.isMenu=!0,this.plane.scale.set(4,4,4),this.ui.add("grid",{values:["NEW","HIGH"],selectable:!1,bsize:[140,30],spaces:[18,2],radius:30}).onChange((function(t){setTimeout(Main.newMap,1e3,t)})),this.ui.add("selector",{name:"",h:30,values:["LOW","MEDIUM","HARD"],radius:30,value:"MEDIUM",p:0}).onChange(Main.setDifficulty),this.ui.add("button",{name:"PLAY THIS MAP",h:40,radius:40,p:20,forceWidth:300}).onChange(this.startPlay.bind(this)))}startPlay(){this.isMenu=!1,this.plane&&this.scene.remove(this.plane),setTimeout(function(){this.ui.dispose()}.bind(this),100),Main.playMap()}easing(){let t=this.ease_p;t>=1&&(this.onEase=null,t=1,this.endOpen());this.center.x=this.center.z=9.5+(.5*this.mapSize[0]-9.5)*t,this.cam.distance=40+110*t,this.moveCamera(),this.basePlane.position.copy(this.center);let e=1+(128/19-1)*t;this.basePlane.scale.set(e,1,e),this.border.morphTargetInfluences[0]=1-t,this.ease_p=t+.01}addBorder(){this.border=this.pool.border,this.border_m=this.pool.border_min,this.border_m.position.set(0,0,0),this.border.position.set(0,0,0),this.scene.add(this.border),this.border.material=this.borderMat,this.border.geometry.morphAttributes.position=[this.border_m.geometry.attributes.position],this.border.updateMorphTargets(),this.border.morphTargetInfluences[0]=1}done(){this.init(),this.createMaterial(),Main.start()}createMaterial(){this.colors={ground:new THREE.Color(this.pool.color.ground).convertSRGBToLinear(),metal:new THREE.Color(this.pool.color.metal).convertSRGBToLinear(),sky:new THREE.Color(this.pool.color.sky).convertSRGBToLinear()};let t=this.nlayers,e=this.isStandardMaterial?{roughness:1,metalness:1,envMapIntensity:1}:{},i=this.isStandardMaterial?THREE.MeshStandardMaterial:THREE.MeshBasicMaterial;for(;t--;)this.terrainMaterials[t]=new i({color:16777215,vertexColors:!0,...e}),this.modifyShader(this.terrainMaterials[t]);this.townMaterial=new i({map:this.pool.texture("town"),...e}),this.modifyShader(this.townMaterial),this.buildingMaterial=new i({map:this.pool.texture("building"),...e}),this.modifyShader(this.buildingMaterial),this.titleMat=new i({map:this.pool.makeTitleTexture(),...e}),this.isStandardMaterial&&(this.titleMat.roughnessMap=this.pool.makeTitleTexture(1),this.titleMat.emissiveMap=this.pool.makeTitleTexture(2),this.titleMat.emissive=new THREE.Color(6710818)),this.modifyShader(this.titleMat),this.isStandardMaterial&&(e.roughness=0),this.waterMat=new i({color:6577323,transparent:!0,opacity:.8,...e}),this.isStandardMaterial&&(e.roughness=.2,e.metalness=.8),this.borderMat=new i({color:this.colors.metal,alphaMap:this.pool.texture("border_a"),transparent:!0,...e}),this.isStandardMaterial&&(e.roughness=.8,e.metalness=.2),this.planeMat=new i({color:this.colors.ground,depthWrite:!1,...e}),this.isStandardMaterial&&(this.isWithRoughness&&(this.townMaterial.roughnessMap=this.pool.texture("town_r"),this.buildingMaterial.roughnessMap=this.pool.texture("building_r")),this.isWithNormal&&(this.townMaterial.normalMap=this.pool.texture("town_n"),this.buildingMaterial.normalMap=this.pool.texture("building_n"))),this.powerMaterial=new THREE.SpriteMaterial({map:this.powerTexture(),transparent:!0,depthTest:!1,toneMapped:!1}),this.preIntro()}modifyShader(t){this.isStandardMaterial&&(t.onBeforeCompile=function(t){t.fragmentShader=t.fragmentShader.replace("#include <metalnessmap_fragment>","\n\t            float metalnessFactor = metalness;\n\t            #ifdef USE_ROUGHNESSMAP\n\t            metalnessFactor *= 1.0 - texelRoughness.g;\n\t            #endif\n\t        ")})}init(){this.tmpPos=new THREE.Vector2(0,0),this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(50,this.vsize.z,.1,1e3),this.scene.add(this.camera),this.rayVector=new THREE.Vector2(0,0),this.raycaster=new THREE.Raycaster,this.land=new THREE.Group,this.scene.add(this.land),this.isWithFog&&(this.fog=new THREE.Fog(9479095,1,100),this.scene.fog=this.fog),this.center=new THREE.Vector3,this.center.x=.5*this.mapSize[0],this.center.z=.5*this.mapSize[1],this.moveCamera(),this.ease=new THREE.Vector3,this.easeRot=new THREE.Vector3;let t=new THREE.WebGLRenderer({antialias:!1});if(t.setSize(this.vsize.x,this.vsize.y),t.setPixelRatio(this.pix),t.outputEncoding=THREE.sRGBEncoding,t.toneMapping=THREE.ACESFilmicToneMapping,t.toneMappingExposure=1,this.anisotropy=t.capabilities.getMaxAnisotropy(),this.container.appendChild(t.domElement),this.renderer=t,this.isWithEnv){let e=this.pool.env,i=new THREE.PMREMGenerator(t);this.env=i.fromEquirectangular(e).texture,this.scene.background=this.env,this.scene.environment=this.env,e.dispose(),i.dispose()}this.isWithLight,this.isWithBackground?(this.skyCanvasBasic=this.gradTexture([[.51,.49,.3],["#cc7f66","#A7DCFA","deepskyblue"]]),this.skyCanvas=this.gradTexture([[.51,.49,.3],["#cc7f66","#A7DCFA","deepskyblue"]]),this.skyTexture=new THREE.Texture(this.skyCanvas),this.skyTexture.encoding=THREE.sRGBEncoding,this.skyTexture.needsUpdate=!0,this.back=new THREE.Mesh(new THREE.IcosahedronGeometry(300,1),new THREE.MeshBasicMaterial({map:this.skyTexture,side:THREE.BackSide,depthWrite:!1,fog:!1})),this.scene.add(this.back)):this.renderer.setClearColor(this.pool.color.sky,1),window.addEventListener("resize",function(t){this.resize()}.bind(this),!1),document.addEventListener("contextmenu",(function(t){t.preventDefault()}),!1),document.addEventListener("mousewheel",this,!1),this.container.addEventListener("mousemove",this,!1),this.container.addEventListener("mousedown",this,!1),this.container.addEventListener("touchmove",this,!1),this.container.addEventListener("touchstart",this,!1),this.container.addEventListener("touchend",this,!1),document.addEventListener("mouseup",this,!1),this.initLayer(),this.tool=new BuildTool,this.scene.add(this.tool),this.tool.visible=!1,this.isMobile||this.bindKeys(),this.loop(0)}loop(t){requestAnimationFrame(this.loop.bind(this)),null!==this.onEase&&this.onEase(),this.dragMode()?this.dragCenterposition():this.updateKey(),this.render(t)}render(t){this.doResize(),this.renderer.render(this.scene,this.camera)}handleEvent(t){switch(t.type){case"mouseup":case"mouseout":case"touchend":this.onMouseUp(t);break;case"mousedown":case"touchstart":this.onMouseDown(t);break;case"mousemove":case"touchmove":this.onMouseMove(t);break;case"mousewheel":this.onMouseWheel(t);break}}resize(t){this.needResize=!0}doResize(){this.needResize&&(this.vsize={x:window.innerWidth,y:window.innerHeight,z:window.innerWidth/window.innerHeight},this.camera.aspect=this.vsize.z,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.vsize.x,this.vsize.y),this.needResize=!1)}startZoom(){this.timer=setInterval(this.faddingZoom,1e3/60,this)}faddingZoom(t){t.cam.distance>20?(t.cam.distance--,t.moveCamera()):clearInterval(t.timer)}clamp(t,e,i){return t<e?e:t>i?i:t}randRange(t,e){return Math.floor(Math.random()*(e-t+1))+t}unwrapDegrees(t){return(t%=360)>180&&(t-=360),t<-180&&(t+=360),t}winterSwitch(){}textureSwitch(t){}setTimeColors(t){}getRandomObject(t){let e;switch(t=t||this.randRange(0,2)){case 0:e=this.pool.geo("residential",this.randRange(1,18));break;case 1:e=this.pool.geo("commercial",this.randRange(1,20));break;case 2:e=this.pool.geo("industrial",this.randRange(1,8));break}return new THREE.Mesh(e,this.buildingMaterial)}buildMeshLayer(t,e="tree"){let i=0;"tree"===(e=e)&&(i=0),"town"===e&&(i=1),"house"===e&&(i=2),"building"===e&&(i=3);let s,h,a,r,o,n,l,d,u,c,p,m,g=this.M_list[i],y=this.M_temp[i],f=this.M_mesh[i],T=this.M_mats[i],w=!1,M=0;if(this[g][t]){for(l=this[g][t].length,a=[],o=[],r=[],s=[];l--;){if(p=this[g][t][l],3===i){for(m=Base.R.length;m--;)p[3]===Base.R[m]&&(h=this.pool.geo("residential",m),0===m&&0===p[5]?(this.buildingLists[t][l][5]=1,this.addBaseHouse(p[0],p[1],p[2])):m>0&&1===p[5]&&(this.buildingLists[t][l][5]=0,this.removeBaseHouse(p[0],p[1],p[2])));for(m=Base.C.length;m--;)p[3]===Base.C[m]&&(h=this.pool.geo("commercial",m));for(m=Base.I.length;m--;)p[3]===Base.I[m]&&(h=this.pool.geo("industrial",m))}else if(2===i)for(m=Base.H.length;m--;)p[3]===Base.H[m]&&(h=this.pool.geo("house",m));else h=this.pool.geo(e,p[3]);if(h){if(null!==h.index){for(w=!0,u=h.index.count,d=0;d<u;++d)s.push(h.index.getX(d)+M);M+=h.attributes.position.count}for(n=h.attributes.position.array,u=h.attributes.position.count,d=0;d<u;++d)c=3*d,a.push(n[c]+p[0],n[c+1]+p[1],n[c+2]+p[2]+0);r=[...r,...h.attributes.normal.array],o=[...o,...h.attributes.uv.array]}}if(this[f][t]&&(this[f][t].geometry.dispose(),this.scene.remove(this[f][t])),a.length>0){let e=new THREE.BufferGeometry;w&&e.setIndex(s),e.setAttribute("position",new THREE.Float32BufferAttribute(a,3)),e.setAttribute("normal",new THREE.Float32BufferAttribute(r,3)),e.setAttribute("uv",new THREE.Float32BufferAttribute(o,2)),this[f][t]=new THREE.Mesh(e,this[T]),this.scene.add(this[f][t])}this[y][t]=0}}addTree(t,e=0,i,s,h){this.isWithTree&&(this.treeLists[h]||(this.treeLists[h]=[]),this.treeLists[h].push([t,e,i,s]))}populateTree(){if(!this.isWithTree)return;let t=this.nlayers;for(;t--;)this.buildMeshLayer(t)}clearAllTrees(){if(!this.isWithTree)return;let t=this.nlayers;for(;t--;)this.treeMeshs[t]&&(this.scene.remove(this.treeMeshs[t]),this.treeMeshs[t].geometry&&this.treeMeshs[t].geometry.dispose());this.treeMeshs=[],this.treeLists=[],this.tempTreeLayers=[],this.treeValue=[]}removeTreePack(t){if(!this.isWithTree)return;let e=t.length;for(;e--;)this.removeTree(t[e][0],t[e][1],!0);for(e=this.tempTreeLayers.length;e--;)1===this.tempTreeLayers[e]&&this.rebuildTreeLayer(e)}removeTree(t,e,i){let s,h=this.findLayer(t,e);if(this.treeLists[h]){let a=this.treeLists[h].length;for(;a--;)if(s=this.treeLists[h][a],s[0]==t&&s[2]==e){if(this.treeLists[h].splice(a,1),!i)return void this.rebuildTreeLayer(h);this.tempTreeLayers[h]=1}}}rebuildTreeLayer(t){this.isWithTree&&(this.scene.remove(this.treeMeshs[t]),this.treeMeshs[t].geometry.dispose(),this.buildMeshLayer(t))}updateBackground(){let t,e;this.isWithBackground?(this.isIsland?(t="#6666e6",e=6711014,this.isWinter&&(t="#AFEEEE",e=11529966),this.skyCanvasBasic=this.gradTexture([[.51,.49,.3],[t,"#BFDDFF","#4A65FF"]]),this.skyCanvas=this.gradTexture([[.51,.49,.3],[t,"#BFDDFF","#4A65FF"]]),this.isWithFog&&this.fog.color.setHex(e)):(t="#E2946D",e=14849133,this.isWinter&&(t="#E6F0FF",e=15134975),this.skyCanvasBasic=this.gradTexture([[.51,.49,.3],[t,"#BFDDFF","#4A65FF"]]),this.skyCanvas=this.gradTexture([[.51,.49,.3],[t,"#BFDDFF","#4A65FF"]]),this.isWithFog&&this.fog.color.setHex(e)),this.skyTexture=new THREE.Texture(this.skyCanvas),this.skyTexture.encoding=THREE.sRGBEncoding,this.skyTexture.needsUpdate=!0,this.back.material.map=this.skyTexture):this.isIsland?this.renderer.setClearColor(6711014,1):this.renderer.setClearColor(13401958,1),this.isWithLight}clearTerrain(){if(0!==this.miniTerrain.length){let t=this.miniTerrain.length;for(;t--;)this.land.remove(this.miniTerrain[t]);this.miniTerrain=[]}}initTerrain(){if(this.center.x=.5*this.mapSize[0],this.center.z=.5*this.mapSize[1],0===this.miniTerrain.length){let t,e,i,s,h,a,r=0,o=this.isWithHeight?16:1;for(t=0;t<8;t++)for(e=0;e<8;e++){for(s=new THREE.PlaneBufferGeometry(16,16,o,o),s.rotateX(.5*-Math.PI),s.translate(8+16*e-.5,0,8+16*t-.5),i=s.attributes.position.array.length,a=[];i--;)a[i]=1;s.setAttribute("color",new THREE.Float32BufferAttribute(a,3)),h=new THREE.Mesh(s,this.terrainMaterials[r]),h.name="terrain_"+r,this.land.add(h),this.miniTerrain[r]=h,r++}}this.isWithHeight?(this.applyHeight(),this.center.y=this.heightData[this.findHeightId(this.center.x,this.center.z)]):this.center.y=0,this.initTerrainTexture(),this.moveCamera(),this.isWithBackground&&this.back.position.copy(this.center)}initTerrainTexture(){let t,e,i,s=this.nlayers,h=document.createElement("canvas");for(h.width=h.height=256*this.mu;s--;)t=new THREE.Texture(h),this.pool.filterTexture(t,{}),this.miniTerrain[s].material.map=t,this.terrainTxt[s]=t,this.isWithNormal&&(e=new THREE.Texture(h),this.pool.filterTexture(e,{normal:!0}),this.miniTerrain[s].material.normalMap=e,this.terrainTxtN[s]=e),this.isWithRoughness&&(i=new THREE.Texture(h),this.pool.filterTexture(i,{normal:!0}),this.miniTerrain[s].material.roughnessMap=i,this.terrainTxtR[s]=i)}generateHeight(){let t=this.mapSize[0]+1,e=t*t;this.heightData=new this.ARRAY_TYPE(e);let i,s,h,a=new ImprovedNoise,r=1/t,o=e,n=0,l=0;for(;o--;)s=o%t,h=Math.floor(o*r),i=.5*(a.noise(.05*s,0,.05*h)+1),i*=2,i=Math.pow(i,3),this.heightData[o]=i,i<n&&(n=i),i>l&&(l=i);this.isWithHeight=!0}clearHeight(){this.water&&this.scene.remove(this.water),this.heightData=null,this.isWithHeight=!1}applyHeight(){let t,e,i,s,h,a,r,o,n,l,d=this.heightData.length;this.Gtmp=[];let u=new THREE.PlaneGeometry(128,128,128,128);for(u.rotateX(.5*-Math.PI),u.translate(this.center.x,0,this.center.z),i=u.attributes.position.array,t=d;t--;)a=3*t,i[a+1]=this.heightData[t];u.attributes.position.needUpdate=!0,u.computeVertexNormals();let c=u.attributes.normal.array;for(t=64;t--;){for(o=this.miniTerrain[t].geometry,i=o.attributes.position.array,s=o.attributes.normal.array,h=o.attributes.color.array,e=i.length/3,this.Gtmp[t]=new this.ARRAY_TYPE(e);e--;)a=3*e,n=this.findHeightId(i[a]+.5,i[a+2]+.5),i[a+1]=this.Gtmp[t][e]=this.heightData[n],r=3*n,s[a]=c[r],s[a+1]=c[r+1],s[a+2]=c[r+2],l=.5+.5*this.clamp(this.heightData[n]/3,-1,1),h[a]=h[a+1]=h[a+2]=l,i[a+1]<0&&(h[a]-=.5*l,h[a+1]-=.4*l),-.5!==i[a]&&-.5!==i[a+2]&&127.5!==i[a]&&127.5!==i[a+2]||(i[a+1]>0&&(i[a+1]=this.heightData[n]=.25),i[a+1]<0&&(i[a+1]=this.heightData[n]=0));o.attributes.position.needUpdate=!0,o.attributes.normal.needUpdate=!0,o.attributes.color.needUpdate=!0}u.dispose(),u=null;let p=new THREE.PlaneGeometry(128,128,1,1);p.rotateX(.5*-Math.PI),p.translate(this.center.x-.5,0,this.center.z-.5),this.water=new THREE.Mesh(p,this.waterMat),this.scene.add(this.water)}makePlanar(t,e){let i,s,h,a,r=t.length,o=[];for(;r--;)s=t[r][0],h=t[r][1],a=this.findHeightId(s,h),this.heightData[a]=e,i=this.findLayer(s,h),o[i]=1;for(r=o.length;r--;)1===o[r]&&this.updateVertices(r)}updateVertices(t){let e,i,s=this.miniTerrain[t].geometry,h=s.attributes.position.array,a=(s.attributes.color.array,h.length/3);for(;a--;)e=3*a,i=this.findHeightId(h[e]+.5,h[e+2]+.5),h[e+1]=this.heightData[i];s.attributes.position.needsUpdate=!0}findLayer(t,e){return Math.floor(t/16)+8*Math.floor(e/16)}findLayerPos(t,e,i){let s=Math.floor(i/8);return[t-16*Math.floor(i-8*s),e-16*s]}findPosition(t){let e=Math.floor(t/this.mapSize[1]);return[t-e*this.mapSize[1],e]}findId(t,e){return t+e*this.mapSize[1]}findVertices(t,e){let i=Math.floor(t/8),s=Math.floor(t-8*i),h=e[1]-16*i;return e[0]-16*s+16*h}findHeightId(t,e){return t+e*(this.mapSize[1]+1)}rayTest(){let t;this.raycaster.setFromCamera(this.rayVector,this.camera),this.isMenu&&!this.inMapGenation&&(this.ui.noMouse(),t=this.raycaster.intersectObjects(this.scene.children),t.length>0&&"p1"===t[0].object.name&&this.ui.setMouse(t[0].uv)),this.land.children.length>0&&(t=this.raycaster.intersectObjects(this.land.children),t.length>0?(this.raypos.x=Math.round(t[0].point.x),this.raypos.z=Math.round(t[0].point.z),this.isWithHeight?this.raypos.y=Math.round(t[0].point.y):this.raypos.y=0,this.currentTool&&(this.tool.position.set(this.raypos.x,this.raypos.y,this.raypos.z),(this.mouse.click||this.mouse.drag)&&Main.mapClick(this.currentTool.tool),this.mouse.click=!1)):(this.raypos.x=-1,this.raypos.z=-1))}selectTool(t){this.tool.visible=!1,this.raypos.x=-1,this.raypos.z=-1,0===t||18===t?(this.currentTool=null,this.mouse.dragView=!1,this.mouse.move=!0):16===t?(this.currentTool=null,this.mouse.move=!1,this.mouse.dragView=!0):(this.currentTool=Base.toolSet[t],this.mouse.move=!1,this.mouse.dragView=!1,this.tool.visible=!0,this.tool.color=this.currentTool.color,this.tool.resize=this.currentTool.size),Main.sendTool(Base.toolSet[t].tool)}build(t,e){if("query"!==this.currentTool.tool)if(this.currentTool.build){let i,s=this.currentTool.size,h=(this.currentTool.sy,0);this.isWithHeight&&(h=this.heightData[this.findHeightId(t,e)]),1==s?i=[[t,e]]:3==s?i=[[t,e],[t-1,e],[t+1,e],[t,e-1],[t-1,e-1],[t+1,e-1],[t,e+1],[t-1,e+1],[t+1,e+1]]:4==s?i=[[t,e],[t-1,e],[t+1,e],[t,e-1],[t-1,e-1],[t+1,e-1],[t,e+1],[t-1,e+1],[t+1,e+1],[t+2,e-1],[t+2,e],[t+2,e+1],[t+2,e+2],[t-1,e+2],[t,e+2],[t+1,e+2]]:6==s&&(i=[[t,e],[t-1,e],[t+1,e],[t,e-1],[t-1,e-1],[t+1,e-1],[t,e+1],[t-1,e+1],[t+1,e+1],[t+2,e-1],[t+2,e],[t+2,e+1],[t+2,e+2],[t-1,e+2],[t,e+2],[t+1,e+2],[t+3,e-1],[t+4,e-1],[t+3,e],[t+4,e],[t+3,e+1],[t+4,e+1],[t+3,e+2],[t+4,e+2],[t+3,e+3],[t+4,e+3],[t+3,e+4],[t+4,e+4],[t-1,e+3],[t-1,e+4],[t,e+3],[t,e+4],[t+1,e+3],[t+1,e+4],[t+2,e+3],[t+2,e+4]]),this.removeTreePack(i),this.isWithHeight&&1!==s&&this.makePlanar(i,h);let a=this.currentTool.geo;a<4&&0!==a&&(this.addBaseBuilding(t,h,e,a,i),this.snd_layzone.play()),8!=a&&9!=a&&4!=a&&5!=a&&7!=a&&10!=a&&11!=a&&12!=a||(this.addBaseTown(t,h,e,a,i),this.snd_layzone.play())}else{if(this.removeTree(t,e),this.isWithHeight){let i=this.heightData[this.findHeightId(t,e)];this.makePlanar([[t,e]],i)}"bulldozer"===this.currentTool.tool&&(this.forceUpdate.x=t,this.forceUpdate.y=e,this.testDestruct(t,e))}}testLayer(t,e){let i=this.findLayer(t,e),s=[i],h=this.findLayerPos(t,e,i),a=0,r=0;return h[0]<4?a=1:h[0]>13&&(a=2),h[1]<4?r=1:h[1]>13&&(r=2),1==r&&i-8>-1&&s.push(i-8),2==r&&i+8<64&&s.push(i+8),1==a&&i-1>-1&&s.push(i-1),2==a&&i+1<64&&s.push(i+1),1==a&&1==r&&i-9>-1&&s.push(i-9),2==a&&2==r&&i+9<64&&s.push(i+9),1==a&&2==r&&i+7<64&&s.push(i+7),2==a&&1==r&&i-7>-1&&s.push(i-7),s}testDestruct(t,e){let i,s,h,a,r,o=this.testLayer(t,e);for(let n=0;n<o.length;n++){if(r=o[n],this.townLists[r])for(i=this.townLists[r].length;i--;)for(h=this.townLists[r][i],a=h[4],s=a.length;s--;)if(t==a[s][0]&&e==a[s][1])return this.showDestruct(h),Main.destroy(a[0][0],a[0][1]),this.townLists[r].splice(i,1),void this.rebuildTownLayer(r);if(this.buildingLists[r])for(i=this.buildingLists[r].length;i--;)for(h=this.buildingLists[r][i],a=h[4],s=a.length;s--;)if(t==a[s][0]&&e==a[s][1])return this.showDestruct(h),Main.destroy(a[0][0],a[0][1]),1===h[5]&&this.removeBaseHouse(h[0],h[1],h[2]),this.buildingLists[r].splice(i,1),void this.rebuildBuildingLayer(r)}}showDestruct(t){this.tempDestruct=t[4]}addBaseTown(t,e,i,s,h){let a=this.findLayer(t,i);this.townLists[a]||(this.townLists[a]=[]),this.townLists[a].push([t,e,i,s,h]),this.rebuildTownLayer(a)}rebuildTownLayer(t){this.buildMeshLayer(t,"town")}addBaseHouse(t,e,i){let s=this.findLayer(t,i),h=[[t,i],[t-1,i],[t+1,i],[t,i-1],[t-1,i-1],[t+1,i-1],[t,i+1],[t-1,i+1],[t+1,i+1]];this.houseLists[s]||(this.houseLists[s]=[]);let a=9;for(;a--;)this.houseLists[s].push([h[a][0],e,h[a][1],0])}removeBaseHouse(t,e,i){let s,h,a=this.findLayer(t,i),r=[[t,i],[t-1,i],[t+1,i],[t,i-1],[t-1,i-1],[t+1,i-1],[t,i+1],[t-1,i+1],[t+1,i+1]],o=this.houseLists[a].length;for(;o--;)for(s=this.houseLists[a][o],h=9;h--;)s[0]===r[h][0]&&s[2]===r[h][1]&&this.houseLists[a].splice(o,1);this.rebuildHouseLayer(a)}rebuildHouseLayer(t){this.buildMeshLayer(t,"house")}addBaseBuilding(t,e,i,s,h){let a=this.findLayer(t,i),r=244;2==s&&(r=427),3==s&&(r=616),this.buildingLists[a]||(this.buildingLists[a]=[]),this.buildingLists[a].push([t,e,i,r,h,0]),this.rebuildBuildingLayer(a)}rebuildBuildingLayer(t){this.buildMeshLayer(t,"building")}saveCityBuild(t){let e=this.nlayers;for(;e--;)t[e]=[0,0,0],void 0!==this.townLists[e]&&(t[e][0]=this.townLists[e]),void 0!==this.houseLists[e]&&(t[e][1]=this.houseLists[e]),void 0!==this.buildingLists[e]&&(t[e][2]=this.buildingLists[e])}loadCityBuild(t){t=JSON.parse(t);let e,i=this.nlayers;for(;i--;)e=t[i],0!==e[0]&&(this.townLists[i]=e[0],this.rebuildTownLayer(i)),0!==e[1]&&(this.houseLists[i]=e[1],this.rebuildHouseLayer(i)),0!==e[2]&&(this.buildingLists[i]=e[2],this.rebuildBuildingLayer(i))}dragMode(){return this.mouse.dragView||3===this.mouse.button}Orbit(t,e,i,s){let h=new THREE.Vector3;i>87&&(i=87),i<1&&(i=1);let a=i*this.ToRad,r=e*this.ToRad;return h.x=s*Math.sin(a)*Math.cos(r)+t.x,h.z=s*Math.sin(a)*Math.sin(r)+t.z,h.y=s*Math.cos(a)+t.y,h}moveCamera(){this.camera.position.copy(this.Orbit(this.center,this.cam.horizontal,this.cam.vertical,this.cam.distance)),this.camera.lookAt(this.center),this.isWithFog&&(this.fog.far=4*this.cam.distance,this.fog.far<20&&(this.fog.far=20))}dragCenterposition(){if(0==this.ease.x&&0==this.ease.z)return;this.easeRot.y=this.cam.horizontal*this.ToRad;this.unwrapDegrees(Math.round(this.cam.horizontal));this.easeRot.x=Math.sin(this.easeRot.y)*this.ease.x+Math.cos(this.easeRot.y)*this.ease.z,this.easeRot.z=Math.cos(this.easeRot.y)*this.ease.x-Math.sin(this.easeRot.y)*this.ease.z,this.center.x+=this.easeRot.x,this.center.z-=this.easeRot.z,this.center.x<0&&(this.center.x=0),this.center.x>128&&(this.center.x=128),this.center.z<0&&(this.center.z=0),this.center.z>128&&(this.center.z=128),this.moveCamera()}onMouseDown(t){let e,i;t.preventDefault(),t.touches?(e=t.clientX||t.touches[0].pageX,i=t.clientY||t.touches[0].pageY):(e=t.clientX,i=t.clientY,this.mouse.button=t.which),this.mouse.ox=e,this.mouse.oy=i,this.rayVector.x=e/this.vsize.x*2-1,this.rayVector.y=-i/this.vsize.y*2+1,this.mouse.h=this.cam.horizontal,this.mouse.v=this.cam.vertical,this.mouse.down=!0,this.currentTool&&this.mouse.button<2&&(this.mouse.click=!0,this.currentTool.drag&&(this.mouse.drag=!0))}onMouseUp(t){t.preventDefault(),this.mouse.button=0,this.mouse.down=!1,this.mouse.drag=!1,null==this.currentTool&&(this.mouse.move=!0),this.ease.x=0,this.ease.z=0,document.body.style.cursor="auto"}onMouseMove(t){let e,i;t.preventDefault(),t.touches?(e=t.clientX||t.touches[0].pageX,i=t.clientY||t.touches[0].pageY):(e=t.clientX,i=t.clientY),this.mouse.down&&((this.mouse.move||2===this.mouse.button)&&(this.mouse.dragView=!1,document.body.style.cursor="crosshair",this.cam.horizontal=.3*(e-this.mouse.ox)+this.mouse.h,this.cam.vertical=.3*-(i-this.mouse.oy)+this.mouse.v,this.moveCamera()),(this.mouse.dragView||3===this.mouse.button)&&(document.body.style.cursor="move",this.mouse.move=!1,this.ease.x=(e-this.mouse.ox)/1e3,this.ease.z=(i-this.mouse.oy)/1e3)),(null!==this.currentTool||this.isMenu)&&(this.rayVector.x=e/this.vsize.x*2-1,this.rayVector.y=-i/this.vsize.y*2+1,this.rayTest())}onMouseWheel(t){let e=0;t.wheelDelta?e=-1*t.wheelDelta:t.detail&&(e=20*t.detail),this.cam.distance+=e/80,this.cam.distance<1&&(this.cam.distance=1),this.cam.distance>150&&(this.cam.distance=150),this.moveCamera()}paintMap(t,e=!1,i=!1){this.isIsland=e,t&&(this.mapSize=t),this.basePlane&&this.scene.remove(this.basePlane),this.clearTerrain(),this.clearAllTrees(),this.clearHeight(),i&&this.generateHeight();let s,h,a,r,o,n,l,d=this.mapSize[1],u=tilesData.length,c=0;for(;d--;)for(s=this.mapSize[0];s--;)a=Math.floor(d/16),r=Math.floor(s/16),o=r+8*a,u--,h=tilesData[u],this.isWithHeight&&(h>1&&h<5&&(l=this.findHeightId(s,d),this.heightData[l]*=-1,s===this.mapSize[0]-1&&(this.heightData[l+1]*=-1),d===this.mapSize[1]-1&&(this.heightData[l+this.mapSize[1]]*=-1),tilesData[u]=0),h>4&&h<21&&(this.heightData[this.findHeightId(s,d)]*=.5,tilesData[u]=0)),h>20&&h<30&&(this.isWithHeight&&(c=this.heightData[this.findHeightId(s,d)]-.1),n=h-21,8===n&&(n=Math.floor(7*Math.random())),i&&c>.5&&(0!==s&&0!==d&&s!==this.mapSize[0]-1&&d!==this.mapSize[0]-1||(c=.5)),this.addTree(s,c,d,n,o),this.treeValue[u]=h);this.updateBackground(),this.initTerrain();let p=this.nlayers;for(;p--;)this.drawLayer(p,!0);this.populateTree(),this.fullRedraw&&(this.fullRedraw=!1),this.inMapGenation=!1}initLayer(){let t=this.nlayers;for(;t--;)this.tempHouseLayers[t]=0,this.tempBuildingLayers[t]=0}updateLayer(){let t=this.nlayers;for(;t--;)1===layerData[t]&&this.drawLayer(t),1===this.tempHouseLayers[t]&&(this.rebuildHouseLayer(t),this.tempHouseLayers[t]=0),1===this.tempBuildingLayers[t]&&(this.rebuildBuildingLayer(t),this.tempBuildingLayers[t]=0)}drawLayer(t,e){let i,s,h,a,r,o,n,l,d=16,u=Math.floor(t/8),c=Math.floor(t-8*u);for(;d--;)for(i=16;i--;)if(o=16*c+i,n=16*u+d,h=o+n*this.mapSize[1],s=tilesData[h],l=s<240?s:0,(e||s!==this.oldData[h])&&(this.oldData[h]=s,l<240&&(this.tmpPos.x=16*i*this.mu,this.tmpPos.y=(240-16*d)*this.mu,this.renderer.copyTextureToTexture(this.tmpPos,this.pool.tile("texture",l),this.terrainTxt[t]),this.isWithNormal&&this.renderer.copyTextureToTexture(this.tmpPos,this.pool.tile("normal",l),this.terrainTxtN[t]),this.isWithRoughness&&this.renderer.copyTextureToTexture(this.tmpPos,this.pool.tile("roughness",l),this.terrainTxtR[t])),s>239))if(s>248&&s<261||0==s){if(this.houseLists[t])for(r=this.houseLists[t].length;r--;)a=this.houseLists[t][r],a[0]===o&&a[2]===n&&a[3]!==s&&(this.houseLists[t][r][3]=s,this.tempHouseLayers[t]=1)}else if(this.buildingLists[t])for(r=this.buildingLists[t].length;r--;)a=this.buildingLists[t][r],a[0]===o&&a[2]===n&&a[3]!==s&&(this.buildingLists[t][r][3]=s,this.tempBuildingLayers[t]=1)}moveSprite(){if(!spriteData)return;let t,e,i,s=spriteData.length,h=new THREE.Vector3;for(;s--;)i=spriteData[s],e=i[1],t=i[0],h.x=Math.round((i[2]-8)/16),h.z=Math.round((i[3]-8)/16),h.y=0,this.isWithHeight&&(h.y=this.heightData[this.findHeightId(h.x,h.z)]),2==i[0]&&(h.y+=5),3==i[0]&&(h.y+=11==e?0:10==e?1:9==e?3:6),null==this.spriteObjs[this.spriteLists[t]]&&(this.spriteObjs[this.spriteLists[t]]=this.addSprite(t,h)),this.spriteObjs[this.spriteLists[t]].visible=1!==t||5!==e,this.spriteObjs[this.spriteLists[t]].position.lerp(h,.6),this.spriteObjs[this.spriteLists[t]].rotation.y=this.rotationSprite(i[0],e)}rotationSprite(t,e){let i=0;return 1===t?1===e?i=0:2===e?i=90*this.ToRad:3===e?i=45*this.ToRad:4===e&&(i=-45*this.ToRad):2!==t&&3!==t||(1===e?i=0:2===e?i=-45*this.ToRad:3===e?i=-90*this.ToRad:4===e?i=-135*this.ToRad:5===e?i=-180*this.ToRad:6===e?i=-225*this.ToRad:7===e?i=-270*this.ToRad:8===e?i=-315*this.ToRad:(9===e||10===e||11===e)&&(i=-90*this.ToRad)),i}addSprite(t,e){let i;return 1===t?(i=new THREE.Mesh(this.pool.geo("sprite",0),this.townMaterial),i.position.copy(e),this.scene.add(i)):2===t?(i=new THREE.Mesh(this.pool.geo("sprite",1),this.townMaterial),i.position.copy(e),this.scene.add(i)):3===t?(i=new THREE.Mesh(this.pool.geo("sprite",2),this.townMaterial),i.position.copy(e),this.scene.add(i)):(i=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),this.townMaterial),i.position.copy(e),this.scene.add(i)),i}showPower(){let t=powerData.length;for(;t--;)0!==powerData[t]&&(2===powerData[t]?null==this.powerMeshs[t]&&this.addPowerMesh(t,this.findPosition(t)):1===powerData[t]&&null!==this.powerMeshs[t]&&this.removePowerMesh(t))}addPowerMesh(t,e){let i=0;this.isWithHeight&&(i=this.heightData[this.findHeightId(e[0],e[1])]);let s=new THREE.Sprite(this.powerMaterial);s.position.set(e[0],i+1,e[1]),this.scene.add(s),this.powerMeshs[t]=s}removePowerMesh(t){this.scene.remove(this.powerMeshs[t]),this.powerMeshs[t]=null}powerTexture(){let t=document.createElement("canvas"),e=t.getContext("2d");t.width=t.height=64;let i=e.createLinearGradient(0,0,64,64);i.addColorStop(.3,"yellow"),i.addColorStop(1,"red"),e.beginPath(),e.moveTo(44,0),e.lineTo(10,34),e.lineTo(34,34),e.lineTo(20,64),e.lineTo(54,30),e.lineTo(30,30),e.lineTo(44,0),e.closePath(),e.strokeStyle="red",e.stroke(),e.fillStyle=i,e.fill();let s=new THREE.Texture(t);return s.needsUpdate=!0,s}gradTexture(t){let e=document.createElement("canvas"),i=e.getContext("2d");e.width=16,e.height=256;let s=i.createLinearGradient(0,0,0,256),h=t[0].length;for(;h--;)s.addColorStop(t[0][h],t[1][h]);return i.fillStyle=s,i.fillRect(0,0,16,256),e}tint(t,e,i){let s,h,a,r=t.width*t.height,o=t.getContext("2d"),n=null,l=null;if(i&&0!==this.dayTime&&1!==this.dayTime){for(o.clearRect(0,0,t.width,t.height),o.drawImage(i,0,0),n=o.getImageData(0,0,t.width,t.height),s=n.data,h=r;h--;)a=h<<2,0!==s[a+3]&&(0==s[a+0]&&0==s[a+1]&&0==s[a+2]&&(s[a+3]=60),0==s[a+1]&&(3==this.dayTime&&(s[a+1]=255),2==this.dayTime&&(s[a+0]=0,s[a+3]=60)));o.putImageData(n,0,0),l=document.createElement("img"),l.src=t.toDataURL("image/png")}if(e?(o.clearRect(0,0,t.width,t.height),o.drawImage(e,0,0)):o.drawImage(this.skyCanvasBasic,0,0),0!==this.dayTime){let e=o.getImageData(0,0,t.width,t.height);s=e.data,h=r;let i=this.tcolor;for(;h--;)a=h<<2,s[a+0]=s[a+0]*(1-i.a)+i.r*i.a,s[a+1]=s[a+1]*(1-i.a)+i.g*i.a,s[a+2]=s[a+2]*(1-i.a)+i.b*i.a;o.putImageData(e,0,0),l&&o.drawImage(l,0,0)}}updateKey(){if(this.isMobile)return;let t=.3,e=!1;1==this.key[0]||1==this.key[1]?(1==this.key[0]&&(this.ease.z=-t),1==this.key[1]&&(this.ease.z=t),e=!0):this.ease.z=0,1==this.key[2]||1==this.key[3]?(1==this.key[2]&&(this.ease.x=-t),1==this.key[3]&&(this.ease.x=t),e=!0):this.ease.x=0,e&&this.dragCenterposition()}bindKeys(){let t=this;document.onkeydown=function(e){switch((e=e||window.event).keyCode){case 38:case 87:case 90:t.key[0]=1;break;case 40:case 83:t.key[1]=1;break;case 37:case 65:case 81:t.key[2]=1;break;case 39:case 68:t.key[3]=1;break}},document.onkeyup=function(e){switch((e=e||window.event).keyCode){case 38:case 87:case 90:t.key[0]=0;break;case 40:case 83:t.key[1]=0;break;case 37:case 65:case 81:t.key[2]=0;break;case 39:case 68:t.key[3]=0;break}},self.focus()}}