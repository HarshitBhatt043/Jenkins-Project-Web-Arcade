import{DataTextureLoader,DataUtils,FloatType,HalfFloatType,LinearEncoding,LinearFilter}from"../../../build/three.module.js";class RGBELoader extends DataTextureLoader{constructor(t){super(t),this.type=HalfFloatType}parse(t){const e=function(t,e){switch(t){case 1:break;case 2:break;case 3:break;default:case 4:}return-1},a=function(t,e,a){e=e||1024;let r=t.pos,n=-1,i=0,o="",s=String.fromCharCode.apply(null,new Uint16Array(t.subarray(r,r+128)));for(;0>(n=s.indexOf("\n"))&&i<e&&r<t.byteLength;)o+=s,i+=s.length,r+=128,s+=String.fromCharCode.apply(null,new Uint16Array(t.subarray(r,r+128)));return-1<n&&(!1!==a&&(t.pos+=i+n+1),o+s.slice(0,n))},r=function(t,e,a,r){const n=t[e+3],i=Math.pow(2,n-128)/255;a[r+0]=t[e+0]*i,a[r+1]=t[e+1]*i,a[r+2]=t[e+2]*i,a[r+3]=1},n=function(t,e,a,r){const n=t[e+3],i=Math.pow(2,n-128)/255;a[r+0]=DataUtils.toHalfFloat(Math.min(t[e+0]*i,65504)),a[r+1]=DataUtils.toHalfFloat(Math.min(t[e+1]*i,65504)),a[r+2]=DataUtils.toHalfFloat(Math.min(t[e+2]*i,65504)),a[r+3]=DataUtils.toHalfFloat(1)},i=new Uint8Array(t);i.pos=0;const o=function(t){const r=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*FORMAT=(\S+)\s*$/,o=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,s={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,c;if(t.pos>=t.byteLength||!(l=a(t)))return e(1);if(!(c=l.match(/^#\?(\S+)/)))return e(3);for(s.valid|=1,s.programtype=c[1],s.string+=l+"\n";l=a(t),!1!==l;)if(s.string+=l+"\n","#"!==l.charAt(0)){if((c=l.match(r))&&(s.gamma=parseFloat(c[1],10)),(c=l.match(n))&&(s.exposure=parseFloat(c[1],10)),(c=l.match(i))&&(s.valid|=2,s.format=c[1]),(c=l.match(o))&&(s.valid|=4,s.height=parseInt(c[1],10),s.width=parseInt(c[2],10)),2&s.valid&&4&s.valid)break}else s.comments+=l+"\n";return 2&s.valid&&4&s.valid?s:e(3)}(i);if(-1!==o){const t=o.width,a=o.height,s=function(t,a,r){const n=a;if(n<8||n>32767||2!==t[0]||2!==t[1]||128&t[2])return new Uint8Array(t);if(n!==(t[2]<<8|t[3]))return e(3);const i=new Uint8Array(4*a*r);if(!i.length)return e(4);let o=0,s=0;const l=4*n,c=new Uint8Array(4),p=new Uint8Array(l);let f=r;for(;f>0&&s<t.byteLength;){if(s+4>t.byteLength)return e(1);if(c[0]=t[s++],c[1]=t[s++],c[2]=t[s++],c[3]=t[s++],2!=c[0]||2!=c[1]||(c[2]<<8|c[3])!=n)return e(3);let a,r=0;for(;r<l&&s<t.byteLength;){a=t[s++];const n=a>128;if(n&&(a-=128),0===a||r+a>l)return e(3);if(n){const e=t[s++];for(let t=0;t<a;t++)p[r++]=e}else p.set(t.subarray(s,s+a),r),r+=a,s+=a}const h=n;for(let t=0;t<h;t++){let e=0;i[o]=p[t+e],e+=n,i[o+1]=p[t+e],e+=n,i[o+2]=p[t+e],e+=n,i[o+3]=p[t+e],o+=4}f--}return i}(i.subarray(i.pos),t,a);if(-1!==s){let e,i,l,c;switch(this.type){case FloatType:c=s.length/4;const t=new Float32Array(4*c);for(let e=0;e<c;e++)r(s,4*e,t,4*e);e=t,l=FloatType;break;case HalfFloatType:c=s.length/4;const a=new Uint16Array(4*c);for(let t=0;t<c;t++)n(s,4*t,a,4*t);e=a,l=HalfFloatType;break;default:break}return{width:t,height:a,data:e,header:o.string,gamma:o.gamma,exposure:o.exposure,format:i,type:l}}}return null}setDataType(t){return this.type=t,this}load(t,e,a,r){return super.load(t,(function(t,a){switch(t.type){case FloatType:t.encoding=LinearEncoding,t.minFilter=LinearFilter,t.magFilter=LinearFilter,t.generateMipmaps=!1,t.flipY=!0;break;case HalfFloatType:t.encoding=LinearEncoding,t.minFilter=LinearFilter,t.magFilter=LinearFilter,t.generateMipmaps=!1,t.flipY=!0;break}e&&e(t,a)}),a,r)}}export{RGBELoader};