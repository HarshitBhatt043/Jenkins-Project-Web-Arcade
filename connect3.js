const colours=["red","orange","yellow","dodgerblue","limegreen","darkorchid","hotpink"],shapes=["minus","circle","triangle","plus","square","hexagon","dot"],BOARD_SIZE=8,score={set(e){score.number=e,squareElem.dataset.score=e},add(e){this.set(e+this.number)}};class Tile{constructor(e,t,l,s=!1){switch(this.colour=-1,this.element=document.createElement("span"),this.element.addEventListener("click",(e=>{if("DONTSELECT"===selectedTile);else if(selectedTile){if(selectedTile.x===this.x&&1===Math.abs(selectedTile.y-this.y)||selectedTile.y===this.y&&1===Math.abs(selectedTile.x-this.x)){let e={me:[this.x,this.y],selectedTile:[selectedTile.x,selectedTile.y,selectedTile.elem]};return selectedTile.moveTileTo(this.x,this.y),this.moveTo(selectedTile.x,selectedTile.y),selectedTile=null,void(startMurderSpree(200)||(selectedTile="DONTSELECT",setTimeout((()=>{e.selectedTile[2].moveTo(e.selectedTile[0],e.selectedTile[1]),this.moveTo(e.me[0],e.me[1]),selectedTile=null}),200)))}if(selectedTile.cancel()===this)return}selectedTile||(this.element.classList.add("active"),selectedTile={x:this.x,y:this.y,moveTileTo:(e,t)=>{this.moveTo(e,t),this.element.classList.remove("active")},cancel:()=>(this.element.classList.remove("active"),selectedTile=null,this),elem:this})}),!1),l){case"bomb":this.element.classList.add("bomb");default:this.element.classList.add(shapes[l]),this.element.style.backgroundColor=colours[l],this.colour=l}s&&this.element.classList.add("entering"),squareElem.appendChild(this.element),this.x=e,this.y=t,this.moveTo(e,t)}remove(e=!0,t=!0){e?(this.element.classList.add("exiting"),this.element.addEventListener("animationend",(e=>{squareElem.removeChild(this.element)}),!1)):squareElem.removeChild(this.element),tileElems[this.y][this.x]=null,tiles[this.y][this.x]=null;for(let e=this.y;e--;)tileElems[e][this.x].moveTo(this.x,e+1);t&&new Tile(this.x,0,Math.floor(Math.random()*colours.length),!0),selectedTile&&selectedTile.elem===this&&(selectedTile=null)}moveTo(e,t){tileElems[this.y][this.x]===this&&(tileElems[this.y][this.x]=null,tiles[this.y][this.x]=null),this.element.style.left=45*(this.x=e)+20+"px",this.element.style.top=45*(this.y=t)+20+"px",tileElems[t][e]=this,tiles[t][e]=this.colour}}function startMurderSpree(e=!1){let t,l=0,s=[];for(;(t=checkForMatches(tiles)).length;){for(let e=t.length;e--;)for(let l=t[e].length;l--;){let i=tileElems[t[e][l][1]][t[e][l][0]];s.includes(i)||(s.push(i),tiles[t[e][l][1]][t[e][l][0]]=NaN)}l++}let i=()=>{for(let e=s.length;e--;)s[e].remove();score.add(100*s.length),startMurderSpree(400)};return 0!==l&&(e?setTimeout(i,e):i()),0!==l}function checkForMatches(e){function t(e,t,l=!0,s=0,i=0){return[e+(l?i:s),t+(l?s:i)]}function l(t){return e[t[1]][t[0]]}function s(e,t){return-1===e||-1===t||e===t}function i(e,i,r){let o=t(e,i),h=l(o),n=[o],c=r?i:e,d=r?e:i;for(let o=1;o<6&&c-o>=0;o++){let c=t(e,i,r,-o);if(!s(h,l(c)))break;n.push(c)}if(n.length>=3){let o=[n];for(let c=n.length;c--;){let n=[t(e,i,r,-c)],a=!1,u=!1;for(let o=1;o<6;o++){let m=t(e,i,r,-c,-o),T=t(e,i,r,-c,o);if(!a&&d-o>=0&&s(h,l(m))?n.push(m):a=!0,!u&&d+o<8&&s(h,l(T))?n.push(T):u=!0,a&&u)break}n.length>=3&&o.push(n)}return o}return!1}for(let e=8;e--;)for(let t=8;t--;){if(e>1){let l=i(t,e,!0);if(l)return l}if(t>1){let l=i(t,e,!1);if(l)return l}}return[]}let foundMatches,squareElem=document.createElement("div"),tiles=[],tileElems=[];squareElem.classList.add("grid");for(let e=8;e--;){let e=[];for(let t=8;t--;)e.push(Math.floor(Math.random()*colours.length));tiles.push(e)}for(;(foundMatches=checkForMatches(tiles)).length;)for(let e=3;e--;)tiles[foundMatches[0][e][1]][foundMatches[0][e][0]]=Math.floor(Math.random()*colours.length);let selectedTile=null;for(let e=8;e--;){let t=[];tileElems[e]=t;for(let t=8;t--;)new Tile(t,e,tiles[e][t])}document.body.appendChild(squareElem),score.set(0);