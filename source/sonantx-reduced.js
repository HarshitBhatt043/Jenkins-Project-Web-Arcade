var sonantxr_generate_song,sonantxr_generate_sound;!function(){var t=44100;function e(t){return _math.sin(6.283184*t)}var n=[e,function(t){return e(t)<0?-1:1},function(t){return t%1-.5},function(t){var e=t%1*4;return e<2?e-1:3-e}];function s(t){return.00390625*_math.pow(1.059463094,t-128)}function i(t){return{left:new Float32Array(t),right:new Float32Array(t)}}function r(t,e,n,s){for(var i=n.fx_delay_time*s>>1,r=n.fx_delay_amt/255,a=0;a<e-i;){var o=a,h=a+i;t.left[h]+=t.right[o]*r,t.right[h]+=t.left[o]*r,a++}}function a(e,n){var s=e.createBuffer(2,n.left.length,t);return s.getChannelData(0).set(n.left),s.getChannelData(1).set(n.right),s}var o=function(t,e,s){this.ctx=t,this.instr=e,this.rowLen=s||5605,this.osc_lfo=n[e.lfo_waveform],this.osc1=n[e.osc1_waveform],this.osc2=n[e.osc2_waveform],this.attack=e.env_attack,this.sustain=e.env_sustain,this.release=e.env_release,this.panFreq=_math.pow(2,e.fx_pan_freq-8)/this.rowLen,this.lfoFreq=_math.pow(2,e.lfo_freq-8)/this.rowLen};o.prototype._genSound=function(n,i,r){for(var a=0,o=0,h=s(n+12*(this.instr.osc1_oct-8)+this.instr.osc1_det)*(1+8e-4*this.instr.osc1_detune),f=s(n+12*(this.instr.osc2_oct-8)+this.instr.osc2_det)*(1+8e-4*this.instr.osc2_detune),c=this.instr.fx_resonance/255,_=0,u=0,v=i.left.length,l=this.attack+this.sustain+this.release-1;l>=0;--l){var g=l+r,w=this.osc_lfo(g*this.lfoFreq)*this.instr.lfo_amt/512+.5,d=1;l<this.attack?d=l/this.attack:l>=this.attack+this.sustain&&(d-=(l-this.attack-this.sustain)/this.release);var x=h;this.instr.lfo_osc1_freq&&(x+=w),this.instr.osc1_xenv&&(x*=d*d),a+=x;var m=this.osc1(a)*this.instr.osc1_vol;x=f,this.instr.osc2_xenv&&(x*=d*d),o+=x,m+=this.osc2(o)*this.instr.osc2_vol,this.instr.noise_fader&&(m+=(2*_math.random()-1)*this.instr.noise_fader*d),m*=d/255;var p=this.instr.fx_freq;this.instr.lfo_fx_freq&&(p*=w);var k=c*(m-u)-(_+=(p=1.5*_math.sin(3.141592*p/t))*u);switch(u+=p*k,this.instr.fx_filter){case 1:m=k;break;case 2:m=_;break;case 3:m=u;break;case 4:m=_+k;break;default:}x=e(g*this.panFreq)*this.instr.fx_pan_amt/512+.5,m*=.00476*this.instr.env_master,g<v&&(i.left[g]+=m*(1-x),i.right[g]+=m*x)}},o.prototype._createAudioBuffer=function(t,e){var n=this.attack+this.sustain+this.release-1+32*this.rowLen,s=i(n);this._genSound(t,s,0),r(s,n,this.instr,this.rowLen),e(a(this.ctx,s))};var h=function(e,n){this.ctx=e,this.song=n,this.waveSize=t*n.songLen};h.prototype._generateTrack=function(t,e,n){var s=this,a=i(this.waveSize),h=s.waveSize,f=s.song.rowLen,c=s.song.endPattern,_=new o(s.ctx,t,f),u=0,v=0,l=0,g=function(){for(var e=Date.now();;)if(32!==l){if(v===c-1)return w();var n=t.p[v];if(n){var s=t.c[n-1].n[l];s&&_._genSound(s,a,u)}if(u+=f,l+=1,Date.now()-e>33)return void setTimeout(g,0)}else l=0,v+=1},w=function(){r(a,h,t,f);for(var s=0;s<h;s++)e.left[s]+=a.left[s];for(s=0;s<h;s++)e.right[s]+=a.right[s];n()};g()},h.prototype._createAudioBuffer=function(t){var e=this,n=i(this.waveSize),s=0,r=function(){s<e.song.songData.length?(s+=1,e._generateTrack(e.song.songData[s-1],n,r)):t(a(e.ctx,n))};r()},sonantxr_generate_song=function(t,e,n){new h(t,e)._createAudioBuffer(n)},sonantxr_generate_sound=function(t,e,n,s){new o(t,e)._createAudioBuffer(n,s)}}();