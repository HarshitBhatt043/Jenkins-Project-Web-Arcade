var vertex_buffer,shader_program,level_num_verts,light_uniform,camera_uniform,gl=c.getContext("webgl")||c.getContext("experimental-webgl"),texture_size=1024,tile_size=16,tile_fraction=tile_size/texture_size,px_nudge=.5/texture_size,max_verts=65536,num_verts=0,buffer_data=new Float32Array(8*max_verts),max_lights=32,num_lights=0,light_data=new Float32Array(7*max_lights),camera_x=0,camera_y=0,camera_z=0,shader_attribute_vec="attribute vec",shader_varying="precision highp float;varying vec3 vl;varying vec2 vuv;",shader_uniform="uniform ",shader_const_mat4="const mat4 ",vertex_shader=shader_varying+shader_attribute_vec+"3 p;"+shader_attribute_vec+"2 uv;"+shader_attribute_vec+"3 n;"+shader_uniform+"vec3 cam;"+shader_uniform+"float l[7*"+max_lights+"];"+shader_const_mat4+"v=mat4(1,0,0,0,0,.707,.707,0,0,-.707,.707,0,0,-22.627,-22.627,1);"+shader_const_mat4+"r=mat4(.977,0,0,0,0,1.303,0,0,0,0,-1,-1,0,0,-2,0);void main(void){vl=vec3(0.3,0.3,0.6);for(int i=0; i<"+max_lights+"; i++) {vec3 lp=vec3(l[i*7],l[i*7+1],l[i*7+2]);vl+=vec3(l[i*7+3],l[i*7+4],l[i*7+5])*max(dot(n,normalize(lp-p)),0.)*(1./(l[i*7+6]*(length(lp-p))));}vuv=uv;gl_Position=r*v*(vec4(p+cam,1.));}",fragment_shader=shader_varying+shader_uniform+"sampler2D s;void main(void){vec4 t=texture2D(s,vuv);if(t.a<.8)discard;if(t.r>0.95&&t.g>0.25&&t.b==0.0)gl_FragColor=t;else{gl_FragColor=t*vec4(vl,1.);gl_FragColor.rgb*=smoothstep(112.,16.,gl_FragCoord.z/gl_FragCoord.w);}gl_FragColor.rgb=floor(gl_FragColor.rgb*6.35)/6.35;}";function renderer_init(){for(var e in gl)gl[e].length!=udef&&(gl[e.match(/(^..|[A-Z]|\d.|v$)/g).join("")]=gl[e]);vertex_buffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,vertex_buffer),gl.bufferData(gl.ARRAY_BUFFER,buffer_data,gl.DYNAMIC_DRAW),shader_program=gl.createProgram(),gl.attachShader(shader_program,compile_shader(gl.VERTEX_SHADER,vertex_shader)),gl.attachShader(shader_program,compile_shader(gl.FRAGMENT_SHADER,fragment_shader)),gl.linkProgram(shader_program),gl.useProgram(shader_program),camera_uniform=gl.getUniformLocation(shader_program,"cam"),light_uniform=gl.getUniformLocation(shader_program,"l"),gl.enable(gl.DEPTH_TEST),gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),gl.viewport(0,0,c.width,c.height),enable_vertex_attrib("p",3,8,0),enable_vertex_attrib("uv",2,8,3),enable_vertex_attrib("n",3,8,5)}function renderer_bind_image(e){var r=gl.TEXTURE_2D;gl.bindTexture(r,gl.createTexture()),gl.texImage2D(r,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),gl.texParameteri(r,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(r,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(r,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(r,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE)}function renderer_prepare_frame(){num_verts=level_num_verts,num_lights=0,light_data.fill(1)}function renderer_end_frame(){gl.uniform3f(camera_uniform,camera_x,camera_y-10,camera_z-30),gl.uniform1fv(light_uniform,light_data),gl.clearColor(0,0,0,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.bufferData(gl.ARRAY_BUFFER,buffer_data,gl.DYNAMIC_DRAW),gl.drawArrays(gl.TRIANGLES,0,num_verts)}function push_quad(e,r,a,t,_,l,g,i,n,o,u,m,s,d,h,c){var v=c*tile_fraction+px_nudge;buffer_data.set([e,r,a,v,0,s,d,h,t,_,l,v+tile_fraction-px_nudge,0,s,d,h,g,i,n,v,1,s,d,h,t,_,l,v+tile_fraction-px_nudge,0,s,d,h,g,i,n,v,1,s,d,h,o,u,m,v+tile_fraction-px_nudge,1,s,d,h],8*num_verts),num_verts+=6}function push_sprite(e,r,a,t){var _=3+(camera_z+a)/12;push_quad(e,r+6,a,e+6,r+6,a,e,r,a+_,e+6,r,a+_,0,0,1,t)}function push_floor(e,r,a){push_quad(e,0,r,e+8,0,r,e,0,r+8,e+8,0,r+8,0,1,0,a)}function push_block(e,r,a,t){var _=~[8,9,17].indexOf(t)?16:8;push_quad(e,_,r,e+8,_,r,e,_,r+8,e+8,_,r+8,0,1,0,a),push_quad(e+8,_,r,e+8,_,r+8,e+8,0,r,e+8,0,r+8,1,0,0,t),push_quad(e,_,r+8,e+8,_,r+8,e,0,r+8,e+8,0,r+8,0,0,1,t),push_quad(e,_,r,e,_,r+8,e,0,r,e,0,r+8,-1,0,0,t)}function push_light(e,r,a,t,_,l,g){num_lights<max_lights&&(light_data.set([e,r,a,t,_,l,g],7*num_lights),num_lights++)}function compile_shader(e,r){var a=gl.createShader(e);return gl.shaderSource(a,r),gl.compileShader(a),a}function enable_vertex_attrib(e,r,a,t){var _=gl.getAttribLocation(shader_program,e);gl.enableVertexAttribArray(_),gl.vertexAttribPointer(_,r,gl.FLOAT,!1,4*a,4*t)}