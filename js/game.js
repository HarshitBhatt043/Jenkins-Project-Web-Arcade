var Game=new function(){var e,t,i,o,a=Config.debug,n=Config.tweet,s=!1,r=[4,6,8,10],h=0,u=null,l=0,d=["Wonderful","Spectacular","Marvelous","Outstanding","Remarkable","Shazam","Impressive","Great","Well done","Fabulous","Clever","Dazzling","Fantastic","Excellent","Nice","Super","Awesome","Ojoo","Brilliant","Splendid","Exceptional","Magnificent","Yay"],c=[],m=!0,f=[],w=!1,g=!1;function v(){var e=320,t=480,i=e/t,o={width:$("#feelsize").width(),height:$("#feelsize").height()},a=o.width/o.height<i,n={width:Math.floor(a?o.width:o.height/t*e),height:Math.floor(a?o.width/e*t:o.height)};$("#container").css({width:n.width+"px",height:n.height+"px"});var s=n.width;$("h1").css("font-size",Math.round(.24*s)+"px"),$("h2").css("font-size",Math.round(.18*s)+"px"),$("h3").css("font-size",Math.round(.15*s)+"px"),$("p").css("font-size",Math.round(.07*s)+"px"),$("#menu h2").css("font-size",Math.round(.24*s)+"px"),$("#menu p").css("font-size",Math.round(.1*s)+"px"),$("#menu p").css("padding",Math.round(.05*s)+"px 0"),$("#menu p").css("line-height",Math.round(.1*s)+"px");var r=Math.round(.1*s);$("#score").css({"font-size":r+"px","line-height":.85*r+"px",height:r+"px"});var h=Math.floor(22/320*s);$(".icon").css({width:h,height:h,marginLeft:h,marginRight:h}),$(".board table").each((function(e,t){var i=$(t),o=i.attr("data-grid"),a=i.width(),n=i.find("tr").first().children("td").length,s=Math.floor(a/n);if(s){i.find(".tile").css({width:s,height:s,"line-height":Math.round(.85*s)+"px","font-size":Math.round(.5*s)+"px"});var r=Math.round(.1*s),h="#"+o+" .tile .inner { border-radius: "+r+"px; }#"+o+" .tile-1 .inner:after, #"+o+" .tile-2 .inner:after { border-radius: "+r+"px; }";Utils.createCSS(h,o+"radius"),Utils.createCSS(".tile.marked .inner { border-width: "+Math.floor(s/24)+"px }","tileSize")}})),$("#digits").width($("#titlegrid table").width()).height($("#titlegrid table").height()),$("#digits").css({"line-height":Math.round(.92*$("#titlegrid table").height())+"px","font-size":.5*$("#titlegrid table").height()+"px"});var u=Math.floor($("#container").height()/2-$("#board").height()/2);$("#hintMsg").height(u+"px")}function p(){m=!0,$(".screen").hide().removeClass("show"),$("#title").show(),setTimeout((function(){$("#title").addClass("show")}),0)}function T(){m=!1,$(".screen").hide().removeClass("show"),$("#game").show(),setTimeout((function(){$("#game").addClass("show")}),0),v()}function b(){m=!0,E(),$(".screen").hide().removeClass("show"),$("#menu").show(),$("#scorenr").html(L()),setTimeout((function(){$("#menu").addClass("show")}),0),v()}function C(){m=!1,$(".screen").hide().removeClass("show"),$("#about").show(),setTimeout((function(){$("#about").addClass("show")}),0),v()}function z(){m=!1,T(),$("#boardsize").html("<span>Select a size</span>"),$("#menugrid").removeClass("hidden"),$("#board").addClass("hidden"),$("#bar [data-action]").not('[data-action="back"]').hide(),$("#board").addClass("hidden"),$("#score").show(),setTimeout((function(){e&&e.clear(),$("#score").addClass("show")}),0)}function k(e){m=!1,$("#game").removeClass("show"),m=!1,$(".screen").hide().removeClass("show"),$("#loading").show(),setTimeout((function(){$("#loading").addClass("show")}),0),v(),Levels.hasPuzzleAvailable(e),setTimeout((function(){x(Levels.getSize(e))}),100)}function x(t){if(m=!1,!t||!t.size||!t.full)throw"no proper puzzle object received";E(),window.STOPPED||(s=!1,$("#undo").closest(".iconcon").css("display","inline-block"),$("#menugrid").addClass("hidden"),$("#board").removeClass("hidden"),$("#bar [data-action]").show(),$("#tweeturl").hide(),$("#chooseSize").removeClass("show"),$("#score").removeClass("show").hide(),$('#bar [data-action="help"]').removeClass("hidden wiggle"),$("#boardsize").html("<span>"+t.size+" x "+t.size+"</span>"),e=new Grid(t.size,t.size),h=t.size,e.load(t.empty,t.full),e.each((function(){this.value=this.value,this.value>0&&(this.system=!0)})),e.state.save("empty"),u=t,e.hint.active=!0,e.activateDomRenderer(),e.render(),f=[],w=!1,g=!1,setTimeout(T,0))}function S(){var a=L(),r=A(e.width*e.height);e.unmark(),e.hint.hide(),e.hint.active=!1;var h=function(){c.length||(c=Utils.shuffle(d.slice(0)));return Utils.draw(c)}()+"!";$("#boardsize").html("<span>"+h+"</span>"),e.each((function(){this.system=!0})),$("#bar [data-action]").not('[data-action="back"]').hide(),o=setTimeout((function(){$("#grid .tile").addClass("completed"),t=setTimeout((function(){$("#board").addClass("hidden"),i=setTimeout((function(){var e,t,i;g=!0,$("#menugrid").removeClass("hidden"),$("#chooseSize").addClass("show"),$("#score").show(),s||r>a&&(!function(e,t){var i=500/(t-e);function o(){$("#scorenr").html(e),e<t&&e++,A.TOH=setTimeout(o,i)}o()}(a,r),n&&!u.isTutorial&&(e=u.size,t="#0hh1 I just completed a "+e+" x "+e+" puzzle and my score is "+L()+".",i="https://twitter.com/share?text="+encodeURIComponent(t),$("#tweeturl").attr("href",i),$("#tweeturl").show())),setTimeout((function(){$("#score").addClass("show")}),0)}),50)}),2e3)}),1200),u.isTutorial||Levels.finishedSize(e.width)}function y(){document.addEventListener("backbutton",I,!1),$(document).on("keydown",(function(e){return 27==e.keyCode?(I(),!1):32==e.keyCode?(_("help"),!1):90==e.keyCode&&(e.metaKey||e.ctrlKey)?(_("undo"),!1):void 0})),$(document).on("touchend mouseup",M),$(document).on("touchstart mousedown","#grid td",(function(t){if(Utils.isDoubleTapBug(t))return!1;var i=$(t.target).closest("td"),o=1*i.attr("data-x"),a=1*i.attr("data-y"),n=e.tile(o,a);if(clearTimeout(l),n.system){var s=i.find(".tile");return s.addClass("error"),setTimeout((function(){s.removeClass("error")}),500),!1}if(Tutorial.active)return Tutorial.tapTile(n),!1;e&&e.hint&&e.hint.clear();var r=[n,n.value,new Date];if(f.length){var h=f[f.length-1],u=h[0],d=h[2];(u.id!=n.id||new Date-d>500)&&f.push(r)}else f.push(r);return n.isEmpty?n.value=1:1==n.value?n.value=2:n.clear(),n.value>0&&(l=setTimeout((function(){U()}),700)),!1}))}function M(e){if(Utils.isDoubleTapBug(e))return!1;var t=$(e.target).closest("*[data-action]"),i=$(e.target).closest("*[data-action]").attr("data-action"),o=t.attr("data-value");return i?(_(i,o),!1):void 0}function _(t,i){switch(t){case"close-titleScreen":D()?b():G();break;case"show-menu":clearTimeout(l),Tutorial.end(),e&&e.hint.clear(),b();break;case"back":if(g)return _("show-menu");clearTimeout(l),Tutorial.end(),g=!0,e&&(e.unmark(),e.hint.hide(),e.hint.active=!1,e.each((function(){this.system=!0}))),z();break;case"next":clearTimeout(l),Tutorial.end(),e&&e.hint.clear(),k(h);break;case"undo":g||B();break;case"retry":if(clearTimeout(l),$("#game").removeClass("show"),Tutorial.active||u.isTutorial)return void setTimeout((function(){Tutorial.start()}),300);setTimeout((function(){x(u)}),300);break;case"help":if(g)break;if(clearTimeout(l),Tutorial.active&&!Tutorial.hintAllowed())return;e.hint.visible?e.hint.clear():(e.hint.clear(),e.hint.next());break;case"play":z();break;case"tutorial":G();break;case"about":C();break}}function U(){e.emptyTileCount>0||(e.wrongTiles.length>0?e.hint.next():S())}function D(){return!window.localStorage||window.localStorage.getItem("tutorialPlayed")+""=="true"}function G(){m=!1,Tutorial.start(),s=!0,D()||(s=!1),window.localStorage&&window.localStorage.setItem("tutorialPlayed",!0),$("#undo").closest(".iconcon").css("display","none")}function I(){m?navigator.app.exitApp():_("back")}function L(){return 1*window.localStorage.getItem("score")}function A(e){clearTimeout(A.TOH);var t=score=L(),i=t+(e||0);return i<=t?t:(window.localStorage.setItem("score",i),i)}function B(){if(!f.length)return e.hint.visible?(e.unmark(),void e.hint.hide()):void(w?e.hint.show("Nothing to undo."):e.hint.show("That's the undo button."));var t=f.pop(),i=t[0],o=t[1];e.unmark(),o>=0?i.value=o:i.clear(),i.mark();var a="This tile was reversed to ";1==o&&(a+="red."),2==o&&(a+="blue."),0==o&&(a+="its empty state."),e.hint.show(a),w=!0,clearTimeout(l),l=setTimeout((function(){U()}),700)}function E(){clearTimeout(t),clearTimeout(i),clearTimeout(o)}this.start=function(){if(setTimeout((function(){BackgroundService.kick()}),100),a)return y(),void b();setTimeout((function(){$(".hide0").removeClass("hide0")}),300),setTimeout((function(){$(".hide1").removeClass("hide1")}),1300),setTimeout((function(){$(".show01").removeClass("hidehs")}),2300),setTimeout((function(){$(".show01").removeClass("show01").addClass("hidehs"),y()}),4200)},this.init=function(){$("#scorenr").html(L()),$("#tweeturl").hide(),Utils.isTouch()&&$("html").addClass("touch"),$("[data-size]").each((function(e,t){var i=$(t),o=1*i.attr("data-size"),a=r[o-1];i.html(a),i.on("touchstart mousedown",(function(e){if(Utils.isDoubleTapBug(e))return!1;k(r[1*$(e.target).closest("[data-size]").attr("data-size")-1])}))})),v(),$(window).on("resize",v),$(window).on("orientationchange",v),p(),v(),Utils.setColorScheme("#c24b31")},this.startGame=x,this.showTitleScreen=p,this.showGame=T,this.showMenu=b,this.resize=v,this.showAbout=C,this.startTutorial=G,this.checkForLevelComplete=U,this.undo=B,window.__defineGetter__("tile",(function(){return e.tile})),this.__defineGetter__("grid",(function(){return e})),this.__defineGetter__("debug",(function(){return a}))};