function Grid(e,t,r){var n=this;r=r||"board";width=e,t=t||e,tiles=[],renderTOH=0,noRender=!1,emptyTile=new Tile(-99,n,-99),maxPerRow=Math.ceil(width/2),maxPerCol=Math.ceil(t/2),wreg=new RegExp("[12]{"+width+"}"),hreg=new RegExp("[12]{"+t+"}"),tripleReg=new RegExp("1{3}|2{3}"),count0reg=new RegExp("[^0]","g"),count1reg=new RegExp("[^1]","g"),count2reg=new RegExp("[^2]","g"),rendered=!1,quality=0,tileToSolve=null;n.state=new State(this);var i=n.hint=new Hint(this);function o(e){for(var t=0;t<tiles.length;t++){var r=t%width,i=Math.floor(t/width),o=tiles[t];if(e.call(o,r,i,t,o))break}return n}function l(e,r){e&&(width=t=Math.sqrt(e.length),r&&n.state.save("full",r)),tiles=[];for(var i=0;i<width*t;i++){var o=e?e[i]:0;tiles[i]=new Tile(o,n,i)}return u(),n}function a(e,r){return e<0||e>=width||r<0||r>=t?-1:r*width+e}function u(){}function s(e){if(!noRender){if(clearTimeout(renderTOH),e){Game.debug,rendered=!1;for(var i='<table data-grid="'+r+'" id="grid" cellpadding=0 cellspacing=0>',o=0;o<t;o++){i+="<tr>";for(var l=0;l<width;l++){var u=a(l,o),h=tiles[u];i+='<td data-x="'+l+'" data-y="'+o+'" class="'+((l+o%2)%2?"even":"odd")+'"><div id="tile-'+l+"-"+o+'" class="tile tile-'+(h&&h.value>0?h.value:"")+'"><div class="inner"></div></div></td>'}i+="</tr>"}return i+="</table>",$("#"+r).html(i),Game.resize(),rendered=!0,n}renderTOH=setTimeout((function(){s(!0)}),0)}}function h(e,r){if(isNaN(e))return emptyTile;if(isNaN(r)){var n=e;e=n%width,r=Math.floor(n/width)}return e<0||e>=width||r<0||r>=t?emptyTile:tiles[a(e,r)]}var f=h;function d(){var e=[];return o((function(){this.isEmpty&&e.push(this)})),e}function c(e,r){var l,a,s=0,h=tiles;if(n.state.clear(),noRender=!0,e||r){h=tiles.concat();Utils.shuffle(h)}if(tileToSolve){var f=[],c=[],w=[];o((function(e,t,r){e==tileToSolve.x?c.push(this):t==tileToSolve.y?f.push(this):w.push(this)})),h=f.concat(c,[tileToSolve],w)}for(var p=width*t*50;s++<p;){a=[];for(var g=!1,m=0;m<h.length;m++)if((l=h[m]).isEmpty){if(v(l)){if(i.active)return;g=l;break}a.push(l)}if(tileToSolve&&g&&tileToSolve.x==g.x&&tileToSolve.y==g.y)return!0;if(!g&&a.length&&e){l=a[0];var _=Utils.pick(l.possibleValues);l.value=_,n.state.push(l),R()||(n.state.pop(l),l.value=1==_?2:1,n.state.push(l),R()||n.state.pop(l))}else{if(!g)break;if(n.state.push(g),R()||n.state.pop(),r)break}}return noRender=!1,u(),0==d().length}function v(e){if(e.collect(i),n.state.currentState&&(n.state.currentState[e.id2]?e.possibleValues=[1]:n.state.currentState[e.id1]&&(e.possibleValues=[2])),1==e.possibleValues.length)return i.active||(e.value=e.possibleValues[0]),!0;if(e.emptyRowPairWith&&w(e,e.emptyRowPairWith)){if(i.active){e.clear();var t=HintType.SinglePossibleRowCombo,r=[];return i.doubleColFound.length?(t=HintType.ColsMustBeUnique,r=i.doubleColFound):i.doubleRowFound.length&&(t=HintType.RowsMustBeUnique,r=i.doubleRowFound),i.mark(e,t,e.emptyRowPairWith,r),!0}return!0}if(e.emptyColPairWith&&w(e,e.emptyColPairWith)){if(i.active){e.clear();t=HintType.SinglePossibleColCombo,r=[];return i.doubleColFound.length?(t=HintType.ColsMustBeUnique,r=i.doubleColFound):i.doubleRowFound.length&&(t=HintType.RowsMustBeUnique,r=i.doubleRowFound),i.mark(e,t,e.emptyColPairWith,r),!0}return!0}return!1}function w(e,t){for(var r=1;r<=2;r++)if(e.value=r,t.value=1==r?2:1,!R())return e.value=1==r?2:1,t.clear(),!0;return e.clear(),t.clear(),!1}for(var p={cols:[],rows:[],colInfo:[],rowInfo:[]},g=0;g<width;g++)p.cols[g]=Utils.fillArray(0,0,t),p.rows[g]=Utils.fillArray(0,0,width);function m(e){var r=p.colInfo[e];if(!r){var n=p.cols[e].join("");(r=p.colInfo[e]={str:n,nr0s:n.replace(count0reg,"").length,nr1s:n.replace(count1reg,"").length,hasTriple:tripleReg.test(n)}).isFull=0==r.nr0s,r.nr2s=t-r.nr0s-r.nr1s,r.isInvalid=r.nr1s>maxPerRow||r.nr2s>maxPerRow||r.hasTriple}return r}function _(e){var t=p.rowInfo[e];if(!t){var r=p.rows[e].join("");(t=p.rowInfo[e]={str:r,nr0s:r.replace(count0reg,"").length,nr1s:r.replace(count1reg,"").length,hasTriple:tripleReg.test(r)}).isFull=0==t.nr0s,t.nr2s=width-t.nr0s-t.nr1s,t.isInvalid=t.nr1s>maxPerRow||t.nr2s>maxPerRow||t.hasTriple}return t}function R(){i.doubleColFound=[],i.doubleRowFound=[];for(var e={},t={},r=0;r<width;r++){var n;if((n=m(r)).isInvalid)return!1;if(n.isFull){if(t[n.str])return n.unique=!1,i.active&&i.doubleColFound.push(t[n.str]-1,r),!1;n.unique=!0,t[n.str]=r+1}if((n=_(r)).isInvalid)return!1;if(n.isFull){if(e[n.str])return n.unique=!1,i.active&&i.doubleRowFound.push(e[n.str]-1,r),!1;n.unique=!0,e[n.str]=r+1}}return!0}this.each=o,this.render=u,this.getIndex=a,this.tile=f,this.generate=function(){var e=c(!0);return n.state.save("full"),e},this.generateFast=function(){var e=[],r=new RegExp("0{3}|1{3}","g");function i(t){for(var r=0;r<width;r++){h(r,t).clear()}var n=l[t];n&&(e.push(n),delete l[t])}noRender=!0,function(){for(var t=0,n=Math.pow(2,width);t<n;t++){var i=Utils.padLeft(t.toString(2),width);i.match(r)||i.split(0).length-1>maxPerRow||i.split(1).length-1>maxPerRow||e.push(i)}}(),Utils.shuffle(e);var o=0,l=[],a=Utils.fillArray(0,0,width);do{a[o]++;for(var u=e.shift(),s=0;s<width;s++){h(s,o).value=1*u.charAt(s)+1}if(R())l[o]=u,o++;else if(e.push(u),i(o),a[o]>=e.length){a[o]=0;for(var f=1;f<o;f++)i(f),a[f]=0;o=1}}while(o<t);n.state.save("full"),noRender=!1},this.breakDown=function(e){var r,i=0,l=e||tiles.concat();tileToSolve=null,n.state.clear(),e||Utils.shuffle(l);for(var a=0;a<l.length&&i++<6;){r=l[a++],tileToSolve=r;var u=r,s=r.value;r.clear(),n.state.save("breakdown"),c()?(n.state.restore("breakdown"),i=0):(n.state.restore("breakdown"),u.value=s)}tileToSolve=null,n.state.save("empty"),quality=Math.round(d().length/(width*t)*100),o((function(){this.isEmpty||(this.system=!0)}))},this.breakDownSimple=function(){var e,r=tiles.concat(),n=0;Utils.shuffle(r);for(var i=[];n<r.length;){var o=(e=r[n++]).value;e.clear(),v(e)?e.clear():(e.value=o,i.push(e))}return quality=Math.round(d().length/(width*t)*100),i},this.clear=function(){return o((function(){this.clear()})),n},this.load=l,this.solve=c,this.step=function(e){return c(e,!0)},this.isValid=R,this.ease=function(e){var t=d(),r=e?Math.floor(e/100*t.length):1;if(!t.length)return n;Utils.shuffle(t);for(var i=0;i<r;i++){var o=t[i];o.value=n.state.getValueForTile("full",o.x,o.y)}return n},this.size=e,this.markRow=function(e){for(var t=0;t<width;t++)f(t,e).mark();return n},this.unmarkRow=function(e){for(var t=0;t<width;t++)f(t,e).unmark();return n},this.markCol=function(e){for(var r=0;r<t;r++)f(e,r).mark();return n},this.unmarkCol=function(e){for(var r=0;r<t;r++)f(e,r).unmark();return n},this.mark=function(e,t){return f(e,t).mark(),n},this.unmark=function(e,r){if("number"==typeof e&&"number"==typeof r)return f(e,r).unmark(),n;for(r=0;r<t;r++)for(e=0;e<width;e++)f(e,r).unmark();return n},this.getValues=function(){var e=[];return o((function(){e.push(this.value)})),e},this.setValue=function(e,t,r,n){p.cols[e][t]=n,p.rows[t][e]=n,p.colInfo[e]=0,p.rowInfo[t]=0},this.getColInfo=m,this.getRowInfo=_,this.activateDomRenderer=function(){u=this.render=s,noRender=!1},this.__defineGetter__("tiles",(function(){return tiles})),this.__defineGetter__("width",(function(){return width})),this.__defineGetter__("height",(function(){return t})),this.__defineGetter__("emptyTileCount",(function(){return d().length})),this.__defineGetter__("emptyTiles",(function(){return d()})),this.__defineGetter__("wrongTiles",(function(){return e=[],o((function(t,r,i,o){var l=o.value,a=n.state.getValueForTile("full",t,r);l>0&&l!=a&&e.push(o)})),e;var e})),this.__defineGetter__("rendered",(function(){return rendered})),this.__defineGetter__("id",(function(){return r})),this.__defineGetter__("quality",(function(){return quality})),this.__defineGetter__("info",(function(){return p})),this.__defineGetter__("maxPerRow",(function(){return maxPerRow})),this.__defineGetter__("maxPerCol",(function(){return maxPerCol})),this.__defineGetter__("hint",(function(){return i})),l()}Grid.generate=function(e){var t,r=0;do{(t=new Grid(e)).generate()}while(t.emptyTileCount>0&&r++<1);return t};