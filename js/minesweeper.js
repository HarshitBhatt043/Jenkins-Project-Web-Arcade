$((function(){"use strict";var e={firstClick:!0,gameover:!1,canvas:null,context:null,totalMines:0,totalFlags:0,elapsedTime:0,clock:"",restart:"",mineMap:"",flagMap:"",revealedMap:"",currentAnimation:"",previous:new Array(2),squaresX:"",squaresY:""},t={difficulty:0,celSize:20,width:400,height:400,background:"white",font:"14px Arial",celColor:"#dadada",celStroke:"white",celRadius:5,mineImg:"images/mine.png",flagImg:"images/flag.png"},a={},n={init:function(){e.canvas=$("#board"),e.context=e.canvas[0].getContext("2d"),e.context.background=t.background;var o=this.hiDPIRatio();if(1!==o){var i=e.canvas[0].width,l=e.canvas[0].height;e.canvas[0].width=i*o,e.canvas[0].height=l*o,e.canvas.css({width:i+"px",height:l+"px"}),e.context.scale(o,o)}e.context.font=t.font,t.width=e.canvas.width(),e.squaresX=Math.floor(t.width/t.celSize),e.squaresY=Math.floor(t.height/t.celSize),e.mineMap=new Array(e.squaresX),e.flagMap=new Array(e.squaresX),e.revealedMap=new Array(e.squaresX),a.flags=$("#flags"),a.mines=$("#mines"),a.status=$("#status"),a.time=$("#time"),a.msg=$("#msg"),a.scoreboard=$("#scoreboard"),a.easy=$("#easybtn"),a.medium=$("#mediumbtn"),a.insane=$("#insanebtn"),a.switchscreens=$("#switchscreens"),a.reset=$("#reset");var c={9:a.easy,6:a.medium,3:a.insane};$.each(c,(function(e,a){a.on({click:function(){t.difficulty=e,s.switchScreens()}})})),a.switchscreens.on({click:function(){s.switchScreens()}}),a.reset.on({click:function(){n.reset()}}),$(".gamescreen").hide(),e.canvas.on({mouseup:function(e){r.click(e)},mousemove:function(e){r.hover(e)}});var f=new Array;f[0]=new Image,f[0].src=t.mineImg,f[1]=new Image,f[1].src=t.flagImg,n.setup()},hiDPIRatio:function(){return(window.devicePixelRatio||1)/(e.context.webkitBackingStorePixelRatio||e.context.mozBackingStorePixelRatio||e.context.msBackingStorePixelRatio||e.context.oBackingStorePixelRatio||e.context.backingStorePixelRatio||1)},reset:function(){window.clearInterval(e.clock),window.clearInterval(e.restart),e.context.clearRect(0,0,t.width,t.height),e.gameover=!1,e.firstClick=!0,e.totalMines=0,e.totalFlags=0,e.elapsedTime=0,e.mineMap=new Array(e.squaresX),e.flagMap=new Array(e.squaresX),e.revealedMap=new Array(e.squaresX),a.flags.html(""),a.mines.html(""),a.status.html("Game on :)"),a.time.html("0"),a.msg.html("Click on a square to start the game!"),n.setup(),window.clearInterval(e.currentAnimation),i.walker()},setup:function(){for(var a=0;a<e.squaresX;a++)e.flagMap[a]=Array(e.squaresY),e.revealedMap[a]=Array(e.squaresY);o.display(),e.context.strokeStyle=t.celStroke,e.context.fillStyle=t.celColor,i.standardBoard()},timer:function(){e.clock=setInterval((function(){e.elapsedTime++,a.time.html(e.elapsedTime)}),1e3)}},r={click:function(o){if(e.gameover)return!1;var l=Math.floor((o.pageX-e.canvas[0].offsetLeft-1)/t.celSize),c=Math.floor((o.pageY-e.canvas[0].offsetTop-1)/t.celSize),f=e.revealedMap[l][c]?1:-1;if(1===o.which&&1!==e.flagMap[l][c]&&0!==t.difficulty){if(!0===e.firstClick){window.clearInterval(e.currentAnimation),i.standardBoard(),n.timer();do{r.generateMines(e.mineMap)}while(-1===e.mineMap[l][c]);a.mines.html("You have to find "+e.totalMines+" mines to win."),e.firstClick=!1}r.index(l,c)}else if(3===o.which&&s.is("revealed",l,c)){for(var u=0,d=new Array,m=[l,l+1,l-1],v=[c,c+1,c-1],g=0;g<3;g++)for(var h=0;h<3;h++)s.is("flag",m[g],v[h])?u++:d.push([m[g],v[h]]);u===e.mineMap[l][c]&&$.each(d,(function(){r.index(this[0],this[1])}))}else if(3===o.which&&f<0&&!0!==e.firstClick){var p=new Image;p.src=t.flagImg,p.onload=function(){r.flag(p,l,c)}}},hover:function(a){if(!e.gameover){var n=Math.floor((a.pageX-e.canvas[0].offsetLeft-1)/t.celSize),r=Math.floor((a.pageY-e.canvas[0].offsetTop-1)/t.celSize),o=e.revealedMap[n][r]?1:-1,i=e.flagMap[n][r]?1:-1,l=e.previous[0],c=e.previous[1];void 0!==l&&1!==e.revealedMap[l][c]&&1!==e.flagMap[l][c]&&(e.context.fillStyle=t.celColor,s.roundRect(e.previous[0],e.previous[1])),o<0&&i<0&&!e.firstClick&&(e.context.fillStyle="#aaa",s.roundRect(n,r),e.previous[0]=n,e.previous[1]=r)}},index:function(a,n){if(a>=0&&n>=0&&a<=e.squaresX&&n<=e.squaresY&&void 0!==e.mineMap[a]){var o=e.revealedMap[a][n]?1:-1;if(!s.is("revealed",a,n)){if(e.revealedMap[a][n]=1,-1!==e.mineMap[a][n])var i=.1,l=setInterval((function(){if(e.context.strokeStyle="white",e.context.fillStyle="rgba(255,255,255,"+i+")",s.roundRect(a,n),-1!==e.mineMap[a][n]){e.context.fillStyle=["none","blue","green","red","black","orange","cyan"][e.mineMap[a][n]],e.context.fillText(e.mineMap[a][n],a*t.celSize+5,n*t.celSize+16)}(i+=.1)>1&&window.clearInterval(l)}),50);else{var c=new Image;c.src=t.mineImg,c.onload=function(){r.revealMines(c)}}if(0===e.mineMap[a][n])for(var f=-1;f<=1;f++)for(var u=-1;u<=1;u++)o<0&&a+f>=0&&n+u>=0&&a+f<=e.squaresX&&n+u<=e.squaresX&&r.index(a+f,n+u)}}},flag:function(n,o,i){if(1!==e.flagMap[o][i])e.context.drawImage(n,o*t.celSize,i*t.celSize,t.celSize,t.celSize),e.flagMap[o][i]=1,e.totalFlags++;else{for(var l=e.context.createImageData(t.celSize,t.celSize),c=l.data.length;--c>=0;)l.data[c]=0;e.context.putImageData(l,o*t.celSize,i*t.celSize),e.context.strokeStyle=t.celStroke,e.context.fillStyle=t.celColor,s.roundRect(o,i),e.flagMap[o][i]=0,e.totalFlags--}a.mines.html("You have to find "+(e.totalMines-e.totalFlags)+" mines to win."),a.flags.html("You have set "+e.totalFlags+" flags."),r.won()},won:function(){for(var t=0,n=0;n<e.squaresX;n++)for(var r=0;r<e.squaresY;r++)1===e.flagMap[n][r]&&-1===e.mineMap[n][r]&&t++;t===e.totalMines&&(e.gameover=!0,a.status.html("You won! :D"),o.save(),window.clearInterval(e.clock))},generateMines:function(){for(var a=0;a<e.squaresX;a++){e.mineMap[a]=new Array(e.squaresX);for(var n=0;n<e.squaresY;n++)e.mineMap[a][n]=Math.floor(Math.random()*t.difficulty-1),e.mineMap[a][n]>0&&(e.mineMap[a][n]=0)}r.calculateMines()},calculateMines:function(){e.totalMines=0;for(var t=0;t<e.squaresX;t++)for(var a=0;a<e.squaresY;a++)if(-1===e.mineMap[t][a]){for(var n=[t,t+1,t-1],r=[a,a+1,a-1],o=0;o<3;o++)for(var i=0;i<3;i++)s.is("mine",n[o],r[i])&&e.mineMap[n[o]][r[i]]++;e.totalMines++}},revealMines:function(n){for(var r=0;r<e.squaresX;r++)for(var o=0;o<e.squaresY;o++)-1===e.mineMap[r][o]&&e.context.drawImage(n,r*t.celSize,o*t.celSize,t.celSize,t.celSize);e.gameover=!0,a.status.html("Game over :("),a.msg.html("Click the reset button to start a new game"),window.clearInterval(e.clock)}},o={display:function(){if("undefined"!=typeof Storage)if(void 0!==localStorage.scores){var e=JSON.parse(localStorage.scores);a.scoreboard.html("<tr><th>Name</th><th>Mines</th><th>Seconds</th></tr>"),$.each(e,(function(){a.scoreboard.append("<tr><td>"+this[0]+"</td><td>"+this[2]+"</td><td>"+this[3]+"</td></tr>")}))}else a.scoreboard.html("<tr><td>You have not won any games yet :(</td></tr>");else a.scoreboard.html("<tr><td>Unfortunately, your browser does not support local storage</td></tr>")},save:function(){if("undefined"!=typeof Storage){var t=[prompt("Your score is being stored. Please enter your name","Name"),"Insane",e.totalMines,e.elapsedTime,1e4],a=void 0!==localStorage.scores?JSON.parse(localStorage.scores):new Array;a.push(t),localStorage.scores=JSON.stringify(a)}}},i={standardBoard:function(){e.context.fillStyle=t.celColor;for(var a=0;a<=e.squaresX;a++)for(var n=0;n<=e.squaresY;n++)s.roundRect(a,n)},walker:function(){e.context.strokeStyle=t.celStroke;var a=0,n=0;e.currentAnimation=setInterval((function(){i.standardBoard(),e.context.fillStyle="#f16529",s.roundRect(a,n),++a===e.squaresX&&(a=0,n++),n===e.squaresY&&(a=0,n=0)}),30)},topDown:function(){e.context.strokeStyle=t.celStroke;var a=0;e.currentAnimation=setInterval((function(){i.standardBoard(),e.context.fillStyle="#f16529";for(var t=0;t<=e.squaresX;t++)s.roundRect(t,a);a===e.squaresY&&(a=0),a++}),50)},leftRight:function(){e.context.strokeStyle=t.celStroke;var a=0,n=0;e.currentAnimation=setInterval((function(){i.standardBoard(),e.context.fillStyle="#f16529",s.roundRect(a,y),0===n&&a===e.squaresX?n=1:1===n&&-1===a&&(n=0),0===n?a++:1===n&&a--}),50)},arrow:function(){var a=[[5,9],[5,10],[5,11],[6,9],[6,10],[6,11],[7,9],[7,10],[7,11],[8,9],[8,10],[8,11],[9,9],[9,10],[9,11],[10,9],[10,10],[10,11],[11,9],[11,10],[11,11],[12,8],[12,9],[12,10],[12,11],[12,12],[13,9],[13,10],[13,11],[14,10]],n=[[5,9],[5,10],[5,11],[6,9],[6,10],[6,11],[7,9],[7,10],[7,11],[8,9],[8,10],[8,11],[9,9],[9,10],[9,11],[10,9],[10,10],[10,11],[11,8],[11,9],[11,10],[11,11],[11,12],[12,9],[12,10],[12,11],[13,10]],r=0,o=n;e.currentAnimation=setInterval((function(){i.standardBoard(),e.context.fillStyle="#f16529";for(var l=0;l<=o.length;l++)void 0!==o[l]&&s.roundRect(o[l][0]*t.celSize,o[l][1]*t.celSize,t.celSize-1,t.celSize-1);o=r%2==0?a:n,r++}),200)}},s={roundRect:function(a,n){var r=t.celSize-1,o=t.celSize-1;a*=t.celSize,n*=t.celSize;e.context.beginPath(),e.context.moveTo(a+t.celRadius,n),e.context.lineTo(a+r-t.celRadius,n),e.context.quadraticCurveTo(a+r,n,a+r,n+t.celRadius),e.context.lineTo(a+r,n+o-t.celRadius),e.context.quadraticCurveTo(a+r,n+o,a+r-t.celRadius,n+o),e.context.lineTo(a+t.celRadius,n+o),e.context.quadraticCurveTo(a,n+o,a,n+o-t.celRadius),e.context.lineTo(a,n+t.celRadius),e.context.quadraticCurveTo(a,n,a+t.celRadius,n),e.context.closePath(),e.context.stroke(),e.context.fill()},switchScreens:function(){!1===$(".startscreen").is(":hidden")?$(".startscreen").fadeToggle(400,"swing",(function(){n.reset(),$(".gamescreen").fadeToggle()})):$(".gamescreen").fadeToggle(400,"swing",(function(){n.reset(),t.difficulty=0,$(".startscreen").fadeToggle()}))},is:function(t,a,n){var r={revealed:e.revealedMap,mine:e.mineMap,flag:e.flagMap};return void 0!==r[t][a]&&void 0!==r[t][a][n]&&r[t][a][n]>-1}};n.init()}));