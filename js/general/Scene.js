define((function(e,n,l){"use strict";var a=e("lib/CustEvent"),t=e("general/Core"),o=e("general/Ball"),r=e("general/BallQueue"),d=e("general/Collide"),u=e("general/Levels"),i=e("lib/util"),s=a();l.exports=function(e,n,l,a){var f,c,g,h,p,b,C="run",v=1;function y(u){var i=u.childs,s=i.length;for(p=u.round(),g&&g.destroy(),g=t(n,l,v,50,a);s--;)g.addChild(i[s],o(l,null,"",null,a));h&&h.destroy(),(h=r(u.queueCount,n.width/2,g.pos().y+4*g.rad(),l,a)).on("popup",(function(n){g.addChild(90-g.angle(),n),d.check(g,n,a)?(b=n,"fail"!==l&&(e.style.backgroundColor="#B8111C",C="fail",c=+new Date)):!h.ballList.length&&"pass"!==C&&(e.style.backgroundColor="#1CB01A",C="pass",c=+new Date)}))}return f={enabled:!1,run:function(t){var o,r,d=u[t];v=t,d?(f.enabled=!0,y(d),e.style.backgroundColor="#000",C="run"):(o="to be continued...",r=i.getTextWidth(l,0,0,o,30*a),i.drawText(l,(n.width-r)/2,200*a,o,30*a,"yellow"))},shot:function(){h&&h.ballList.length&&h.popup()},update:function(){var n;f.enabled&&("run"===C?p&&(g.angle(p()),g.update(),h.update()):"pass"===C?(!function(){var n,l,a,t,o=g.childs(),r=o.length;for(e.style.backgroundColor=f.bgColor;r--;)n=o[r].angle+g.angle(),l=25*Math.cos(n*Math.PI/180),a=25*Math.sin(n*Math.PI/180),t=o[r].ball.pos(),o[r].ball.pos(t.x+l,t.y+a)}(),+new Date-c>1e3&&(C="",s.fire("passed"))):"fail"===C&&(function(e){var n,l=[25,15,20,15],t=l.length,o=200/t;for(g.update(),n=1;n<=t;n++)e>o*n&&b.rad(l[n-1]*a)}(n=+new Date-c),n>1e3&&(C="",s.fire("failed"))))},render:function(){f.enabled&&(g.render(),h.render())},on:function(e,n){s.add(e,n)},off:function(e,n){s.remove(e,n)}}}}));