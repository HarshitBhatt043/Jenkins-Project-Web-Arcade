function Fish(t,i,s,h,e,r){var a=randColor();this.dir=e||0,this.AI=t||!1,this.targetDir=e,this.arcSpeed=.14,this.canv=document.createElement("canvas"),this.circles=Array.apply([],new Array(6)).map((function(t,i){return{x:this.x,y:this.y,r:1}})),this.AIDir=1,this.setSize(h||20),this.frame=r||0,this.ossilation=Math.sin(r/5),this.curv=0,this.colors=[{col:randColor().rgb(),thick:4,loaded:1}],this.x=i||0,this.y=s||0,this.dying=!1,this.dead=!1,this.deathParticles=[],this.bodyColor=a.rgb(),this.bodyOutline=a.rgb(),this.isInput=!!t,this.targetPos=null,this.velocity=[0,0],this.accel=[0,0],this.maxSpeed=this.AI?2:6}var r,g,b;Fish.prototype.draw=function(t){if(this.dying)return this.drawDeath(t);if(this.ctx.clearRect(-this.canv.width,-this.canv.height,2*this.canv.width,2*this.canv.height),this.ctx.beginPath(),this.drawBody(),this.drawColors(),t.save(),t.translate(this.x,this.y),t.rotate(this.dir),t.drawImage(this.canv,-this.canv.width/2-this.size,-this.canv.height/2),t.restore(),debug){var i=t;if(i.strokeStyle="#0f0",i.fillStyle="#0f0",i.lineWidth=2,i.beginPath(),i.save(),!this.dying)for(var s=0;s<this.circles.length;s++){var h=this.circles[s];i.arc(h.x,h.y,h.r,0,2*Math.PI,!1)}i.strokeStyle="#0f0",i.stroke(),i.closePath(),i.beginPath(),i.moveTo(this.x,this.y),i.lineTo(this.x+2*this.size*Math.cos(this.dir),this.y+2*this.size*Math.sin(this.dir)),i.strokeStyle="#ff0",i.stroke(),i.closePath(),i.beginPath(),i.moveTo(this.x,this.y),i.lineTo(this.x+2*this.size*Math.cos(this.targetDir),this.y+2*this.size*Math.sin(this.targetDir)),i.strokeStyle="#f00",i.stroke(),i.closePath(),this.targetPos&&i.fillRect(this.targetPos.x,this.targetPos.y,10,10),i.restore()}},Fish.prototype.drawBody=function(){var t=this.ossilation;this.ctx.strokeStyle=this.bodyOutline,this.ctx.lineWidth=4;for(var i=-1;i<2;i+=2)this.ctx.moveTo(this.size,0),this.ctx.bezierCurveTo(this.size*(14/15),i*this.size+this.size/30*t+this.curv/3,-this.size/2,i*this.size+this.size/30*t+this.curv/2,2*-this.size,i*this.size/3+this.size/15*t+this.curv),this.ctx.bezierCurveTo(2.5*-this.size,i*this.size/6+this.size/10*t+this.curv,3*-this.size,i*this.size/4-this.size/15*t+this.curv/2,3*-this.size,-this.size/15*t+this.curv/3);this.ctx.stroke()},Fish.prototype.drawColors=function(){var t,i,s,h=this.ossilation;this.ctx.lineWidth=2;var e=this.size-this.size/4,r=0;for(t=0,i=this.colors.length;t<i;t++)r+=this.colors[t].thick*this.colors[t].loaded;var a=[];for(t=0,i=this.colors.length;t<i;t++)a.push(this.colors[t].thick/r*e);for(s=0,i=this.colors.length;s<i&&e>=0;s++){for(this.ctx.beginPath(),t=-1;t<2;t+=2)this.ctx.moveTo(e,0),this.ctx.bezierCurveTo(e*(14/15),t*e+this.size/30*h+this.curv/3,-e/2,t*e+this.size/30*h+this.curv/2,2.75*-e,this.size/15*h*this.colors[s].loaded+this.curv);this.ctx.strokeStyle=this.colors[s].col,this.ctx.stroke(),e-=a[s]}},Fish.prototype.drawDeath=function(t){for(var i=0;i<this.deathParticles.length;i++)this.deathParticles[i].draw(t)},Fish.prototype.collide=function(t){if(this.dying||t.dying||distance(this,t)>5*this.size+5*t.size)return!1;for(var i,s,h=-1,e=this.circles.length;++h<e;){i=this.circles[h];for(var r=-1,a=t.circles.length;++r<a;)if(s=t.circles[r],distance(i,s)<=s.r+i.r)return!0}return!1},Fish.prototype.killedBy=function(t){this.dying=!0,this.AI&&t.AI||playPop(),this.deathParticles=this.toParticles(t)},Fish.prototype.toParticles=function(t){for(var i=[],s=this.ctx.getImageData(0,0,this.canv.width,this.canv.height).data,h=0;h<s.length;h+=36*Math.ceil(this.size/20)*(isMobile?6:1))if(r=s[h],g=s[h+1],b=s[h+2],r||g||b){var e=h/4%this.canv.width,a=Math.floor(h/4/this.canv.width);e-=this.canv.width/2+this.size,a-=this.canv.height/2;var o=rot(e,a,this.dir);e=this.x+o[0],a=this.y+o[1];var c=new Color(r,g,b);directionTowards({x:e,y:a},this);i.push(new Particle(e,a,c,t,Math.PI*Math.random()*2-Math.PI,this.size/20))}return i};var t1,t2,moveDir,diff,ossilation,curv,p,i,l,pos,arcSpeed,friction=.1;Fish.prototype.physics=function(){this.ossilation=Math.sin(this.frame/3),ossilation=this.ossilation,t1=this.dir,t2=this.targetDir,moveDir=1,diff=0,Math.abs(t1-t2)>Math.PI&&(moveDir=-1),t1>t2?diff=t1-t2*moveDir:t1<t2&&(diff=t2-t1*moveDir),curv=this.size/15*diff,this.curv=curv||0;for(var t=0,i=this.colors.length;t<i;t++)this.colors[t].loaded<1&&(this.colors[t].loaded+=.01);if(this.dying){for(t=this.deathParticles.length-1;t>=0;t--)if((p=this.deathParticles[t]).physics()<p.target.size/8+10&&(this.deathParticles.splice(t,1),p.target.setSize(p.target.size+.001*(isMobile?6:1)),this.colors.length>0))for(t=this.colors.length-1;t>=0;t--)this.colors[t].loaded=0,p.target.colors.push(this.colors.pop());this.deathParticles.length||(this.dead=!0)}else{for(t=0,i=this.circles.length;t<i;t++)pos=rot(this.circleMap[t][0],this.circleMap[t][1]*ossilation,this.dir),this.circles[t].x=pos[0]+this.x,this.circles[t].y=pos[1]+this.y;this.targetPos&&(this.targetDir=directionTowards(this.targetPos,this)),this.AI&&(Math.random()<.01&&(this.AIDir*=-1),diff=Math.random()/100*this.AIDir,this.targetDir=this.targetDir+diff,this.targetDir%=Math.PI),t1=this.dir,t2=void 0===this.targetDir?this.dir:this.targetDir,arcSpeed=this.arcSpeed,moveDir=1,Math.abs(t1-t2)>Math.PI&&(moveDir=-1),t1>t2?this.dir-=moveDir*Math.min(arcSpeed,Math.abs(t1-t2)):t1<t2&&(this.dir+=moveDir*Math.min(arcSpeed,Math.abs(t1-t2))),this.dir>Math.PI&&(this.dir=this.dir-2*Math.PI),this.dir<-Math.PI&&(this.dir=this.dir+2*Math.PI),this.isInput?(this.accel[0]=Math.cos(this.dir),this.accel[1]=Math.sin(this.dir)):(this.accel[0]=0,this.accel[1]=0),this.velocity[0]+=this.accel[0],this.velocity[1]+=this.accel[1],this.velocity[0]=Math.max(-this.maxSpeed,Math.min(this.maxSpeed,this.velocity[0])),this.velocity[1]=Math.max(-this.maxSpeed,Math.min(this.maxSpeed,this.velocity[1])),this.velocity[0]>0&&(this.velocity[0]-=Math.min(friction,this.velocity[0])),this.velocity[0]<0&&(this.velocity[0]-=Math.max(-friction,this.velocity[0])),this.velocity[1]>0&&(this.velocity[1]-=Math.min(friction,this.velocity[1])),this.velocity[1]<0&&(this.velocity[1]-=Math.max(-friction,this.velocity[1])),this.x+=this.velocity[0]*Math.abs(Math.cos(this.dir)),this.y+=this.velocity[1]*Math.abs(Math.sin(this.dir))}this.frame++};var pi=Math.PI,dirMap={up:-pi/2,"right up":-pi/4,right:0,"down right":pi/4,down:pi/2,"down left":3*pi/4,left:pi,"left up":-3*pi/4};Fish.prototype.updateInput=function(t,i){if(i){if(void 0===t[0]||void 0===t[1])return this.isInput=!1,this.targetPos=null,this.targetDir=this.dir;this.isInput=!0,this.targetDir=directionTowards({x:this.x+t[0],y:this.y+t[1]},this)}else{var s=t.slice(0,2).sort().join(" ");void 0===dirMap[s]?this.isInput=!1:this.isInput=!0,this.targetDir=valid?dirMap[s]:this.dir,this.targetPos=null}},Fish.prototype.setSize=function(t){this.size=t,this.canv.width=4.4*this.size,this.canv.height=2.3*~~this.size,this.ctx=this.canv.getContext("2d"),this.ctx.translate(this.canv.width/2+this.size,this.canv.height/2);for(var i=[11/14,.8,10/15,7/15,4/14,.2],s=0;s<this.circles.length;s++)this.circles[s].r=this.size*i[s];this.circleMap=[[this.size/5,this.size/40],[-this.size/3,this.size/30],[-this.size,this.size/20],[1.6*-this.size,this.size/15],[2.2*-this.size,this.size/12],[2.8*-this.size,-this.size/30]]};