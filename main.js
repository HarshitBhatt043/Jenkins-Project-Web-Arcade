"use strict";function setGlobals(){window.isMobile=!!window.ext,window.devPixelRatio=(window.devicePixelRatio>2?2:window.devicePixelRatio)||1,window.$canv=document.getElementById("mainCanv"),$canv.width=window.innerWidth*devPixelRatio,$canv.height=window.innerHeight*devPixelRatio,window.ctx=$canv.getContext("2d"),ctx.lineJoin="round",window.debug=!1,window.usingSmallLogo=!1,window.pallet=[[105,210,231],[167,219,216],[224,228,204],[243,134,48],[250,105,0]],window.lastColor=new Color,window.GAME={MENU:{opacity:1},state:"menu",firstLoop:!0,bufferLoop:!0},window.ASSETS={loaded:!1},debug&&(window.stats=new Stats,document.body.appendChild(stats.domElement)),window.MS_PER_UPDATE=32,window.previousTime=0,window.lag=0,window.quality=10}function init(){GAME.state="playing",GAME.player=new Fish(!1),GAME.fishes=[GAME.player],GAME.spawner=new Spawner($canv.width,$canv.height,GAME.player,GAME.fishes),GAME.levelParticles=[],GAME.levelBar=new LevelBar($canv.width),GAME.levelBalls=new LevelBalls($canv.width,$canv.height),GAME.levelBallParticles=[],GAME.endGameParticles=[],GAME.firstLoop=!0,requestAnimFrame(draw)}function lowerQuality(){isMobile&&quality>=7&&(quality-=1,resizeWindow())}function draw(e){var a,n,t,i,l;if(lag+=e-previousTime,previousTime=e,"playing"!==GAME.state)return fadeInMenu();requestAnimFrame((function(e){draw(e)}));var o=GAME.player,s=GAME.fishes,r=GAME.spawner,d=GAME.levelParticles,c=GAME.levelBar,w=GAME.levelBalls,h=GAME.levelBallParticles,f=GAME.endGameParticles;debug&&stats.begin();for(var u=17;lag>=MS_PER_UPDATE&&u;)v(),lag-=MS_PER_UPDATE,u--;function v(){!function(){c.physics()&&(GAME.levelBallParticles=h.concat(c.toParticles(w)),w.nextColors=c.colors.slice(0,2),GAME.levelBar=new LevelBar($canv.width));a=d.length;for(;a-- >0;)d[a].physics()<10&&(d.splice(a,1),c.updating||(c.updating=!0,c.addColor()),0===d.length&&(c.updating=!1))}(),function(){if(w.physics()){for(GAME.endGameParticles=w.toParticles(o),a=0;a<GAME.endGameParticles.length;a++)GAME.endGameParticles[a].x+=o.x-$canv.width/2,GAME.endGameParticles[a].y+=o.y-$canv.height/2;GAME.levelBalls=new LevelBalls($canv.width,$canv.height)}a=h.length;for(;a-- >0;)h[a].physics()<10&&(h.splice(a,1),w.updating||(w.updating=!0,w.addBall()),0===h.length&&(w.updating=!1,w.shift()))}(),function(){for(a=-1,n=f.length;++a<n;)f[a].physics()}(),r.update(),function(){a=s.length;for(;a-- >0;)if(s[a].dead)s[a]===o&&setTimeout((function(){GAME.state="menu"}),4e3),s.splice(a,1);else{if(i=s[a],Math.abs(i.x-o.x)<$canv.width&&Math.abs(i.y-o.y)<$canv.height)for(i.physics(),t=a;t-- >0;)l=s[t],Math.abs(l.x-o.x)<$canv.width&&Math.abs(l.y-o.y)<$canv.height&&i.collide(l)&&(i.size>=l.size?l.killedBy(i):i.killedBy(l));distance(i,o)>1.5*Math.max($canv.width,$canv.height)&&(i.dead=!0)}}(),function(){if((a=o.colors.length)<=4)return;for(;a-- >0;)if(o.colors[a].loaded<1)return;o.drawColors();var e=o.toParticles(c);for(a=0;a<e.length;a++)e[a].x+=-o.x+$canv.width/2,e[a].y+=-o.y+$canv.height/2;GAME.levelParticles=d.concat(e),o.colors.splice(0,4)}()}0===u&&GAME.firstLoop?GAME.firstLoop=!1:0===u&&GAME.bufferLoop?GAME.bufferLoop=!1:0===u&&(lowerQuality(),GAME.firstLoop=!0,GAME.bufferLoop=!0),lag/MS_PER_UPDATE>75&&(lag=0),function(){ctx.fillStyle="#111",ctx.fillRect(0,0,$canv.width,$canv.height),c.draw(ctx),function(){for(a=-1,n=d.length;++a<n;)d[a].draw(ctx)}(),function(){for(a=-1,n=h.length;++a<n;)h[a].draw(ctx)}(),w.draw(ctx),ctx.save(),ctx.translate(-o.x+$canv.width/2,-o.y+$canv.height/2),function(){for(a=-1,n=f.length;++a<n;)f[a].draw(ctx)}(),function(){for(a=-1,n=s.length;++a<n;)i=s[a],Math.abs(i.x-o.x)<$canv.width/2+100&&Math.abs(i.y-o.y)<$canv.height/2+100&&i.draw(ctx)}(),debug&&r.debug();ctx.restore(),drawSoundControl()}(),debug&&stats.end()}function loadAssets(e){var a=[{name:"logo",src:"assets/logo.png"},{name:"logoSmall",src:"assets/logo-small.png"},{name:"soundOn",src:"assets/sound-on.png"},{name:"soundOff",src:"assets/sound-off.png"},{name:"enter",src:"assets/enter.png"}];!function n(){var t=a.pop();if(t){var i=new Image;i.onload=function(){ASSETS[t.name]=this,n()},i.src=t.src}else ASSETS.loaded=!0,e()}()}function levelUp(){for(var e=GAME.levelBar,a=0;a<9;a++)e.addColor();e.colors.forEach((function(e){e.loaded=1})),e.x=e.targetX,e.addColor()}function levelUp2(){for(var e=GAME.levelBalls,a=0;a<8;a++)e.addBall(),e.shift();e.balls.forEach((function(e){e.size=e.targetSize})),e.addBall()}setGlobals(),loadAssets(fadeInMenu);